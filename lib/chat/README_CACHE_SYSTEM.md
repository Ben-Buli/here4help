# Chat é é¢å¿«å–ç³»çµ±

## ğŸ¯ æ¦‚è¿°

é€™å€‹å¿«å–ç³»çµ±ç‚º `/chat` é é¢æä¾›äº†ä½é »æ›´æ–°çš„æ•¸æ“šç®¡ç†ï¼Œå¯¦ç¾äº†ã€Œç§’é–‹ã€çš„ç”¨æˆ¶é«”é©—ã€‚

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å¿«å–ç­–ç•¥
- **App å•Ÿå‹•** â†’ é¡¯ç¤ºå¿«å–ï¼ˆç§’é–‹ï¼‰
- **é€²å…¥é é¢** â†’ è¼•é‡æª¢æŸ¥æœ‰ç„¡è®Šæ›´
- **æœ‰è®Šæ›´** â†’ å±€éƒ¨æ›´æ–° + å‹•ç•«æç¤º
- **æœ‰äººæ‡‰å¾µ** â†’ å¾Œç«¯æ¨äº‹ä»¶æˆ–æ¨æ’­è§¸ç™¼æ›´æ–°

### 2. å¿«å–æœ‰æ•ˆæœŸ
- **24å°æ™‚**ï¼šå¿«å–æ•¸æ“šåœ¨24å°æ™‚å…§è¢«èªç‚ºæ˜¯æœ‰æ•ˆçš„
- **è‡ªå‹•éæœŸ**ï¼šè¶…é24å°æ™‚å¾Œè‡ªå‹•æ¨™è¨˜ç‚ºéæœŸï¼Œéœ€è¦é‡æ–°è¼‰å…¥

## ğŸ—ï¸ æ¶æ§‹çµ„ä»¶

### ChatCacheManager
æ ¸å¿ƒå¿«å–ç®¡ç†é¡ï¼Œè² è²¬ï¼š
- æ•¸æ“šçš„è¼‰å…¥ã€å„²å­˜å’Œæ›´æ–°
- å¿«å–ç‹€æ…‹ç®¡ç†
- å¢é‡æ›´æ–°æª¢æŸ¥

### UpdateStatusIndicator
æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨ï¼Œæä¾›ï¼š
- å¯¦æ™‚æ›´æ–°ç‹€æ…‹é¡¯ç¤º
- å‹•ç•«æç¤ºæ•ˆæœ
- ç”¨æˆ¶å‹å¥½çš„ç‹€æ…‹åé¥‹

### ChatProviders
Provider é…ç½®ï¼Œç¢ºä¿ï¼š
- å¿«å–ç®¡ç†å™¨åœ¨æ•´å€‹èŠå¤©é é¢å¯ç”¨
- ç‹€æ…‹çš„éŸ¿æ‡‰å¼æ›´æ–°

## ğŸ“± ä½¿ç”¨æµç¨‹

### åˆå§‹åŒ–éšæ®µ
```dart
// 1. App å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥å¿«å–
await _cacheManager.initializeCache();

// 2. å¦‚æœå¿«å–æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨
if (_cacheManager.isCacheValid && !_cacheManager.isCacheEmpty) {
  await _loadDataFromCache();
  // é¡¯ç¤ºå¿«å–æ•¸æ“šï¼ˆç§’é–‹ï¼‰
} else {
  // åŸ·è¡Œå®Œæ•´è¼‰å…¥
  await _loadChatData();
}
```

### é€²å…¥é é¢å¾Œ
```dart
// è¼•é‡æª¢æŸ¥æ›´æ–°
void _checkForUpdatesAfterEnter() {
  Future.delayed(const Duration(seconds: 1), () {
    if (mounted) {
      _cacheManager.checkForUpdates();
    }
  });
}
```

### ç”¨æˆ¶æ‰‹å‹•åˆ·æ–°
```dart
// Pull-to-refresh æ™‚èª¿ç”¨
onRefresh: () async {
  await _cacheManager.forceRefresh();
  await _loadDataFromCache();
  _pagingController.refresh();
}
```

## ğŸ”„ æ›´æ–°æ©Ÿåˆ¶

### å¢é‡æ›´æ–°æª¢æŸ¥
```dart
Future<bool> _checkForDataUpdates() async {
  // æª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
  if (!isCacheValid) {
    return true;
  }
  
  // å¯ä»¥æ·»åŠ å…¶ä»–æª¢æŸ¥é‚è¼¯
  // ä¾‹å¦‚ï¼šæª¢æŸ¥ updated_after æ™‚é–“æˆ³
  // ä¾‹å¦‚ï¼šæª¢æŸ¥æ‡‰å¾µè€…æ•¸é‡è®ŠåŒ–
  
  return false;
}
```

### å±€éƒ¨æ›´æ–°
```dart
Future<void> _performIncrementalUpdate() async {
  try {
    // åªæ›´æ–°è®Šæ›´çš„éƒ¨åˆ†
    await _loadPostedTasksData();
    await _loadMyWorksData();
  } catch (e) {
    // å¦‚æœå¢é‡æ›´æ–°å¤±æ•—ï¼Œå›é€€åˆ°å®Œæ•´æ›´æ–°
    await _loadFullData();
  }
}
```

## ğŸ’¾ æ•¸æ“šå„²å­˜

### SharedPreferences éµå€¼
- `chat_posted_tasks_cache`ï¼šPosted Tasks å¿«å–
- `chat_my_works_cache`ï¼šMy Works å¿«å–
- `chat_last_update`ï¼šæœ€å¾Œæ›´æ–°æ™‚é–“
- `chat_cache_version`ï¼šå¿«å–ç‰ˆæœ¬

### å¿«å–æ•¸æ“šçµæ§‹
```dart
// Posted Tasks å¿«å–
{
  'id': 'task_id',
  'title': 'ä»»å‹™æ¨™é¡Œ',
  'applications': [
    {
      'application_id': 'app_id',
      'applier_name': 'æ‡‰å¾µè€…å§“å',
      // ... å…¶ä»–æ‡‰å¾µè€…è³‡æ–™
    }
  ]
}

// My Works å¿«å–
{
  'id': 'task_id',
  'title': 'ä»»å‹™æ¨™é¡Œ',
  'application_status': 'æ‡‰å¾µç‹€æ…‹',
  // ... å…¶ä»–ä»»å‹™è³‡æ–™
}
```

## ğŸ¨ UI çµ„ä»¶

### UpdateStatusBanner
å…¨å¯¬ç‹€æ…‹æ©«å¹…ï¼Œé¡¯ç¤ºï¼š
- æ›´æ–°ä¸­ç‹€æ…‹
- æ›´æ–°å®Œæˆæç¤º
- å·²æ˜¯æœ€æ–°æç¤º

### UpdateStatusIndicator
åœ“è§’ç‹€æ…‹æŒ‡ç¤ºå™¨ï¼Œæä¾›ï¼š
- æ»‘å‹•å‹•ç•«æ•ˆæœ
- å½ˆæ€§å‹•ç•«æ›²ç·š
- ç‹€æ…‹åœ–æ¨™å’Œæ–‡å­—

## ğŸ”§ é…ç½®é¸é …

### å¿«å–æœ‰æ•ˆæœŸ
```dart
// åœ¨ ChatCacheManager ä¸­ä¿®æ”¹
bool get isCacheValid {
  if (_lastUpdate == null) return false;
  final now = DateTime.now();
  final difference = now.difference(_lastUpdate!);
  return difference.inHours < 24; // å¯èª¿æ•´å°æ™‚æ•¸
}
```

### æ›´æ–°æª¢æŸ¥å»¶é²
```dart
// åœ¨ ChatListPage ä¸­èª¿æ•´
void _checkForUpdatesAfterEnter() {
  Future.delayed(const Duration(seconds: 1), () { // å¯èª¿æ•´ç§’æ•¸
    if (mounted) {
      _cacheManager.checkForUpdates();
    }
  });
}
```

## ğŸš¨ éŒ¯èª¤è™•ç†

### å¿«å–è¼‰å…¥å¤±æ•—
- è‡ªå‹•å›é€€åˆ°å®Œæ•´è¼‰å…¥
- è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
- ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤º

### å¢é‡æ›´æ–°å¤±æ•—
- è‡ªå‹•å›é€€åˆ°å®Œæ•´æ›´æ–°
- ä¿æŒæ‡‰ç”¨ç©©å®šæ€§
- ä¸å½±éŸ¿ç”¨æˆ¶é«”é©—

## ğŸ“Š æ€§èƒ½å„ªåŒ–

### è¨˜æ†¶é«”ç®¡ç†
- åŠæ™‚æ¸…ç†ç„¡ç”¨å¿«å–
- é¿å…è¨˜æ†¶é«”æ´©æ¼
- å„ªåŒ–æ•¸æ“šçµæ§‹

### ç¶²è·¯è«‹æ±‚å„ªåŒ–
- æ¸›å°‘ä¸å¿…è¦çš„ API èª¿ç”¨
- æ™ºèƒ½çš„æ›´æ–°æª¢æŸ¥
- æ‰¹é‡æ•¸æ“šè™•ç†

## ğŸ”® æœªä¾†æ“´å±•

### æ¨æ’­é€šçŸ¥
- å¾Œç«¯æ¨äº‹ä»¶è§¸ç™¼æ›´æ–°
- å¯¦æ™‚æ•¸æ“šåŒæ­¥
- ç”¨æˆ¶ä¸»å‹•é€šçŸ¥

### æ™ºèƒ½å¿«å–
- åŸºæ–¼ç”¨æˆ¶è¡Œç‚ºçš„å¿«å–ç­–ç•¥
- é æ¸¬æ€§æ•¸æ“šè¼‰å…¥
- è‡ªé©æ‡‰å¿«å–å¤§å°

### é›¢ç·šæ”¯æ´
- å®Œå…¨é›¢ç·šæ¨¡å¼
- æ•¸æ“šåŒæ­¥æ©Ÿåˆ¶
- è¡çªè§£æ±ºç­–ç•¥

## ğŸ“ ä½¿ç”¨æ³¨æ„äº‹é …

1. **å¿«å–ä¸€è‡´æ€§**ï¼šç¢ºä¿å¿«å–æ•¸æ“šèˆ‡å¾Œç«¯æ•¸æ“šçš„ä¸€è‡´æ€§
2. **è¨˜æ†¶é«”ç®¡ç†**ï¼šå®šæœŸæ¸…ç†éæœŸå¿«å–ï¼Œé¿å…è¨˜æ†¶é«”ä½”ç”¨éå¤§
3. **éŒ¯èª¤è™•ç†**ï¼šå¦¥å–„è™•ç†å¿«å–è¼‰å…¥å’Œæ›´æ–°å¤±æ•—çš„æƒ…æ³
4. **ç”¨æˆ¶é«”é©—**ï¼šæä¾›æ¸…æ™°çš„æ›´æ–°ç‹€æ…‹æç¤ºï¼Œè®“ç”¨æˆ¶äº†è§£ç•¶å‰ç‹€æ…‹
5. **æ€§èƒ½ç›£æ§**ï¼šç›£æ§å¿«å–ç³»çµ±çš„æ€§èƒ½æŒ‡æ¨™ï¼ŒåŠæ™‚å„ªåŒ–

## ğŸ‰ ç¸½çµ

é€™å€‹å¿«å–ç³»çµ±é€šéæ™ºèƒ½çš„æ•¸æ“šç®¡ç†å’Œç”¨æˆ¶å‹å¥½çš„ç‹€æ…‹æç¤ºï¼Œå¯¦ç¾äº†ï¼š
- **ç§’é–‹é«”é©—**ï¼šApp å•Ÿå‹•æ™‚ç«‹å³é¡¯ç¤ºå¿«å–æ•¸æ“š
- **æ™ºèƒ½æ›´æ–°**ï¼šè¼•é‡æª¢æŸ¥æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„ç¶²è·¯è«‹æ±‚
- **æµæš¢å‹•ç•«**ï¼šå„ªé›…çš„ç‹€æ…‹æç¤ºå’Œæ›´æ–°å‹•ç•«
- **ç©©å®šå¯é **ï¼šå®Œå–„çš„éŒ¯èª¤è™•ç†å’Œå›é€€æ©Ÿåˆ¶

ç‚ºç”¨æˆ¶æä¾›äº†å¿«é€Ÿã€æµæš¢ã€å¯é çš„èŠå¤©é é¢é«”é©—ï¼
