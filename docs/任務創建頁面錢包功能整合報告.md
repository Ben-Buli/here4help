# ä»»å‹™å‰µå»ºé é¢éŒ¢åŒ…åŠŸèƒ½æ•´åˆå ±å‘Š

## ğŸ“‹ **æ¦‚è¿°**

æœ¬å ±å‘Šè©³ç´°èªªæ˜äº†å°‡ `wallet_page.dart` ä¸­çš„éŠ€è¡Œå¸³æˆ¶è³‡è¨Š UI å’Œè®€å–è³‡æ–™æ–¹å¼æ•´åˆåˆ° `task_create_page.dart` çš„å®Œæ•´éç¨‹ã€‚

## ğŸ¯ **ç›®æ¨™**

å°‡ `wallet_page.dart` ä¸­çš„ä»¥ä¸‹åŠŸèƒ½å®Œæ•´ç§»æ¤åˆ° `task_create_page.dart`ï¼š

1. **éŠ€è¡Œå¸³æˆ¶è³‡è¨Šé¡¯ç¤º**: åœ¨å……å€¼å°è©±æ¡†ä¸­é¡¯ç¤ºå®˜æ–¹éŠ€è¡Œå¸³æˆ¶è³‡è¨Š
2. **è¤‡è£½åŠŸèƒ½**: æ”¯æŒä¸€éµè¤‡è£½éŠ€è¡Œåç¨±ã€å¸³è™Ÿã€å¸³æˆ¶æŒæœ‰äººè³‡è¨Š
3. **è³‡æ–™è®€å–**: åŒæ™‚è¼‰å…¥éŒ¢åŒ…æ‘˜è¦å’ŒéŠ€è¡Œå¸³æˆ¶è³‡è¨Š
4. **éŒ¯èª¤è™•ç†**: ç•¶éŠ€è¡Œå¸³æˆ¶è³‡è¨Šä¸å¯ç”¨æ™‚çš„å‹å¥½æç¤º

## ğŸ”§ **å¯¦ç¾çš„ä¿®æ”¹**

### **1. ç‹€æ…‹è®Šæ•¸æ·»åŠ **

åœ¨ `_PostFormPageState` ä¸­æ·»åŠ äº†éŠ€è¡Œå¸³æˆ¶ç›¸é—œçš„ç‹€æ…‹è®Šæ•¸ï¼š

```dart
// éŒ¢åŒ…ç›¸é—œç‹€æ…‹
WalletSummary? _walletSummary;
BankAccountInfo? _bankAccountInfo;  // æ–°å¢
bool _isLoadingWallet = false;
String? _walletError;
bool _showInsufficientBalance = false;

// éŠ€è¡Œå¸³æˆ¶è³‡è¨Šè¤‡è£½ç›¸é—œç‹€æ…‹
final Map<String, bool> _bankInfoCopied = {};      // æ–°å¢
final Map<String, int> _bankInfoCopyTimers = {};  // æ–°å¢
```

### **2. è³‡æ–™è¼‰å…¥æ–¹æ³•ä¿®æ”¹**

ä¿®æ”¹äº† `_loadWalletData()` æ–¹æ³•ï¼Œä½¿å…¶åŒæ™‚è¼‰å…¥éŒ¢åŒ…æ‘˜è¦å’ŒéŠ€è¡Œå¸³æˆ¶è³‡è¨Šï¼š

```dart
/// è¼‰å…¥éŒ¢åŒ…æ•¸æ“š
Future<void> _loadWalletData() async {
  try {
    setState(() {
      _isLoadingWallet = true;
      _walletError = null;
    });

    final userService = Provider.of<UserService>(context, listen: false);
    await userService.ensureUserLoaded();

    if (userService.currentUser == null) {
      throw Exception('User not logged in');
    }

    // åŒæ™‚è¼‰å…¥éŒ¢åŒ…æ‘˜è¦å’ŒéŠ€è¡Œå¸³æˆ¶è³‡è¨Š
    final results = await Future.wait([
      WalletService.getWalletSummary(userService),
      WalletService.getBankAccountInfo(userService),  // æ–°å¢
    ]);

    setState(() {
      _walletSummary = results[0] as WalletSummary;
      _bankAccountInfo = results[1] as BankAccountInfo;  // æ–°å¢
      _isLoadingWallet = false;
    });
  } catch (e) {
    setState(() {
      _walletError = e.toString();
      _isLoadingWallet = false;
    });
  }
}
```

### **3. è¤‡è£½åŠŸèƒ½å¯¦ç¾**

æ·»åŠ äº†éŠ€è¡Œå¸³æˆ¶è³‡è¨Šè¤‡è£½ç›¸é—œçš„æ–¹æ³•ï¼š

```dart
void _handleBankInfoCopy(String key, String value) async {
  await Clipboard.setData(ClipboardData(text: value));
  setState(() {
    _bankInfoCopied[key] = true;
  });
  // Cancel any previous timer for this key (by incrementing a counter)
  final int currentTimer = (_bankInfoCopyTimers[key] ?? 0) + 1;
  _bankInfoCopyTimers[key] = currentTimer;
  Future.delayed(const Duration(seconds: 3), () {
    // Only clear if this is the latest timer for this key
    if (_bankInfoCopyTimers[key] == currentTimer) {
      setState(() {
        _bankInfoCopied[key] = false;
      });
    }
  });
}
```

### **4. éŠ€è¡Œå¸³æˆ¶è³‡è¨Š UI çµ„ä»¶**

æ·»åŠ äº† `_buildBankInfoContainer()` æ–¹æ³•ï¼Œå®Œå…¨è¤‡è£½äº† `wallet_page.dart` ä¸­çš„éŠ€è¡Œå¸³æˆ¶è³‡è¨Šé¡¯ç¤ºé‚è¼¯ï¼š

```dart
Widget _buildBankInfoContainer() {
  if (_bankAccountInfo == null || !_bankAccountInfo!.hasValidAccount) {
    return Container(
      padding: const EdgeInsets.all(12),
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.grey[300]!),
      ),
      child: const Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Bank account info not found.',
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
          ),
          Text(
            'Please contact admin to add bank account info.',
            style: TextStyle(fontSize: 12),
          ),
        ],
      ),
    );
  }

  final bankAccount = _bankAccountInfo!.displayAccount!;

  // Helper to build each card tile row for bank info
  Widget buildBankInfoTile({
    required String label,
    required String value,
    required String copyKey,
    IconData? icon,
  }) {
    final copied = _bankInfoCopied[copyKey] == true;
    return ListTile(
      dense: true,
      leading: icon != null ? Icon(icon, color: Colors.blueGrey[600]) : null,
      title: Text(
        label,
        style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
      ),
      subtitle: Text(
        value,
        style: const TextStyle(fontSize: 13),
        overflow: TextOverflow.ellipsis,
      ),
      trailing: IconButton(
        icon: AnimatedSwitcher(
          duration: const Duration(milliseconds: 200),
          child: copied
              ? const Icon(Icons.check, key: ValueKey('check'), color: Colors.green)
              : const Icon(Icons.copy, key: ValueKey('copy')),
        ),
        tooltip: copied ? "Copied!" : "Copy",
        onPressed: () => _handleBankInfoCopy(copyKey, value),
      ),
      visualDensity: const VisualDensity(horizontal: -2, vertical: -2),
      contentPadding: const EdgeInsets.symmetric(horizontal: 8, vertical: 0),
    );
  }

  return Card(
    elevation: 1,
    margin: const EdgeInsets.only(bottom: 16),
    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
    child: Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Padding(
            padding: EdgeInsets.only(left: 16, top: 10, bottom: 2),
            child: Text(
              'Bank Transfer Info',
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
            ),
          ),
          buildBankInfoTile(
            label: 'Bank Name',
            value: bankAccount.bankName,
            copyKey: 'bankName',
            icon: Icons.account_balance,
          ),
          buildBankInfoTile(
            label: 'Account',
            value: bankAccount.accountNumber,
            copyKey: 'accountNumber',
            icon: Icons.numbers,
          ),
          buildBankInfoTile(
            label: 'Account Holder',
            value: bankAccount.accountHolder,
            copyKey: 'accountHolder',
            icon: Icons.person,
          ),
          const SizedBox(height: 8),
          Container(
            width: double.infinity,
            margin: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
            decoration: BoxDecoration(
              color: const Color(0xFFFFF8E1), // æ·ºé»ƒè‰²
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Icon(Icons.info_outline, color: Color(0xFFFBC02D), size: 18),
                SizedBox(width: 6),
                Expanded(
                  child: Text.rich(
                    TextSpan(
                      children: [
                        TextSpan(
                          text: 'After completing the transfer, enter ',
                          style: TextStyle(fontSize: 12, color: Colors.brown),
                        ),
                        TextSpan(
                          text: 'last 5 digits of your bank account, ',
                          style: TextStyle(
                              fontSize: 12,
                              color: Colors.brown,
                              fontWeight: FontWeight.bold),
                        ),
                        TextSpan(
                          text: 'and the ',
                          style: TextStyle(fontSize: 12, color: Colors.brown),
                        ),
                        TextSpan(
                          text: 'amount transferred.',
                          style: TextStyle(
                              fontSize: 12,
                              color: Colors.brown,
                              fontWeight: FontWeight.bold),
                        ),
                      ],
                      style: TextStyle(fontSize: 12, color: Colors.brown),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    ),
  );
}
```

### **5. å……å€¼å°è©±æ¡†ä¿®æ”¹**

ä¿®æ”¹äº† `_showAddPointsDialog()` æ–¹æ³•ï¼Œåœ¨è¼¸å…¥æ¬„ä½ä¹‹å‰æ·»åŠ äº†éŠ€è¡Œå¸³æˆ¶è³‡è¨Šé¡¯ç¤ºï¼š

```dart
content: Column(
  mainAxisSize: MainAxisSize.min,
  children: [
    // éŠ€è¡Œå¸³æˆ¶è³‡è¨Šé¡¯ç¤º
    if (_bankAccountInfo != null && _bankAccountInfo!.hasValidAccount)
      _buildBankInfoContainer()
    else
      const Padding(
        padding: EdgeInsets.only(bottom: 8.0),
        child: Text(
          'Bank info unavailable. Please try again later.',
          style: TextStyle(fontSize: 12, color: Colors.redAccent),
        ),
      ),
    const SizedBox(height: 16),
    // åŸæœ‰çš„è¼¸å…¥æ¬„ä½...
  ],
),
```

## ğŸ—„ï¸ **å¾Œç«¯ API ä¿®å¾©**

### **1. bank-accounts.php ä¿®å¾©**

ä¿®å¾©äº†å°å…¥è·¯å¾‘å’Œ JWT é©—è­‰æ–¹æ³•ï¼š

```php
// ä¿®å¾©å‰
require_once __DIR__ . '/../../config/database.php';
require_once __DIR__ . '/../../utils/Response.php';

// ä¿®å¾©å¾Œ
require_once dirname(__DIR__, 2) . '/config/database.php';
require_once dirname(__DIR__, 2) . '/utils/response.php';
```

### **2. summary.php ä¿®å¾©**

åŒæ¨£ä¿®å¾©äº†å°å…¥è·¯å¾‘å’Œ JWT é©—è­‰æ–¹æ³•ã€‚

### **3. æ•¸æ“šåº«è¡¨å‰µå»º**

å‰µå»ºäº†å¿…è¦çš„æ•¸æ“šåº«è¡¨ï¼š

- `official_bank_accounts`: å®˜æ–¹éŠ€è¡Œå¸³æˆ¶è³‡è¨Šè¡¨
- `task_completion_points_fee_settings`: ä»»å‹™å®Œæˆæ‰‹çºŒè²»è¨­å®šè¡¨

## ğŸ§ª **æ¸¬è©¦é©—è­‰**

### **1. æ•¸æ“šåº«æ¸¬è©¦**

å‰µå»ºäº† `test_wallet_apis.php` ä¾†é©—è­‰ï¼š
- æ•¸æ“šåº«é€£æ¥
- è¡¨æ˜¯å¦å­˜åœ¨
- é è¨­æ•¸æ“šæ˜¯å¦æ­£ç¢ºæ’å…¥

### **2. API ç«¯é»æ¸¬è©¦**

å‰µå»ºäº† `test_api_endpoints.php` ä¾†é©—è­‰ï¼š
- `summary.php`: éŒ¢åŒ…æ‘˜è¦ API
- `bank-accounts.php`: éŠ€è¡Œå¸³æˆ¶è³‡è¨Š API
- `fee-settings.php`: æ‰‹çºŒè²»è¨­å®š API

### **3. æ¸¬è©¦çµæœ**

æ‰€æœ‰æ¸¬è©¦éƒ½é€šéï¼š
- âœ… æ•¸æ“šåº«é€£æ¥æ­£å¸¸
- âœ… éŠ€è¡Œå¸³æˆ¶è³‡è¨Šæ­£å¸¸è¼‰å…¥
- âœ… æ‰‹çºŒè²»è¨­å®šæ­£å¸¸è¼‰å…¥
- âœ… API ç«¯é»æ­£å¸¸éŸ¿æ‡‰

## ğŸ¨ **UI åŠŸèƒ½ç‰¹é»**

### **1. éŠ€è¡Œå¸³æˆ¶è³‡è¨Šé¡¯ç¤º**
- éŠ€è¡Œåç¨±ã€å¸³è™Ÿã€å¸³æˆ¶æŒæœ‰äººè³‡è¨Š
- æ¯å€‹æ¬„ä½éƒ½æœ‰å°æ‡‰çš„åœ–æ¨™
- æ”¯æŒä¸€éµè¤‡è£½åŠŸèƒ½
- è¤‡è£½æˆåŠŸå¾Œé¡¯ç¤ºç¶ è‰²å‹¾è™Ÿ

### **2. è¤‡è£½åŠŸèƒ½**
- é»æ“Šè¤‡è£½æŒ‰éˆ•å¾Œç«‹å³è¤‡è£½åˆ°å‰ªè²¼æ¿
- è¤‡è£½æˆåŠŸå¾Œé¡¯ç¤º "Copied!" æç¤º
- 3ç§’å¾Œè‡ªå‹•éš±è—æç¤º
- æ”¯æŒå¤šå€‹æ¬„ä½åŒæ™‚è¤‡è£½

### **3. éŒ¯èª¤è™•ç†**
- ç•¶éŠ€è¡Œå¸³æˆ¶è³‡è¨Šä¸å¯ç”¨æ™‚é¡¯ç¤ºå‹å¥½æç¤º
- æç¤ºç”¨æˆ¶è¯ç¹«ç®¡ç†å“¡æ·»åŠ éŠ€è¡Œå¸³æˆ¶è³‡è¨Š

### **4. ä½¿ç”¨èªªæ˜**
- æ·ºé»ƒè‰²èƒŒæ™¯çš„èªªæ˜æ–‡å­—
- è©³ç´°èªªæ˜å¦‚ä½•å®Œæˆè½‰å¸³å’Œå¡«å¯«è³‡è¨Š
- çªå‡ºé¡¯ç¤ºé—œéµæ­¥é©Ÿ

## ğŸ“± **ç”¨æˆ¶é«”é©—**

### **1. ä¸€è‡´æ€§**
- èˆ‡ `wallet_page.dart` ä¸­çš„ UI å®Œå…¨ä¸€è‡´
- ç›¸åŒçš„è¦–è¦ºè¨­è¨ˆå’Œäº¤äº’æ–¹å¼
- çµ±ä¸€çš„éŒ¯èª¤è™•ç†å’Œæç¤ºè¨Šæ¯

### **2. ä¾¿åˆ©æ€§**
- åœ¨ä»»å‹™å‰µå»ºé é¢å³å¯æŸ¥çœ‹éŠ€è¡Œå¸³æˆ¶è³‡è¨Š
- ç„¡éœ€è·³è½‰åˆ°éŒ¢åŒ…é é¢å³å¯é€²è¡Œå……å€¼
- ä¸€éµè¤‡è£½åŠŸèƒ½æé«˜æ“ä½œæ•ˆç‡

### **3. å¯é æ€§**
- å®Œæ•´çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- ç¶²è·¯è«‹æ±‚å¤±æ•—æ™‚çš„å‹å¥½æç¤º
- æ•¸æ“šè¼‰å…¥ç‹€æ…‹çš„è¦–è¦ºåé¥‹

## ğŸ”„ **æ•´åˆæµç¨‹**

1. **é é¢åˆå§‹åŒ–**: è¼‰å…¥éŒ¢åŒ…æ‘˜è¦å’ŒéŠ€è¡Œå¸³æˆ¶è³‡è¨Š
2. **ç”¨æˆ¶é»æ“Šå……å€¼**: é¡¯ç¤ºåŒ…å«éŠ€è¡Œå¸³æˆ¶è³‡è¨Šçš„å……å€¼å°è©±æ¡†
3. **æŸ¥çœ‹éŠ€è¡Œè³‡è¨Š**: ç”¨æˆ¶å¯ä»¥æŸ¥çœ‹ä¸¦è¤‡è£½éŠ€è¡Œå¸³æˆ¶è³‡è¨Š
4. **å¡«å¯«å……å€¼è³‡è¨Š**: è¼¸å…¥å¸³è™Ÿå¾Œ5ä½å’Œè½‰å¸³é‡‘é¡
5. **æäº¤è«‹æ±‚**: æäº¤å……å€¼è«‹æ±‚ä¸¦ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸

## âœ… **å®Œæˆç‹€æ…‹**

- âœ… éŠ€è¡Œå¸³æˆ¶è³‡è¨Š UI å®Œå…¨ç§»æ¤
- âœ… è¤‡è£½åŠŸèƒ½æ­£å¸¸é‹ä½œ
- âœ… è³‡æ–™è®€å–æ–¹å¼çµ±ä¸€
- âœ… éŒ¯èª¤è™•ç†æ©Ÿåˆ¶å®Œæ•´
- âœ… å¾Œç«¯ API ä¿®å¾©å®Œæˆ
- âœ… æ•¸æ“šåº«è¡¨å‰µå»ºå®Œæˆ
- âœ… æ¸¬è©¦é©—è­‰é€šé

## ğŸš€ **ä½¿ç”¨æ–¹å¼**

ç”¨æˆ¶ç¾åœ¨å¯ä»¥åœ¨ä»»å‹™å‰µå»ºé é¢ï¼š

1. é»æ“Š "Add" æŒ‰éˆ•ï¼ˆåœ¨çå‹µé»æ•¸è¼¸å…¥æ¬„ä½æ—é‚Šï¼‰
2. æŸ¥çœ‹å®˜æ–¹éŠ€è¡Œå¸³æˆ¶è³‡è¨Š
3. é»æ“Šè¤‡è£½æŒ‰éˆ•è¤‡è£½éœ€è¦çš„è³‡è¨Š
4. å®ŒæˆéŠ€è¡Œè½‰å¸³å¾Œå¡«å¯«è¡¨å–®
5. æäº¤å……å€¼è«‹æ±‚

æ‰€æœ‰åŠŸèƒ½éƒ½å·²ç¶“éæ¸¬è©¦ä¸¦æº–å‚™å¥½æŠ•å…¥ç”Ÿç”¢ä½¿ç”¨ï¼
