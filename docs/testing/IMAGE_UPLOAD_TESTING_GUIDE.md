# 圖片上傳測試指南

## 🎯 測試目標
幫助診斷和解決 Web 環境下圖片上傳的各種問題，包括：
- 圖片選擇問題
- 壓縮失敗問題
- 縮圖生成問題
- Web 兼容性問題

## 🔧 測試工具使用方法

### 1. **訪問測試頁面**
有兩種方式訪問圖片上傳測試工具：

#### 方式一：直接訪問 URL
```
http://localhost:8081/#/debug/image-upload
```

#### 方式二：從聊天頁面快速訪問
1. 進入任意聊天頁面：`http://localhost:8081/#/chat/detail?room_id=113`
2. 點擊右上角的橙色調試按鈕 🐛
3. 選擇「圖片上傳測試」

### 2. **測試功能說明**

#### 🔍 **環境信息**
- 顯示當前運行環境（Web/Native）
- 顯示 Debug 模式狀態
- 顯示圖片壓縮支援情況

#### 📸 **測試圖片選擇**
- 測試 `image_picker` 套件的基本功能
- 檢查圖片讀取和尺寸獲取
- 驗證檔案大小和格式
- **適用場景**：圖片選擇失敗、無法讀取圖片信息

#### 🗜️ **測試圖片壓縮**
- 測試不同壓縮策略：
  - Web 兼容壓縮（僅質量參數）
  - 原生壓縮（含尺寸參數）
  - JPEG 格式壓縮
- 比較壓縮前後的檔案大小
- **適用場景**：`Platform._operatingSystem` 錯誤、壓縮失敗

#### 🖼️ **測試縮圖生成**
- 測試縮圖生成功能
- 比較 Web 和原生環境的差異
- **適用場景**：縮圖生成失敗、預覽圖片問題

#### 🔄 **完整流程測試**
- 模擬完整的圖片處理流程：
  1. 圖片選擇
  2. 尺寸獲取和驗證
  3. 圖片壓縮
  4. 縮圖生成
- 顯示每個步驟的成功/失敗狀態
- **適用場景**：整體流程問題診斷

## 🐛 常見問題診斷

### 1. **"_Namespace" 錯誤**
```
❌ 處理圖片失敗: Unsupported operation: _Namespace
```
**原因**：Web 環境下直接使用 `File` 對象的限制
**解決方案**：
- 使用 `XFile.readAsBytes()` 讀取圖片數據
- 避免直接訪問 `File.path` 等屬性
- 使用 Web 兼容的處理方法

### 2. **"Platform._operatingSystem" 錯誤**
```
❌ 壓縮圖片失敗: Unsupported operation: Platform._operatingSystem
```
**原因**：Web 環境下 `flutter_image_compress` 使用了不支援的參數
**解決方案**：
- Web 環境下只使用 `quality` 參數
- 不使用 `minWidth`、`minHeight` 等尺寸參數
- 使用簡化的壓縮策略

### 3. **圖片尺寸驗證失敗**
```
❌ 圖片尺寸太小，最小需要 320x320
```
**解決方案**：
- 選擇至少 320x320 像素的圖片
- 使用測試工具檢查圖片實際尺寸

### 4. **檔案大小超限**
```
❌ 檔案過大，最大允許 10MB
```
**解決方案**：
- 選擇小於 10MB 的圖片
- 使用圖片編輯軟體預先壓縮

## 📋 測試建議

### **測試圖片準備**
建議準備以下類型的測試圖片：

1. **正常圖片**：
   - 尺寸：500x500 像素
   - 格式：PNG/JPG
   - 大小：1-5MB

2. **邊界測試圖片**：
   - 最小尺寸：320x320 像素
   - 最大尺寸：4000x4000 像素
   - 最大檔案：接近 10MB

3. **異常測試圖片**：
   - 過小尺寸：100x100 像素
   - 過大檔案：超過 10MB
   - 不支援格式：GIF、BMP

### **測試步驟**
1. **環境檢查**：確認當前運行環境
2. **基本功能**：測試圖片選擇功能
3. **壓縮測試**：測試不同壓縮策略
4. **完整流程**：測試端到端流程
5. **異常處理**：測試錯誤情況的處理

## 🔧 修復驗證

### **Web 環境修復驗證**
1. 訪問測試頁面：`http://localhost:8081/#/debug/image-upload`
2. 選擇 404x404 像素的 PNG 圖片
3. 執行「完整流程測試」
4. 確認所有步驟都顯示 ✅

### **預期結果**
```
✅ 圖片讀取成功: 245.6KB
✅ 尺寸獲取成功: 404x404
✅ 尺寸驗證通過
✅ 圖片壓縮成功: 123.4KB
✅ 縮圖生成成功: 45.2KB
```

## 📞 支援信息

如果測試工具顯示錯誤，請提供以下信息：
1. 運行環境（Web/Native）
2. 測試圖片信息（尺寸、格式、大小）
3. 具體錯誤訊息
4. 測試結果截圖

這將幫助快速定位和解決問題。
