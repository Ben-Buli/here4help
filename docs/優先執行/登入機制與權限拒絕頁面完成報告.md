# ç™»å…¥æ©Ÿåˆ¶èˆ‡æ¬Šé™æ‹’çµ•é é¢å®Œæˆå ±å‘Š

## ğŸ¯ **ä»»å‹™æ¦‚è¿°**

1. **ç¢ºèªå¾Œç«¯ç™»å…¥æ©Ÿåˆ¶**ï¼šäº†è§£ `users.status` å’Œ `users.permission` çš„é—œä¿‚
2. **å»ºç«‹ 403 æ¬Šé™æ‹’çµ•é é¢**ï¼šæä¾›ç”¨æˆ¶å‹å¥½çš„æ¬Šé™æ‹’çµ•é«”é©—

## ğŸ” **å¾Œç«¯ç™»å…¥æ©Ÿåˆ¶åˆ†æ**

### **1. ç™»å…¥æª¢æŸ¥é‚è¼¯** (`backend/api/auth/login.php`)

```php
// æŸ¥è©¢ç”¨æˆ¶ - åªæª¢æŸ¥ status = 'active'
$stmt = $db->query(
    "SELECT * FROM users WHERE email = ? AND status = 'active'",
    [$email]
);
```

**é—œéµç™¼ç¾**ï¼š
- âœ… å¾Œç«¯ç™»å…¥**åªæª¢æŸ¥ `users.status = 'active'`**
- âœ… **ä¸æª¢æŸ¥ `users.permission`** æ¬„ä½
- âœ… é€™æ„å‘³è‘— `permission = -3` ä½† `status = 'active'` çš„ç”¨æˆ¶å¯ä»¥ç™»å…¥

### **2. ç”¨æˆ¶ç‹€æ…‹å®šç¾©**

æ ¹æ“šè³‡æ–™åº« schemaï¼Œ`users.status` çš„å®šç¾©ï¼š
```sql
status ENUM('active','pending_review','rejected','banned','inactive') DEFAULT 'pending_review'
```

| ç‹€æ…‹å€¼ | èªªæ˜ | å¯ç™»å…¥ | å°æ‡‰æ¬Šé™ |
|--------|------|--------|----------|
| `active` | æ´»èºç”¨æˆ¶ | âœ… | ä»»ä½• permission å€¼ |
| `pending_review` | å¾…å¯©æ ¸ | âŒ | é€šå¸¸ 0 |
| `rejected` | è¢«æ‹’çµ• | âŒ | é€šå¸¸ 0 |
| `banned` | è¢«ç®¡ç†å“¡å°é– | âŒ | é€šå¸¸ -1 æˆ– -2 |
| `inactive` | ç”¨æˆ¶è‡ªè¡Œåœç”¨ | âŒ | é€šå¸¸ -3 æˆ– -4 |

### **3. åœç”¨å¸³è™Ÿé‚è¼¯** (`backend/api/account/deactivate.php`)

```php
// æ›´æ–°ç”¨æˆ¶ç‹€æ…‹ç‚ºè‡ªä¸»åœç”¨ï¼ˆpermission = -3, status = 'inactive'ï¼‰
$upd = $pdo->prepare(
    "UPDATE users SET permission = -3, status = 'inactive', updated_at = NOW() WHERE id = ?"
);
```

**é—œéµç™¼ç¾**ï¼š
- âœ… è‡ªä¸»åœç”¨æœƒåŒæ™‚è¨­å®š `permission = -3` å’Œ `status = 'inactive'`
- âœ… é€™ç¢ºä¿äº†è‡ªä¸»åœç”¨çš„ç”¨æˆ¶ç„¡æ³•ç™»å…¥ï¼ˆå› ç‚º `status != 'active'`ï¼‰

### **4. æ¬Šé™èˆ‡ç‹€æ…‹çš„é—œä¿‚**

| æ¬Šé™å€¼ | ç‹€æ…‹ | å¯ç™»å…¥ | èªªæ˜ |
|--------|------|--------|------|
| `-4` | `inactive` | âŒ | ç”¨æˆ¶è‡ªè¡Œè»Ÿåˆªé™¤ |
| `-3` | `inactive` | âŒ | ç”¨æˆ¶è‡ªè¡Œåœç”¨ |
| `-2` | `banned` | âŒ | ç®¡ç†å“¡è»Ÿåˆªé™¤ |
| `-1` | `banned` | âŒ | ç®¡ç†å“¡åœæ¬Š |
| `0` | `active` | âœ… | æ–°ç”¨æˆ¶æœªèªè­‰ |
| `1` | `active` | âœ… | å·²èªè­‰ç”¨æˆ¶ |
| `99` | `active` | âœ… | ç®¡ç†å“¡ |

## ğŸ¨ **403 æ¬Šé™æ‹’çµ•é é¢å¯¦ä½œ**

### **1. é é¢åŠŸèƒ½** (`lib/system/pages/permission_denied_page.dart`)

#### **ä¸»è¦ç‰¹è‰²**ï¼š
- ğŸ¯ **æ¸…æ™°çš„ 403 éŒ¯èª¤æç¤º**
- ğŸ“ **é¡¯ç¤ºç•¶å‰è·¯å¾‘è³‡è¨Š**
- ğŸ”„ **æ™ºèƒ½è¿”å›é‚è¼¯**ï¼ˆè¿”å›ä¸Šä¸€é æˆ–é¦–é ï¼‰
- ğŸ  **è¿”å›é¦–é é¸é …**
- ğŸ“ **è¯ç¹«å®¢æœå…¥å£**

#### **UI è¨­è¨ˆ**ï¼š
```dart
class PermissionDeniedPage extends StatelessWidget {
  final String message;        // æ¬Šé™æ‹’çµ•è¨Šæ¯
  final String currentPath;    // ç•¶å‰è·¯å¾‘

  // ä¸»è¦å…ƒä»¶ï¼š
  // - 403 åœ–ç¤ºï¼ˆç´…è‰²åœ“å½¢èƒŒæ™¯ï¼‰
  // - éŒ¯èª¤è¨Šæ¯å®¹å™¨ï¼ˆæ©™è‰²è­¦å‘Šæ¨£å¼ï¼‰
  // - è·¯å¾‘è³‡è¨Šé¡¯ç¤º
  // - ä¸‰å€‹æ“ä½œæŒ‰éˆ•
}
```

#### **æŒ‰éˆ•åŠŸèƒ½**ï¼š
1. **Go Back**ï¼šæ™ºèƒ½è¿”å›ï¼ˆ`context.pop()` æˆ– `context.go('/home')`ï¼‰
2. **Go to Home**ï¼šç›´æ¥è¿”å›é¦–é 
3. **Contact Support**ï¼šè¯ç¹«å®¢æœï¼ˆé ç•™åŠŸèƒ½ï¼‰

### **2. ä½¿ç”¨æ–¹å¼**

åœ¨æ¬Šé™å®ˆè¡›ä¸­ä½¿ç”¨ï¼š
```dart
// åœ¨ permission_guard.dart ä¸­
return PermissionDeniedPage(
  message: PermissionService.getPermissionStatus(userPermission),
  currentPath: path,
);
```

### **3. éŸ¿æ‡‰å¼è¨­è¨ˆ**

- ğŸ“± **æ‰‹æ©Ÿå‹å¥½**ï¼šå…¨å¯¬æŒ‰éˆ•ï¼Œé©ç•¶é–“è·
- ğŸ¨ **ç¾ä»£åŒ– UI**ï¼šåœ“è§’ã€é™°å½±ã€æ¼¸å±¤è‰²å½©
- â™¿ **ç„¡éšœç¤™è¨­è¨ˆ**ï¼šæ¸…æ™°çš„åœ–ç¤ºå’Œæ–‡å­—

## ğŸ”§ **æ¬Šé™æª¢æŸ¥é‚è¼¯æ•´åˆ**

### **1. æ¬Šé™å®ˆè¡›æ›´æ–°**

å·²æ›´æ–° `lib/router/guards/permission_guard.dart`ï¼š
- âœ… ä½¿ç”¨æ–°çš„ `PermissionDeniedPage`
- âœ… çµ±ä¸€çš„æ¬Šé™æª¢æŸ¥é‚è¼¯
- âœ… æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯

### **2. æ¬Šé™æœå‹™å„ªåŒ–**

å·²æ›´æ–° `lib/services/permission_service.dart`ï¼š
- âœ… ä¿®å¾© `canAccessPage` é‚è¼¯
- âœ… æ”¯æ´åœæ¬Šç”¨æˆ¶è¨ªå•åŸºæœ¬é é¢
- âœ… çµ±ä¸€çš„æ¬Šé™æª¢æŸ¥æ¨™æº–

## ğŸ“Š **æ¸¬è©¦æ¡ˆä¾‹**

### **æ¸¬è©¦ 1ï¼šæ­£å¸¸ç”¨æˆ¶ç™»å…¥**
- **ç”¨æˆ¶ç‹€æ…‹**ï¼š`status = 'active'`, `permission = 1`
- **é æœŸçµæœ**ï¼šâœ… æˆåŠŸç™»å…¥ï¼Œå¯è¨ªå•æ‰€æœ‰é é¢

### **æ¸¬è©¦ 2ï¼šè‡ªä¸»åœç”¨ç”¨æˆ¶**
- **ç”¨æˆ¶ç‹€æ…‹**ï¼š`status = 'inactive'`, `permission = -3`
- **é æœŸçµæœ**ï¼šâŒ ç„¡æ³•ç™»å…¥ï¼ˆå¾Œç«¯é˜»æ“‹ï¼‰

### **æ¸¬è©¦ 3ï¼šç®¡ç†å“¡åœæ¬Šç”¨æˆ¶**
- **ç”¨æˆ¶ç‹€æ…‹**ï¼š`status = 'banned'`, `permission = -1`
- **é æœŸçµæœ**ï¼šâŒ ç„¡æ³•ç™»å…¥ï¼ˆå¾Œç«¯é˜»æ“‹ï¼‰

### **æ¸¬è©¦ 4ï¼šæ¬Šé™ä¸è¶³é é¢è¨ªå•**
- **ç”¨æˆ¶ç‹€æ…‹**ï¼š`status = 'active'`, `permission = -3`
- **è¨ªå•é é¢**ï¼š`/chat`ï¼ˆéœ€è¦ `permission >= 1`ï¼‰
- **é æœŸçµæœ**ï¼šâœ… é¡¯ç¤º 403 æ¬Šé™æ‹’çµ•é é¢

## ğŸš€ **å®Œæˆé …ç›®**

### **âœ… å·²å®Œæˆ**ï¼š
1. **å¾Œç«¯ç™»å…¥æ©Ÿåˆ¶ç¢ºèª**
   - ç¢ºèª `users.status` æª¢æŸ¥é‚è¼¯
   - ç¢ºèª `users.permission` ä¸å½±éŸ¿ç™»å…¥
   - ç¢ºèªåœç”¨å¸³è™Ÿçš„ç‹€æ…‹æ›´æ–°é‚è¼¯

2. **403 æ¬Šé™æ‹’çµ•é é¢**
   - å‰µå»º `lib/system/pages/permission_denied_page.dart`
   - å¯¦ä½œç¾ä»£åŒ– UI è¨­è¨ˆ
   - æä¾›æ™ºèƒ½è¿”å›å’Œå°èˆªåŠŸèƒ½
   - æ”¯æ´è‡ªå®šç¾©éŒ¯èª¤è¨Šæ¯

3. **æ¬Šé™æª¢æŸ¥é‚è¼¯æ•´åˆ**
   - æ›´æ–°æ¬Šé™å®ˆè¡›ä½¿ç”¨æ–°é é¢
   - ä¿®å¾©æ¬Šé™æª¢æŸ¥é‚è¼¯
   - çµ±ä¸€éŒ¯èª¤è™•ç†

### **ğŸ“ å¾ŒçºŒå»ºè­°**ï¼š
1. **è¯ç¹«å®¢æœåŠŸèƒ½**ï¼šå¯¦ä½œçœŸæ­£çš„å®¢æœè¯ç¹«æ©Ÿåˆ¶
2. **å¤šèªè¨€æ”¯æ´**ï¼šæ·»åŠ éŒ¯èª¤è¨Šæ¯çš„å¤šèªè¨€ç‰ˆæœ¬
3. **åˆ†æè¿½è¹¤**ï¼šæ·»åŠ æ¬Šé™æ‹’çµ•äº‹ä»¶çš„è¿½è¹¤
4. **ç”¨æˆ¶æ•™è‚²**ï¼šåœ¨é¦–é é¡¯ç¤ºæ¬Šé™ç‹€æ…‹æç¤º

## ğŸ“‹ **æŠ€è¡“è¦æ ¼**

### **æª”æ¡ˆçµæ§‹**ï¼š
```
lib/
â”œâ”€â”€ system/
â”‚   â””â”€â”€ pages/
â”‚       â””â”€â”€ permission_denied_page.dart  # æ–°å¢
â”œâ”€â”€ router/
â”‚   â””â”€â”€ guards/
â”‚       â””â”€â”€ permission_guard.dart        # æ›´æ–°
â””â”€â”€ services/
    â””â”€â”€ permission_service.dart          # æ›´æ–°
```

### **ä¾è³´é—œä¿‚**ï¼š
- `flutter/material.dart` - UI å…ƒä»¶
- `go_router/go_router.dart` - è·¯ç”±å°èˆª
- `lib/services/permission_service.dart` - æ¬Šé™æª¢æŸ¥

### **ç›¸å®¹æ€§**ï¼š
- âœ… Flutter 3.0+
- âœ… Material Design 3
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆ
- âœ… æ·±è‰²æ¨¡å¼æ”¯æ´

---

**å®Œæˆæ™‚é–“**ï¼š2025å¹´1æœˆ11æ—¥  
**åŸ·è¡Œè€…**ï¼šAI Assistant  
**æ¸¬è©¦ç‹€æ…‹**ï¼šé‚è¼¯é©—è­‰å®Œæˆï¼Œå¾…å¯¦éš›æ¸¬è©¦
