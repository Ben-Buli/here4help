# 登入機制與權限拒絕頁面完成報告

## 🎯 **任務概述**

1. **確認後端登入機制**：了解 `users.status` 和 `users.permission` 的關係
2. **建立 403 權限拒絕頁面**：提供用戶友好的權限拒絕體驗

## 🔍 **後端登入機制分析**

### **1. 登入檢查邏輯** (`backend/api/auth/login.php`)

```php
// 查詢用戶 - 只檢查 status = 'active'
$stmt = $db->query(
    "SELECT * FROM users WHERE email = ? AND status = 'active'",
    [$email]
);
```

**關鍵發現**：
- ✅ 後端登入**只檢查 `users.status = 'active'`**
- ✅ **不檢查 `users.permission`** 欄位
- ✅ 這意味著 `permission = -3` 但 `status = 'active'` 的用戶可以登入

### **2. 用戶狀態定義**

根據資料庫 schema，`users.status` 的定義：
```sql
status ENUM('active','pending_review','rejected','banned','inactive') DEFAULT 'pending_review'
```

| 狀態值 | 說明 | 可登入 | 對應權限 |
|--------|------|--------|----------|
| `active` | 活躍用戶 | ✅ | 任何 permission 值 |
| `pending_review` | 待審核 | ❌ | 通常 0 |
| `rejected` | 被拒絕 | ❌ | 通常 0 |
| `banned` | 被管理員封鎖 | ❌ | 通常 -1 或 -2 |
| `inactive` | 用戶自行停用 | ❌ | 通常 -3 或 -4 |

### **3. 停用帳號邏輯** (`backend/api/account/deactivate.php`)

```php
// 更新用戶狀態為自主停用（permission = -3, status = 'inactive'）
$upd = $pdo->prepare(
    "UPDATE users SET permission = -3, status = 'inactive', updated_at = NOW() WHERE id = ?"
);
```

**關鍵發現**：
- ✅ 自主停用會同時設定 `permission = -3` 和 `status = 'inactive'`
- ✅ 這確保了自主停用的用戶無法登入（因為 `status != 'active'`）

### **4. 權限與狀態的關係**

| 權限值 | 狀態 | 可登入 | 說明 |
|--------|------|--------|------|
| `-4` | `inactive` | ❌ | 用戶自行軟刪除 |
| `-3` | `inactive` | ❌ | 用戶自行停用 |
| `-2` | `banned` | ❌ | 管理員軟刪除 |
| `-1` | `banned` | ❌ | 管理員停權 |
| `0` | `active` | ✅ | 新用戶未認證 |
| `1` | `active` | ✅ | 已認證用戶 |
| `99` | `active` | ✅ | 管理員 |

## 🎨 **403 權限拒絕頁面實作**

### **1. 頁面功能** (`lib/system/pages/permission_denied_page.dart`)

#### **主要特色**：
- 🎯 **清晰的 403 錯誤提示**
- 📍 **顯示當前路徑資訊**
- 🔄 **智能返回邏輯**（返回上一頁或首頁）
- 🏠 **返回首頁選項**
- 📞 **聯繫客服入口**

#### **UI 設計**：
```dart
class PermissionDeniedPage extends StatelessWidget {
  final String message;        // 權限拒絕訊息
  final String currentPath;    // 當前路徑

  // 主要元件：
  // - 403 圖示（紅色圓形背景）
  // - 錯誤訊息容器（橙色警告樣式）
  // - 路徑資訊顯示
  // - 三個操作按鈕
}
```

#### **按鈕功能**：
1. **Go Back**：智能返回（`context.pop()` 或 `context.go('/home')`）
2. **Go to Home**：直接返回首頁
3. **Contact Support**：聯繫客服（預留功能）

### **2. 使用方式**

在權限守衛中使用：
```dart
// 在 permission_guard.dart 中
return PermissionDeniedPage(
  message: PermissionService.getPermissionStatus(userPermission),
  currentPath: path,
);
```

### **3. 響應式設計**

- 📱 **手機友好**：全寬按鈕，適當間距
- 🎨 **現代化 UI**：圓角、陰影、漸層色彩
- ♿ **無障礙設計**：清晰的圖示和文字

## 🔧 **權限檢查邏輯整合**

### **1. 權限守衛更新**

已更新 `lib/router/guards/permission_guard.dart`：
- ✅ 使用新的 `PermissionDeniedPage`
- ✅ 統一的權限檢查邏輯
- ✅ 清晰的錯誤訊息

### **2. 權限服務優化**

已更新 `lib/services/permission_service.dart`：
- ✅ 修復 `canAccessPage` 邏輯
- ✅ 支援停權用戶訪問基本頁面
- ✅ 統一的權限檢查標準

## 📊 **測試案例**

### **測試 1：正常用戶登入**
- **用戶狀態**：`status = 'active'`, `permission = 1`
- **預期結果**：✅ 成功登入，可訪問所有頁面

### **測試 2：自主停用用戶**
- **用戶狀態**：`status = 'inactive'`, `permission = -3`
- **預期結果**：❌ 無法登入（後端阻擋）

### **測試 3：管理員停權用戶**
- **用戶狀態**：`status = 'banned'`, `permission = -1`
- **預期結果**：❌ 無法登入（後端阻擋）

### **測試 4：權限不足頁面訪問**
- **用戶狀態**：`status = 'active'`, `permission = -3`
- **訪問頁面**：`/chat`（需要 `permission >= 1`）
- **預期結果**：✅ 顯示 403 權限拒絕頁面

## 🚀 **完成項目**

### **✅ 已完成**：
1. **後端登入機制確認**
   - 確認 `users.status` 檢查邏輯
   - 確認 `users.permission` 不影響登入
   - 確認停用帳號的狀態更新邏輯

2. **403 權限拒絕頁面**
   - 創建 `lib/system/pages/permission_denied_page.dart`
   - 實作現代化 UI 設計
   - 提供智能返回和導航功能
   - 支援自定義錯誤訊息

3. **權限檢查邏輯整合**
   - 更新權限守衛使用新頁面
   - 修復權限檢查邏輯
   - 統一錯誤處理

### **📝 後續建議**：
1. **聯繫客服功能**：實作真正的客服聯繫機制
2. **多語言支援**：添加錯誤訊息的多語言版本
3. **分析追蹤**：添加權限拒絕事件的追蹤
4. **用戶教育**：在首頁顯示權限狀態提示

## 📋 **技術規格**

### **檔案結構**：
```
lib/
├── system/
│   └── pages/
│       └── permission_denied_page.dart  # 新增
├── router/
│   └── guards/
│       └── permission_guard.dart        # 更新
└── services/
    └── permission_service.dart          # 更新
```

### **依賴關係**：
- `flutter/material.dart` - UI 元件
- `go_router/go_router.dart` - 路由導航
- `lib/services/permission_service.dart` - 權限檢查

### **相容性**：
- ✅ Flutter 3.0+
- ✅ Material Design 3
- ✅ 響應式設計
- ✅ 深色模式支援

---

**完成時間**：2025年1月11日  
**執行者**：AI Assistant  
**測試狀態**：邏輯驗證完成，待實際測試
