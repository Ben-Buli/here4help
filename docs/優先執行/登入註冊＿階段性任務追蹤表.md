# Here4Help 登入註冊模組 - 階段性任務追蹤表

> 本文件追蹤登入註冊模組的階段性任務完成狀況，確保開發進度可追蹤且不重複執行
> 參考文件：[登入註冊＿規格整合文件.md](登入註冊＿規格整合文件.md)

---

## 📋 **任務概覽**

### **主要目標**
實作完整的第三方登入流程，包括：
1. 第三方登入成功後的用戶導向邏輯
2. 新用戶註冊流程（預填第三方資料）
3. 國家選擇和語言自動填充功能
4. 用戶身份綁定和資料庫整合

### **開發原則**
- 每次重要專案變更都需要備注在此文件
- 確保團隊開發不中斷或重複執行
- 遵循現有的資料庫架構和 API 設計
- 保持向後兼容性

---

## 🎯 **階段性任務清單**

### **第一階段：後端 OAuth 回調邏輯優化**
- [x] **任務 1.1**：修改 `google-callback.php` 的導向邏輯 ✅
  - `isNewUser = false` → 重定向到 `/home`
  - `isNewUser = true` → 重定向到 `/signup` 並帶入 user_identities 資料
  - 發生錯誤 → 重定向到 `/login`
- [x] **任務 1.2**：實作 session 暫存機制 ✅
  - 建立 user_identities session 資料
  - 處理第三方登入資料的暫存和傳遞

### **第二階段：前端路由和頁面修改**
- [x] **任務 2.1**：修改 `shell_pages.dart` 的 `/signup` 路由 ✅
  - 允許接收第三方登入參數
  - 支援 user_identities 資料傳遞
- [x] **任務 2.2**：更新 `AuthCallbackPage` 的導向邏輯 ✅
  - 整合新的導向邏輯
  - 處理第三方登入資料的傳遞

### **第三階段：註冊頁面功能增強**
- [x] **任務 3.1**：實作第三方登入資料預填 ✅
  - 接收 session 中的 user_identities 資料
  - 自動填入註冊表單的對應欄位
- [x] **任務 3.2**：新增國家選擇功能 ✅
  - 整合 REST Countries API
  - 實作國家下拉選單（國名 + 國旗 + 語言）
- [x] **任務 3.3**：語言自動填充功能 ✅
  - 選擇國家時自動填入 primary_language
  - 新增語言欄位到表單

### **第四階段：資料庫整合和流程完成**
- [x] **任務 4.1**：實作用戶註冊 API ✅
  - 建立新的註冊 API 端點
  - 處理 users 表的資料插入
  - 綁定 user_identities 資料
  - 清理暫存資料
- [x] **任務 4.2**：完成註冊流程 ✅
  - 註冊成功後自動導向 `/signup/student-id`
  - 清理暫存的 session 資料

---

## 🔧 **詳細任務說明**

### **任務 1.1：修改 google-callback.php 導向邏輯**

#### **當前狀態**
- ✅ OAuth 回調處理已實作
- ✅ 用戶資料獲取和驗證已完成
- ✅ JWT token 生成功能正常

#### **需要修改**
```php
// 修改重定向邏輯
if ($isNewUser) {
    // 新用戶：重定向到註冊頁面，並帶入 user_identities 資料
    $redirectUrl = $frontendUrl . '/signup?' . http_build_query([
        'oauth_provider' => 'google',
        'oauth_data' => base64_encode(json_encode($userData)),
        'is_new_user' => 'true'
    ]);
} else {
    // 現有用戶：重定向到主頁
    $redirectUrl = $frontendUrl . '/home?' . http_build_query([
        'token' => $token,
        'user_data' => json_encode($userData)
    ]);
}
```

#### **預估工時**：2-3 小時

---

### **任務 1.2：實作 session 暫存機制**

#### **需要實作**
- 建立 session 管理機制
- 暫存 user_identities 資料
- 處理資料的加密和傳遞

#### **技術方案**
```php
// 使用 PHP session 或 JWT 暫存
session_start();
$_SESSION['oauth_temp_data'] = [
    'provider' => 'google',
    'user_data' => $userData,
    'expires_at' => time() + 3600 // 1小時過期
];
```

#### **預估工時**：3-4 小時

---

### **任務 2.1：修改 shell_pages.dart 路由**

#### **當前狀態**
```dart
{
  'path': '/signup',
  'child': const SignupPage(),
  'title': 'ESSENTIAL INFORMATION',
  'showAppBar': true,
  'showBottomNav': false,
  'showBackArrow': true,
},
```

#### **需要修改**
```dart
{
  'path': '/signup',
  'builder': (context, extra) => SignupPage(oauthData: extra as Map<String, dynamic>?),
  'title': 'ESSENTIAL INFORMATION',
  'showAppBar': true,
  'showBottomNav': false,
  'showBackArrow': true,
},
```

#### **預估工時**：1-2 小時

---

### **任務 2.2：更新 AuthCallbackPage**

#### **需要修改**
- 整合新的導向邏輯
- 處理第三方登入資料的傳遞
- 支援不同的重定向目標

#### **預估工時**：2-3 小時

---

### **任務 3.1：實作第三方登入資料預填**

#### **需要實作**
- 在 SignupPage 中接收 oauthData 參數
- 自動填入表單欄位
- 處理空值和預設值

#### **預估工時**：4-5 小時

---

### **任務 3.2：新增國家選擇功能**

#### **需要實作**
- 整合 REST Countries API
- 實作國家下拉選單
- 國旗圖示顯示
- 語言列表獲取

#### **API 整合**
```dart
class CountryService {
  static Future<List<Country>> getCountries() async {
    final response = await http.get(
      Uri.parse('https://restcountries.com/v3.1/all?fields=name,flags,languages')
    );
    // 解析回應並返回國家列表
  }
}
```

#### **預估工時**：6-8 小時

---

### **任務 3.3：語言自動填充功能**

#### **需要實作**
- 選擇國家時自動填入 primary_language
- 新增語言欄位到表單
- 語言選擇的用戶體驗優化

#### **預估工時**：3-4 小時

---

### **任務 4.1：實作用戶註冊 API**

#### **需要實作**
- 建立新的註冊 API 端點
- 處理 users 表的資料插入
- 綁定 user_identities 資料
- 清理暫存資料

#### **預估工時**：4-5 小時

---

### **任務 4.2：完成註冊流程**

#### **需要實作**
- 註冊成功後的自動導向
- 清理暫存的 session 資料
- 錯誤處理和用戶提示

#### **預估工時**：2-3 小時

---

## 📊 **進度追蹤**

### **總體進度**
- **總任務數**：8 個主要任務
- **已完成**：8 個
- **進行中**：0 個
- **待開始**：0 個
- **完成度**：100%

### **階段進度**
- **第一階段**：2/2 任務完成 ✅
- **第二階段**：2/2 任務完成 ✅
- **第三階段**：3/3 任務完成 ✅
- **第四階段**：2/2 任務完成 ✅

---

## 🚀 **下一步行動**

### **立即執行（本週）**
1. 開始第一階段：後端 OAuth 回調邏輯優化
2. 實作 session 暫存機制
3. 測試基本的導向邏輯

### **本週完成**
1. 完成第一階段的所有任務
2. 開始第二階段：前端路由修改

### **下週完成**
1. 完成第二階段的所有任務
2. 開始第三階段：註冊頁面功能增強

---

## 📝 **變更記錄**

| 日期 | 版本/PR | 項目 | 影響區 | 修改主題類型 | 說明 |
|---|---|---|---|---|---|
| 2025-01-21 | task-tracking-01 | 建立階段性任務追蹤表 | Docs | 登入註冊 | 建立完整的任務追蹤和進度管理系統 |
| 2025-01-21 | oauth-flow-01 | 後端 OAuth 回調邏輯優化 | Backend | 第三方登入 | 修改 google-callback.php 導向邏輯，支援新用戶和現有用戶的不同重定向 |
| 2025-01-21 | oauth-flow-02 | 實作 session 暫存機制 | Backend | 第三方登入 | 在 google-callback.php 中添加 session 管理，暫存 user_identities 資料 |
| 2025-01-21 | frontend-route-01 | 修改 shell_pages.dart 路由 | Frontend | 路由配置 | 更新 /signup 路由，支援接收第三方登入參數 |
| 2025-01-21 | frontend-route-02 | 更新 AuthCallbackPage | Frontend | 第三方登入 | 整合新的導向邏輯，處理第三方登入資料傳遞 |
| 2025-01-21 | signup-enhance-01 | 實作第三方登入資料預填 | Frontend | 註冊功能 | 在 SignupPage 中添加 oauthData 參數支援和資料預填功能 |
| 2025-01-21 | signup-enhance-02 | 新增國家選擇功能 | Frontend | 註冊功能 | 整合 REST Countries API，實作國家下拉選單（國名 + 國旗 + 語言） |
| 2025-01-21 | signup-enhance-03 | 實作語言自動填充功能 | Frontend | 註冊功能 | 選擇國家時自動填入 primary_language，新增語言欄位到表單 |
| 2025-01-21 | oauth-register-01 | 實作用戶註冊 API | Backend | 第三方登入 | 建立新的註冊 API 端點，處理 users 表的資料插入，綁定 user_identities 資料 |
| 2025-01-21 | oauth-register-02 | 完成註冊流程 | Frontend | 註冊功能 | 註冊成功後自動導向 /signup/student-id，清理暫存的 session 資料 |

---

## 🔍 **注意事項**

### **技術考量**
- 保持與現有資料庫架構的兼容性
- 遵循現有的 API 設計模式
- 確保第三方登入資料的安全性

### **用戶體驗**
- 新用戶註冊流程應該流暢且直觀
- 第三方登入資料的預填應該準確
- 錯誤處理應該用戶友好

### **測試要求**
- 每個階段完成後都需要進行測試
- 確保第三方登入流程的端到端測試
- 驗證資料庫整合的正確性

---

## 📞 **聯絡資訊**

如有問題或需要協助，請聯繫開發團隊。

---

## 📝 **更新記錄**

- **2025-01-21**：初始版本，建立完整的任務追蹤系統
