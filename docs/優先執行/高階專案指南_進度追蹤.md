# 高階專案指南進度追蹤表

## 專案概述
- **專案名稱**: Here4Help Flutter App
- **當前階段**: 順序1 - OAuth 流程閉環完成
- **完成日期**: 2025-01-11
- **主要目標**: 實現第三方登入首次導引註冊的完整流程

## 順序1完成狀況 ✅

## 順序2完成狀況 ✅

## 順序3完成狀況 ✅

## 順序4完成狀況 🚧 (進行中)

### 1. Laravel 管理員後台基礎架構 ✅

#### 新增檔案與目錄
- **`admin/`** - Laravel 12.25.0 專案根目錄
  - 完整的 Laravel 框架結構
  - 配置 MySQL 資料庫連線（使用 MAMP socket）
  - 整合 Laravel Sanctum 用於 API 認證

#### 資料庫結構設計 ✅
- **`admin_roles`** - 管理員角色表
  - 支援角色名稱、顯示名稱、描述
  - JSON 格式儲存權限陣列
  - 角色啟用/停用狀態控制

- **`admins`** - 管理員用戶表（適配現有結構）
  - 使用現有欄位：`username`, `full_name`, `email`
  - 關聯 `admin_roles` 表進行 RBAC
  - 登入狀態與安全控制

- **`admin_role_permissions`** - 角色權限詳細表
  - 資源類型與動作權限控制
  - 支援條件式權限設定

- **`admin_activity_logs`** - 管理員活動日誌
  - 完整的操作審計追蹤
  - 記錄修改前後值與 IP 位址

- **`admin_login_logs`** - 登入日誌
  - 成功/失敗登入記錄
  - 安全監控與異常檢測

#### Eloquent Models ✅
- **`Admin`** - 繼承 `Authenticatable`，支援 Sanctum 認證
  - 完整的關聯設定（role, activityLogs, loginLogs）
  - 權限檢查方法 `hasPermission()`
  - 狀態檢查方法 `isActive()`

- **`AdminRole`** - 角色管理 Model
  - JSON 權限陣列處理
  - 權限新增/移除方法
  - 角色與管理員關聯

#### 資料初始化 ✅
- **預設角色建立**：
  - `super_admin`：超級管理員（完整權限）
  - `admin`：一般管理員（大部分權限）
  - `moderator`：版主（內容審核權限）

- **預設管理員帳號**：
  - Super Admin: `admin@here4help.com` / `admin123`
  - Test Admin: `test@here4help.com` / `test123`

### 2. 技術實現細節

#### 權限系統設計
- **資源導向權限**：`{resource}.{action}` 格式
  - `users.list`, `users.view`, `users.edit`, `users.delete`
  - `tasks.list`, `tasks.view`, `tasks.edit`, `tasks.delete`
  - `services.list`, `services.view`, `services.edit`, `services.delete`
  - `points.list`, `points.view`, `points.edit`, `points.delete`
  - `admins.list`, `admins.create`, `admins.edit`, `admins.delete`
  - `logs.view`

#### 資料庫整合
- **共用資料庫**：與現有 PHP 後端使用相同的 MySQL 資料庫
- **MAMP 整合**：使用 socket 連接 `/Applications/MAMP/tmp/mysql/mysql.sock`
- **遷移管理**：適配現有表結構，避免衝突

#### Laravel 配置
- **Sanctum 認證**：API token 認證機制
- **環境配置**：`.env` 檔案配置資料庫與應用設定
- **版本**：Laravel 12.25.0 最新穩定版

### 3. 測試結果

#### 基礎功能驗證 ✅
```bash
# Laravel 版本確認
php artisan --version
# 結果：Laravel Framework 12.25.0

# 資料庫連線測試
php artisan migrate:status
# 結果：成功連接並顯示遷移狀態

# Seeder 執行測試
php artisan db:seed --class=AdminSeeder
# 結果：成功建立角色與管理員帳號
```

#### 資料驗證 ✅
- [x] 管理員角色建立：3 個預設角色
- [x] 管理員帳號建立：2 個測試帳號
- [x] 權限系統配置：完整的 RBAC 權限陣列
- [x] 資料表關聯：正確的外鍵與索引設定

### 4. 管理員認證與權限控制系統 ✅

#### 新增檔案
- **`app/Http/Controllers/Admin/AuthController.php`** - 管理員認證控制器
  - 完整的登入/登出/刷新 API
  - 密碼驗證與帳號狀態檢查
  - 登入失敗次數限制與帳號鎖定機制
  - 完整的登入日誌記錄

- **`app/Http/Middleware/AdminMiddleware.php`** - RBAC 權限中介層
  - 管理員身份驗證檢查
  - 細粒度權限控制（支援 `resource.action` 格式）
  - 自動活動日誌記錄
  - 未授權訪問嘗試追蹤

- **`app/Models/AdminLoginLog.php`** - 登入日誌 Model
  - 適配現有資料表結構
  - 登入成功/失敗狀態追蹤
  - IP 位址與 User Agent 記錄

- **`app/Models/AdminActivityLog.php`** - 活動日誌 Model
  - 管理員操作審計追蹤
  - 資源類型與動作分類
  - 中文顯示名稱支援

#### API 路由設計 ✅
- **認證端點**：
  - `POST /api/admin/login` - 管理員登入
  - `POST /api/admin/logout` - 管理員登出
  - `GET /api/admin/me` - 獲取當前管理員資訊
  - `POST /api/admin/refresh` - 刷新 token

- **權限保護端點**：
  - `GET /api/admin/users` - 用戶管理（需要 `users.list`）
  - `GET /api/admin/tasks` - 任務管理（需要 `tasks.list`）
  - `GET /api/admin/admins` - 管理員管理（需要 `admins.list`）
  - `GET /api/admin/logs/*` - 日誌查看（需要 `logs.view`）

#### 技術實現亮點
- **Laravel Sanctum 整合**：API token 認證機制
- **適配現有資料庫**：兼容現有表結構，避免資料遷移
- **靜態權限配置**：在 Model 中定義角色權限，靈活且易維護
- **安全機制**：登入失敗鎖定、IP 追蹤、活動審計
- **中介層設計**：支援參數化權限檢查，可擴展性強

#### 測試結果 ✅
```bash
# 登入測試
Login Response Status: 200
Success: YES
Admin: Admin Buli
Permissions: 27 permissions
Token: 1|M9kSv4FZRHJKyvQETK...
Login logged: YES

# 權限中介層測試
No permission required: 200
users.list permission: 200
nonexistent permission: 403
```

### 5. 管理員後台 API 路由與控制器系統 ✅

#### 新增控制器
- **`app/Http/Controllers/Admin/UserController.php`** - 用戶管理控制器
  - 用戶列表查詢（分頁、篩選、搜尋、排序）
  - 用戶詳細資訊（包含統計資料和最近活動）
  - 用戶狀態更新（active, banned, inactive 等）
  - 用戶權限等級調整（-4 到 99 的權限系統）
  - 批量操作（批量啟用、停用、封鎖）
  - 完整的操作審計日誌

- **`app/Http/Controllers/Admin/TaskController.php`** - 任務管理控制器
  - 任務列表查詢（支援狀態、創建者、參與者篩選）
  - 任務詳細資訊（包含申請記錄和聊天統計）
  - 任務狀態管理（Open, In Progress, Completed 等）
  - 管理員操作記錄與審計追蹤

- **`app/Http/Controllers/Admin/LogController.php`** - 日誌管理控制器
  - 管理員活動日誌查看（支援多維度篩選）
  - 管理員登入日誌追蹤（成功/失敗/IP 統計）
  - 系統統計資訊（今日/本週/本月/本年）
  - 豐富的統計圖表資料

#### 完整 API 路由架構 ✅
```
POST   /api/admin/login                    # 管理員登入
POST   /api/admin/logout                   # 管理員登出
GET    /api/admin/me                       # 獲取當前管理員資訊
POST   /api/admin/refresh                  # 刷新 token

# 用戶管理 (需要 users.* 權限)
GET    /api/admin/users                    # 用戶列表
GET    /api/admin/users/{id}               # 用戶詳情
PATCH  /api/admin/users/{id}/status        # 更新用戶狀態
PATCH  /api/admin/users/{id}/permission    # 更新用戶權限
POST   /api/admin/users/batch-action       # 批量操作

# 任務管理 (需要 tasks.* 權限)
GET    /api/admin/tasks                    # 任務列表
GET    /api/admin/tasks/{id}               # 任務詳情
PATCH  /api/admin/tasks/{id}/status        # 更新任務狀態

# 日誌管理 (需要 logs.view 權限)
GET    /api/admin/logs/activity            # 活動日誌
GET    /api/admin/logs/login               # 登入日誌
GET    /api/admin/logs/stats               # 系統統計

# 系統資訊
GET    /api/admin/dashboard                # 儀表板資料
```

#### 權限控制整合 ✅
- **細粒度權限檢查**：每個 API 端點都有對應的權限要求
- **自動審計日誌**：所有管理員操作都會自動記錄
- **資料庫適配**：完全適配現有資料表結構
- **錯誤處理**：統一的 JSON 錯誤回應格式

#### 測試驗證 ✅
```bash
Testing User API...
Users List: 200          # ✅ 用戶管理 API 正常
Testing Task API...
Tasks List: 200          # ✅ 任務管理 API 正常
Testing Log API...
System Stats: 200        # ✅ 日誌管理 API 正常
All APIs working!        # ✅ 所有 API 端點正常運作
```

#### 功能特色
- **智能分頁**：支援自訂每頁筆數和排序
- **多維篩選**：狀態、權限、時間範圍、關鍵字搜尋
- **統計資訊**：即時統計各種資料指標
- **批量操作**：支援批量用戶狀態管理
- **審計追蹤**：完整的操作歷史記錄
- **安全防護**：基於 RBAC 的權限控制

### 6. Vue.js 管理前端基礎架構 ✅

#### 前端技術棧
- **Vue 3 + TypeScript**：現代化前端框架
- **Tailwind CSS**：實用優先的 CSS 框架
- **Pinia**：Vue 3 狀態管理
- **Vue Router**：單頁應用路由
- **Axios**：HTTP 客戶端
- **Chart.js + Vue-chartjs**：圖表視覺化

#### 核心功能實現 ✅
- **認證系統**：
  - 完整的登入/登出流程
  - JWT Token 自動管理
  - 權限檢查與路由守衛
  - 自動 token 刷新機制

- **狀態管理**：
  - Pinia 認證 store
  - 用戶資訊與權限狀態
  - 本地存儲持久化

- **UI 組件**：
  - 響應式管理介面佈局
  - 側邊欄導航與麵包屑
  - 統一的設計系統 (admin-* CSS 類)
  - 現代化的登入頁面

#### API 整合 ✅
- **完整的 API 服務層**：
  - 認證 API (authApi)
  - 用戶管理 API (userApi)
  - 任務管理 API (taskApi)
  - 日誌管理 API (logApi)
  - 系統資訊 API (systemApi)

- **錯誤處理**：
  - 統一的錯誤攔截
  - 401 自動跳轉登入
  - API 響應類型定義

#### 路由系統 ✅
- **權限路由守衛**：
  - 認證檢查 (requiresAuth)
  - 權限檢查 (permission)
  - 訪客頁面保護 (requiresGuest)

- **頁面結構**：
  ```
  /login          # 登入頁面
  /dashboard      # 儀表板 (已實現)
  /users          # 用戶管理 (placeholder)
  /tasks          # 任務管理 (placeholder)
  /logs           # 日誌查看 (placeholder)
  /settings       # 系統設定 (placeholder)
  ```

#### 開發環境配置 ✅
- **代碼品質**：
  - ESLint + Prettier 配置
  - TypeScript 嚴格模式
  - 自動格式化

- **構建工具**：
  - Vite 快速開發伺服器
  - PostCSS + Tailwind 處理
  - 環境變數配置

#### Git 版本控制 ✅
- **`.gitignore` 更新**：
  - 移除 `admin/` 忽略規則
  - 添加 Laravel 特定忽略
  - 保護敏感配置檔案

- **版本提交**：
  - 114 個檔案成功提交
  - 完整的 commit 訊息
  - 推送到遠端倉庫成功

## 📋 專案執行順序總覽

### 順序1：OAuth 流程閉環完成 ✅
**目標**：實作完整的第三方登入 OAuth token 化流程
- [x] T1-BE-CALLBACK-SAVE-TEMP：重構回調，寫入 oauth_temp_users
- [x] T2-BE-API-FETCH-TEMP：新增 GET /auth/oauth-temp API
- [x] T3-BE-REGISTER-CONSUME-TEMP：改造註冊 API 消費 temp token
- **狀態**：✅ 完成 - 新/舊用戶分流正常，token 化流程運作

### 順序2：前端 OAuth 註冊完成 ✅
**目標**：前端支援 OAuth token 預填與註冊流程
- [x] T4-FE-SIGNUP-PREFILL：/signup 支援 token 載入預填
- [x] T5-FE-OAUTH-WIRING：前端第三方登入流程銜接
- **狀態**：✅ 完成 - OAuth 註冊流程完整，包含國家選擇與語言自動填入

### 順序3：OAuth 流程整合與第三方登入統一化 ✅
**目標**：整合所有第三方登入服務與流程優化
- [x] 統一第三方登入服務架構
- [x] Web 平台 OAuth 流程實作
- [x] 錯誤處理與用戶體驗優化
- **狀態**：✅ 完成 - 所有第三方登入統一化，Web OAuth 正常運作

### 順序4：管理員後台基礎 ✅
**目標**：建立 Laravel + Vue 管理員後台基礎架構
- [x] T6-LAR-ADMIN-SETUP：建立 Laravel 管理員後台基礎架構
- [x] T6B-LAR-ADMIN-MIGRATIONS：建立 RBAC 與稽核資料表
- [x] T6C-LAR-ADMIN-ROUTES-RBAC：/admin 路由樹與 RBAC 中介層
- [x] T7-LAR-ADMIN-AUTH：實作管理員登入與權限控制
- [x] T8-VUE-ADMIN-UI：建立 Vue.js 管理員前端介面基礎
- **狀態**：✅ 完成 - 17個API端點，完整RBAC系統，Vue.js前端基礎架構

### 順序5：管理員後台詳細頁面開發 ✅
**目標**：完善管理員後台的具體功能頁面
- [x] 完善用戶管理頁面 (列表、詳情、編輯)
- [x] 完善任務管理頁面 (列表、詳情、狀態管理)
- [x] 完善日誌查看頁面 (活動日誌、登入日誌)
- [x] 整合 Chart.js 圖表與統計視覺化
- [x] 實作響應式設計與手機適配
- [x] 端對端測試與性能優化
- **狀態**：✅ 完成 - 管理員後台所有核心功能頁面已完整實作

#### 用戶管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 分頁、搜尋、篩選、排序功能
  - 批量操作（啟用、停用、封鎖）
  - 統計卡片顯示（總用戶、活躍用戶、待審核、封鎖用戶）
  - 響應式表格設計

- **用戶詳情頁面**：
  - 完整用戶資訊展示
  - 帳號狀態與權限管理
  - 用戶統計資料
  - 最近活動記錄

- **用戶編輯功能**：
  - 模態框編輯介面
  - 狀態與權限等級調整
  - 操作原因記錄（審計追蹤）
  - 即時表單驗證

- **技術實現**：
  - TypeScript 嚴格類型檢查
  - Vue 3 Composition API
  - Tailwind CSS 響應式設計
  - 完整的錯誤處理與載入狀態

#### 任務管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 多維度篩選（狀態、創建者、參與者、日期範圍）
  - 高級搜尋功能（標題、描述、用戶）
  - 統計卡片顯示（總任務、活躍任務、待審核、爭議任務）
  - 導出功能準備

- **任務詳情頁面**：
  - 完整任務資訊展示（基本資訊、參與人員、時間軸）
  - 任務申請記錄查看
  - 麵包屑導航與狀態標籤
  - 任務狀態編輯功能

- **任務狀態管理**：
  - 狀態編輯模態框（6種狀態：開放、進行中、完成、取消、爭議、待確認）
  - 狀態變更影響警告
  - 操作原因強制記錄
  - 狀態變更審計追蹤

- **技術特色**：
  - 防抖搜尋優化（500ms延遲）
  - 狀態徽章動態樣式
  - 完整的表單驗證
  - 響應式表格設計

#### 日誌查看頁面實作詳情 ✅
- **多類型日誌管理**：
  - 標籤式介面（全部日誌、登入日誌、活動日誌、管理員操作）
  - 即時統計數量顯示
  - 多維度篩選（用戶ID、動作類型、日期範圍）
  - 預設日期範圍選擇（今天、昨天、最近7天、最近30天、自定義）

- **高級搜尋功能**：
  - 用戶、動作、IP地址搜尋
  - 自定義日期時間範圍選擇
  - 防抖搜尋優化
  - 即時篩選結果

- **詳細日誌資訊**：
  - 完整時間戳記錄
  - 用戶資訊與系統操作區分
  - 動作類型彩色標籤
  - IP地址與User Agent追蹤
  - 操作詳情完整記錄

#### Chart.js 圖表統計視覺化 ✅
- **多類型圖表展示**：
  - 用戶註冊趨勢（線性圖）
  - 任務狀態分佈（甜甜圈圖）
  - 每日活動統計（柱狀圖）
  - 點數分佈趨勢（線性圖）

- **圖表功能特色**：
  - 響應式圖表設計
  - 即時數據載入
  - 模擬數據展示（開發環境）
  - 圖例與工具提示
  - 多數據集比較

- **數據視覺化**：
  - 7天趨勢分析
  - 多維度數據對比
  - 顏色編碼狀態識別
  - 互動式圖表操作

#### 響應式設計與優化 ✅
- **完整響應式支援**：
  - 桌面、平板、手機適配
  - Tailwind CSS 響應式類別
  - 彈性網格佈局
  - 適應性表格設計

- **性能優化實作**：
  - 防抖搜尋減少API調用
  - 圖表懶載入機制
  - 分頁數據載入
  - TypeScript 嚴格類型檢查

- **用戶體驗優化**：
  - 載入狀態指示器
  - 錯誤處理與重試機制
  - 空狀態友好提示
  - 統一的設計語言

### 順序6：帳號安全與保護 ✅
**目標**：實作用戶帳號安全機制與風險檢查
- [x] T1-BE-SECURITY-GUARD：GET /account/risky-actions-check, POST /account/deactivate, POST /account/reactivate
- [x] T2-FLT-SECURITY-UI：/account/security UI 與保護流程
- **狀態**：✅ 完成 - 帳號安全與保護機制已完整實作

#### 後端 API 實作詳情 ✅
- **風險檢查 API** (`risky-actions-check.php`)：
  - 檢查進行中任務（作為參與者）
  - 檢查發布中任務（作為創建者）
  - 檢查活躍聊天室
  - 返回詳細的風險狀態與數量統計
  - 提供 `can_deactivate` 布林值判斷

- **帳號停用 API** (`deactivate.php`)：
  - 驗證無進行中任務才允許停用
  - 區分自主停用與管理員停權
  - 更新用戶權限為 -3（自主停用）
  - 記錄操作日誌到 `user_activity_logs`
  - 完整的錯誤處理與狀態檢查

- **帳號啟用 API** (`reactivate.php`)：
  - 僅允許自主停用帳號重新啟用
  - 管理員停權帳號需聯繫客服
  - 更新用戶權限為 1（正常用戶）
  - 記錄重新啟用操作日誌
  - 返回詳細的狀態更新資訊

#### 前端 UI 實作詳情 ✅
- **風險警告系統**：
  - 頁面載入時自動檢查風險狀態
  - 視覺化警告卡片顯示具體風險項目
  - 動態禁用停用按鈕（有風險時）
  - 即時更新風險狀態與按鈕可用性

- **帳號停用流程**：
  - 雙重確認對話框
  - 載入狀態指示器
  - 成功/失敗 SnackBar 提示
  - 自動更新本地權限狀態
  - 重新檢查風險狀態

- **帳號啟用流程**：
  - 條件式顯示啟用按鈕（僅自主停用時）
  - 確認對話框與操作反饋
  - 管理員停權專用提示卡片
  - 客服聯繫按鈕（管理員停權時）

- **狀態管理**：
  - 本地 SharedPreferences 權限同步
  - 即時 UI 狀態更新
  - 錯誤處理與重試機制
  - 載入狀態與錯誤訊息顯示

#### 安全機制特色 ✅
- **任務保護**：禁止在有進行中任務時停用帳號
- **權限區分**：自主停用(-3) vs 管理員停權(-1)
- **操作審計**：完整的操作日誌記錄
- **用戶體驗**：清晰的狀態提示與操作指引
- **錯誤處理**：完善的錯誤訊息與重試機制

### 順序7：全域權限與路由守衛 ✅
**目標**：實作前端權限控制系統
- [x] T1-PERMISSION-GUARD：新增 guards/permission_guard.dart 並套用至路由與元件
- **狀態**：✅ 完成 - 全域權限控制系統已完整實作並整合現有架構

#### 權限系統整合分析 ✅
**現有權限架構評估**：
- **`permission_service.dart`** - 靜態權限檢查服務 ✅ 保留
- **`permission_provider.dart`** - 權限狀態管理 Provider ✅ 保留  
- **`permission_aware_widget.dart`** - 權限感知元件 ✅ 保留
- **`auth_guard.dart`** - 路由守衛（部分實作）✅ 整合
- **`route_permissions.dart`** - 路由權限配置 ✅ 整合
- **`shell_pages.dart`** - 頁面配置 ✅ 新增權限欄位

#### Shell Pages 權限配置 ✅
**為所有頁面添加 `permission` 欄位**：
- **登入/註冊頁面**：`permission: -4` （任何狀態可訪問）
- **身份驗證頁面**：`permission: 0` （新用戶可訪問）
- **首頁/帳戶頁面**：`permission: 0` （新用戶可訪問）
- **聊天功能**：`permission: 1` （需要已認證用戶）
- **任務創建/應徵**：`permission: 1` （需要已認證用戶）
- **錢包/評價/歷史**：`permission: 1` （需要已認證用戶）
- **安全設定/主題/客服**：`permission: 0` （新用戶可訪問）
- **支付設定**：`permission: 1` （需要已認證用戶）

#### 統一權限守衛實作 ✅
**`lib/router/guards/permission_guard.dart`**：
- **路由級權限檢查**：`canAccessRoute()` 整合 shell_pages 配置
- **功能級權限檢查**：`canUseFeature()` 整合 permission_service
- **路由守衛中介層**：`guardRoute()` 統一處理權限拒絕
- **智能對話框系統**：根據用戶狀態顯示不同提示
  - 未認證用戶：導向身份驗證頁面
  - 管理員停權：導向客服聯繫頁面
  - 自主停用：導向安全設定頁面
- **權限提示系統**：`shouldShowPermissionHint()` 動態提示

#### 權限感知按鈕組件 ✅
**`lib/widgets/buttons/apply_now_button.dart`**：
- **ApplyNowButton**：權限感知的任務應徵按鈕
- **EnterChatButton**：權限感知的聊天室進入按鈕
- **CreateTaskButton**：權限感知的任務創建按鈕
- **動態狀態顯示**：
  - 有權限：正常顯示可點擊按鈕
  - 權限不足：顯示鎖定圖標與提示
  - 帳號刪除：完全隱藏按鈕
- **智能提示系統**：Tooltip + 點擊顯示權限對話框

#### 技術整合特色 ✅
**避免重複功能**：
- 保留現有 `permission_service.dart` 靜態方法
- 整合 `permission_provider.dart` 狀態管理
- 擴展 `permission_aware_widget.dart` 功能
- 統一 `auth_guard.dart` 與新守衛邏輯
- 升級 `shell_pages.dart` 權限配置

**統一權限控制**：
- 路由級：透過 `guardRoute()` 統一檢查
- 元件級：透過權限感知按鈕動態控制
- 功能級：透過 `checkFeaturePermission()` 即時驗證
- 提示級：透過智能對話框引導用戶操作

**用戶體驗優化**：
- 根據權限狀態顯示不同提示訊息
- 提供明確的解決方案（驗證、聯繫客服、重新啟用）
- 保持 UI 一致性（禁用狀態、鎖定圖標）
- 避免突然跳轉，優先顯示對話框說明

### 順序8：歷史任務與未評價快捷 ✅
**目標**：實作任務歷史查看與快捷評價功能
- [x] T1-BE-HISTORY-ENDPOINTS：GET /tasks/history?role=poster|acceptor
- [x] T2-FLT-HISTORY-UI：history_page 與 review_dialog
- **狀態**：✅ 完成 - 任務歷史查看與快捷評價功能已完整實作

#### 後端 API 實作詳情 ✅
- **任務歷史 API** (`backend/api/tasks/history.php`)：
  - 支援 `role` 參數：`poster`（發布者）或 `acceptor`（接受者）
  - 完整的分頁支援：`page`, `per_page` 參數
  - 雙向評價狀態檢查：已評價/未評價/可評價標記
  - 任務詳細資訊：標題、描述、獎勵點數、狀態、參與者資訊
  - 統計資訊：總任務數、未評價數量、分頁資訊
  - JWT 認證與權限檢查

- **評價提交 API** (`backend/api/tasks/reviews_submit.php`)：
  - 完整重構：從舊版多維評價改為單一 1-5 星評價
  - 雙向評價支援：發布者評價接受者、接受者評價發布者
  - 嚴格權限檢查：任務狀態、用戶角色、重複評價防護
  - 操作日誌記錄：記錄評價提交到 `user_activity_logs`
  - 資料庫完整性：使用現有 `task_ratings` 表結構

#### 前端 UI 實作詳情 ✅
- **API 服務層** (`lib/services/api/review_api.dart`)：
  - `TaskHistoryApi.getTaskHistory()`：獲取任務歷史列表
  - `ReviewApi.submitReview()`：提交任務評價
  - `ReviewApi.getReview()`：獲取任務評價
  - 完整的錯誤處理與網路異常處理

- **評價對話框** (`lib/widgets/review_dialog.dart`)：
  - **ReviewDialog**：完整的評價提交對話框
    - 5星評分系統（Poor/Fair/Good/Very Good/Excellent）
    - 可選評論輸入（最多200字）
    - 任務與被評價者資訊顯示
    - 載入狀態與錯誤處理
    - 成功提交後自動刷新父組件
  - **QuickReviewButton**：快捷評價按鈕
    - 條件式顯示（僅未評價任務）
    - 一鍵開啟評價對話框
    - 評價完成後回調通知

- **任務歷史頁面** (`lib/account/pages/task_history_page.dart`)：
  - **雙標籤介面**：Posted（發布的）/ Accepted（接受的）
  - **完整功能列表**：
    - 下拉刷新與分頁載入
    - 未評價任務統計提示
    - 任務卡片詳細資訊展示
    - 狀態標籤與顏色編碼
    - 相對時間顯示（X天前/小時前）
  - **智能評價按鈕**：
    - 僅在可評價任務顯示 Review 按鈕
    - 已評價任務顯示 "Reviewed" 標記
    - 點擊開啟評價對話框
    - 評價完成後即時刷新列表

#### 技術實現特色 ✅
**資料庫整合**：
- 複雜 SQL 查詢：多表 JOIN（tasks, task_applications, task_statuses, users, task_ratings）
- 雙向評價邏輯：區分發布者評價接受者 vs 接受者評價發布者
- 評價狀態計算：`has_reviewed_*`, `can_review`, `received_rating`
- 分頁與統計：高效的 COUNT 查詢與分頁計算

**用戶體驗優化**：
- **即時反饋**：評價提交後立即更新 UI 狀態
- **智能提示**：未評價任務數量統計與醒目提示
- **載入狀態**：完整的載入指示器與錯誤重試
- **空狀態處理**：友好的空列表提示與引導

**評價系統設計**：
- **簡化評分**：從複雜多維評價簡化為直觀 1-5 星
- **防重複評價**：資料庫層級唯一約束防護
- **權限控制**：嚴格檢查任務狀態與用戶角色
- **審計追蹤**：完整的操作日誌記錄

**前端架構優化**：
- **狀態管理**：本地狀態與 API 資料同步
- **組件複用**：評價對話框與快捷按鈕組件化
- **錯誤處理**：統一的異常處理與用戶提示
- **性能優化**：分頁載入減少記憶體佔用

### 順序9：用戶帳號設定模組 ✅
**目標**：完整的用戶帳號管理功能
- [x] T1-BE-CHANGE-PASSWORD：POST /account/change-password（驗舊密碼、強度）
- [x] T2-BE-REQUEST-RESET：POST /account/request-password-reset（寄送驗證連結）
- [x] T3-BE-RESET-PASSWORD：POST /account/reset-password（驗 token 重設）
- [x] T4-BE-DELETE-ACCOUNT：POST /account/delete（軟刪除，檢查活躍任務）
- [x] T5-FLT-ACCOUNT-SETTINGS：設定頁：改密碼/重設/停權/刪帳/恢復 UI
- [x] T6-FLT-PASSWORD-FORMS：密碼相關表單與驗證
- **狀態**：✅ 完成 - 用戶帳號設定模組已完整實作，安全性校驗完整

#### 後端 API 實作詳情 ✅
- **密碼變更 API** (`backend/api/account/change-password.php`)：
  - JWT 認證與用戶身份驗證
  - 當前密碼驗證：使用 `password_verify()` 檢查
  - 密碼強度檢查：最少8字元、包含大小寫字母和數字
  - 防重複密碼：檢查新密碼不得與當前密碼相同
  - 操作日誌記錄：記錄到 `user_activity_logs` 表
  - 安全性：密碼使用 `PASSWORD_DEFAULT` 雜湊演算法

- **密碼重設請求 API** (`backend/api/account/request-password-reset.php`)：
  - 郵件地址驗證與用戶存在性檢查
  - 安全性考量：即使用戶不存在也返回成功訊息
  - Token 生成：使用 `bin2hex(random_bytes(32))` 產生64字元安全 token
  - 過期機制：1小時後自動過期
  - 防重複請求：自動清理舊的未過期請求
  - 郵件發送：HTML 格式重設連結，包含過期提醒
  - 整合現有表結構：使用 `email_verification_tokens` 表的 `password_reset` 類型

- **密碼重設確認 API** (`backend/api/account/reset-password.php`)：
  - Token 驗證：檢查 token 有效性、過期時間、使用狀態
  - 雙重驗證：同時驗證 token 和 email 匹配
  - 密碼強度檢查：與變更密碼相同的安全要求
  - 一次性使用：重設成功後立即標記 token 為已使用
  - 資料庫交易：確保密碼更新和 token 標記的原子性
  - 防重複密碼：檢查新密碼不得與當前密碼相同

- **帳號刪除 API** (`backend/api/account/delete.php`)：
  - 密碼確認：要求輸入當前密碼驗證身份
  - 刪除原因記錄：強制要求提供刪除原因
  - 活躍任務檢查：防止有進行中任務時刪除帳號
  - 活躍聊天檢查：防止有活躍聊天室時刪除帳號
  - 權限檢查：被管理員停權的帳號需聯繫客服刪除
  - 軟刪除機制：設置 `permission = -4`, `status = 'self_deleted'`
  - 資料匿名化：清除敏感資料（email、phone、avatar）
  - 完整日誌：記錄刪除原因和操作詳情

#### 前端 UI 實作詳情 ✅
- **密碼 API 服務** (`lib/services/api/password_api.dart`)：
  - `changePassword()`：密碼變更 API 呼叫
  - `requestPasswordReset()`：密碼重設請求
  - `resetPassword()`：密碼重設確認
  - `deleteAccount()`：帳號刪除
  - 統一的錯誤處理與網路異常處理

- **密碼變更組件** (`lib/account/pages/change_password.dart`)：
  - **兩階段驗證流程**：先輸入當前和新密碼，再確認新密碼
  - **即時驗證**：欄位完整性檢查和密碼匹配驗證
  - **載入狀態**：API 呼叫期間顯示載入指示器
  - **錯誤處理**：友好的錯誤訊息顯示
  - **成功回饋**：密碼變更成功後顯示 SnackBar 並關閉編輯模式

- **密碼重設頁面** (`lib/auth/pages/reset_password_page.dart`)：
  - **URL 參數驗證**：檢查 token 和 email 參數完整性
  - **密碼強度提示**：清楚顯示密碼要求（8字元、大小寫、數字）
  - **密碼可見性切換**：新密碼和確認密碼的顯示/隱藏切換
  - **即時驗證**：密碼匹配檢查和強度驗證
  - **自動跳轉**：重設成功後自動跳轉到登入頁面
  - **錯誤處理**：Token 無效時顯示錯誤並跳轉

- **忘記密碼頁面** (`lib/auth/pages/forgot_password_page.dart`)：
  - **Email 驗證**：即時 email 格式驗證
  - **雙狀態 UI**：發送前的輸入狀態和發送後的確認狀態
  - **成功反饋**：發送成功後顯示確認訊息和 email 地址
  - **重新發送**：提供重新發送功能
  - **使用提示**：包含檢查垃圾郵件、過期時間等提醒

- **安全設定頁面** (`lib/account/pages/security_page.dart`)：
  - **整合現有功能**：保留原有的帳號停用/啟用功能
  - **危險區域**：明確標示帳號刪除為危險操作
  - **刪除確認對話框**：
    - 密碼確認輸入
    - 刪除原因必填
    - 警告訊息顯示
    - 載入狀態處理
  - **完整流程**：刪除成功後清除本地資料並跳轉登入

#### 技術實現特色 ✅
**安全性設計**：
- **密碼強度要求**：8字元以上、包含大小寫字母和數字
- **防暴力破解**：密碼重設 token 1小時過期
- **一次性使用**：重設 token 使用後立即失效
- **身份驗證**：所有敏感操作都需要密碼確認
- **操作審計**：完整的操作日誌記錄

**用戶體驗優化**：
- **分階段操作**：密碼變更採用兩階段確認流程
- **即時反饋**：表單驗證和 API 回應的即時顯示
- **載入狀態**：所有 API 呼叫都有載入指示器
- **錯誤處理**：友好的錯誤訊息和恢復建議
- **成功引導**：操作成功後的明確下一步指引

**資料庫整合**：
- **現有表結構**：充分利用 `email_verification_tokens` 表
- **軟刪除機制**：保留資料完整性的同時實現帳號刪除
- **交易安全**：關鍵操作使用資料庫交易確保一致性
- **日誌完整性**：所有操作都記錄到 `user_activity_logs`

**前端架構優化**：
- **組件複用**：密碼輸入組件的可見性切換功能
- **狀態管理**：本地狀態與 API 資料的同步
- **路由整合**：密碼重設流程與現有路由系統整合
- **錯誤邊界**：完善的異常處理和用戶提示

### 順序10：聊天功能增強 ✅
**目標**：實作聊天室滑動工具列與動作矩陣
- [x] T1-FLT-POST-SWIPE：/chat POST 分頁滑動工具列（Slidable/Dismissible + 可擴充動作列）
- [x] T2-BE-POST-ACTIONS：補齊 Read/Delete/Reject 相關 API
- [x] T3-FLT-ACTION-BAR-MATRIX：1v1 聊天室 Action Bar（狀態×角色矩陣）
- [x] T4-BE-ACTION-ENDPOINTS：補齊任務狀態變更端點與 task_logs 紀錄
- **狀態**：✅ 完成 - 聊天功能增強已完整實作，滑動操作與動態 Action Bar 系統完成

#### 前端滑動工具列實作詳情 ✅
- **應徵者卡片滑動功能** (`lib/chat/widgets/posted_tasks_widget.dart`)：
  - **Slidable 整合**：使用 `flutter_slidable` 套件實現左右滑動操作
  - **動態動作配置**：根據應徵狀態（applied/accepted/rejected）動態顯示不同的滑動動作
  - **狀態條件邏輯**：
    - `applied`：Read（標記已讀）、Reject（拒絕）、Delete（刪除）
    - `accepted`：Read（標記已讀）、Cancel（取消接受）
    - `rejected`：Read（標記已讀）、Delete（刪除）
    - `其他狀態`：僅 Read（標記已讀）
  - **確認對話框**：破壞性操作（拒絕、刪除）需要用戶確認
  - **即時反饋**：操作完成後顯示 SnackBar 並自動刷新數據
  - **錯誤處理**：API 失敗時顯示錯誤訊息

- **滑動動作實作方法**：
  - `_markAsRead()`：標記聊天室為已讀，清除未讀數
  - `_rejectApplication()`：調用 TaskService 拒絕應徵
  - `_deleteApplication()`：調用 TaskService 刪除應徵
  - `_cancelAcceptance()`：取消已接受的應徵，恢復為 applied 狀態
  - `_showConfirmDialog()`：通用確認對話框
  - `_refreshApplications()`：刷新應徵數據

#### 後端 API 實作詳情 ✅
- **應徵狀態更新 API** (`backend/api/tasks/applications/update-status.php`)：
  - **JWT 認證**：驗證用戶身份和權限
  - **權限檢查**：只有任務創建者可以更新應徵狀態
  - **狀態驗證**：支援 applied/accepted/rejected/cancelled 狀態
  - **自動拒絕邏輯**：接受一個應徵時自動拒絕同任務的其他應徵
  - **資料庫交易**：確保狀態更新的原子性
  - **操作日誌**：記錄所有狀態變更到 `user_activity_logs`
  - **防重複操作**：檢查當前狀態避免重複更新

- **應徵刪除 API** (`backend/api/tasks/applications/delete.php`)：
  - **軟刪除機制**：設置 `deleted_at` 而非真正刪除記錄
  - **狀態限制**：不能刪除已接受的應徵，需先拒絕
  - **權限驗證**：只有任務創建者可以刪除應徵
  - **完整日誌**：記錄刪除操作的詳細信息
  - **錯誤處理**：友好的錯誤訊息和狀態碼

#### 動態 Action Bar 系統實作詳情 ✅
- **Action Bar 配置管理器** (`lib/chat/utils/action_bar_config.dart`)：
  - **ActionBarAction 類**：定義動作的屬性（ID、標籤、圖標、回調、顏色等）
  - **狀態和角色枚舉**：TaskStatus 和 UserRole 枚舉定義
  - **動作配置矩陣**：根據任務狀態和用戶角色的組合返回可用動作
  - **確認機制**：支援需要確認的破壞性操作
  - **狀態解析器**：字符串狀態轉換為枚舉的工具方法
  - **視覺配置**：狀態顏色和圖標的統一管理

- **動態 Action Bar 組件** (`lib/chat/widgets/dynamic_action_bar.dart`)：
  - **DynamicActionBar 組件**：主要的動態 Action Bar 實現
  - **狀態顯示條**：顯示任務狀態、進度條和狀態圖標
  - **玻璃效果背景**：使用 BackdropFilter 實現毛玻璃效果
  - **動作按鈕渲染**：根據配置動態生成操作按鈕
  - **確認對話框**：自動處理需要確認的操作
  - **ActionBarBuilder**：提供更靈活的構建方式

- **聊天詳情頁面整合** (`lib/chat/pages/chat_detail_page.dart`)：
  - **新舊系統並存**：保留舊的 Action Bar 實作作為向後相容
  - **動作回調映射**：`_buildActionCallbacks()` 方法映射動作到具體實現
  - **狀態解析**：使用 ActionBarConfigManager 解析任務狀態和用戶角色
  - **TaskStatus 命名衝突解決**：使用 alias 避免與現有 TaskStatus 類衝突
  - **統一的動作處理**：所有動作都通過統一的處理方法實現

#### 技術實現特色 ✅
**可擴充架構**：
- **配置驅動**：動作配置與 UI 渲染分離，易於擴展新狀態和動作
- **組件化設計**：Action Bar 組件可在不同頁面重用
- **狀態矩陣**：清晰的狀態×角色矩陣，易於理解和維護
- **Builder 模式**：ActionBarBuilder 提供靈活的動作組合方式

**用戶體驗優化**：
- **滑動手勢**：直觀的左右滑動操作，符合移動端使用習慣
- **視覺反饋**：不同動作使用不同顏色和圖標區分
- **確認機制**：破壞性操作需要二次確認，防止誤操作
- **即時更新**：操作完成後立即更新 UI 狀態

**安全性設計**：
- **權限驗證**：所有後端 API 都有完整的權限檢查
- **狀態驗證**：防止非法的狀態轉換
- **操作審計**：完整的操作日誌記錄
- **資料庫交易**：確保數據一致性

**性能優化**：
- **軟刪除**：保留數據完整性的同時實現邏輯刪除
- **批量操作**：接受應徵時自動處理其他相關應徵
- **快取刷新**：操作完成後智能刷新相關數據
- **錯誤邊界**：完善的異常處理和用戶提示

### 順序11：任務自動完成與申訴流程 ✅
**目標**：實作任務自動完成機制與申訴處理
- [x] T1-BE-AUTO-COMPLETE：排程：pending confirmation > 7 天 → completed（寫 task_logs）
- [x] T2-FLT-DISPUTE-ACTION：Action Bar 觸發 → 轉 dispute 並停止倒數
- [x] T3-LAR-ADMIN-DISPUTE-REVIEW：後台審核（含圖片）
- **狀態**：✅ 完成 - 自動完成機制與申訴流程已完整實作

#### 自動完成機制實作詳情 ✅
- **Cron 排程腳本** (`backend/cron/auto_complete_tasks.php`)：
  - 檢查 pending confirmation 狀態超過7天的任務
  - 自動標記為 completed 狀態
  - 記錄到 `task_logs` 表進行審計追蹤
  - 為創建者和接受者記錄活動日誌
  - 完整的錯誤處理與日誌記錄
  - 自動清理舊日誌檔案（保留3個月）

- **排程設定指南** (`backend/cron/README.md`)：
  - 詳細的 cron job 設定說明
  - 本地開發環境配置（MAMP）
  - 監控與維護指引
  - 故障排除步驟

#### 申訴功能實作詳情 ✅
- **後端 API** (`backend/api/tasks/dispute.php`)：
  - 支援任務申訴提交
  - 6種申訴原因：未完成、品質不佳、溝通問題、付款爭議、安全顧慮、其他
  - 嚴格權限檢查：只有任務參與者可申訴
  - 狀態驗證：僅允許 pending_confirmation 和 completed 狀態申訴
  - 防重複申訴機制
  - 自動停止自動完成倒數（任務狀態改為 dispute）
  - 完整的操作日誌記錄

- **前端 API 服務** (`lib/services/api/dispute_api.dart`)：
  - `submitDispute()`: 提交申訴
  - `getDisputeHistory()`: 獲取申訴歷史
  - `getDisputeDetail()`: 獲取申訴詳情
  - 統一的錯誤處理與調試日誌

- **申訴對話框組件** (`lib/widgets/dispute_dialog.dart`)：
  - `DisputeDialog`: 完整的申訴提交對話框
  - 申訴原因下拉選擇
  - 詳細說明文字輸入（最多500字）
  - 即時表單驗證
  - 載入狀態與錯誤處理
  - `QuickDisputeButton`: 快捷申訴按鈕組件

#### Action Bar 整合 ✅
- **動態配置更新** (`lib/chat/utils/action_bar_config.dart`)：
  - 在 `pending_confirmation` 狀態添加申訴按鈕
  - 在 `completed` 狀態添加申訴按鈕
  - 創建者和參與者都可使用申訴功能
  - 申訴按鈕標記為破壞性操作（紅色警告）

- **聊天詳情頁面整合** (`lib/chat/pages/chat_detail_page.dart`)：
  - 添加 `_handleDispute()` 方法
  - 整合申訴對話框
  - 申訴成功後自動刷新任務資料
  - 統一的動作回調系統

#### 管理員後台申訴審核 ✅
- **後端控制器** (`admin/app/Http/Controllers/Admin/DisputeController.php`)：
  - `index()`: 申訴列表查詢（分頁、篩選、搜尋）
  - `show()`: 申訴詳情查看（含任務和狀態日誌）
  - `updateStatus()`: 申訴狀態更新（open/in_review/resolved/rejected）
  - `batchAction()`: 批量申訴處理
  - 完整的權限檢查與活動日誌記錄

- **API 路由配置** (`admin/routes/api.php`)：
  - `/disputes` - 申訴列表（需要 disputes.list 權限）
  - `/disputes/{id}` - 申訴詳情（需要 disputes.view 權限）
  - `/disputes/{id}/status` - 狀態更新（需要 disputes.edit 權限）
  - `/disputes/batch-action` - 批量操作（需要 disputes.edit 權限）

- **權限系統更新** (`admin/app/Models/AdminRole.php`)：
  - 所有角色添加申訴查看權限
  - 管理員以上角色添加申訴編輯權限
  - 超級管理員擁有完整申訴管理權限

#### 技術實現特色 ✅
**自動化機制**：
- 基於 cron 的可靠排程系統
- 完整的錯誤處理與重試機制
- 詳細的操作審計追蹤
- 自動日誌清理與維護

**申訴流程**：
- 用戶友好的申訴介面
- 嚴格的權限與狀態檢查
- 防重複申訴保護機制
- 自動停止倒數計時

**管理員審核**：
- 豐富的篩選與搜尋功能
- 批量操作提升效率
- 完整的申訴歷史追蹤
- 狀態變更審計日誌

**安全性設計**：
- JWT 認證保護所有 API
- 細粒度權限控制
- 完整的操作日誌記錄
- 資料庫交易確保一致性


✅ 已修復的錯誤
DisputeController.php 中的 auth()->id() 錯誤
將 auth()->id() 改為 $request->user()->id
這是 Laravel 中獲取當前認證用戶 ID 的正確方法
chat_detail_page.dart 中的 _loadTaskData 方法錯誤
將 _loadTaskData() 改為 _initializeChat()
使用現有的方法來刷新聊天室資料
dispute_api.dart 中的 const 錯誤
將 static const String _baseUrl 改為 static String get _baseUrl
因為 AppConfig.apiBaseUrl 不是編譯時常量
修復了 if 語句缺少大括號的問題

### 順序12：客服事件系統 ✅
**目標**：實作客服事件紀錄與管理系統
- [x] T9-BE-SUPPORT-EVENTS：實作客服事件紀錄後端 API
- [x] T10-FE-SUPPORT-EVENTS：實作客服事件前端介面
- **狀態**：✅ 完成 - 客服事件系統已完整實作，包含後端 API、前端介面與 WebSocket 即時更新

#### 後端 API 實作詳情 ✅
- **客服事件管理 API** (`backend/api/support/events.php`)：
  - 支援 POST（新增事件）、GET（查詢事件列表）、PATCH（更新狀態）
  - 嚴格限制僅能綁定 `chat_rooms.type = 'support'`
  - 完整的權限檢查與錯誤處理
  - 自動記錄狀態變更到 `support_event_logs`
  - 整合 WebSocket 事件觸發

- **客戶結案 API** (`backend/api/support/events_close.php`)：
  - 支援客戶主動結案並提交評分
  - 可選評分（1-5星）與評論功能
  - 狀態更新為 `closed_by_customer`
  - 完整的操作日誌記錄

- **評分提交 API** (`backend/api/support/events_rating.php`)：
  - 獨立的評分提交端點
  - 支援事後評分功能
  - 評分與評論資料完整性驗證

#### 前端介面實作詳情 ✅
- **API 服務層** (`lib/services/api/support_event_api.dart`)：
  - `getEvents()`: 獲取聊天室內事件列表
  - `closeEvent()`: 客戶結案事件
  - `submitRating()`: 提交事件評分
  - 完整的錯誤處理與網路異常處理
  - 新增 PATCH 方法到 HttpClientService

- **整合現有頁面** (`lib/account/pages/issue_status_page.dart`)：
  - **向後相容設計**：保留原有靜態 issue status 顯示
  - **動態客服事件系統**：當提供 `chatRoomId` 時啟用新功能
  - **完整功能列表**：
    - 事件狀態篩選（All/Open/In Progress/Resolved/Closed）
    - 下拉刷新與即時更新
    - 事件詳情對話框（含狀態歷程）
    - 客戶結案功能（評分與評論）
    - 事後評分功能
  - **智能 UI 狀態**：
    - 載入狀態指示器
    - 錯誤處理與重試機制
    - 空狀態友好提示

- **事件卡片組件** (`lib/widgets/support_event_card.dart`)：
  - 事件基本資訊展示
  - 狀態標籤與顏色編碼
  - 動態操作按鈕（查看詳情、結案、評分）
  - 響應式設計

#### WebSocket 即時更新 ✅
- **客服事件處理器** (`backend/socket/support_events.js`)：
  - 支援事件：`event:new`、`event:update`、`event:closed`、`event:rated`
  - JWT 認證與聊天室權限檢查
  - 完整的資料庫整合與事件詳情查詢
  - 廣播機制確保即時更新

- **Socket 伺服器整合** (`backend/socket/server.js`)：
  - 整合客服事件處理器到主要 Socket 伺服器
  - 統一的連線管理與認證機制
  - 健康檢查端點包含客服事件狀態

#### 技術實現特色 ✅
**資料庫整合**：
- 充分利用現有 `support_events` 和 `support_event_logs` 表
- 嚴格的聊天室類型檢查（僅支援 `type='support'`）
- 完整的狀態變更審計追蹤
- 客戶與管理員角色自動識別

**用戶體驗優化**：
- **向後相容**：現有功能不受影響
- **漸進增強**：新功能無縫整合到現有介面
- **即時反饋**：WebSocket 確保狀態即時同步
- **離線友好**：API 失敗不影響基本功能顯示

**安全性設計**：
- JWT 認證保護所有 API 端點
- 聊天室權限檢查
- 客戶僅能操作自己相關的事件
- WebSocket 觸發採用非阻塞方式，失敗不影響主功能

**架構優化**：
- 模組化設計，易於擴展
- 統一的錯誤處理機制
- 完整的日誌記錄
- 高效的資料庫查詢與索引利用

### 順序13：任務功能增強 ✅
**目標**：新增任務收藏與檢舉功能
- [x] T11-BE-TASK-FEATURES：實作任務收藏與檢舉後端 API
- [x] T12-FE-TASK-FEATURES：實作任務收藏與檢舉前端介面
- **狀態**：✅ 完成 - 任務收藏與檢舉功能已完整實作，包含後端 API 與前端 UI

#### 後端 API 實作詳情 ✅
- **任務收藏 API** (`backend/api/tasks/favorites.php`)：
  - 支援 GET（獲取收藏列表）、POST（收藏任務）、DELETE（取消收藏）
  - 完整的分頁支援與任務詳細資訊查詢
  - 防止收藏自己的任務與重複收藏檢查
  - 自動記錄收藏操作到 `task_logs`
  - 利用現有 `task_favorites` 表的唯一約束 `uq_user_task`

- **任務檢舉 API** (`backend/api/tasks/reports.php`)：
  - 支援 POST（提交檢舉）、GET（查詢檢舉歷史）
  - 5種檢舉原因：不當內容、垃圾訊息、虛假任務、危險活動、其他
  - 管理員與檢舉者權限區分（管理員可查看所有檢舉）
  - 防止檢舉自己的任務與重複檢舉保護
  - 完整的檢舉狀態管理（pending/reviewed/resolved/dismissed）
  - 詳細的操作日誌記錄

#### 前端介面實作詳情 ✅
- **API 服務層**：
  - `TaskFavoritesApi` (`lib/services/api/task_favorites_api.dart`)：
    - `getFavorites()`: 分頁獲取收藏列表
    - `addFavorite()` / `removeFavorite()`: 收藏操作
    - `isFavorited()`: 檢查收藏狀態
  - `TaskReportsApi` (`lib/services/api/task_reports_api.dart`)：
    - `submitReport()`: 提交檢舉
    - `getReports()`: 獲取檢舉歷史
    - 檢舉原因與狀態的本地化顯示

- **收藏功能組件**：
  - `TaskFavoriteButton` (`lib/widgets/task_favorite_button.dart`)：
    - 圖標版本與文字版本收藏按鈕
    - 動畫效果與載入狀態指示
    - 即時狀態更新與錯誤處理
    - 可自訂顏色與大小
  - `FavoritesPage` (`lib/account/pages/favorites_page.dart`)：
    - 完整的收藏列表頁面
    - 無限滾動載入與下拉刷新
    - 任務詳細資訊展示（標題、描述、獎勵、狀態、創建者）
    - 空狀態與錯誤狀態處理

- **檢舉功能組件**：
  - `TaskReportDialog` (`lib/widgets/task_report_dialog.dart`)：
    - 完整的檢舉提交對話框
    - 檢舉原因下拉選擇與詳細說明輸入
    - 表單驗證與提交狀態管理
    - 安全提示與使用說明
  - `TaskReportButton`: 快捷檢舉按鈕組件

#### 技術實現特色 ✅
**資料庫整合**：
- 充分利用現有 `task_favorites` 和 `task_reports` 表結構
- 唯一約束防止重複收藏 (`uq_user_task`)
- 完整的外鍵關聯與索引優化
- 管理員權限檢查與操作審計

**用戶體驗優化**：
- **即時反饋**：收藏狀態即時更新，操作成功提示
- **防誤操作**：收藏自己任務、重複操作的友好提示
- **載入狀態**：所有 API 操作都有載入指示器
- **錯誤處理**：網路錯誤、權限錯誤的統一處理
- **無限滾動**：收藏列表支援分頁載入

**安全性設計**：
- JWT 認證保護所有 API 端點
- 權限檢查：不能收藏/檢舉自己的任務
- 重複操作防護：防止重複收藏與檢舉
- 輸入驗證：檢舉原因與說明的完整性檢查
- 操作審計：完整的操作日誌記錄

**架構優化**：
- 模組化 API 服務層，易於測試與維護
- 可複用的 UI 組件，支援自訂樣式
- 統一的錯誤處理與狀態管理
- 響應式設計，適配不同螢幕尺寸

#### 任務大廳整合 ✅
**現有收藏邏輯分析**：
- 使用 `Set<String> _favoriteTaskIds` 管理收藏狀態
- 書籤圖標 (`Icons.bookmark` / `Icons.bookmark_border`) 顯示收藏狀態
- 位置在任務卡片右下角，使用 `Colors.amber` 顏色區分
- 原有的 `_loadFavorites()` 和 `_toggleFavorite()` 方法

**整合實作**：
- **API 整合**：導入 `TaskFavoritesApi` 服務
- **載入邏輯**：`_loadFavorites()` 改為從 API 載入收藏列表
- **切換邏輯**：`_toggleFavorite()` 改為非同步 API 調用
- **錯誤處理**：API 失敗時恢復原狀態並顯示錯誤訊息
- **用戶反饋**：操作成功/失敗的 SnackBar 提示
- **狀態同步**：本地狀態與後端 API 即時同步

**向後相容**：
- 保持原有的 UI 設計與交互方式
- 維持現有的圖標樣式與位置
- 保留原有的狀態管理邏輯
- 無縫整合新的 API 功能

### 順序14：安全加固 ✅
**目標**：基本安全機制實作
- [x] T-SH-CORS：設定 CORS 白名單（dev/stage/prod 分環境）
- [x] T-SH-RATE-LIMIT：登入/註冊/檢舉/傳訊 API 節流（如 5 req/min）
- [x] T-SH-JWT-BASICS：JWT 期限/Refresh Token 基本輪替；黑名單撤銷端點
- **狀態**：✅ 完成 - 安全加固機制已完整實作，包含 CORS 白名單、API 節流與 JWT 輪替

#### CORS 跨域安全實作詳情 ✅
- **環境分離配置** (`backend/config/cors.php`)：
  - 開發環境：允許 localhost 多端口與 ngrok
  - 測試環境：允許測試域名與本地開發
  - 生產環境：僅允許正式域名
  - 萬用字元支援：支援 `*.ngrok-free.app` 等動態域名
  - 安全標頭：X-Content-Type-Options, X-Frame-Options, X-XSS-Protection

- **動態來源驗證**：
  - 檢查 HTTP_ORIGIN 標頭
  - 模式匹配支援萬用字元
  - 開發環境寬鬆，生產環境嚴格
  - 預檢請求 (OPTIONS) 正確處理

#### API 節流機制實作詳情 ✅
- **分類節流規則** (`backend/utils/RateLimiter.php`)：
  - 認證端點：5 req/5min（登入、註冊、OAuth）
  - 訊息端點：30 req/1min（聊天、上傳）
  - 檢舉端點：3 req/1hour（檢舉、客服）
  - 一般端點：100 req/1min（其他 API）

- **智能識別機制**：
  - 優先使用用戶 ID（已認證用戶）
  - 備用 IP 地址識別
  - 支援代理伺服器 X-Forwarded-For
  - 檔案儲存實作（可擴展至 Redis）

- **節流回應標頭**：
  - X-RateLimit-Remaining：剩餘請求數
  - X-RateLimit-Reset：重置時間
  - Retry-After：重試等待時間
  - 429 狀態碼與詳細錯誤訊息

#### JWT 安全輪替實作詳情 ✅
- **Token 對機制** (`backend/utils/JWTManager.php`)：
  - Access Token：1小時短期，用於 API 認證
  - Refresh Token：7天長期，用於 Token 刷新
  - JWT ID (jti)：唯一識別符，支援黑名單

- **黑名單系統**：
  - 個別 Token 撤銷：`blacklistToken()`
  - 用戶全域撤銷：`revokeAllUserTokens()`
  - 撤銷檢查：`isTokenBlacklisted()`, `isUserTokenRevoked()`
  - 自動過期清理：避免儲存空間無限增長

- **API 端點**：
  - `/api/auth/refresh-token.php`：刷新 Access Token
  - `/api/auth/revoke-token.php`：撤銷 Token 或全部 Token
  - 完整的錯誤處理與日誌記錄

#### 統一中介層系統 ✅
- **API 中介層** (`backend/middleware/api_middleware.php`)：
  - 統一 CORS 處理
  - 自動節流檢查
  - 安全標頭設定
  - JWT 驗證與權限檢查
  - 全域錯誤處理

- **安全標頭配置**：
  - Content-Security-Policy（生產環境）
  - Strict-Transport-Security（HTTPS）
  - Referrer-Policy: strict-origin-when-cross-origin
  - 防止 MIME 嗅探與點擊劫持

#### 維護與監控 ✅
- **自動清理腳本** (`backend/cron/cleanup_security.php`)：
  - 清理過期節流記錄
  - 清理過期 JWT 黑名單
  - 清理舊日誌檔案（30天保留）
  - 大檔案自動壓縮
  - 詳細執行日誌

- **日誌系統**：
  - 節流超限記錄：`rate_limit.log`
  - API 錯誤記錄：`api_errors.log`
  - 清理作業記錄：`cleanup_security.log`
  - 結構化 JSON 格式，便於分析

#### 技術實現特色 ✅
**環境適應性**：
- 開發/測試/生產環境差異化配置
- 環境變數驅動的安全策略
- 動態 CORS 來源驗證
- 條件式安全標頭設定

**性能優化**：
- 檔案儲存節流計數（可擴展至 Redis）
- 過期記錄自動清理
- 高效的黑名單檢查
- 最小化記憶體佔用

**安全防護**：
- 防暴力攻擊節流
- JWT 黑名單防重放攻擊
- 用戶全域 Token 撤銷
- 完整的操作審計追蹤

**可維護性**：
- 模組化設計，易於擴展
- 統一的中介層處理
- 詳細的錯誤日誌
- 自動化維護腳本

### 順序15：API 合約與錯誤碼 ✅
**目標**：統一 API 回應格式與錯誤碼
- [x] T-AC-ERROR-SPEC：定義統一格式 {success, code, message, data, traceId}
- [x] T-AC-PAGINATION：統一分頁參數與回傳欄位
- [x] T-AC-OPENAPI-MIN：以 OpenAPI 標註關鍵端點
- **狀態**：✅ 完成 - API 合約與錯誤碼系統已完整實作，包含統一回應格式、分頁系統與 OpenAPI 文檔

#### 統一錯誤碼系統實作詳情 ✅
- **錯誤碼定義** (`backend/utils/ErrorCodes.php`)：
  - 54 個標準化錯誤碼，按功能分類（1000-9999）
  - 成功碼：SUCCESS
  - 通用錯誤：E1001-E1999（請求格式、參數等）
  - 認證錯誤：E2001-E2999（登入、權限、Token 等）
  - 用戶錯誤：E3001-E3999（用戶管理、驗證等）
  - 任務錯誤：E4001-E4999（任務狀態、申請等）
  - 聊天錯誤：E5001-E5999（聊天室、訊息等）
  - 節流錯誤：E6001-E6999（API 限制等）
  - 業務邏輯：E7001-E7999（衝突、配額等）
  - 第三方服務：E8001-E8999（OAuth、支付等）
  - 資料驗證：E9001-E9999（格式、範圍等）

- **自動 HTTP 狀態碼映射**：
  - 每個錯誤碼自動對應正確的 HTTP 狀態碼
  - 支援多語言錯誤訊息
  - 錯誤碼分類與查詢功能

#### 請求追蹤系統實作詳情 ✅
- **TraceId 生成器** (`backend/utils/TraceId.php`)：
  - 20 字元十六進制格式：timestamp(8) + random(8) + process_id(4)
  - 支援客戶端傳遞的 TraceId（X-Trace-Id, X-Request-Id 等）
  - TraceId 解析與驗證功能
  - 自動添加到回應標頭

- **請求追蹤功能**：
  - 請求開始/結束自動記錄
  - 執行時間統計
  - 結構化日誌記錄（trace.log）
  - 自動清理舊日誌（7天保留）

#### 統一回應格式實作詳情 ✅
- **標準回應結構** (`backend/utils/Response.php`)：
  ```json
  {
    "success": true|false,
    "code": "SUCCESS|E1001|E2001|...",
    "message": "操作描述",
    "data": {...},
    "traceId": "68A8362D5712F07814D26",
    "timestamp": "2025-01-11T17:30:00+08:00",
    "server_time": 1641897000
  }
  ```

- **便捷方法**：
  - `Response::success()`: 成功回應
  - `Response::error()`: 錯誤回應（使用錯誤碼）
  - `Response::unauthorized()`: 未授權
  - `Response::forbidden()`: 權限不足
  - `Response::notFound()`: 資源不存在
  - `Response::validationError()`: 驗證錯誤
  - `Response::badRequest()`: 請求錯誤
  - `Response::serverError()`: 伺服器錯誤

#### 分頁系統實作詳情 ✅
- **分頁工具類** (`backend/utils/Pagination.php`)：
  - 統一分頁參數：`page`, `per_page`（支援別名 `p`, `limit`, `size`）
  - 預設配置：每頁 20 項，最大 100 項
  - 自動參數驗證與錯誤處理
  - 支援 GET 和 POST 請求參數

- **分頁資訊格式**：
  ```json
  {
    "current_page": 1,
    "per_page": 20,
    "total": 100,
    "total_pages": 5,
    "has_next_page": true,
    "has_previous_page": false,
    "next_page": 2,
    "previous_page": null,
    "from": 1,
    "to": 20
  }
  ```

- **SQL 輔助功能**：
  - `getSqlLimit()`: MySQL LIMIT 子句
  - `getSqlOffset()`: PostgreSQL OFFSET 子句
  - 分頁連結生成
  - 分頁描述文字（中英文）

#### OpenAPI 文檔系統實作詳情 ✅
- **OpenAPI 規範** (`docs/api/openapi.yaml`)：
  - OpenAPI 3.0.3 標準
  - 完整的認證端點定義
  - 統一的錯誤回應模式
  - 分頁參數與回應格式
  - 資料模型定義（User, Task, ChatRoom 等）

- **API 文檔生成器** (`backend/utils/ApiDocGenerator.php`)：
  - 自動生成 HTML 文檔
  - Postman Collection 生成
  - 錯誤碼參考表
  - 互動式 API 範例
  - 節流限制說明

- **生成的文檔**：
  - `docs/api/index.html`: 完整的 HTML 文檔（10.88 KB）
  - `docs/api/postman_collection.json`: Postman 集合（3.89 KB）
  - 自動化生成腳本：`backend/scripts/generate_api_docs.php`

#### 技術實現特色 ✅
**標準化設計**：
- 統一的錯誤碼命名規範
- 一致的回應格式結構
- 標準化的分頁參數
- OpenAPI 3.0.3 規範遵循

**開發者體驗**：
- 詳細的錯誤訊息與解決建議
- 完整的 API 文檔與範例
- Postman Collection 快速測試
- TraceId 追蹤問題定位

**維護性**：
- 模組化的錯誤碼管理
- 自動化文檔生成
- 向後相容的 API 設計
- 完整的日誌記錄

**性能優化**：
- 高效的分頁查詢
- 最小化回應大小
- 自動清理機制
- 結構化日誌格式

### 順序16：監控與觀測性 ✅
**目標**：集中化日誌與前端錯誤上報
- [x] T-OB-LOGGING：後端加 traceId；記錄 4xx/5xx 與主要商務事件
- [x] T-OB-FLT-ERROR：Flutter 全域錯誤上報 hook（含裝置/版本）
- [x] T-OB-ALERT-MIN：簡單警示：API 5xx 連續 N 次觸發通知
- **驗收**：✅ 可由 traceId 追查錯誤；5xx 連續觸發能通知

### 順序17：資料治理 ✅
**目標**：避免型別不一致與資料遺失的最小治理
- [x] T-DG-ID-AUDIT：列出所有 id/FK 型別差異清單與準備遷移計畫
- [x] T-DG-BACKUP：建立每日/每 6 小時 DB 備份腳本與還原演練步驟
- [x] T-DG-CONSTRAINT：檢查並補強 FK 約束與索引最佳化
- **驗收**：✅ 有型別差異清單與備份/還原 SOP；FK 約束和索引最佳化完成

### 順序18：媒體處理 ✅
**目標**：聊天室/申訴圖片的上傳規範與風險控管
- [x] T-MP-LIMITS：檔案大小/類型白名單與壓縮策略
- [x] T-MP-STORAGE：S3/本機儲存切換與清理排程
- [x] T-MP-SCAN：掃毒/惡意檔阻擋流程（hook）
- **驗收**：✅ 超限與非法檔案被阻擋；存放與清理規則生效

**實施記錄**：
- 創建 `MediaValidator` 類，支援檔案大小/類型白名單驗證與圖片壓縮
- 實現 `StorageManager` 類，支援本機/S3 儲存切換與清理排程
- 開發 `SecurityScanner` 類，提供檔案安全掃描與威脅檢測
- 建立 `media_files` 資料表儲存媒體檔案元資料
- 創建媒體上傳/服務 API 端點 (`upload.php`, `serve.php`, `scan.php`)
- 實施儲存清理 cron 作業 (`storage_cleanup.php`)
- 完成功能測試驗證，確保檔案驗證、壓縮、掃描和儲存功能正常運作

### 順序19：通知策略 ✅
**目標**：推播/站內/Email 的規則與頻率，使用者可控
- [x] T-NP-MATRIX：事件→通知矩陣（任務/聊天/客服/審核）
- [x] T-NP-SETTINGS：使用者通知偏好設定 UI
- **驗收**：✅ 事件→通知矩陣落地；前端可調整偏好

**實施記錄**：
- 建立完整的通知系統資料庫架構（6個核心資料表）
- 創建 `NotificationManager` 類別，實現事件→通知矩陣邏輯
- 開發通知模板系統，支援多種通知類型（Push、站內、Email、簡訊）
- 實現使用者通知偏好管理，包含全域設定、靜音時段、分類偏好
- 建立通知佇列處理機制，支援延遲發送、重試、統計
- 創建通知處理 cron 作業，自動處理佇列和清理過期資料
- 開發完整的通知 API 端點（觸發、偏好設定、站內通知管理）
- 實現 Flutter 通知偏好設定頁面，提供直觀的使用者介面
- 完成核心邏輯測試，驗證模板渲染、條件檢查、靜音時段等功能

### 順序20：離線模式與斷線恢復 ✅
**目標**：聊天室與列表的快取與重連策略
- [x] T-OR-CACHE：列表快取與失效策略（最新 N 筆）
- [x] T-OR-RETRY：Socket 重連與退避（backoff）
- **驗收**：✅ 列表離線可瀏覽；斷線可自動重連與退避

**實施記錄**：
- 建立完整的快取管理系統（`CacheManager`），支援任務、聊天、通知、使用者資料快取
- 創建離線狀態管理器（`OfflineManager`），監控網路狀態並管理離線動作佇列
- 實現離線感知 API 基類（`OfflineAwareApi`），提供自動快取和離線支援
- 開發離線感知任務 API（`OfflineTaskApi`），支援任務相關的離線操作
- 建立 Socket 重連管理器（`SocketReconnectManager`），實現指數退避重連策略
- 創建離線感知聊天服務（`OfflineChatService`），支援訊息快取和離線發送
- 實現完整的測試頁面，驗證離線快取和 Socket 重連功能
- 支援最新 N 筆資料快取，自動過期清理，網路恢復後自動同步

### 順序21：無障礙與空/錯誤狀態 ✅
**目標**：字級、對比度、螢幕閱讀、可鍵盤操作
- [x] T-A11Y-FONT：動態字級與可讀性檢查
- [x] T-A11Y-ARIA：Semantics 標註與可鍵盤操作
- [x] T-EES-TEMPLATES：空/錯頁模板組件（可參數化圖示/文案/CTA）
- **驗收**：✅ 主要流程具可讀性與空/錯態一致樣板

**實施記錄**：
- 建立動態字級管理服務（`FontSizeService`），支援字級縮放、可讀性檢查和對比度計算
- 創建無障礙文字組件（`AccessibleText`, `AccessibleHeading`, `AccessibleButton`），自動應用字級縮放
- 實現語義標註服務（`SemanticsService`），提供統一的無障礙語義標註
- 開發鍵盤導航輔助類（`KeyboardNavigationHelper`），支援焦點管理和鍵盤操作
- 建立空狀態模板組件（`EmptyStateWidget`），提供可參數化的空狀態 UI
- 創建錯誤狀態模板組件（`ErrorStateWidget`），支援多種錯誤類型和狀態碼
- 實現載入狀態組件（`LoadingStateWidget`, `SkeletonLoader`），提供統一的載入體驗
- 支援 WCAG AA 標準對比度檢查，動態字級調整，語義化標註

## 🎯 當前執行狀態

**目前位置**：順序5 - 管理員後台詳細頁面開發
**已完成**：順序1-4 (OAuth流程、管理員後台基礎架構)
**進行中**：Vue.js 管理介面詳細功能實作
**下一步**：完成管理員後台後，進入順序6帳號安全與保護模組

## 順序3完成狀況 ✅

### 1. OAuth 流程整合完成

#### 修改檔案
- **`lib/auth/services/third_party_auth_service.dart`**
  - 重構：Web 版 Google/Facebook/Apple 登入使用真實 OAuth 流程
  - 移除：模擬資料，改為直接重定向到 OAuth 授權頁面
  - 新增：統一的 OAuth 流程啟動機制
  - 更新：`_sendUserDataToBackend` 方法支援新的 API 端點
  - 整合：所有第三方登入提供商使用相同的 token 化流程

- **`lib/auth/pages/auth_callback_page.dart`**
  - 新增：支援新用戶 OAuth token 處理邏輯
  - 新增：`_redirectToSignupPage` 方法處理新用戶重定向
  - 修改：`_handleLoginSuccess` 方法區分新用戶與現有用戶
  - 優化：UI 顯示邏輯，正確處理不同的用戶狀態
  - 整合：完整的錯誤處理與用戶體驗

### 2. 技術實現細節

#### 統一 OAuth 流程
1. **Web 版第三方登入**：
   - Google：重定向至 `accounts.google.com/o/oauth2/v2/auth`
   - Facebook：重定向至 `www.facebook.com/v18.0/dialog/oauth`
   - Apple：重定向至 `appleid.apple.com/auth/authorize`
   - 所有提供商都重定向到對應的 `{provider}-callback.php`

2. **回調處理**：
   - 新用戶：後端返回 `oauth_token` → 前端重定向 `/signup?oauth_token=...`
   - 現有用戶：後端返回 `token` + `user_data` → 前端重定向 `/home`
   - 錯誤：統一錯誤處理與用戶提示

3. **移動版兼容**：
   - 保留原有的 Google Sign-In SDK 整合
   - 使用統一的後端 API 端點
   - 支援 iOS/Android 平台特定功能

#### 用戶體驗優化
- 統一的載入狀態與進度指示
- 清晰的錯誤訊息與重試機制
- 新用戶與現有用戶的差異化處理
- 自動重定向與手動操作選項

### 3. 測試結果

#### 語法檢查 ✅
```bash
flutter analyze lib/auth/services/third_party_auth_service.dart lib/auth/pages/auth_callback_page.dart
# 結果：40 issues found (均為 info/warning，無錯誤)
```

#### 流程驗證 ✅
- [x] Google Web OAuth 流程：正確生成授權 URL 並啟動流程
- [x] Facebook Web OAuth 流程：正確配置並支援回調
- [x] Apple Web OAuth 流程：正確配置並支援回調
- [x] 回調頁面處理：正確區分新用戶與現有用戶
- [x] 錯誤處理：統一的錯誤提示與重試機制
- [x] 移動版兼容：保持原有功能不受影響

### 4. 完整流程整合
- [x] 前端 OAuth 啟動：三大提供商統一流程
- [x] 後端回調處理：token 化流程完整實現
- [x] 前端回調處理：新舊用戶正確分流
- [x] 註冊流程整合：OAuth token 預填與註冊
- [x] 錯誤處理機制：端對端錯誤處理與用戶體驗

## 順序2完成狀況 ✅

### 1. 前端 OAuth 註冊完成

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：`_handleOAuthRegistration()` 使用新的 token 化流程
  - 新增：從 URL 參數 `oauth_token` 獲取 token 並調用 API
  - 新增：`_getSchoolValue()` 輔助方法處理學校資料
  - 新增：`_showTokenExpiredDialog()` 處理 token 過期情況
  - 修改：`_handleSubmit()` 正確判斷 OAuth vs 傳統註冊流程
  - 整合：完整的錯誤處理與用戶提示機制

#### 後端 API 更新
- **`backend/api/auth/register-oauth.php`**
  - 修改：從 session 方式改為 token 化流程
  - 新增：接收 `oauth_token` 參數並從 `oauth_temp_users` 表消費
  - 新增：交易式處理確保資料一致性
  - 新增：token 消費後自動刪除，確保一次性使用
  - 保留：完整的錯誤處理與日誌記錄

### 2. 技術實現細節

#### OAuth 註冊流程
1. **前端接收 token**：從 URL 參數 `?oauth_token=xxx` 獲取
2. **API 調用**：POST `/auth/register-oauth.php` 傳遞 token 與表單資料
3. **後端處理**：
   - 驗證 token 有效性與過期時間
   - 從 `oauth_temp_users` 獲取 OAuth 資料
   - 建立 `users` 與 `user_identities` 記錄
   - 刪除臨時 token（消費）
   - 生成 JWT 並返回
4. **前端處理**：保存登入資訊並導向 `/signup/student-id`

#### 錯誤處理機制
- Token 過期/無效：顯示專用對話框建議重新登入
- API 錯誤：顯示具體錯誤訊息
- 網路錯誤：顯示通用錯誤提示
- 表單驗證：保持原有驗證邏輯

### 3. 測試結果

#### API 測試 ✅
```bash
# 無效 token 測試
curl -X POST -H 'Content-Type: application/json' \
  -d '{"oauth_token":"INVALID_TOKEN","name":"Test User"}' \
  http://localhost:8888/here4help/backend/api/auth/register-oauth.php
# 結果：{"success":false,"message":"OAuth token expired or invalid"}
```

#### 語法檢查 ✅
```bash
php -l backend/api/auth/register-oauth.php
# 結果：No syntax errors detected

flutter analyze lib/auth/pages/signup_page.dart
# 結果：45 issues found (均為 info/warning，無錯誤)
```

### 4. 完整流程驗證
- [x] 新用戶 OAuth 流程：Google 登入 → 暫存 → 重定向 `/signup?oauth_token=...`
- [x] 前端 token 預填：自動讀取 token 並調用 API 獲取預填資料
- [x] 註冊 API 調用：token 化 API 正確處理表單提交
- [x] 錯誤處理：token 過期、API 錯誤、網路錯誤均有適當處理
- [x] 成功流程：註冊成功後正確導向 `/signup/student-id`

## 順序1完成狀況 ✅

### 1. 後端部分

#### 新增檔案
- **`backend/api/auth/oauth-temp.php`**
  - 功能：處理臨時 OAuth 用戶資料的查詢與消費
  - 支援 `peek=true` 參數進行資料查看而不刪除
  - 驗證 token 有效性與過期時間
  - 返回用戶基本資料（provider, email, name, avatar_url）

#### 修改檔案
- **`backend/api/auth/google-callback.php`**
  - 新增：新用戶資料存入 `oauth_temp_users` 表
  - 新增：生成一次性 `tempToken` 與 `expired_at` 時間戳
  - 修改：新用戶重定向至 `/signup?oauth_token=...`
  - 保留：現有用戶仍獲得 JWT 並重定向至 `/home`

### 2. 前端部分

#### 新增檔案
- **`lib/services/api/oauth_api.dart`**
  - 功能：OAuth 臨時資料 API 服務
  - 方法：`fetchTempUser(String token)` 查詢臨時用戶資料
  - 整合：使用 `AppConfig.apiBaseUrl` 與 debug 日誌

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：支援 URL 參數 `?token=` 的 OAuth 預填
  - 新增：`_loadThirdPartyData()` 中優先處理 token 參數
  - 保留：原有的 `widget.oauthData` 與 SharedPreferences 備用機制
  - 整合：`OAuthApi.fetchTempUser()` 調用

### 3. 資料庫結構
- **`oauth_temp_users` 表** (已建立)
  - 欄位：provider, provider_user_id, email, name, avatar_url, raw_data, token, expired_at
  - 用途：暫存第三方登入的新用戶資料
  - 過期機制：1小時自動過期

## 技術實現細節

### OAuth 流程
1. **用戶點擊 Google 登入**
2. **後端處理**：
   - 檢查是否為新用戶
   - 新用戶：存入 `oauth_temp_users`，生成 tempToken
   - 現有用戶：直接登入並獲得 JWT
3. **前端處理**：
   - 新用戶：重定向至 `/signup?oauth_token=xxx`
   - 現有用戶：重定向至 `/home`
4. **註冊頁面**：
   - 自動讀取 URL 中的 `oauth_token`
   - 調用 `OAuthApi.fetchTempUser()` 獲取預填資料
   - 預填表單欄位（name, email, avatar_url）

### 錯誤處理
- Token 過期或無效時返回 404
- API 調用失敗時記錄 debug 日誌
- 預填失敗時不影響正常註冊流程

## 測試結果

### 語法檢查 ✅
```bash
flutter analyze
# 結果：633 issues found (均為 info/warning，無錯誤)
# 新檔案無語法錯誤
```

### 後端檢查 ✅
```bash
php -l backend/api/auth/google-callback.php
# 結果：No syntax errors detected

php -l backend/api/auth/oauth-temp.php  
# 結果：No syntax errors detected
```

### 功能驗證
- [x] 新用戶 OAuth 流程
- [x] 現有用戶 OAuth 流程  
- [x] Token 預填機制
- [x] 錯誤處理機制
- [x] 過期時間驗證

## 下一步計劃

### 順序3：OAuth 流程整合 (PR3) ✅
- [x] 更新 `third_party_auth_service.dart` 整合新的回調流程
- [x] 確保 Facebook 和 Apple 登入使用相同的 token 化流程
- [x] 更新 `auth_callback_page.dart` 處理新的重定向邏輯
- [x] 端對端測試完整 OAuth 流程並優化用戶體驗

### 順序4：管理員後台基礎 (PR4)
- [ ] 建立 Laravel 管理員後台基礎架構
- [ ] 設定 RBAC 與稽核資料表
- [ ] 實作管理員登入與權限控制
- [ ] 建立路由樹與中介層

### 順序5：用戶帳戶安全 (PR5)
- [ ] 實作密碼修改功能
- [ ] 建立重設密碼驗證信機制
- [ ] 用戶自主停權與帳號刪除功能
- [ ] 停權恢復流程

## 注意事項

### 環境配置
- 確保 `FRONTEND_URL` 設定為 `http://localhost:3000`
- 確保 Google Cloud Console 已配置正確的 redirect URI
- 確保 `oauth_temp_users` 表已建立

### 開發建議
- 使用 debug 模式查看詳細日誌
- 測試時注意 token 的 1 小時過期限制
- 建議在生產環境中調整過期時間

## 相關文件
- `docs/優先執行/高階專案分析指令.md`
- `docs/PLAN.md`
- `docs/plan.json`
- `docs/優先執行/專案修改指南（Chief Architect 版）.md`

---

**更新記錄**
- 2025-01-11: 完成順序1，建立進度追蹤文件
- 2025-01-11: 完成順序2，OAuth 註冊流程整合完成
- 2025-01-11: 完成順序3，OAuth 流程整合與第三方登入統一化
- 2025-08-22: 完成順序16，監控與觀測性系統實作完成
- 2025-08-22: 完成順序17，資料治理系統實作完成

---

## 順序16：監控與觀測性 - 實作記錄 ✅

### 實作日期
2025-08-22

### 實作內容

#### 1. T-OB-LOGGING：後端加 traceId；記錄 4xx/5xx 與主要商務事件

**新增檔案：**
- `backend/utils/Logger.php` - 集中化日誌系統
- `backend/middleware/logging_middleware.php` - 自動日誌記錄中間件
- `backend/cron/monitoring_alerts.php` - 監控警報 Cron 腳本

**修改檔案：**
- `backend/utils/Response.php` - 整合日誌記錄到 API 響應
- `backend/utils/TraceId.php` - 公開 `getExecutionTime` 方法

#### 2. T-OB-FLT-ERROR：Flutter 全域錯誤上報 hook（含裝置/版本）

**新增檔案：**
- `lib/services/error_reporting_service.dart` - Flutter 全域錯誤上報服務
- `backend/api/system/error-reports.php` - 錯誤報告接收 API

**修改檔案：**
- `lib/main.dart` - 初始化錯誤報告服務
- `pubspec.yaml` - 添加 `device_info_plus` 和 `package_info_plus` 依賴

#### 3. T-OB-ALERT-MIN：簡單警示：API 5xx 連續 N 次觸發通知

**新增檔案：**
- `backend/utils/AlertManager.php` - 警報管理系統
- `backend/test/monitoring_test.php` - 監控系統測試腳本

### 驗收測試結果

**測試腳本執行：**
```bash
php backend/test/monitoring_test.php
```

**測試結果：**
- ✅ 基本日誌記錄功能
- ✅ HTTP 響應日誌記錄  
- ✅ 警報系統（info, warning, critical）
- ✅ 連續 5xx 錯誤檢測（觸發閾值：5次）
- ✅ 高錯誤率檢測（觸發閾值：5%）
- ✅ TraceId 追蹤功能
- ✅ 警報持久化和解決機制

**最終統計：**
- 測試完成後活躍警報數：4個
- 測試完成後日誌條目數：53條
- 測試完成後錯誤數：27個

### 部署建議

**Cron 設定：**
```bash
# 每5分鐘檢查一次監控警報
*/5 * * * * php /path/to/backend/cron/monitoring_alerts.php
```

**日誌檔案位置：**
- `backend/storage/logs/` - 主要日誌目錄
- `backend/storage/alerts/` - 警報存儲目錄

**關鍵配置：**
- 錯誤率閾值：5%
- 連續 5xx 錯誤閾值：5次
- 日誌保留期：30天
- Flutter 錯誤報告批量間隔：5分鐘

---

## 順序17：資料治理 - 實作記錄 ✅

### 實作日期
2025-08-22

### 實作內容

#### 1. T-DG-ID-AUDIT：列出所有 id/FK 型別差異清單與準備遷移計畫

**新增檔案：**
- `backend/database/id_audit.php` - ID/FK 類型差異審計工具

**功能特點：**
- 檢查主鍵類型一致性
- 檢查外鍵類型匹配
- 檢查常見 ID 欄位類型
- 生成遷移計劃和 SQL 腳本
- 輸出 JSON 和 Markdown 報告

**審計結果：**
- 總問題數：52個
- 高優先級：0個
- 中優先級：27個（主要是主鍵不是 BIGINT 類型）
- 低優先級：25個（VARCHAR 外鍵類型）

#### 2. T-DG-BACKUP：建立每日/每 6 小時 DB 備份腳本與還原演練步驟

**新增檔案：**
- `backend/database/backup_manager.php` - 備份管理器
- `backend/database/restore_manager.php` - 還原管理器
- `backend/cron/database_backup.php` - 備份排程腳本
- `backend/database/backup_test.php` - 備份系統測試腳本

**備份功能：**
- 完整備份（每日凌晨1點）
- 增量備份（每6小時：6、12、18點）
- 結構備份（每週日凌晨3點）
- 自動壓縮和清理（保留30天）
- 備份日誌記錄和統計

**還原功能：**
- 還原演練（使用測試資料庫）
- 實際還原（含安全確認機制）
- 緊急備份創建
- 還原驗證和報告生成

**測試結果：**
- ✅ 備份目錄結構創建
- ✅ 備份檔案管理
- ✅ 日誌記錄系統
- ✅ 統計和清理功能
- ✅ 還原演練準備
- ✅ 報告生成

#### 3. T-DG-CONSTRAINT：檢查並補強 FK 約束與索引最佳化

**新增檔案：**
- `backend/database/constraint_optimizer.php` - 約束與索引最佳化工具

**分析功能：**
- 外鍵約束檢查（發現64個約束）
- 缺失索引檢查
- 重複索引檢查（發現8個重複索引）
- 未使用索引分析（發現82個可疑索引）
- 查詢性能分析

**最佳化建議：**
1. 🟡 添加缺失外鍵約束：`tasks.status_id -> task_statuses.id`
2. 🟢 為常用查詢欄位添加索引：`task_applications.status`
3. 🟢 刪除8個重複索引以節省空間
4. 🟢 檢查82個可能未使用的索引

**性能問題發現：**
- 11個表格索引過大（比例 > 2:1）
- 主要是小表格的索引開銷相對較大

### 技術架構

#### 備份系統架構
```
BackupManager (備份管理器)
├── 完整備份 (mysqldump --single-transaction)
├── 增量備份 (基於修改時間)
├── 結構備份 (--no-data)
├── 自動壓縮 (gzip)
└── 清理機制 (30天保留)

RestoreManager (還原管理器)
├── 還原演練 (測試資料庫)
├── 實際還原 (安全確認)
├── 緊急備份 (還原前備份)
└── 驗證機制 (表格和記錄數檢查)

Cron 排程
├── 每日 01:00 完整備份
├── 每6小時 增量備份
├── 每週日 03:00 結構備份
└── 每日 02:00 清理舊檔案
```

#### 審計系統架構
```
IdAudit (ID 類型審計)
├── 主鍵類型檢查
├── 外鍵一致性檢查
├── ID 欄位類型統計
└── 遷移計劃生成

ConstraintOptimizer (約束最佳化)
├── 外鍵約束分析
├── 索引效率分析
├── 重複索引檢測
├── 性能問題識別
└── 最佳化建議生成
```

### 驗收測試結果

#### ID 審計測試
```bash
php backend/database/id_audit.php
```
- ✅ 主鍵類型分析完成
- ✅ 外鍵一致性檢查完成
- ✅ 遷移計劃生成完成
- ✅ JSON 和 Markdown 報告生成

#### 備份系統測試
```bash
php backend/database/backup_test.php
```
- ✅ 備份目錄結構：6個子目錄創建
- ✅ 備份檔案創建：3個測試檔案
- ✅ 日誌記錄：3條備份記錄
- ✅ 統計功能：7個備份檔案統計
- ✅ 清理功能：2個舊檔案清理
- ✅ 還原準備：7個可用備份
- ✅ 報告生成：演練報告創建

#### 約束最佳化測試
```bash
php backend/database/constraint_optimizer.php
```
- ✅ 外鍵約束：64個約束檢查
- ✅ 索引分析：所有外鍵欄位已有索引
- ✅ 重複索引：8個重複索引發現
- ✅ 性能分析：11個表格索引過大問題
- ✅ 最佳化計劃：10個建議生成

### 部署建議

#### Cron 設定
```bash
# 每日完整備份
0 1 * * * php /path/to/backend/cron/database_backup.php

# 每6小時增量備份
0 6,12,18 * * * php /path/to/backend/cron/database_backup.php

# 每週結構備份
0 3 * * 0 php /path/to/backend/cron/database_backup.php

# 每日清理
0 2 * * * php /path/to/backend/cron/database_backup.php
```

#### 檔案位置
- 備份檔案：`backend/database/backups/`
- 審計報告：`backend/database/reports/`
- 日誌檔案：`backend/database/backups/logs/`

#### 關鍵配置
- 備份保留期：30天
- 壓縮：啟用 gzip
- 還原演練：每週執行
- 審計檢查：每月執行

### 監控指標

#### 備份監控
- 備份成功率：100%
- 備份檔案大小趨勢
- 備份耗時監控
- 存儲空間使用率

#### 資料庫健康度
- 外鍵約束完整性
- 索引效率比例
- 查詢性能趨勢
- 資料類型一致性

### 維護建議

1. **定期審計**：每季度執行 ID 類型和約束審計
2. **備份驗證**：每月執行還原演練
3. **性能監控**：監控索引使用率和查詢性能
4. **空間管理**：定期清理舊備份和日誌
5. **文件更新**：保持 SOP 文件最新狀態
