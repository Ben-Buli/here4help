# 高階專案指南進度追蹤表

## 專案概述
- **專案名稱**: Here4Help Flutter App
- **當前階段**: 順序1 - OAuth 流程閉環完成
- **完成日期**: 2025-01-11
- **主要目標**: 實現第三方登入首次導引註冊的完整流程

## 順序1完成狀況 ✅

## 順序2完成狀況 ✅

## 順序3完成狀況 ✅

## 順序4完成狀況 🚧 (進行中)

### 1. Laravel 管理員後台基礎架構 ✅

#### 新增檔案與目錄
- **`admin/`** - Laravel 12.25.0 專案根目錄
  - 完整的 Laravel 框架結構
  - 配置 MySQL 資料庫連線（使用 MAMP socket）
  - 整合 Laravel Sanctum 用於 API 認證

#### 資料庫結構設計 ✅
- **`admin_roles`** - 管理員角色表
  - 支援角色名稱、顯示名稱、描述
  - JSON 格式儲存權限陣列
  - 角色啟用/停用狀態控制

- **`admins`** - 管理員用戶表（適配現有結構）
  - 使用現有欄位：`username`, `full_name`, `email`
  - 關聯 `admin_roles` 表進行 RBAC
  - 登入狀態與安全控制

- **`admin_role_permissions`** - 角色權限詳細表
  - 資源類型與動作權限控制
  - 支援條件式權限設定

- **`admin_activity_logs`** - 管理員活動日誌
  - 完整的操作審計追蹤
  - 記錄修改前後值與 IP 位址

- **`admin_login_logs`** - 登入日誌
  - 成功/失敗登入記錄
  - 安全監控與異常檢測

#### Eloquent Models ✅
- **`Admin`** - 繼承 `Authenticatable`，支援 Sanctum 認證
  - 完整的關聯設定（role, activityLogs, loginLogs）
  - 權限檢查方法 `hasPermission()`
  - 狀態檢查方法 `isActive()`

- **`AdminRole`** - 角色管理 Model
  - JSON 權限陣列處理
  - 權限新增/移除方法
  - 角色與管理員關聯

#### 資料初始化 ✅
- **預設角色建立**：
  - `super_admin`：超級管理員（完整權限）
  - `admin`：一般管理員（大部分權限）
  - `moderator`：版主（內容審核權限）

- **預設管理員帳號**：
  - Super Admin: `admin@here4help.com` / `admin123`
  - Test Admin: `test@here4help.com` / `test123`

### 2. 技術實現細節

#### 權限系統設計
- **資源導向權限**：`{resource}.{action}` 格式
  - `users.list`, `users.view`, `users.edit`, `users.delete`
  - `tasks.list`, `tasks.view`, `tasks.edit`, `tasks.delete`
  - `services.list`, `services.view`, `services.edit`, `services.delete`
  - `points.list`, `points.view`, `points.edit`, `points.delete`
  - `admins.list`, `admins.create`, `admins.edit`, `admins.delete`
  - `logs.view`

#### 資料庫整合
- **共用資料庫**：與現有 PHP 後端使用相同的 MySQL 資料庫
- **MAMP 整合**：使用 socket 連接 `/Applications/MAMP/tmp/mysql/mysql.sock`
- **遷移管理**：適配現有表結構，避免衝突

#### Laravel 配置
- **Sanctum 認證**：API token 認證機制
- **環境配置**：`.env` 檔案配置資料庫與應用設定
- **版本**：Laravel 12.25.0 最新穩定版

### 3. 測試結果

#### 基礎功能驗證 ✅
```bash
# Laravel 版本確認
php artisan --version
# 結果：Laravel Framework 12.25.0

# 資料庫連線測試
php artisan migrate:status
# 結果：成功連接並顯示遷移狀態

# Seeder 執行測試
php artisan db:seed --class=AdminSeeder
# 結果：成功建立角色與管理員帳號
```

#### 資料驗證 ✅
- [x] 管理員角色建立：3 個預設角色
- [x] 管理員帳號建立：2 個測試帳號
- [x] 權限系統配置：完整的 RBAC 權限陣列
- [x] 資料表關聯：正確的外鍵與索引設定

### 4. 管理員認證與權限控制系統 ✅

#### 新增檔案
- **`app/Http/Controllers/Admin/AuthController.php`** - 管理員認證控制器
  - 完整的登入/登出/刷新 API
  - 密碼驗證與帳號狀態檢查
  - 登入失敗次數限制與帳號鎖定機制
  - 完整的登入日誌記錄

- **`app/Http/Middleware/AdminMiddleware.php`** - RBAC 權限中介層
  - 管理員身份驗證檢查
  - 細粒度權限控制（支援 `resource.action` 格式）
  - 自動活動日誌記錄
  - 未授權訪問嘗試追蹤

- **`app/Models/AdminLoginLog.php`** - 登入日誌 Model
  - 適配現有資料表結構
  - 登入成功/失敗狀態追蹤
  - IP 位址與 User Agent 記錄

- **`app/Models/AdminActivityLog.php`** - 活動日誌 Model
  - 管理員操作審計追蹤
  - 資源類型與動作分類
  - 中文顯示名稱支援

#### API 路由設計 ✅
- **認證端點**：
  - `POST /api/admin/login` - 管理員登入
  - `POST /api/admin/logout` - 管理員登出
  - `GET /api/admin/me` - 獲取當前管理員資訊
  - `POST /api/admin/refresh` - 刷新 token

- **權限保護端點**：
  - `GET /api/admin/users` - 用戶管理（需要 `users.list`）
  - `GET /api/admin/tasks` - 任務管理（需要 `tasks.list`）
  - `GET /api/admin/admins` - 管理員管理（需要 `admins.list`）
  - `GET /api/admin/logs/*` - 日誌查看（需要 `logs.view`）

#### 技術實現亮點
- **Laravel Sanctum 整合**：API token 認證機制
- **適配現有資料庫**：兼容現有表結構，避免資料遷移
- **靜態權限配置**：在 Model 中定義角色權限，靈活且易維護
- **安全機制**：登入失敗鎖定、IP 追蹤、活動審計
- **中介層設計**：支援參數化權限檢查，可擴展性強

#### 測試結果 ✅
```bash
# 登入測試
Login Response Status: 200
Success: YES
Admin: Admin Buli
Permissions: 27 permissions
Token: 1|M9kSv4FZRHJKyvQETK...
Login logged: YES

# 權限中介層測試
No permission required: 200
users.list permission: 200
nonexistent permission: 403
```

### 5. 管理員後台 API 路由與控制器系統 ✅

#### 新增控制器
- **`app/Http/Controllers/Admin/UserController.php`** - 用戶管理控制器
  - 用戶列表查詢（分頁、篩選、搜尋、排序）
  - 用戶詳細資訊（包含統計資料和最近活動）
  - 用戶狀態更新（active, banned, inactive 等）
  - 用戶權限等級調整（-4 到 99 的權限系統）
  - 批量操作（批量啟用、停用、封鎖）
  - 完整的操作審計日誌

- **`app/Http/Controllers/Admin/TaskController.php`** - 任務管理控制器
  - 任務列表查詢（支援狀態、創建者、參與者篩選）
  - 任務詳細資訊（包含申請記錄和聊天統計）
  - 任務狀態管理（Open, In Progress, Completed 等）
  - 管理員操作記錄與審計追蹤

- **`app/Http/Controllers/Admin/LogController.php`** - 日誌管理控制器
  - 管理員活動日誌查看（支援多維度篩選）
  - 管理員登入日誌追蹤（成功/失敗/IP 統計）
  - 系統統計資訊（今日/本週/本月/本年）
  - 豐富的統計圖表資料

#### 完整 API 路由架構 ✅
```
POST   /api/admin/login                    # 管理員登入
POST   /api/admin/logout                   # 管理員登出
GET    /api/admin/me                       # 獲取當前管理員資訊
POST   /api/admin/refresh                  # 刷新 token

# 用戶管理 (需要 users.* 權限)
GET    /api/admin/users                    # 用戶列表
GET    /api/admin/users/{id}               # 用戶詳情
PATCH  /api/admin/users/{id}/status        # 更新用戶狀態
PATCH  /api/admin/users/{id}/permission    # 更新用戶權限
POST   /api/admin/users/batch-action       # 批量操作

# 任務管理 (需要 tasks.* 權限)
GET    /api/admin/tasks                    # 任務列表
GET    /api/admin/tasks/{id}               # 任務詳情
PATCH  /api/admin/tasks/{id}/status        # 更新任務狀態

# 日誌管理 (需要 logs.view 權限)
GET    /api/admin/logs/activity            # 活動日誌
GET    /api/admin/logs/login               # 登入日誌
GET    /api/admin/logs/stats               # 系統統計

# 系統資訊
GET    /api/admin/dashboard                # 儀表板資料
```

#### 權限控制整合 ✅
- **細粒度權限檢查**：每個 API 端點都有對應的權限要求
- **自動審計日誌**：所有管理員操作都會自動記錄
- **資料庫適配**：完全適配現有資料表結構
- **錯誤處理**：統一的 JSON 錯誤回應格式

#### 測試驗證 ✅
```bash
Testing User API...
Users List: 200          # ✅ 用戶管理 API 正常
Testing Task API...
Tasks List: 200          # ✅ 任務管理 API 正常
Testing Log API...
System Stats: 200        # ✅ 日誌管理 API 正常
All APIs working!        # ✅ 所有 API 端點正常運作
```

#### 功能特色
- **智能分頁**：支援自訂每頁筆數和排序
- **多維篩選**：狀態、權限、時間範圍、關鍵字搜尋
- **統計資訊**：即時統計各種資料指標
- **批量操作**：支援批量用戶狀態管理
- **審計追蹤**：完整的操作歷史記錄
- **安全防護**：基於 RBAC 的權限控制

### 6. 下一步計劃

#### 順序5：前端管理介面開發
- [ ] 建立 Vue.js 管理後台專案
- [ ] 實作登入介面與 Token 管理
- [ ] 建立用戶管理頁面
- [ ] 建立任務管理頁面
- [ ] 建立日誌查看頁面
- [ ] 整合圖表與統計視覺化

## 順序3完成狀況 ✅

### 1. OAuth 流程整合完成

#### 修改檔案
- **`lib/auth/services/third_party_auth_service.dart`**
  - 重構：Web 版 Google/Facebook/Apple 登入使用真實 OAuth 流程
  - 移除：模擬資料，改為直接重定向到 OAuth 授權頁面
  - 新增：統一的 OAuth 流程啟動機制
  - 更新：`_sendUserDataToBackend` 方法支援新的 API 端點
  - 整合：所有第三方登入提供商使用相同的 token 化流程

- **`lib/auth/pages/auth_callback_page.dart`**
  - 新增：支援新用戶 OAuth token 處理邏輯
  - 新增：`_redirectToSignupPage` 方法處理新用戶重定向
  - 修改：`_handleLoginSuccess` 方法區分新用戶與現有用戶
  - 優化：UI 顯示邏輯，正確處理不同的用戶狀態
  - 整合：完整的錯誤處理與用戶體驗

### 2. 技術實現細節

#### 統一 OAuth 流程
1. **Web 版第三方登入**：
   - Google：重定向至 `accounts.google.com/o/oauth2/v2/auth`
   - Facebook：重定向至 `www.facebook.com/v18.0/dialog/oauth`
   - Apple：重定向至 `appleid.apple.com/auth/authorize`
   - 所有提供商都重定向到對應的 `{provider}-callback.php`

2. **回調處理**：
   - 新用戶：後端返回 `oauth_token` → 前端重定向 `/signup?oauth_token=...`
   - 現有用戶：後端返回 `token` + `user_data` → 前端重定向 `/home`
   - 錯誤：統一錯誤處理與用戶提示

3. **移動版兼容**：
   - 保留原有的 Google Sign-In SDK 整合
   - 使用統一的後端 API 端點
   - 支援 iOS/Android 平台特定功能

#### 用戶體驗優化
- 統一的載入狀態與進度指示
- 清晰的錯誤訊息與重試機制
- 新用戶與現有用戶的差異化處理
- 自動重定向與手動操作選項

### 3. 測試結果

#### 語法檢查 ✅
```bash
flutter analyze lib/auth/services/third_party_auth_service.dart lib/auth/pages/auth_callback_page.dart
# 結果：40 issues found (均為 info/warning，無錯誤)
```

#### 流程驗證 ✅
- [x] Google Web OAuth 流程：正確生成授權 URL 並啟動流程
- [x] Facebook Web OAuth 流程：正確配置並支援回調
- [x] Apple Web OAuth 流程：正確配置並支援回調
- [x] 回調頁面處理：正確區分新用戶與現有用戶
- [x] 錯誤處理：統一的錯誤提示與重試機制
- [x] 移動版兼容：保持原有功能不受影響

### 4. 完整流程整合
- [x] 前端 OAuth 啟動：三大提供商統一流程
- [x] 後端回調處理：token 化流程完整實現
- [x] 前端回調處理：新舊用戶正確分流
- [x] 註冊流程整合：OAuth token 預填與註冊
- [x] 錯誤處理機制：端對端錯誤處理與用戶體驗

## 順序2完成狀況 ✅

### 1. 前端 OAuth 註冊完成

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：`_handleOAuthRegistration()` 使用新的 token 化流程
  - 新增：從 URL 參數 `oauth_token` 獲取 token 並調用 API
  - 新增：`_getSchoolValue()` 輔助方法處理學校資料
  - 新增：`_showTokenExpiredDialog()` 處理 token 過期情況
  - 修改：`_handleSubmit()` 正確判斷 OAuth vs 傳統註冊流程
  - 整合：完整的錯誤處理與用戶提示機制

#### 後端 API 更新
- **`backend/api/auth/register-oauth.php`**
  - 修改：從 session 方式改為 token 化流程
  - 新增：接收 `oauth_token` 參數並從 `oauth_temp_users` 表消費
  - 新增：交易式處理確保資料一致性
  - 新增：token 消費後自動刪除，確保一次性使用
  - 保留：完整的錯誤處理與日誌記錄

### 2. 技術實現細節

#### OAuth 註冊流程
1. **前端接收 token**：從 URL 參數 `?oauth_token=xxx` 獲取
2. **API 調用**：POST `/auth/register-oauth.php` 傳遞 token 與表單資料
3. **後端處理**：
   - 驗證 token 有效性與過期時間
   - 從 `oauth_temp_users` 獲取 OAuth 資料
   - 建立 `users` 與 `user_identities` 記錄
   - 刪除臨時 token（消費）
   - 生成 JWT 並返回
4. **前端處理**：保存登入資訊並導向 `/signup/student-id`

#### 錯誤處理機制
- Token 過期/無效：顯示專用對話框建議重新登入
- API 錯誤：顯示具體錯誤訊息
- 網路錯誤：顯示通用錯誤提示
- 表單驗證：保持原有驗證邏輯

### 3. 測試結果

#### API 測試 ✅
```bash
# 無效 token 測試
curl -X POST -H 'Content-Type: application/json' \
  -d '{"oauth_token":"INVALID_TOKEN","name":"Test User"}' \
  http://localhost:8888/here4help/backend/api/auth/register-oauth.php
# 結果：{"success":false,"message":"OAuth token expired or invalid"}
```

#### 語法檢查 ✅
```bash
php -l backend/api/auth/register-oauth.php
# 結果：No syntax errors detected

flutter analyze lib/auth/pages/signup_page.dart
# 結果：45 issues found (均為 info/warning，無錯誤)
```

### 4. 完整流程驗證
- [x] 新用戶 OAuth 流程：Google 登入 → 暫存 → 重定向 `/signup?oauth_token=...`
- [x] 前端 token 預填：自動讀取 token 並調用 API 獲取預填資料
- [x] 註冊 API 調用：token 化 API 正確處理表單提交
- [x] 錯誤處理：token 過期、API 錯誤、網路錯誤均有適當處理
- [x] 成功流程：註冊成功後正確導向 `/signup/student-id`

## 順序1完成狀況 ✅

### 1. 後端部分

#### 新增檔案
- **`backend/api/auth/oauth-temp.php`**
  - 功能：處理臨時 OAuth 用戶資料的查詢與消費
  - 支援 `peek=true` 參數進行資料查看而不刪除
  - 驗證 token 有效性與過期時間
  - 返回用戶基本資料（provider, email, name, avatar_url）

#### 修改檔案
- **`backend/api/auth/google-callback.php`**
  - 新增：新用戶資料存入 `oauth_temp_users` 表
  - 新增：生成一次性 `tempToken` 與 `expired_at` 時間戳
  - 修改：新用戶重定向至 `/signup?oauth_token=...`
  - 保留：現有用戶仍獲得 JWT 並重定向至 `/home`

### 2. 前端部分

#### 新增檔案
- **`lib/services/api/oauth_api.dart`**
  - 功能：OAuth 臨時資料 API 服務
  - 方法：`fetchTempUser(String token)` 查詢臨時用戶資料
  - 整合：使用 `AppConfig.apiBaseUrl` 與 debug 日誌

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：支援 URL 參數 `?token=` 的 OAuth 預填
  - 新增：`_loadThirdPartyData()` 中優先處理 token 參數
  - 保留：原有的 `widget.oauthData` 與 SharedPreferences 備用機制
  - 整合：`OAuthApi.fetchTempUser()` 調用

### 3. 資料庫結構
- **`oauth_temp_users` 表** (已建立)
  - 欄位：provider, provider_user_id, email, name, avatar_url, raw_data, token, expired_at
  - 用途：暫存第三方登入的新用戶資料
  - 過期機制：1小時自動過期

## 技術實現細節

### OAuth 流程
1. **用戶點擊 Google 登入**
2. **後端處理**：
   - 檢查是否為新用戶
   - 新用戶：存入 `oauth_temp_users`，生成 tempToken
   - 現有用戶：直接登入並獲得 JWT
3. **前端處理**：
   - 新用戶：重定向至 `/signup?oauth_token=xxx`
   - 現有用戶：重定向至 `/home`
4. **註冊頁面**：
   - 自動讀取 URL 中的 `oauth_token`
   - 調用 `OAuthApi.fetchTempUser()` 獲取預填資料
   - 預填表單欄位（name, email, avatar_url）

### 錯誤處理
- Token 過期或無效時返回 404
- API 調用失敗時記錄 debug 日誌
- 預填失敗時不影響正常註冊流程

## 測試結果

### 語法檢查 ✅
```bash
flutter analyze
# 結果：633 issues found (均為 info/warning，無錯誤)
# 新檔案無語法錯誤
```

### 後端檢查 ✅
```bash
php -l backend/api/auth/google-callback.php
# 結果：No syntax errors detected

php -l backend/api/auth/oauth-temp.php  
# 結果：No syntax errors detected
```

### 功能驗證
- [x] 新用戶 OAuth 流程
- [x] 現有用戶 OAuth 流程  
- [x] Token 預填機制
- [x] 錯誤處理機制
- [x] 過期時間驗證

## 下一步計劃

### 順序3：OAuth 流程整合 (PR3) ✅
- [x] 更新 `third_party_auth_service.dart` 整合新的回調流程
- [x] 確保 Facebook 和 Apple 登入使用相同的 token 化流程
- [x] 更新 `auth_callback_page.dart` 處理新的重定向邏輯
- [x] 端對端測試完整 OAuth 流程並優化用戶體驗

### 順序4：管理員後台基礎 (PR4)
- [ ] 建立 Laravel 管理員後台基礎架構
- [ ] 設定 RBAC 與稽核資料表
- [ ] 實作管理員登入與權限控制
- [ ] 建立路由樹與中介層

### 順序5：用戶帳戶安全 (PR5)
- [ ] 實作密碼修改功能
- [ ] 建立重設密碼驗證信機制
- [ ] 用戶自主停權與帳號刪除功能
- [ ] 停權恢復流程

## 注意事項

### 環境配置
- 確保 `FRONTEND_URL` 設定為 `http://localhost:3000`
- 確保 Google Cloud Console 已配置正確的 redirect URI
- 確保 `oauth_temp_users` 表已建立

### 開發建議
- 使用 debug 模式查看詳細日誌
- 測試時注意 token 的 1 小時過期限制
- 建議在生產環境中調整過期時間

## 相關文件
- `docs/優先執行/高階專案分析指令.md`
- `docs/PLAN.md`
- `docs/plan.json`
- `docs/優先執行/專案修改指南（Chief Architect 版）.md`

---

**更新記錄**
- 2025-01-11: 完成順序1，建立進度追蹤文件
- 2025-01-11: 完成順序2，OAuth 註冊流程整合完成
- 2025-01-11: 完成順序3，OAuth 流程整合與第三方登入統一化
