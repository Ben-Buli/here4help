# 高階專案指南進度追蹤表

## 專案概述
- **專案名稱**: Here4Help Flutter App
- **當前階段**: 順序1 - OAuth 流程閉環完成
- **完成日期**: 2025-01-11
- **主要目標**: 實現第三方登入首次導引註冊的完整流程

## 順序1完成狀況 ✅

## 順序2完成狀況 ✅

## 順序3完成狀況 ✅

## 順序4完成狀況 🚧 (進行中)

### 1. Laravel 管理員後台基礎架構 ✅

#### 新增檔案與目錄
- **`admin/`** - Laravel 12.25.0 專案根目錄
  - 完整的 Laravel 框架結構
  - 配置 MySQL 資料庫連線（使用 MAMP socket）
  - 整合 Laravel Sanctum 用於 API 認證

#### 資料庫結構設計 ✅
- **`admin_roles`** - 管理員角色表
  - 支援角色名稱、顯示名稱、描述
  - JSON 格式儲存權限陣列
  - 角色啟用/停用狀態控制

- **`admins`** - 管理員用戶表（適配現有結構）
  - 使用現有欄位：`username`, `full_name`, `email`
  - 關聯 `admin_roles` 表進行 RBAC
  - 登入狀態與安全控制

- **`admin_role_permissions`** - 角色權限詳細表
  - 資源類型與動作權限控制
  - 支援條件式權限設定

- **`admin_activity_logs`** - 管理員活動日誌
  - 完整的操作審計追蹤
  - 記錄修改前後值與 IP 位址

- **`admin_login_logs`** - 登入日誌
  - 成功/失敗登入記錄
  - 安全監控與異常檢測

#### Eloquent Models ✅
- **`Admin`** - 繼承 `Authenticatable`，支援 Sanctum 認證
  - 完整的關聯設定（role, activityLogs, loginLogs）
  - 權限檢查方法 `hasPermission()`
  - 狀態檢查方法 `isActive()`

- **`AdminRole`** - 角色管理 Model
  - JSON 權限陣列處理
  - 權限新增/移除方法
  - 角色與管理員關聯

#### 資料初始化 ✅
- **預設角色建立**：
  - `super_admin`：超級管理員（完整權限）
  - `admin`：一般管理員（大部分權限）
  - `moderator`：版主（內容審核權限）

- **預設管理員帳號**：
  - Super Admin: `admin@here4help.com` / `admin123`
  - Test Admin: `test@here4help.com` / `test123`

### 2. 技術實現細節

#### 權限系統設計
- **資源導向權限**：`{resource}.{action}` 格式
  - `users.list`, `users.view`, `users.edit`, `users.delete`
  - `tasks.list`, `tasks.view`, `tasks.edit`, `tasks.delete`
  - `services.list`, `services.view`, `services.edit`, `services.delete`
  - `points.list`, `points.view`, `points.edit`, `points.delete`
  - `admins.list`, `admins.create`, `admins.edit`, `admins.delete`
  - `logs.view`

#### 資料庫整合
- **共用資料庫**：與現有 PHP 後端使用相同的 MySQL 資料庫
- **MAMP 整合**：使用 socket 連接 `/Applications/MAMP/tmp/mysql/mysql.sock`
- **遷移管理**：適配現有表結構，避免衝突

#### Laravel 配置
- **Sanctum 認證**：API token 認證機制
- **環境配置**：`.env` 檔案配置資料庫與應用設定
- **版本**：Laravel 12.25.0 最新穩定版

### 3. 測試結果

#### 基礎功能驗證 ✅
```bash
# Laravel 版本確認
php artisan --version
# 結果：Laravel Framework 12.25.0

# 資料庫連線測試
php artisan migrate:status
# 結果：成功連接並顯示遷移狀態

# Seeder 執行測試
php artisan db:seed --class=AdminSeeder
# 結果：成功建立角色與管理員帳號
```

#### 資料驗證 ✅
- [x] 管理員角色建立：3 個預設角色
- [x] 管理員帳號建立：2 個測試帳號
- [x] 權限系統配置：完整的 RBAC 權限陣列
- [x] 資料表關聯：正確的外鍵與索引設定

### 4. 管理員認證與權限控制系統 ✅

#### 新增檔案
- **`app/Http/Controllers/Admin/AuthController.php`** - 管理員認證控制器
  - 完整的登入/登出/刷新 API
  - 密碼驗證與帳號狀態檢查
  - 登入失敗次數限制與帳號鎖定機制
  - 完整的登入日誌記錄

- **`app/Http/Middleware/AdminMiddleware.php`** - RBAC 權限中介層
  - 管理員身份驗證檢查
  - 細粒度權限控制（支援 `resource.action` 格式）
  - 自動活動日誌記錄
  - 未授權訪問嘗試追蹤

- **`app/Models/AdminLoginLog.php`** - 登入日誌 Model
  - 適配現有資料表結構
  - 登入成功/失敗狀態追蹤
  - IP 位址與 User Agent 記錄

- **`app/Models/AdminActivityLog.php`** - 活動日誌 Model
  - 管理員操作審計追蹤
  - 資源類型與動作分類
  - 中文顯示名稱支援

#### API 路由設計 ✅
- **認證端點**：
  - `POST /api/admin/login` - 管理員登入
  - `POST /api/admin/logout` - 管理員登出
  - `GET /api/admin/me` - 獲取當前管理員資訊
  - `POST /api/admin/refresh` - 刷新 token

- **權限保護端點**：
  - `GET /api/admin/users` - 用戶管理（需要 `users.list`）
  - `GET /api/admin/tasks` - 任務管理（需要 `tasks.list`）
  - `GET /api/admin/admins` - 管理員管理（需要 `admins.list`）
  - `GET /api/admin/logs/*` - 日誌查看（需要 `logs.view`）

#### 技術實現亮點
- **Laravel Sanctum 整合**：API token 認證機制
- **適配現有資料庫**：兼容現有表結構，避免資料遷移
- **靜態權限配置**：在 Model 中定義角色權限，靈活且易維護
- **安全機制**：登入失敗鎖定、IP 追蹤、活動審計
- **中介層設計**：支援參數化權限檢查，可擴展性強

#### 測試結果 ✅
```bash
# 登入測試
Login Response Status: 200
Success: YES
Admin: Admin Buli
Permissions: 27 permissions
Token: 1|M9kSv4FZRHJKyvQETK...
Login logged: YES

# 權限中介層測試
No permission required: 200
users.list permission: 200
nonexistent permission: 403
```

### 5. 管理員後台 API 路由與控制器系統 ✅

#### 新增控制器
- **`app/Http/Controllers/Admin/UserController.php`** - 用戶管理控制器
  - 用戶列表查詢（分頁、篩選、搜尋、排序）
  - 用戶詳細資訊（包含統計資料和最近活動）
  - 用戶狀態更新（active, banned, inactive 等）
  - 用戶權限等級調整（-4 到 99 的權限系統）
  - 批量操作（批量啟用、停用、封鎖）
  - 完整的操作審計日誌

- **`app/Http/Controllers/Admin/TaskController.php`** - 任務管理控制器
  - 任務列表查詢（支援狀態、創建者、參與者篩選）
  - 任務詳細資訊（包含申請記錄和聊天統計）
  - 任務狀態管理（Open, In Progress, Completed 等）
  - 管理員操作記錄與審計追蹤

- **`app/Http/Controllers/Admin/LogController.php`** - 日誌管理控制器
  - 管理員活動日誌查看（支援多維度篩選）
  - 管理員登入日誌追蹤（成功/失敗/IP 統計）
  - 系統統計資訊（今日/本週/本月/本年）
  - 豐富的統計圖表資料

#### 完整 API 路由架構 ✅
```
POST   /api/admin/login                    # 管理員登入
POST   /api/admin/logout                   # 管理員登出
GET    /api/admin/me                       # 獲取當前管理員資訊
POST   /api/admin/refresh                  # 刷新 token

# 用戶管理 (需要 users.* 權限)
GET    /api/admin/users                    # 用戶列表
GET    /api/admin/users/{id}               # 用戶詳情
PATCH  /api/admin/users/{id}/status        # 更新用戶狀態
PATCH  /api/admin/users/{id}/permission    # 更新用戶權限
POST   /api/admin/users/batch-action       # 批量操作

# 任務管理 (需要 tasks.* 權限)
GET    /api/admin/tasks                    # 任務列表
GET    /api/admin/tasks/{id}               # 任務詳情
PATCH  /api/admin/tasks/{id}/status        # 更新任務狀態

# 日誌管理 (需要 logs.view 權限)
GET    /api/admin/logs/activity            # 活動日誌
GET    /api/admin/logs/login               # 登入日誌
GET    /api/admin/logs/stats               # 系統統計

# 系統資訊
GET    /api/admin/dashboard                # 儀表板資料
```

#### 權限控制整合 ✅
- **細粒度權限檢查**：每個 API 端點都有對應的權限要求
- **自動審計日誌**：所有管理員操作都會自動記錄
- **資料庫適配**：完全適配現有資料表結構
- **錯誤處理**：統一的 JSON 錯誤回應格式

#### 測試驗證 ✅
```bash
Testing User API...
Users List: 200          # ✅ 用戶管理 API 正常
Testing Task API...
Tasks List: 200          # ✅ 任務管理 API 正常
Testing Log API...
System Stats: 200        # ✅ 日誌管理 API 正常
All APIs working!        # ✅ 所有 API 端點正常運作
```

#### 功能特色
- **智能分頁**：支援自訂每頁筆數和排序
- **多維篩選**：狀態、權限、時間範圍、關鍵字搜尋
- **統計資訊**：即時統計各種資料指標
- **批量操作**：支援批量用戶狀態管理
- **審計追蹤**：完整的操作歷史記錄
- **安全防護**：基於 RBAC 的權限控制

### 6. Vue.js 管理前端基礎架構 ✅

#### 前端技術棧
- **Vue 3 + TypeScript**：現代化前端框架
- **Tailwind CSS**：實用優先的 CSS 框架
- **Pinia**：Vue 3 狀態管理
- **Vue Router**：單頁應用路由
- **Axios**：HTTP 客戶端
- **Chart.js + Vue-chartjs**：圖表視覺化

#### 核心功能實現 ✅
- **認證系統**：
  - 完整的登入/登出流程
  - JWT Token 自動管理
  - 權限檢查與路由守衛
  - 自動 token 刷新機制

- **狀態管理**：
  - Pinia 認證 store
  - 用戶資訊與權限狀態
  - 本地存儲持久化

- **UI 組件**：
  - 響應式管理介面佈局
  - 側邊欄導航與麵包屑
  - 統一的設計系統 (admin-* CSS 類)
  - 現代化的登入頁面

#### API 整合 ✅
- **完整的 API 服務層**：
  - 認證 API (authApi)
  - 用戶管理 API (userApi)
  - 任務管理 API (taskApi)
  - 日誌管理 API (logApi)
  - 系統資訊 API (systemApi)

- **錯誤處理**：
  - 統一的錯誤攔截
  - 401 自動跳轉登入
  - API 響應類型定義

#### 路由系統 ✅
- **權限路由守衛**：
  - 認證檢查 (requiresAuth)
  - 權限檢查 (permission)
  - 訪客頁面保護 (requiresGuest)

- **頁面結構**：
  ```
  /login          # 登入頁面
  /dashboard      # 儀表板 (已實現)
  /users          # 用戶管理 (placeholder)
  /tasks          # 任務管理 (placeholder)
  /logs           # 日誌查看 (placeholder)
  /settings       # 系統設定 (placeholder)
  ```

#### 開發環境配置 ✅
- **代碼品質**：
  - ESLint + Prettier 配置
  - TypeScript 嚴格模式
  - 自動格式化

- **構建工具**：
  - Vite 快速開發伺服器
  - PostCSS + Tailwind 處理
  - 環境變數配置

#### Git 版本控制 ✅
- **`.gitignore` 更新**：
  - 移除 `admin/` 忽略規則
  - 添加 Laravel 特定忽略
  - 保護敏感配置檔案

- **版本提交**：
  - 114 個檔案成功提交
  - 完整的 commit 訊息
  - 推送到遠端倉庫成功

## 📋 專案執行順序總覽

### 順序1：OAuth 流程閉環完成 ✅
**目標**：實作完整的第三方登入 OAuth token 化流程
- [x] T1-BE-CALLBACK-SAVE-TEMP：重構回調，寫入 oauth_temp_users
- [x] T2-BE-API-FETCH-TEMP：新增 GET /auth/oauth-temp API
- [x] T3-BE-REGISTER-CONSUME-TEMP：改造註冊 API 消費 temp token
- **狀態**：✅ 完成 - 新/舊用戶分流正常，token 化流程運作

### 順序2：前端 OAuth 註冊完成 ✅
**目標**：前端支援 OAuth token 預填與註冊流程
- [x] T4-FE-SIGNUP-PREFILL：/signup 支援 token 載入預填
- [x] T5-FE-OAUTH-WIRING：前端第三方登入流程銜接
- **狀態**：✅ 完成 - OAuth 註冊流程完整，包含國家選擇與語言自動填入

### 順序3：OAuth 流程整合與第三方登入統一化 ✅
**目標**：整合所有第三方登入服務與流程優化
- [x] 統一第三方登入服務架構
- [x] Web 平台 OAuth 流程實作
- [x] 錯誤處理與用戶體驗優化
- **狀態**：✅ 完成 - 所有第三方登入統一化，Web OAuth 正常運作

### 順序4：管理員後台基礎 ✅
**目標**：建立 Laravel + Vue 管理員後台基礎架構
- [x] T6-LAR-ADMIN-SETUP：建立 Laravel 管理員後台基礎架構
- [x] T6B-LAR-ADMIN-MIGRATIONS：建立 RBAC 與稽核資料表
- [x] T6C-LAR-ADMIN-ROUTES-RBAC：/admin 路由樹與 RBAC 中介層
- [x] T7-LAR-ADMIN-AUTH：實作管理員登入與權限控制
- [x] T8-VUE-ADMIN-UI：建立 Vue.js 管理員前端介面基礎
- **狀態**：✅ 完成 - 17個API端點，完整RBAC系統，Vue.js前端基礎架構

### 順序5：管理員後台詳細頁面開發 ✅
**目標**：完善管理員後台的具體功能頁面
- [x] 完善用戶管理頁面 (列表、詳情、編輯)
- [x] 完善任務管理頁面 (列表、詳情、狀態管理)
- [x] 完善日誌查看頁面 (活動日誌、登入日誌)
- [x] 整合 Chart.js 圖表與統計視覺化
- [x] 實作響應式設計與手機適配
- [x] 端對端測試與性能優化
- **狀態**：✅ 完成 - 管理員後台所有核心功能頁面已完整實作

#### 用戶管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 分頁、搜尋、篩選、排序功能
  - 批量操作（啟用、停用、封鎖）
  - 統計卡片顯示（總用戶、活躍用戶、待審核、封鎖用戶）
  - 響應式表格設計

- **用戶詳情頁面**：
  - 完整用戶資訊展示
  - 帳號狀態與權限管理
  - 用戶統計資料
  - 最近活動記錄

- **用戶編輯功能**：
  - 模態框編輯介面
  - 狀態與權限等級調整
  - 操作原因記錄（審計追蹤）
  - 即時表單驗證

- **技術實現**：
  - TypeScript 嚴格類型檢查
  - Vue 3 Composition API
  - Tailwind CSS 響應式設計
  - 完整的錯誤處理與載入狀態

#### 任務管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 多維度篩選（狀態、創建者、參與者、日期範圍）
  - 高級搜尋功能（標題、描述、用戶）
  - 統計卡片顯示（總任務、活躍任務、待審核、爭議任務）
  - 導出功能準備

- **任務詳情頁面**：
  - 完整任務資訊展示（基本資訊、參與人員、時間軸）
  - 任務申請記錄查看
  - 麵包屑導航與狀態標籤
  - 任務狀態編輯功能

- **任務狀態管理**：
  - 狀態編輯模態框（6種狀態：開放、進行中、完成、取消、爭議、待確認）
  - 狀態變更影響警告
  - 操作原因強制記錄
  - 狀態變更審計追蹤

- **技術特色**：
  - 防抖搜尋優化（500ms延遲）
  - 狀態徽章動態樣式
  - 完整的表單驗證
  - 響應式表格設計

#### 日誌查看頁面實作詳情 ✅
- **多類型日誌管理**：
  - 標籤式介面（全部日誌、登入日誌、活動日誌、管理員操作）
  - 即時統計數量顯示
  - 多維度篩選（用戶ID、動作類型、日期範圍）
  - 預設日期範圍選擇（今天、昨天、最近7天、最近30天、自定義）

- **高級搜尋功能**：
  - 用戶、動作、IP地址搜尋
  - 自定義日期時間範圍選擇
  - 防抖搜尋優化
  - 即時篩選結果

- **詳細日誌資訊**：
  - 完整時間戳記錄
  - 用戶資訊與系統操作區分
  - 動作類型彩色標籤
  - IP地址與User Agent追蹤
  - 操作詳情完整記錄

#### Chart.js 圖表統計視覺化 ✅
- **多類型圖表展示**：
  - 用戶註冊趨勢（線性圖）
  - 任務狀態分佈（甜甜圈圖）
  - 每日活動統計（柱狀圖）
  - 點數分佈趨勢（線性圖）

- **圖表功能特色**：
  - 響應式圖表設計
  - 即時數據載入
  - 模擬數據展示（開發環境）
  - 圖例與工具提示
  - 多數據集比較

- **數據視覺化**：
  - 7天趨勢分析
  - 多維度數據對比
  - 顏色編碼狀態識別
  - 互動式圖表操作

#### 響應式設計與優化 ✅
- **完整響應式支援**：
  - 桌面、平板、手機適配
  - Tailwind CSS 響應式類別
  - 彈性網格佈局
  - 適應性表格設計

- **性能優化實作**：
  - 防抖搜尋減少API調用
  - 圖表懶載入機制
  - 分頁數據載入
  - TypeScript 嚴格類型檢查

- **用戶體驗優化**：
  - 載入狀態指示器
  - 錯誤處理與重試機制
  - 空狀態友好提示
  - 統一的設計語言

### 順序6：帳號安全與保護 ✅
**目標**：實作用戶帳號安全機制與風險檢查
- [x] T1-BE-SECURITY-GUARD：GET /account/risky-actions-check, POST /account/deactivate, POST /account/reactivate
- [x] T2-FLT-SECURITY-UI：/account/security UI 與保護流程
- **狀態**：✅ 完成 - 帳號安全與保護機制已完整實作

#### 後端 API 實作詳情 ✅
- **風險檢查 API** (`risky-actions-check.php`)：
  - 檢查進行中任務（作為參與者）
  - 檢查發布中任務（作為創建者）
  - 檢查活躍聊天室
  - 返回詳細的風險狀態與數量統計
  - 提供 `can_deactivate` 布林值判斷

- **帳號停用 API** (`deactivate.php`)：
  - 驗證無進行中任務才允許停用
  - 區分自主停用與管理員停權
  - 更新用戶權限為 -3（自主停用）
  - 記錄操作日誌到 `user_activity_logs`
  - 完整的錯誤處理與狀態檢查

- **帳號啟用 API** (`reactivate.php`)：
  - 僅允許自主停用帳號重新啟用
  - 管理員停權帳號需聯繫客服
  - 更新用戶權限為 1（正常用戶）
  - 記錄重新啟用操作日誌
  - 返回詳細的狀態更新資訊

#### 前端 UI 實作詳情 ✅
- **風險警告系統**：
  - 頁面載入時自動檢查風險狀態
  - 視覺化警告卡片顯示具體風險項目
  - 動態禁用停用按鈕（有風險時）
  - 即時更新風險狀態與按鈕可用性

- **帳號停用流程**：
  - 雙重確認對話框
  - 載入狀態指示器
  - 成功/失敗 SnackBar 提示
  - 自動更新本地權限狀態
  - 重新檢查風險狀態

- **帳號啟用流程**：
  - 條件式顯示啟用按鈕（僅自主停用時）
  - 確認對話框與操作反饋
  - 管理員停權專用提示卡片
  - 客服聯繫按鈕（管理員停權時）

- **狀態管理**：
  - 本地 SharedPreferences 權限同步
  - 即時 UI 狀態更新
  - 錯誤處理與重試機制
  - 載入狀態與錯誤訊息顯示

#### 安全機制特色 ✅
- **任務保護**：禁止在有進行中任務時停用帳號
- **權限區分**：自主停用(-3) vs 管理員停權(-1)
- **操作審計**：完整的操作日誌記錄
- **用戶體驗**：清晰的狀態提示與操作指引
- **錯誤處理**：完善的錯誤訊息與重試機制

### 順序7：全域權限與路由守衛 📋
**目標**：實作前端權限控制系統
- [ ] T1-PERMISSION-GUARD：新增 guards/permission_guard.dart 並套用至路由與元件
- **驗收**：不同 permission/status 下導向與禁用一致

### 順序8：歷史任務與未評價快捷 📋
**目標**：實作任務歷史查看與快捷評價功能
- [ ] T1-BE-HISTORY-ENDPOINTS：GET /tasks/history?role=poster|acceptor
- [ ] T2-FLT-HISTORY-UI：history_page 與 review_dialog
- **驗收**：未評價項目可快捷評分

### 順序9：用戶帳號設定模組 📋
**目標**：完整的用戶帳號管理功能
- [ ] T1-BE-CHANGE-PASSWORD：POST /account/change-password（驗舊密碼、強度）
- [ ] T2-BE-REQUEST-RESET：POST /account/request-password-reset（寄送驗證連結）
- [ ] T3-BE-RESET-PASSWORD：POST /account/reset-password（驗 token 重設）
- [ ] T4-BE-DEACTIVATE-DELETE：POST /account/deactivate, DELETE /account（軟刪除/標記）
- [ ] T5-FLT-ACCOUNT-PAGES：設定頁：改密碼/重設/停權/刪帳/恢復 UI
- **驗收**：完整流程可操作，安全性校驗完整

### 順序10：聊天功能增強 📋
**目標**：實作聊天室滑動工具列與動作矩陣
- [ ] T1-FLT-POST-SWIPE：/chat POST 分頁滑動工具列（Slidable/Dismissible + 可擴充動作列）
- [ ] T2-BE-POST-ACTIONS：補齊 Read/Delete/Reject 相關 API
- [ ] T3-FLT-ACTION-BAR-MATRIX：1v1 聊天室 Action Bar（狀態×角色矩陣）
- [ ] T4-BE-ACTION-ENDPOINTS：補齊任務狀態變更端點與 task_logs 紀錄
- **驗收**：滑動與動作矩陣可用，依任務狀態條件顯示

### 順序11：任務自動完成與申訴流程 📋
**目標**：實作任務自動完成機制與申訴處理
- [ ] T1-BE-AUTO-COMPLETE：排程：pending confirmation > 7 天 → completed（寫 task_logs）
- [ ] T2-FLT-DISPUTE-ACTION：Action Bar 觸發 → 轉 dispute 並停止倒數
- [ ] T3-LAR-ADMIN-DISPUTE-REVIEW：後台審核（含圖片）
- **驗收**：七日自動完成/申訴審核可用

### 順序12：客服事件系統 📋
**目標**：實作客服事件紀錄與管理系統
- [ ] T9-BE-SUPPORT-EVENTS：實作客服事件紀錄後端 API
- [ ] T10-FE-SUPPORT-EVENTS：實作客服事件前端介面
- **驗收**：客服事件系統可正常運作

### 順序13：任務功能增強 📋
**目標**：新增任務收藏與檢舉功能
- [ ] T11-BE-TASK-FEATURES：實作任務收藏與檢舉後端 API
- [ ] T12-FE-TASK-FEATURES：實作任務收藏與檢舉前端介面
- **驗收**：任務收藏與檢舉功能正常

### 順序14：安全加固 📋
**目標**：基本安全機制實作
- [ ] T-SH-CORS：設定 CORS 白名單（dev/stage/prod 分環境）
- [ ] T-SH-RATE-LIMIT：登入/註冊/檢舉/傳訊 API 節流（如 5 req/min）
- [ ] T-SH-JWT-BASICS：JWT 期限/Refresh Token 基本輪替；黑名單撤銷端點
- **驗收**：關鍵端點節流生效；跨域正確；JWT 基本輪替可用

### 順序15：API 合約與錯誤碼 📋
**目標**：統一 API 回應格式與錯誤碼
- [ ] T-AC-ERROR-SPEC：定義統一格式 {success, code, message, data, traceId}
- [ ] T-AC-PAGINATION：統一分頁參數與回傳欄位
- [ ] T-AC-OPENAPI-MIN：以 OpenAPI 標註關鍵端點
- **驗收**：主要端點回應格式一致；OpenAPI 文檔可產生

### 順序16：監控與觀測性 📋
**目標**：集中化日誌與前端錯誤上報
- [ ] T-OB-LOGGING：後端加 traceId；記錄 4xx/5xx 與主要商務事件
- [ ] T-OB-FLT-ERROR：Flutter 全域錯誤上報 hook（含裝置/版本）
- [ ] T-OB-ALERT-MIN：簡單警示：API 5xx 連續 N 次觸發通知
- **驗收**：可由 traceId 追查錯誤；5xx 連續觸發能通知

### 順序17：資料治理 📋
**目標**：避免型別不一致與資料遺失的最小治理
- [ ] T-DG-ID-AUDIT：列出所有 id/FK 型別差異清單與準備遷移計畫
- [ ] T-DG-BACKUP：建立每日/每 6 小時 DB 備份腳本與還原演練步驟
- [ ] T-DG-RETENTION：定義最低限度資料保留/清理策略
- **驗收**：有型別差異清單與備份/還原 SOP；最低限度保留策略就緒

### 順序18：媒體處理 📋
**目標**：聊天室/申訴圖片的上傳規範與風險控管
- [ ] T-MP-LIMITS：檔案大小/類型白名單與壓縮策略
- [ ] T-MP-STORAGE：S3/本機儲存切換與清理排程
- [ ] T-MP-SCAN：掃毒/惡意檔阻擋流程（hook）
- **驗收**：超限與非法檔案被阻擋；存放與清理規則生效

### 順序19：通知策略 📋
**目標**：推播/站內/Email 的規則與頻率，使用者可控
- [ ] T-NP-MATRIX：事件→通知矩陣（任務/聊天/客服/審核）
- [ ] T-NP-SETTINGS：使用者通知偏好設定 UI
- **驗收**：事件→通知矩陣落地；前端可調整偏好

### 順序20：離線模式與斷線恢復 📋
**目標**：聊天室與列表的快取與重連策略
- [ ] T-OR-CACHE：列表快取與失效策略（最新 N 筆）
- [ ] T-OR-RETRY：Socket 重連與退避（backoff）
- **驗收**：列表離線可瀏覽；斷線可自動重連與退避

### 順序21：無障礙與空/錯誤狀態 📋
**目標**：字級、對比度、螢幕閱讀、可鍵盤操作
- [ ] T-A11Y-FONT：動態字級與可讀性檢查
- [ ] T-A11Y-ARIA：Semantics 標註與可鍵盤操作
- [ ] T-EES-TEMPLATES：空/錯頁模板組件（可參數化圖示/文案/CTA）
- **驗收**：主要流程具可讀性與空/錯態一致樣板

## 🎯 當前執行狀態

**目前位置**：順序5 - 管理員後台詳細頁面開發
**已完成**：順序1-4 (OAuth流程、管理員後台基礎架構)
**進行中**：Vue.js 管理介面詳細功能實作
**下一步**：完成管理員後台後，進入順序6帳號安全與保護模組

## 順序3完成狀況 ✅

### 1. OAuth 流程整合完成

#### 修改檔案
- **`lib/auth/services/third_party_auth_service.dart`**
  - 重構：Web 版 Google/Facebook/Apple 登入使用真實 OAuth 流程
  - 移除：模擬資料，改為直接重定向到 OAuth 授權頁面
  - 新增：統一的 OAuth 流程啟動機制
  - 更新：`_sendUserDataToBackend` 方法支援新的 API 端點
  - 整合：所有第三方登入提供商使用相同的 token 化流程

- **`lib/auth/pages/auth_callback_page.dart`**
  - 新增：支援新用戶 OAuth token 處理邏輯
  - 新增：`_redirectToSignupPage` 方法處理新用戶重定向
  - 修改：`_handleLoginSuccess` 方法區分新用戶與現有用戶
  - 優化：UI 顯示邏輯，正確處理不同的用戶狀態
  - 整合：完整的錯誤處理與用戶體驗

### 2. 技術實現細節

#### 統一 OAuth 流程
1. **Web 版第三方登入**：
   - Google：重定向至 `accounts.google.com/o/oauth2/v2/auth`
   - Facebook：重定向至 `www.facebook.com/v18.0/dialog/oauth`
   - Apple：重定向至 `appleid.apple.com/auth/authorize`
   - 所有提供商都重定向到對應的 `{provider}-callback.php`

2. **回調處理**：
   - 新用戶：後端返回 `oauth_token` → 前端重定向 `/signup?oauth_token=...`
   - 現有用戶：後端返回 `token` + `user_data` → 前端重定向 `/home`
   - 錯誤：統一錯誤處理與用戶提示

3. **移動版兼容**：
   - 保留原有的 Google Sign-In SDK 整合
   - 使用統一的後端 API 端點
   - 支援 iOS/Android 平台特定功能

#### 用戶體驗優化
- 統一的載入狀態與進度指示
- 清晰的錯誤訊息與重試機制
- 新用戶與現有用戶的差異化處理
- 自動重定向與手動操作選項

### 3. 測試結果

#### 語法檢查 ✅
```bash
flutter analyze lib/auth/services/third_party_auth_service.dart lib/auth/pages/auth_callback_page.dart
# 結果：40 issues found (均為 info/warning，無錯誤)
```

#### 流程驗證 ✅
- [x] Google Web OAuth 流程：正確生成授權 URL 並啟動流程
- [x] Facebook Web OAuth 流程：正確配置並支援回調
- [x] Apple Web OAuth 流程：正確配置並支援回調
- [x] 回調頁面處理：正確區分新用戶與現有用戶
- [x] 錯誤處理：統一的錯誤提示與重試機制
- [x] 移動版兼容：保持原有功能不受影響

### 4. 完整流程整合
- [x] 前端 OAuth 啟動：三大提供商統一流程
- [x] 後端回調處理：token 化流程完整實現
- [x] 前端回調處理：新舊用戶正確分流
- [x] 註冊流程整合：OAuth token 預填與註冊
- [x] 錯誤處理機制：端對端錯誤處理與用戶體驗

## 順序2完成狀況 ✅

### 1. 前端 OAuth 註冊完成

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：`_handleOAuthRegistration()` 使用新的 token 化流程
  - 新增：從 URL 參數 `oauth_token` 獲取 token 並調用 API
  - 新增：`_getSchoolValue()` 輔助方法處理學校資料
  - 新增：`_showTokenExpiredDialog()` 處理 token 過期情況
  - 修改：`_handleSubmit()` 正確判斷 OAuth vs 傳統註冊流程
  - 整合：完整的錯誤處理與用戶提示機制

#### 後端 API 更新
- **`backend/api/auth/register-oauth.php`**
  - 修改：從 session 方式改為 token 化流程
  - 新增：接收 `oauth_token` 參數並從 `oauth_temp_users` 表消費
  - 新增：交易式處理確保資料一致性
  - 新增：token 消費後自動刪除，確保一次性使用
  - 保留：完整的錯誤處理與日誌記錄

### 2. 技術實現細節

#### OAuth 註冊流程
1. **前端接收 token**：從 URL 參數 `?oauth_token=xxx` 獲取
2. **API 調用**：POST `/auth/register-oauth.php` 傳遞 token 與表單資料
3. **後端處理**：
   - 驗證 token 有效性與過期時間
   - 從 `oauth_temp_users` 獲取 OAuth 資料
   - 建立 `users` 與 `user_identities` 記錄
   - 刪除臨時 token（消費）
   - 生成 JWT 並返回
4. **前端處理**：保存登入資訊並導向 `/signup/student-id`

#### 錯誤處理機制
- Token 過期/無效：顯示專用對話框建議重新登入
- API 錯誤：顯示具體錯誤訊息
- 網路錯誤：顯示通用錯誤提示
- 表單驗證：保持原有驗證邏輯

### 3. 測試結果

#### API 測試 ✅
```bash
# 無效 token 測試
curl -X POST -H 'Content-Type: application/json' \
  -d '{"oauth_token":"INVALID_TOKEN","name":"Test User"}' \
  http://localhost:8888/here4help/backend/api/auth/register-oauth.php
# 結果：{"success":false,"message":"OAuth token expired or invalid"}
```

#### 語法檢查 ✅
```bash
php -l backend/api/auth/register-oauth.php
# 結果：No syntax errors detected

flutter analyze lib/auth/pages/signup_page.dart
# 結果：45 issues found (均為 info/warning，無錯誤)
```

### 4. 完整流程驗證
- [x] 新用戶 OAuth 流程：Google 登入 → 暫存 → 重定向 `/signup?oauth_token=...`
- [x] 前端 token 預填：自動讀取 token 並調用 API 獲取預填資料
- [x] 註冊 API 調用：token 化 API 正確處理表單提交
- [x] 錯誤處理：token 過期、API 錯誤、網路錯誤均有適當處理
- [x] 成功流程：註冊成功後正確導向 `/signup/student-id`

## 順序1完成狀況 ✅

### 1. 後端部分

#### 新增檔案
- **`backend/api/auth/oauth-temp.php`**
  - 功能：處理臨時 OAuth 用戶資料的查詢與消費
  - 支援 `peek=true` 參數進行資料查看而不刪除
  - 驗證 token 有效性與過期時間
  - 返回用戶基本資料（provider, email, name, avatar_url）

#### 修改檔案
- **`backend/api/auth/google-callback.php`**
  - 新增：新用戶資料存入 `oauth_temp_users` 表
  - 新增：生成一次性 `tempToken` 與 `expired_at` 時間戳
  - 修改：新用戶重定向至 `/signup?oauth_token=...`
  - 保留：現有用戶仍獲得 JWT 並重定向至 `/home`

### 2. 前端部分

#### 新增檔案
- **`lib/services/api/oauth_api.dart`**
  - 功能：OAuth 臨時資料 API 服務
  - 方法：`fetchTempUser(String token)` 查詢臨時用戶資料
  - 整合：使用 `AppConfig.apiBaseUrl` 與 debug 日誌

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：支援 URL 參數 `?token=` 的 OAuth 預填
  - 新增：`_loadThirdPartyData()` 中優先處理 token 參數
  - 保留：原有的 `widget.oauthData` 與 SharedPreferences 備用機制
  - 整合：`OAuthApi.fetchTempUser()` 調用

### 3. 資料庫結構
- **`oauth_temp_users` 表** (已建立)
  - 欄位：provider, provider_user_id, email, name, avatar_url, raw_data, token, expired_at
  - 用途：暫存第三方登入的新用戶資料
  - 過期機制：1小時自動過期

## 技術實現細節

### OAuth 流程
1. **用戶點擊 Google 登入**
2. **後端處理**：
   - 檢查是否為新用戶
   - 新用戶：存入 `oauth_temp_users`，生成 tempToken
   - 現有用戶：直接登入並獲得 JWT
3. **前端處理**：
   - 新用戶：重定向至 `/signup?oauth_token=xxx`
   - 現有用戶：重定向至 `/home`
4. **註冊頁面**：
   - 自動讀取 URL 中的 `oauth_token`
   - 調用 `OAuthApi.fetchTempUser()` 獲取預填資料
   - 預填表單欄位（name, email, avatar_url）

### 錯誤處理
- Token 過期或無效時返回 404
- API 調用失敗時記錄 debug 日誌
- 預填失敗時不影響正常註冊流程

## 測試結果

### 語法檢查 ✅
```bash
flutter analyze
# 結果：633 issues found (均為 info/warning，無錯誤)
# 新檔案無語法錯誤
```

### 後端檢查 ✅
```bash
php -l backend/api/auth/google-callback.php
# 結果：No syntax errors detected

php -l backend/api/auth/oauth-temp.php  
# 結果：No syntax errors detected
```

### 功能驗證
- [x] 新用戶 OAuth 流程
- [x] 現有用戶 OAuth 流程  
- [x] Token 預填機制
- [x] 錯誤處理機制
- [x] 過期時間驗證

## 下一步計劃

### 順序3：OAuth 流程整合 (PR3) ✅
- [x] 更新 `third_party_auth_service.dart` 整合新的回調流程
- [x] 確保 Facebook 和 Apple 登入使用相同的 token 化流程
- [x] 更新 `auth_callback_page.dart` 處理新的重定向邏輯
- [x] 端對端測試完整 OAuth 流程並優化用戶體驗

### 順序4：管理員後台基礎 (PR4)
- [ ] 建立 Laravel 管理員後台基礎架構
- [ ] 設定 RBAC 與稽核資料表
- [ ] 實作管理員登入與權限控制
- [ ] 建立路由樹與中介層

### 順序5：用戶帳戶安全 (PR5)
- [ ] 實作密碼修改功能
- [ ] 建立重設密碼驗證信機制
- [ ] 用戶自主停權與帳號刪除功能
- [ ] 停權恢復流程

## 注意事項

### 環境配置
- 確保 `FRONTEND_URL` 設定為 `http://localhost:3000`
- 確保 Google Cloud Console 已配置正確的 redirect URI
- 確保 `oauth_temp_users` 表已建立

### 開發建議
- 使用 debug 模式查看詳細日誌
- 測試時注意 token 的 1 小時過期限制
- 建議在生產環境中調整過期時間

## 相關文件
- `docs/優先執行/高階專案分析指令.md`
- `docs/PLAN.md`
- `docs/plan.json`
- `docs/優先執行/專案修改指南（Chief Architect 版）.md`

---

**更新記錄**
- 2025-01-11: 完成順序1，建立進度追蹤文件
- 2025-01-11: 完成順序2，OAuth 註冊流程整合完成
- 2025-01-11: 完成順序3，OAuth 流程整合與第三方登入統一化
