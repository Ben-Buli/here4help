# 高階專案指南進度追蹤表

## 專案概述
- **專案名稱**: Here4Help Flutter App
- **當前階段**: 順序1 - OAuth 流程閉環完成
- **完成日期**: 2025-01-11
- **主要目標**: 實現第三方登入首次導引註冊的完整流程

## 順序1完成狀況 ✅

## 順序2完成狀況 ✅

## 順序3完成狀況 ✅

## 順序4完成狀況 🚧 (進行中)

### 1. Laravel 管理員後台基礎架構 ✅

#### 新增檔案與目錄
- **`admin/`** - Laravel 12.25.0 專案根目錄
  - 完整的 Laravel 框架結構
  - 配置 MySQL 資料庫連線（使用 MAMP socket）
  - 整合 Laravel Sanctum 用於 API 認證

#### 資料庫結構設計 ✅
- **`admin_roles`** - 管理員角色表
  - 支援角色名稱、顯示名稱、描述
  - JSON 格式儲存權限陣列
  - 角色啟用/停用狀態控制

- **`admins`** - 管理員用戶表（適配現有結構）
  - 使用現有欄位：`username`, `full_name`, `email`
  - 關聯 `admin_roles` 表進行 RBAC
  - 登入狀態與安全控制

- **`admin_role_permissions`** - 角色權限詳細表
  - 資源類型與動作權限控制
  - 支援條件式權限設定

- **`admin_activity_logs`** - 管理員活動日誌
  - 完整的操作審計追蹤
  - 記錄修改前後值與 IP 位址

- **`admin_login_logs`** - 登入日誌
  - 成功/失敗登入記錄
  - 安全監控與異常檢測

#### Eloquent Models ✅
- **`Admin`** - 繼承 `Authenticatable`，支援 Sanctum 認證
  - 完整的關聯設定（role, activityLogs, loginLogs）
  - 權限檢查方法 `hasPermission()`
  - 狀態檢查方法 `isActive()`

- **`AdminRole`** - 角色管理 Model
  - JSON 權限陣列處理
  - 權限新增/移除方法
  - 角色與管理員關聯

#### 資料初始化 ✅
- **預設角色建立**：
  - `super_admin`：超級管理員（完整權限）
  - `admin`：一般管理員（大部分權限）
  - `moderator`：版主（內容審核權限）

- **預設管理員帳號**：
  - Super Admin: `admin@here4help.com` / `admin123`
  - Test Admin: `test@here4help.com` / `test123`

### 2. 技術實現細節

#### 權限系統設計
- **資源導向權限**：`{resource}.{action}` 格式
  - `users.list`, `users.view`, `users.edit`, `users.delete`
  - `tasks.list`, `tasks.view`, `tasks.edit`, `tasks.delete`
  - `services.list`, `services.view`, `services.edit`, `services.delete`
  - `points.list`, `points.view`, `points.edit`, `points.delete`
  - `admins.list`, `admins.create`, `admins.edit`, `admins.delete`
  - `logs.view`

#### 資料庫整合
- **共用資料庫**：與現有 PHP 後端使用相同的 MySQL 資料庫
- **MAMP 整合**：使用 socket 連接 `/Applications/MAMP/tmp/mysql/mysql.sock`
- **遷移管理**：適配現有表結構，避免衝突

#### Laravel 配置
- **Sanctum 認證**：API token 認證機制
- **環境配置**：`.env` 檔案配置資料庫與應用設定
- **版本**：Laravel 12.25.0 最新穩定版

### 3. 測試結果

#### 基礎功能驗證 ✅
```bash
# Laravel 版本確認
php artisan --version
# 結果：Laravel Framework 12.25.0

# 資料庫連線測試
php artisan migrate:status
# 結果：成功連接並顯示遷移狀態

# Seeder 執行測試
php artisan db:seed --class=AdminSeeder
# 結果：成功建立角色與管理員帳號
```

#### 資料驗證 ✅
- [x] 管理員角色建立：3 個預設角色
- [x] 管理員帳號建立：2 個測試帳號
- [x] 權限系統配置：完整的 RBAC 權限陣列
- [x] 資料表關聯：正確的外鍵與索引設定

### 4. 管理員認證與權限控制系統 ✅

#### 新增檔案
- **`app/Http/Controllers/Admin/AuthController.php`** - 管理員認證控制器
  - 完整的登入/登出/刷新 API
  - 密碼驗證與帳號狀態檢查
  - 登入失敗次數限制與帳號鎖定機制
  - 完整的登入日誌記錄

- **`app/Http/Middleware/AdminMiddleware.php`** - RBAC 權限中介層
  - 管理員身份驗證檢查
  - 細粒度權限控制（支援 `resource.action` 格式）
  - 自動活動日誌記錄
  - 未授權訪問嘗試追蹤

- **`app/Models/AdminLoginLog.php`** - 登入日誌 Model
  - 適配現有資料表結構
  - 登入成功/失敗狀態追蹤
  - IP 位址與 User Agent 記錄

- **`app/Models/AdminActivityLog.php`** - 活動日誌 Model
  - 管理員操作審計追蹤
  - 資源類型與動作分類
  - 中文顯示名稱支援

#### API 路由設計 ✅
- **認證端點**：
  - `POST /api/admin/login` - 管理員登入
  - `POST /api/admin/logout` - 管理員登出
  - `GET /api/admin/me` - 獲取當前管理員資訊
  - `POST /api/admin/refresh` - 刷新 token

- **權限保護端點**：
  - `GET /api/admin/users` - 用戶管理（需要 `users.list`）
  - `GET /api/admin/tasks` - 任務管理（需要 `tasks.list`）
  - `GET /api/admin/admins` - 管理員管理（需要 `admins.list`）
  - `GET /api/admin/logs/*` - 日誌查看（需要 `logs.view`）

#### 技術實現亮點
- **Laravel Sanctum 整合**：API token 認證機制
- **適配現有資料庫**：兼容現有表結構，避免資料遷移
- **靜態權限配置**：在 Model 中定義角色權限，靈活且易維護
- **安全機制**：登入失敗鎖定、IP 追蹤、活動審計
- **中介層設計**：支援參數化權限檢查，可擴展性強

#### 測試結果 ✅
```bash
# 登入測試
Login Response Status: 200
Success: YES
Admin: Admin Buli
Permissions: 27 permissions
Token: 1|M9kSv4FZRHJKyvQETK...
Login logged: YES

# 權限中介層測試
No permission required: 200
users.list permission: 200
nonexistent permission: 403
```

### 5. 管理員後台 API 路由與控制器系統 ✅

#### 新增控制器
- **`app/Http/Controllers/Admin/UserController.php`** - 用戶管理控制器
  - 用戶列表查詢（分頁、篩選、搜尋、排序）
  - 用戶詳細資訊（包含統計資料和最近活動）
  - 用戶狀態更新（active, banned, inactive 等）
  - 用戶權限等級調整（-4 到 99 的權限系統）
  - 批量操作（批量啟用、停用、封鎖）
  - 完整的操作審計日誌

- **`app/Http/Controllers/Admin/TaskController.php`** - 任務管理控制器
  - 任務列表查詢（支援狀態、創建者、參與者篩選）
  - 任務詳細資訊（包含申請記錄和聊天統計）
  - 任務狀態管理（Open, In Progress, Completed 等）
  - 管理員操作記錄與審計追蹤

- **`app/Http/Controllers/Admin/LogController.php`** - 日誌管理控制器
  - 管理員活動日誌查看（支援多維度篩選）
  - 管理員登入日誌追蹤（成功/失敗/IP 統計）
  - 系統統計資訊（今日/本週/本月/本年）
  - 豐富的統計圖表資料

#### 完整 API 路由架構 ✅
```
POST   /api/admin/login                    # 管理員登入
POST   /api/admin/logout                   # 管理員登出
GET    /api/admin/me                       # 獲取當前管理員資訊
POST   /api/admin/refresh                  # 刷新 token

# 用戶管理 (需要 users.* 權限)
GET    /api/admin/users                    # 用戶列表
GET    /api/admin/users/{id}               # 用戶詳情
PATCH  /api/admin/users/{id}/status        # 更新用戶狀態
PATCH  /api/admin/users/{id}/permission    # 更新用戶權限
POST   /api/admin/users/batch-action       # 批量操作

# 任務管理 (需要 tasks.* 權限)
GET    /api/admin/tasks                    # 任務列表
GET    /api/admin/tasks/{id}               # 任務詳情
PATCH  /api/admin/tasks/{id}/status        # 更新任務狀態

# 日誌管理 (需要 logs.view 權限)
GET    /api/admin/logs/activity            # 活動日誌
GET    /api/admin/logs/login               # 登入日誌
GET    /api/admin/logs/stats               # 系統統計

# 系統資訊
GET    /api/admin/dashboard                # 儀表板資料
```

#### 權限控制整合 ✅
- **細粒度權限檢查**：每個 API 端點都有對應的權限要求
- **自動審計日誌**：所有管理員操作都會自動記錄
- **資料庫適配**：完全適配現有資料表結構
- **錯誤處理**：統一的 JSON 錯誤回應格式

#### 測試驗證 ✅
```bash
Testing User API...
Users List: 200          # ✅ 用戶管理 API 正常
Testing Task API...
Tasks List: 200          # ✅ 任務管理 API 正常
Testing Log API...
System Stats: 200        # ✅ 日誌管理 API 正常
All APIs working!        # ✅ 所有 API 端點正常運作
```

#### 功能特色
- **智能分頁**：支援自訂每頁筆數和排序
- **多維篩選**：狀態、權限、時間範圍、關鍵字搜尋
- **統計資訊**：即時統計各種資料指標
- **批量操作**：支援批量用戶狀態管理
- **審計追蹤**：完整的操作歷史記錄
- **安全防護**：基於 RBAC 的權限控制

### 6. Vue.js 管理前端基礎架構 ✅

#### 前端技術棧
- **Vue 3 + TypeScript**：現代化前端框架
- **Tailwind CSS**：實用優先的 CSS 框架
- **Pinia**：Vue 3 狀態管理
- **Vue Router**：單頁應用路由
- **Axios**：HTTP 客戶端
- **Chart.js + Vue-chartjs**：圖表視覺化

#### 核心功能實現 ✅
- **認證系統**：
  - 完整的登入/登出流程
  - JWT Token 自動管理
  - 權限檢查與路由守衛
  - 自動 token 刷新機制

- **狀態管理**：
  - Pinia 認證 store
  - 用戶資訊與權限狀態
  - 本地存儲持久化

- **UI 組件**：
  - 響應式管理介面佈局
  - 側邊欄導航與麵包屑
  - 統一的設計系統 (admin-* CSS 類)
  - 現代化的登入頁面

#### API 整合 ✅
- **完整的 API 服務層**：
  - 認證 API (authApi)
  - 用戶管理 API (userApi)
  - 任務管理 API (taskApi)
  - 日誌管理 API (logApi)
  - 系統資訊 API (systemApi)

- **錯誤處理**：
  - 統一的錯誤攔截
  - 401 自動跳轉登入
  - API 響應類型定義

#### 路由系統 ✅
- **權限路由守衛**：
  - 認證檢查 (requiresAuth)
  - 權限檢查 (permission)
  - 訪客頁面保護 (requiresGuest)

- **頁面結構**：
  ```
  /login          # 登入頁面
  /dashboard      # 儀表板 (已實現)
  /users          # 用戶管理 (placeholder)
  /tasks          # 任務管理 (placeholder)
  /logs           # 日誌查看 (placeholder)
  /settings       # 系統設定 (placeholder)
  ```

#### 開發環境配置 ✅
- **代碼品質**：
  - ESLint + Prettier 配置
  - TypeScript 嚴格模式
  - 自動格式化

- **構建工具**：
  - Vite 快速開發伺服器
  - PostCSS + Tailwind 處理
  - 環境變數配置

#### Git 版本控制 ✅
- **`.gitignore` 更新**：
  - 移除 `admin/` 忽略規則
  - 添加 Laravel 特定忽略
  - 保護敏感配置檔案

- **版本提交**：
  - 114 個檔案成功提交
  - 完整的 commit 訊息
  - 推送到遠端倉庫成功

## 📋 專案執行順序總覽

### 順序1：OAuth 流程閉環完成 ✅
**目標**：實作完整的第三方登入 OAuth token 化流程
- [x] T1-BE-CALLBACK-SAVE-TEMP：重構回調，寫入 oauth_temp_users
- [x] T2-BE-API-FETCH-TEMP：新增 GET /auth/oauth-temp API
- [x] T3-BE-REGISTER-CONSUME-TEMP：改造註冊 API 消費 temp token
- **狀態**：✅ 完成 - 新/舊用戶分流正常，token 化流程運作

### 順序2：前端 OAuth 註冊完成 ✅
**目標**：前端支援 OAuth token 預填與註冊流程
- [x] T4-FE-SIGNUP-PREFILL：/signup 支援 token 載入預填
- [x] T5-FE-OAUTH-WIRING：前端第三方登入流程銜接
- **狀態**：✅ 完成 - OAuth 註冊流程完整，包含國家選擇與語言自動填入

### 順序3：OAuth 流程整合與第三方登入統一化 ✅
**目標**：整合所有第三方登入服務與流程優化
- [x] 統一第三方登入服務架構
- [x] Web 平台 OAuth 流程實作
- [x] 錯誤處理與用戶體驗優化
- **狀態**：✅ 完成 - 所有第三方登入統一化，Web OAuth 正常運作

### 順序4：管理員後台基礎 ✅
**目標**：建立 Laravel + Vue 管理員後台基礎架構
- [x] T6-LAR-ADMIN-SETUP：建立 Laravel 管理員後台基礎架構
- [x] T6B-LAR-ADMIN-MIGRATIONS：建立 RBAC 與稽核資料表
- [x] T6C-LAR-ADMIN-ROUTES-RBAC：/admin 路由樹與 RBAC 中介層
- [x] T7-LAR-ADMIN-AUTH：實作管理員登入與權限控制
- [x] T8-VUE-ADMIN-UI：建立 Vue.js 管理員前端介面基礎
- **狀態**：✅ 完成 - 17個API端點，完整RBAC系統，Vue.js前端基礎架構

### 順序5：管理員後台詳細頁面開發 ✅
**目標**：完善管理員後台的具體功能頁面
- [x] 完善用戶管理頁面 (列表、詳情、編輯)
- [x] 完善任務管理頁面 (列表、詳情、狀態管理)
- [x] 完善日誌查看頁面 (活動日誌、登入日誌)
- [x] 整合 Chart.js 圖表與統計視覺化
- [x] 實作響應式設計與手機適配
- [x] 端對端測試與性能優化
- **狀態**：✅ 完成 - 管理員後台所有核心功能頁面已完整實作

#### 用戶管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 分頁、搜尋、篩選、排序功能
  - 批量操作（啟用、停用、封鎖）
  - 統計卡片顯示（總用戶、活躍用戶、待審核、封鎖用戶）
  - 響應式表格設計

- **用戶詳情頁面**：
  - 完整用戶資訊展示
  - 帳號狀態與權限管理
  - 用戶統計資料
  - 最近活動記錄

- **用戶編輯功能**：
  - 模態框編輯介面
  - 狀態與權限等級調整
  - 操作原因記錄（審計追蹤）
  - 即時表單驗證

- **技術實現**：
  - TypeScript 嚴格類型檢查
  - Vue 3 Composition API
  - Tailwind CSS 響應式設計
  - 完整的錯誤處理與載入狀態

#### 任務管理頁面實作詳情 ✅
- **完整功能列表頁面**：
  - 多維度篩選（狀態、創建者、參與者、日期範圍）
  - 高級搜尋功能（標題、描述、用戶）
  - 統計卡片顯示（總任務、活躍任務、待審核、爭議任務）
  - 導出功能準備

- **任務詳情頁面**：
  - 完整任務資訊展示（基本資訊、參與人員、時間軸）
  - 任務申請記錄查看
  - 麵包屑導航與狀態標籤
  - 任務狀態編輯功能

- **任務狀態管理**：
  - 狀態編輯模態框（6種狀態：開放、進行中、完成、取消、爭議、待確認）
  - 狀態變更影響警告
  - 操作原因強制記錄
  - 狀態變更審計追蹤

- **技術特色**：
  - 防抖搜尋優化（500ms延遲）
  - 狀態徽章動態樣式
  - 完整的表單驗證
  - 響應式表格設計

#### 日誌查看頁面實作詳情 ✅
- **多類型日誌管理**：
  - 標籤式介面（全部日誌、登入日誌、活動日誌、管理員操作）
  - 即時統計數量顯示
  - 多維度篩選（用戶ID、動作類型、日期範圍）
  - 預設日期範圍選擇（今天、昨天、最近7天、最近30天、自定義）

- **高級搜尋功能**：
  - 用戶、動作、IP地址搜尋
  - 自定義日期時間範圍選擇
  - 防抖搜尋優化
  - 即時篩選結果

- **詳細日誌資訊**：
  - 完整時間戳記錄
  - 用戶資訊與系統操作區分
  - 動作類型彩色標籤
  - IP地址與User Agent追蹤
  - 操作詳情完整記錄

#### Chart.js 圖表統計視覺化 ✅
- **多類型圖表展示**：
  - 用戶註冊趨勢（線性圖）
  - 任務狀態分佈（甜甜圈圖）
  - 每日活動統計（柱狀圖）
  - 點數分佈趨勢（線性圖）

- **圖表功能特色**：
  - 響應式圖表設計
  - 即時數據載入
  - 模擬數據展示（開發環境）
  - 圖例與工具提示
  - 多數據集比較

- **數據視覺化**：
  - 7天趨勢分析
  - 多維度數據對比
  - 顏色編碼狀態識別
  - 互動式圖表操作

#### 響應式設計與優化 ✅
- **完整響應式支援**：
  - 桌面、平板、手機適配
  - Tailwind CSS 響應式類別
  - 彈性網格佈局
  - 適應性表格設計

- **性能優化實作**：
  - 防抖搜尋減少API調用
  - 圖表懶載入機制
  - 分頁數據載入
  - TypeScript 嚴格類型檢查

- **用戶體驗優化**：
  - 載入狀態指示器
  - 錯誤處理與重試機制
  - 空狀態友好提示
  - 統一的設計語言

### 順序6：帳號安全與保護 ✅
**目標**：實作用戶帳號安全機制與風險檢查
- [x] T1-BE-SECURITY-GUARD：GET /account/risky-actions-check, POST /account/deactivate, POST /account/reactivate
- [x] T2-FLT-SECURITY-UI：/account/security UI 與保護流程
- **狀態**：✅ 完成 - 帳號安全與保護機制已完整實作

#### 後端 API 實作詳情 ✅
- **風險檢查 API** (`risky-actions-check.php`)：
  - 檢查進行中任務（作為參與者）
  - 檢查發布中任務（作為創建者）
  - 檢查活躍聊天室
  - 返回詳細的風險狀態與數量統計
  - 提供 `can_deactivate` 布林值判斷

- **帳號停用 API** (`deactivate.php`)：
  - 驗證無進行中任務才允許停用
  - 區分自主停用與管理員停權
  - 更新用戶權限為 -3（自主停用）
  - 記錄操作日誌到 `user_activity_logs`
  - 完整的錯誤處理與狀態檢查

- **帳號啟用 API** (`reactivate.php`)：
  - 僅允許自主停用帳號重新啟用
  - 管理員停權帳號需聯繫客服
  - 更新用戶權限為 1（正常用戶）
  - 記錄重新啟用操作日誌
  - 返回詳細的狀態更新資訊

#### 前端 UI 實作詳情 ✅
- **風險警告系統**：
  - 頁面載入時自動檢查風險狀態
  - 視覺化警告卡片顯示具體風險項目
  - 動態禁用停用按鈕（有風險時）
  - 即時更新風險狀態與按鈕可用性

- **帳號停用流程**：
  - 雙重確認對話框
  - 載入狀態指示器
  - 成功/失敗 SnackBar 提示
  - 自動更新本地權限狀態
  - 重新檢查風險狀態

- **帳號啟用流程**：
  - 條件式顯示啟用按鈕（僅自主停用時）
  - 確認對話框與操作反饋
  - 管理員停權專用提示卡片
  - 客服聯繫按鈕（管理員停權時）

- **狀態管理**：
  - 本地 SharedPreferences 權限同步
  - 即時 UI 狀態更新
  - 錯誤處理與重試機制
  - 載入狀態與錯誤訊息顯示

#### 安全機制特色 ✅
- **任務保護**：禁止在有進行中任務時停用帳號
- **權限區分**：自主停用(-3) vs 管理員停權(-1)
- **操作審計**：完整的操作日誌記錄
- **用戶體驗**：清晰的狀態提示與操作指引
- **錯誤處理**：完善的錯誤訊息與重試機制

### 順序7：全域權限與路由守衛 ✅
**目標**：實作前端權限控制系統
- [x] T1-PERMISSION-GUARD：新增 guards/permission_guard.dart 並套用至路由與元件
- **狀態**：✅ 完成 - 全域權限控制系統已完整實作並整合現有架構

#### 權限系統整合分析 ✅
**現有權限架構評估**：
- **`permission_service.dart`** - 靜態權限檢查服務 ✅ 保留
- **`permission_provider.dart`** - 權限狀態管理 Provider ✅ 保留  
- **`permission_aware_widget.dart`** - 權限感知元件 ✅ 保留
- **`auth_guard.dart`** - 路由守衛（部分實作）✅ 整合
- **`route_permissions.dart`** - 路由權限配置 ✅ 整合
- **`shell_pages.dart`** - 頁面配置 ✅ 新增權限欄位

#### Shell Pages 權限配置 ✅
**為所有頁面添加 `permission` 欄位**：
- **登入/註冊頁面**：`permission: -4` （任何狀態可訪問）
- **身份驗證頁面**：`permission: 0` （新用戶可訪問）
- **首頁/帳戶頁面**：`permission: 0` （新用戶可訪問）
- **聊天功能**：`permission: 1` （需要已認證用戶）
- **任務創建/應徵**：`permission: 1` （需要已認證用戶）
- **錢包/評價/歷史**：`permission: 1` （需要已認證用戶）
- **安全設定/主題/客服**：`permission: 0` （新用戶可訪問）
- **支付設定**：`permission: 1` （需要已認證用戶）

#### 統一權限守衛實作 ✅
**`lib/router/guards/permission_guard.dart`**：
- **路由級權限檢查**：`canAccessRoute()` 整合 shell_pages 配置
- **功能級權限檢查**：`canUseFeature()` 整合 permission_service
- **路由守衛中介層**：`guardRoute()` 統一處理權限拒絕
- **智能對話框系統**：根據用戶狀態顯示不同提示
  - 未認證用戶：導向身份驗證頁面
  - 管理員停權：導向客服聯繫頁面
  - 自主停用：導向安全設定頁面
- **權限提示系統**：`shouldShowPermissionHint()` 動態提示

#### 權限感知按鈕組件 ✅
**`lib/widgets/buttons/apply_now_button.dart`**：
- **ApplyNowButton**：權限感知的任務應徵按鈕
- **EnterChatButton**：權限感知的聊天室進入按鈕
- **CreateTaskButton**：權限感知的任務創建按鈕
- **動態狀態顯示**：
  - 有權限：正常顯示可點擊按鈕
  - 權限不足：顯示鎖定圖標與提示
  - 帳號刪除：完全隱藏按鈕
- **智能提示系統**：Tooltip + 點擊顯示權限對話框

#### 技術整合特色 ✅
**避免重複功能**：
- 保留現有 `permission_service.dart` 靜態方法
- 整合 `permission_provider.dart` 狀態管理
- 擴展 `permission_aware_widget.dart` 功能
- 統一 `auth_guard.dart` 與新守衛邏輯
- 升級 `shell_pages.dart` 權限配置

**統一權限控制**：
- 路由級：透過 `guardRoute()` 統一檢查
- 元件級：透過權限感知按鈕動態控制
- 功能級：透過 `checkFeaturePermission()` 即時驗證
- 提示級：透過智能對話框引導用戶操作

**用戶體驗優化**：
- 根據權限狀態顯示不同提示訊息
- 提供明確的解決方案（驗證、聯繫客服、重新啟用）
- 保持 UI 一致性（禁用狀態、鎖定圖標）
- 避免突然跳轉，優先顯示對話框說明

### 順序8：歷史任務與未評價快捷 ✅
**目標**：實作任務歷史查看與快捷評價功能
- [x] T1-BE-HISTORY-ENDPOINTS：GET /tasks/history?role=poster|acceptor
- [x] T2-FLT-HISTORY-UI：history_page 與 review_dialog
- **狀態**：✅ 完成 - 任務歷史查看與快捷評價功能已完整實作

#### 後端 API 實作詳情 ✅
- **任務歷史 API** (`backend/api/tasks/history.php`)：
  - 支援 `role` 參數：`poster`（發布者）或 `acceptor`（接受者）
  - 完整的分頁支援：`page`, `per_page` 參數
  - 雙向評價狀態檢查：已評價/未評價/可評價標記
  - 任務詳細資訊：標題、描述、獎勵點數、狀態、參與者資訊
  - 統計資訊：總任務數、未評價數量、分頁資訊
  - JWT 認證與權限檢查

- **評價提交 API** (`backend/api/tasks/reviews_submit.php`)：
  - 完整重構：從舊版多維評價改為單一 1-5 星評價
  - 雙向評價支援：發布者評價接受者、接受者評價發布者
  - 嚴格權限檢查：任務狀態、用戶角色、重複評價防護
  - 操作日誌記錄：記錄評價提交到 `user_activity_logs`
  - 資料庫完整性：使用現有 `task_ratings` 表結構

#### 前端 UI 實作詳情 ✅
- **API 服務層** (`lib/services/api/review_api.dart`)：
  - `TaskHistoryApi.getTaskHistory()`：獲取任務歷史列表
  - `ReviewApi.submitReview()`：提交任務評價
  - `ReviewApi.getReview()`：獲取任務評價
  - 完整的錯誤處理與網路異常處理

- **評價對話框** (`lib/widgets/review_dialog.dart`)：
  - **ReviewDialog**：完整的評價提交對話框
    - 5星評分系統（Poor/Fair/Good/Very Good/Excellent）
    - 可選評論輸入（最多200字）
    - 任務與被評價者資訊顯示
    - 載入狀態與錯誤處理
    - 成功提交後自動刷新父組件
  - **QuickReviewButton**：快捷評價按鈕
    - 條件式顯示（僅未評價任務）
    - 一鍵開啟評價對話框
    - 評價完成後回調通知

- **任務歷史頁面** (`lib/account/pages/task_history_page.dart`)：
  - **雙標籤介面**：Posted（發布的）/ Accepted（接受的）
  - **完整功能列表**：
    - 下拉刷新與分頁載入
    - 未評價任務統計提示
    - 任務卡片詳細資訊展示
    - 狀態標籤與顏色編碼
    - 相對時間顯示（X天前/小時前）
  - **智能評價按鈕**：
    - 僅在可評價任務顯示 Review 按鈕
    - 已評價任務顯示 "Reviewed" 標記
    - 點擊開啟評價對話框
    - 評價完成後即時刷新列表

#### 技術實現特色 ✅
**資料庫整合**：
- 複雜 SQL 查詢：多表 JOIN（tasks, task_applications, task_statuses, users, task_ratings）
- 雙向評價邏輯：區分發布者評價接受者 vs 接受者評價發布者
- 評價狀態計算：`has_reviewed_*`, `can_review`, `received_rating`
- 分頁與統計：高效的 COUNT 查詢與分頁計算

**用戶體驗優化**：
- **即時反饋**：評價提交後立即更新 UI 狀態
- **智能提示**：未評價任務數量統計與醒目提示
- **載入狀態**：完整的載入指示器與錯誤重試
- **空狀態處理**：友好的空列表提示與引導

**評價系統設計**：
- **簡化評分**：從複雜多維評價簡化為直觀 1-5 星
- **防重複評價**：資料庫層級唯一約束防護
- **權限控制**：嚴格檢查任務狀態與用戶角色
- **審計追蹤**：完整的操作日誌記錄

**前端架構優化**：
- **狀態管理**：本地狀態與 API 資料同步
- **組件複用**：評價對話框與快捷按鈕組件化
- **錯誤處理**：統一的異常處理與用戶提示
- **性能優化**：分頁載入減少記憶體佔用

### 順序9：用戶帳號設定模組 ✅
**目標**：完整的用戶帳號管理功能
- [x] T1-BE-CHANGE-PASSWORD：POST /account/change-password（驗舊密碼、強度）
- [x] T2-BE-REQUEST-RESET：POST /account/request-password-reset（寄送驗證連結）
- [x] T3-BE-RESET-PASSWORD：POST /account/reset-password（驗 token 重設）
- [x] T4-BE-DELETE-ACCOUNT：POST /account/delete（軟刪除，檢查活躍任務）
- [x] T5-FLT-ACCOUNT-SETTINGS：設定頁：改密碼/重設/停權/刪帳/恢復 UI
- [x] T6-FLT-PASSWORD-FORMS：密碼相關表單與驗證
- **狀態**：✅ 完成 - 用戶帳號設定模組已完整實作，安全性校驗完整

#### 後端 API 實作詳情 ✅
- **密碼變更 API** (`backend/api/account/change-password.php`)：
  - JWT 認證與用戶身份驗證
  - 當前密碼驗證：使用 `password_verify()` 檢查
  - 密碼強度檢查：最少8字元、包含大小寫字母和數字
  - 防重複密碼：檢查新密碼不得與當前密碼相同
  - 操作日誌記錄：記錄到 `user_activity_logs` 表
  - 安全性：密碼使用 `PASSWORD_DEFAULT` 雜湊演算法

- **密碼重設請求 API** (`backend/api/account/request-password-reset.php`)：
  - 郵件地址驗證與用戶存在性檢查
  - 安全性考量：即使用戶不存在也返回成功訊息
  - Token 生成：使用 `bin2hex(random_bytes(32))` 產生64字元安全 token
  - 過期機制：1小時後自動過期
  - 防重複請求：自動清理舊的未過期請求
  - 郵件發送：HTML 格式重設連結，包含過期提醒
  - 整合現有表結構：使用 `email_verification_tokens` 表的 `password_reset` 類型

- **密碼重設確認 API** (`backend/api/account/reset-password.php`)：
  - Token 驗證：檢查 token 有效性、過期時間、使用狀態
  - 雙重驗證：同時驗證 token 和 email 匹配
  - 密碼強度檢查：與變更密碼相同的安全要求
  - 一次性使用：重設成功後立即標記 token 為已使用
  - 資料庫交易：確保密碼更新和 token 標記的原子性
  - 防重複密碼：檢查新密碼不得與當前密碼相同

- **帳號刪除 API** (`backend/api/account/delete.php`)：
  - 密碼確認：要求輸入當前密碼驗證身份
  - 刪除原因記錄：強制要求提供刪除原因
  - 活躍任務檢查：防止有進行中任務時刪除帳號
  - 活躍聊天檢查：防止有活躍聊天室時刪除帳號
  - 權限檢查：被管理員停權的帳號需聯繫客服刪除
  - 軟刪除機制：設置 `permission = -4`, `status = 'self_deleted'`
  - 資料匿名化：清除敏感資料（email、phone、avatar）
  - 完整日誌：記錄刪除原因和操作詳情

#### 前端 UI 實作詳情 ✅
- **密碼 API 服務** (`lib/services/api/password_api.dart`)：
  - `changePassword()`：密碼變更 API 呼叫
  - `requestPasswordReset()`：密碼重設請求
  - `resetPassword()`：密碼重設確認
  - `deleteAccount()`：帳號刪除
  - 統一的錯誤處理與網路異常處理

- **密碼變更組件** (`lib/account/pages/change_password.dart`)：
  - **兩階段驗證流程**：先輸入當前和新密碼，再確認新密碼
  - **即時驗證**：欄位完整性檢查和密碼匹配驗證
  - **載入狀態**：API 呼叫期間顯示載入指示器
  - **錯誤處理**：友好的錯誤訊息顯示
  - **成功回饋**：密碼變更成功後顯示 SnackBar 並關閉編輯模式

- **密碼重設頁面** (`lib/auth/pages/reset_password_page.dart`)：
  - **URL 參數驗證**：檢查 token 和 email 參數完整性
  - **密碼強度提示**：清楚顯示密碼要求（8字元、大小寫、數字）
  - **密碼可見性切換**：新密碼和確認密碼的顯示/隱藏切換
  - **即時驗證**：密碼匹配檢查和強度驗證
  - **自動跳轉**：重設成功後自動跳轉到登入頁面
  - **錯誤處理**：Token 無效時顯示錯誤並跳轉

- **忘記密碼頁面** (`lib/auth/pages/forgot_password_page.dart`)：
  - **Email 驗證**：即時 email 格式驗證
  - **雙狀態 UI**：發送前的輸入狀態和發送後的確認狀態
  - **成功反饋**：發送成功後顯示確認訊息和 email 地址
  - **重新發送**：提供重新發送功能
  - **使用提示**：包含檢查垃圾郵件、過期時間等提醒

- **安全設定頁面** (`lib/account/pages/security_page.dart`)：
  - **整合現有功能**：保留原有的帳號停用/啟用功能
  - **危險區域**：明確標示帳號刪除為危險操作
  - **刪除確認對話框**：
    - 密碼確認輸入
    - 刪除原因必填
    - 警告訊息顯示
    - 載入狀態處理
  - **完整流程**：刪除成功後清除本地資料並跳轉登入

#### 技術實現特色 ✅
**安全性設計**：
- **密碼強度要求**：8字元以上、包含大小寫字母和數字
- **防暴力破解**：密碼重設 token 1小時過期
- **一次性使用**：重設 token 使用後立即失效
- **身份驗證**：所有敏感操作都需要密碼確認
- **操作審計**：完整的操作日誌記錄

**用戶體驗優化**：
- **分階段操作**：密碼變更採用兩階段確認流程
- **即時反饋**：表單驗證和 API 回應的即時顯示
- **載入狀態**：所有 API 呼叫都有載入指示器
- **錯誤處理**：友好的錯誤訊息和恢復建議
- **成功引導**：操作成功後的明確下一步指引

**資料庫整合**：
- **現有表結構**：充分利用 `email_verification_tokens` 表
- **軟刪除機制**：保留資料完整性的同時實現帳號刪除
- **交易安全**：關鍵操作使用資料庫交易確保一致性
- **日誌完整性**：所有操作都記錄到 `user_activity_logs`

**前端架構優化**：
- **組件複用**：密碼輸入組件的可見性切換功能
- **狀態管理**：本地狀態與 API 資料的同步
- **路由整合**：密碼重設流程與現有路由系統整合
- **錯誤邊界**：完善的異常處理和用戶提示

### 順序10：聊天功能增強 ✅
**目標**：實作聊天室滑動工具列與動作矩陣
- [x] T1-FLT-POST-SWIPE：/chat POST 分頁滑動工具列（Slidable/Dismissible + 可擴充動作列）
- [x] T2-BE-POST-ACTIONS：補齊 Read/Delete/Reject 相關 API
- [x] T3-FLT-ACTION-BAR-MATRIX：1v1 聊天室 Action Bar（狀態×角色矩陣）
- [x] T4-BE-ACTION-ENDPOINTS：補齊任務狀態變更端點與 task_logs 紀錄
- **狀態**：✅ 完成 - 聊天功能增強已完整實作，滑動操作與動態 Action Bar 系統完成

#### 前端滑動工具列實作詳情 ✅
- **應徵者卡片滑動功能** (`lib/chat/widgets/posted_tasks_widget.dart`)：
  - **Slidable 整合**：使用 `flutter_slidable` 套件實現左右滑動操作
  - **動態動作配置**：根據應徵狀態（applied/accepted/rejected）動態顯示不同的滑動動作
  - **狀態條件邏輯**：
    - `applied`：Read（標記已讀）、Reject（拒絕）、Delete（刪除）
    - `accepted`：Read（標記已讀）、Cancel（取消接受）
    - `rejected`：Read（標記已讀）、Delete（刪除）
    - `其他狀態`：僅 Read（標記已讀）
  - **確認對話框**：破壞性操作（拒絕、刪除）需要用戶確認
  - **即時反饋**：操作完成後顯示 SnackBar 並自動刷新數據
  - **錯誤處理**：API 失敗時顯示錯誤訊息

- **滑動動作實作方法**：
  - `_markAsRead()`：標記聊天室為已讀，清除未讀數
  - `_rejectApplication()`：調用 TaskService 拒絕應徵
  - `_deleteApplication()`：調用 TaskService 刪除應徵
  - `_cancelAcceptance()`：取消已接受的應徵，恢復為 applied 狀態
  - `_showConfirmDialog()`：通用確認對話框
  - `_refreshApplications()`：刷新應徵數據

#### 後端 API 實作詳情 ✅
- **應徵狀態更新 API** (`backend/api/tasks/applications/update-status.php`)：
  - **JWT 認證**：驗證用戶身份和權限
  - **權限檢查**：只有任務創建者可以更新應徵狀態
  - **狀態驗證**：支援 applied/accepted/rejected/cancelled 狀態
  - **自動拒絕邏輯**：接受一個應徵時自動拒絕同任務的其他應徵
  - **資料庫交易**：確保狀態更新的原子性
  - **操作日誌**：記錄所有狀態變更到 `user_activity_logs`
  - **防重複操作**：檢查當前狀態避免重複更新

- **應徵刪除 API** (`backend/api/tasks/applications/delete.php`)：
  - **軟刪除機制**：設置 `deleted_at` 而非真正刪除記錄
  - **狀態限制**：不能刪除已接受的應徵，需先拒絕
  - **權限驗證**：只有任務創建者可以刪除應徵
  - **完整日誌**：記錄刪除操作的詳細信息
  - **錯誤處理**：友好的錯誤訊息和狀態碼

#### 動態 Action Bar 系統實作詳情 ✅
- **Action Bar 配置管理器** (`lib/chat/utils/action_bar_config.dart`)：
  - **ActionBarAction 類**：定義動作的屬性（ID、標籤、圖標、回調、顏色等）
  - **狀態和角色枚舉**：TaskStatus 和 UserRole 枚舉定義
  - **動作配置矩陣**：根據任務狀態和用戶角色的組合返回可用動作
  - **確認機制**：支援需要確認的破壞性操作
  - **狀態解析器**：字符串狀態轉換為枚舉的工具方法
  - **視覺配置**：狀態顏色和圖標的統一管理

- **動態 Action Bar 組件** (`lib/chat/widgets/dynamic_action_bar.dart`)：
  - **DynamicActionBar 組件**：主要的動態 Action Bar 實現
  - **狀態顯示條**：顯示任務狀態、進度條和狀態圖標
  - **玻璃效果背景**：使用 BackdropFilter 實現毛玻璃效果
  - **動作按鈕渲染**：根據配置動態生成操作按鈕
  - **確認對話框**：自動處理需要確認的操作
  - **ActionBarBuilder**：提供更靈活的構建方式

- **聊天詳情頁面整合** (`lib/chat/pages/chat_detail_page.dart`)：
  - **新舊系統並存**：保留舊的 Action Bar 實作作為向後相容
  - **動作回調映射**：`_buildActionCallbacks()` 方法映射動作到具體實現
  - **狀態解析**：使用 ActionBarConfigManager 解析任務狀態和用戶角色
  - **TaskStatus 命名衝突解決**：使用 alias 避免與現有 TaskStatus 類衝突
  - **統一的動作處理**：所有動作都通過統一的處理方法實現

#### 技術實現特色 ✅
**可擴充架構**：
- **配置驅動**：動作配置與 UI 渲染分離，易於擴展新狀態和動作
- **組件化設計**：Action Bar 組件可在不同頁面重用
- **狀態矩陣**：清晰的狀態×角色矩陣，易於理解和維護
- **Builder 模式**：ActionBarBuilder 提供靈活的動作組合方式

**用戶體驗優化**：
- **滑動手勢**：直觀的左右滑動操作，符合移動端使用習慣
- **視覺反饋**：不同動作使用不同顏色和圖標區分
- **確認機制**：破壞性操作需要二次確認，防止誤操作
- **即時更新**：操作完成後立即更新 UI 狀態

**安全性設計**：
- **權限驗證**：所有後端 API 都有完整的權限檢查
- **狀態驗證**：防止非法的狀態轉換
- **操作審計**：完整的操作日誌記錄
- **資料庫交易**：確保數據一致性

**性能優化**：
- **軟刪除**：保留數據完整性的同時實現邏輯刪除
- **批量操作**：接受應徵時自動處理其他相關應徵
- **快取刷新**：操作完成後智能刷新相關數據
- **錯誤邊界**：完善的異常處理和用戶提示

### 順序11：任務自動完成與申訴流程 📋
**目標**：實作任務自動完成機制與申訴處理
- [ ] T1-BE-AUTO-COMPLETE：排程：pending confirmation > 7 天 → completed（寫 task_logs）
- [ ] T2-FLT-DISPUTE-ACTION：Action Bar 觸發 → 轉 dispute 並停止倒數
- [ ] T3-LAR-ADMIN-DISPUTE-REVIEW：後台審核（含圖片）
- **驗收**：七日自動完成/申訴審核可用

### 順序12：客服事件系統 📋
**目標**：實作客服事件紀錄與管理系統
- [ ] T9-BE-SUPPORT-EVENTS：實作客服事件紀錄後端 API
- [ ] T10-FE-SUPPORT-EVENTS：實作客服事件前端介面
- **驗收**：客服事件系統可正常運作

### 順序13：任務功能增強 📋
**目標**：新增任務收藏與檢舉功能
- [ ] T11-BE-TASK-FEATURES：實作任務收藏與檢舉後端 API
- [ ] T12-FE-TASK-FEATURES：實作任務收藏與檢舉前端介面
- **驗收**：任務收藏與檢舉功能正常

### 順序14：安全加固 📋
**目標**：基本安全機制實作
- [ ] T-SH-CORS：設定 CORS 白名單（dev/stage/prod 分環境）
- [ ] T-SH-RATE-LIMIT：登入/註冊/檢舉/傳訊 API 節流（如 5 req/min）
- [ ] T-SH-JWT-BASICS：JWT 期限/Refresh Token 基本輪替；黑名單撤銷端點
- **驗收**：關鍵端點節流生效；跨域正確；JWT 基本輪替可用

### 順序15：API 合約與錯誤碼 📋
**目標**：統一 API 回應格式與錯誤碼
- [ ] T-AC-ERROR-SPEC：定義統一格式 {success, code, message, data, traceId}
- [ ] T-AC-PAGINATION：統一分頁參數與回傳欄位
- [ ] T-AC-OPENAPI-MIN：以 OpenAPI 標註關鍵端點
- **驗收**：主要端點回應格式一致；OpenAPI 文檔可產生

### 順序16：監控與觀測性 📋
**目標**：集中化日誌與前端錯誤上報
- [ ] T-OB-LOGGING：後端加 traceId；記錄 4xx/5xx 與主要商務事件
- [ ] T-OB-FLT-ERROR：Flutter 全域錯誤上報 hook（含裝置/版本）
- [ ] T-OB-ALERT-MIN：簡單警示：API 5xx 連續 N 次觸發通知
- **驗收**：可由 traceId 追查錯誤；5xx 連續觸發能通知

### 順序17：資料治理 📋
**目標**：避免型別不一致與資料遺失的最小治理
- [ ] T-DG-ID-AUDIT：列出所有 id/FK 型別差異清單與準備遷移計畫
- [ ] T-DG-BACKUP：建立每日/每 6 小時 DB 備份腳本與還原演練步驟
- [ ] T-DG-RETENTION：定義最低限度資料保留/清理策略
- **驗收**：有型別差異清單與備份/還原 SOP；最低限度保留策略就緒

### 順序18：媒體處理 📋
**目標**：聊天室/申訴圖片的上傳規範與風險控管
- [ ] T-MP-LIMITS：檔案大小/類型白名單與壓縮策略
- [ ] T-MP-STORAGE：S3/本機儲存切換與清理排程
- [ ] T-MP-SCAN：掃毒/惡意檔阻擋流程（hook）
- **驗收**：超限與非法檔案被阻擋；存放與清理規則生效

### 順序19：通知策略 📋
**目標**：推播/站內/Email 的規則與頻率，使用者可控
- [ ] T-NP-MATRIX：事件→通知矩陣（任務/聊天/客服/審核）
- [ ] T-NP-SETTINGS：使用者通知偏好設定 UI
- **驗收**：事件→通知矩陣落地；前端可調整偏好

### 順序20：離線模式與斷線恢復 📋
**目標**：聊天室與列表的快取與重連策略
- [ ] T-OR-CACHE：列表快取與失效策略（最新 N 筆）
- [ ] T-OR-RETRY：Socket 重連與退避（backoff）
- **驗收**：列表離線可瀏覽；斷線可自動重連與退避

### 順序21：無障礙與空/錯誤狀態 📋
**目標**：字級、對比度、螢幕閱讀、可鍵盤操作
- [ ] T-A11Y-FONT：動態字級與可讀性檢查
- [ ] T-A11Y-ARIA：Semantics 標註與可鍵盤操作
- [ ] T-EES-TEMPLATES：空/錯頁模板組件（可參數化圖示/文案/CTA）
- **驗收**：主要流程具可讀性與空/錯態一致樣板

## 🎯 當前執行狀態

**目前位置**：順序5 - 管理員後台詳細頁面開發
**已完成**：順序1-4 (OAuth流程、管理員後台基礎架構)
**進行中**：Vue.js 管理介面詳細功能實作
**下一步**：完成管理員後台後，進入順序6帳號安全與保護模組

## 順序3完成狀況 ✅

### 1. OAuth 流程整合完成

#### 修改檔案
- **`lib/auth/services/third_party_auth_service.dart`**
  - 重構：Web 版 Google/Facebook/Apple 登入使用真實 OAuth 流程
  - 移除：模擬資料，改為直接重定向到 OAuth 授權頁面
  - 新增：統一的 OAuth 流程啟動機制
  - 更新：`_sendUserDataToBackend` 方法支援新的 API 端點
  - 整合：所有第三方登入提供商使用相同的 token 化流程

- **`lib/auth/pages/auth_callback_page.dart`**
  - 新增：支援新用戶 OAuth token 處理邏輯
  - 新增：`_redirectToSignupPage` 方法處理新用戶重定向
  - 修改：`_handleLoginSuccess` 方法區分新用戶與現有用戶
  - 優化：UI 顯示邏輯，正確處理不同的用戶狀態
  - 整合：完整的錯誤處理與用戶體驗

### 2. 技術實現細節

#### 統一 OAuth 流程
1. **Web 版第三方登入**：
   - Google：重定向至 `accounts.google.com/o/oauth2/v2/auth`
   - Facebook：重定向至 `www.facebook.com/v18.0/dialog/oauth`
   - Apple：重定向至 `appleid.apple.com/auth/authorize`
   - 所有提供商都重定向到對應的 `{provider}-callback.php`

2. **回調處理**：
   - 新用戶：後端返回 `oauth_token` → 前端重定向 `/signup?oauth_token=...`
   - 現有用戶：後端返回 `token` + `user_data` → 前端重定向 `/home`
   - 錯誤：統一錯誤處理與用戶提示

3. **移動版兼容**：
   - 保留原有的 Google Sign-In SDK 整合
   - 使用統一的後端 API 端點
   - 支援 iOS/Android 平台特定功能

#### 用戶體驗優化
- 統一的載入狀態與進度指示
- 清晰的錯誤訊息與重試機制
- 新用戶與現有用戶的差異化處理
- 自動重定向與手動操作選項

### 3. 測試結果

#### 語法檢查 ✅
```bash
flutter analyze lib/auth/services/third_party_auth_service.dart lib/auth/pages/auth_callback_page.dart
# 結果：40 issues found (均為 info/warning，無錯誤)
```

#### 流程驗證 ✅
- [x] Google Web OAuth 流程：正確生成授權 URL 並啟動流程
- [x] Facebook Web OAuth 流程：正確配置並支援回調
- [x] Apple Web OAuth 流程：正確配置並支援回調
- [x] 回調頁面處理：正確區分新用戶與現有用戶
- [x] 錯誤處理：統一的錯誤提示與重試機制
- [x] 移動版兼容：保持原有功能不受影響

### 4. 完整流程整合
- [x] 前端 OAuth 啟動：三大提供商統一流程
- [x] 後端回調處理：token 化流程完整實現
- [x] 前端回調處理：新舊用戶正確分流
- [x] 註冊流程整合：OAuth token 預填與註冊
- [x] 錯誤處理機制：端對端錯誤處理與用戶體驗

## 順序2完成狀況 ✅

### 1. 前端 OAuth 註冊完成

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：`_handleOAuthRegistration()` 使用新的 token 化流程
  - 新增：從 URL 參數 `oauth_token` 獲取 token 並調用 API
  - 新增：`_getSchoolValue()` 輔助方法處理學校資料
  - 新增：`_showTokenExpiredDialog()` 處理 token 過期情況
  - 修改：`_handleSubmit()` 正確判斷 OAuth vs 傳統註冊流程
  - 整合：完整的錯誤處理與用戶提示機制

#### 後端 API 更新
- **`backend/api/auth/register-oauth.php`**
  - 修改：從 session 方式改為 token 化流程
  - 新增：接收 `oauth_token` 參數並從 `oauth_temp_users` 表消費
  - 新增：交易式處理確保資料一致性
  - 新增：token 消費後自動刪除，確保一次性使用
  - 保留：完整的錯誤處理與日誌記錄

### 2. 技術實現細節

#### OAuth 註冊流程
1. **前端接收 token**：從 URL 參數 `?oauth_token=xxx` 獲取
2. **API 調用**：POST `/auth/register-oauth.php` 傳遞 token 與表單資料
3. **後端處理**：
   - 驗證 token 有效性與過期時間
   - 從 `oauth_temp_users` 獲取 OAuth 資料
   - 建立 `users` 與 `user_identities` 記錄
   - 刪除臨時 token（消費）
   - 生成 JWT 並返回
4. **前端處理**：保存登入資訊並導向 `/signup/student-id`

#### 錯誤處理機制
- Token 過期/無效：顯示專用對話框建議重新登入
- API 錯誤：顯示具體錯誤訊息
- 網路錯誤：顯示通用錯誤提示
- 表單驗證：保持原有驗證邏輯

### 3. 測試結果

#### API 測試 ✅
```bash
# 無效 token 測試
curl -X POST -H 'Content-Type: application/json' \
  -d '{"oauth_token":"INVALID_TOKEN","name":"Test User"}' \
  http://localhost:8888/here4help/backend/api/auth/register-oauth.php
# 結果：{"success":false,"message":"OAuth token expired or invalid"}
```

#### 語法檢查 ✅
```bash
php -l backend/api/auth/register-oauth.php
# 結果：No syntax errors detected

flutter analyze lib/auth/pages/signup_page.dart
# 結果：45 issues found (均為 info/warning，無錯誤)
```

### 4. 完整流程驗證
- [x] 新用戶 OAuth 流程：Google 登入 → 暫存 → 重定向 `/signup?oauth_token=...`
- [x] 前端 token 預填：自動讀取 token 並調用 API 獲取預填資料
- [x] 註冊 API 調用：token 化 API 正確處理表單提交
- [x] 錯誤處理：token 過期、API 錯誤、網路錯誤均有適當處理
- [x] 成功流程：註冊成功後正確導向 `/signup/student-id`

## 順序1完成狀況 ✅

### 1. 後端部分

#### 新增檔案
- **`backend/api/auth/oauth-temp.php`**
  - 功能：處理臨時 OAuth 用戶資料的查詢與消費
  - 支援 `peek=true` 參數進行資料查看而不刪除
  - 驗證 token 有效性與過期時間
  - 返回用戶基本資料（provider, email, name, avatar_url）

#### 修改檔案
- **`backend/api/auth/google-callback.php`**
  - 新增：新用戶資料存入 `oauth_temp_users` 表
  - 新增：生成一次性 `tempToken` 與 `expired_at` 時間戳
  - 修改：新用戶重定向至 `/signup?oauth_token=...`
  - 保留：現有用戶仍獲得 JWT 並重定向至 `/home`

### 2. 前端部分

#### 新增檔案
- **`lib/services/api/oauth_api.dart`**
  - 功能：OAuth 臨時資料 API 服務
  - 方法：`fetchTempUser(String token)` 查詢臨時用戶資料
  - 整合：使用 `AppConfig.apiBaseUrl` 與 debug 日誌

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：支援 URL 參數 `?token=` 的 OAuth 預填
  - 新增：`_loadThirdPartyData()` 中優先處理 token 參數
  - 保留：原有的 `widget.oauthData` 與 SharedPreferences 備用機制
  - 整合：`OAuthApi.fetchTempUser()` 調用

### 3. 資料庫結構
- **`oauth_temp_users` 表** (已建立)
  - 欄位：provider, provider_user_id, email, name, avatar_url, raw_data, token, expired_at
  - 用途：暫存第三方登入的新用戶資料
  - 過期機制：1小時自動過期

## 技術實現細節

### OAuth 流程
1. **用戶點擊 Google 登入**
2. **後端處理**：
   - 檢查是否為新用戶
   - 新用戶：存入 `oauth_temp_users`，生成 tempToken
   - 現有用戶：直接登入並獲得 JWT
3. **前端處理**：
   - 新用戶：重定向至 `/signup?oauth_token=xxx`
   - 現有用戶：重定向至 `/home`
4. **註冊頁面**：
   - 自動讀取 URL 中的 `oauth_token`
   - 調用 `OAuthApi.fetchTempUser()` 獲取預填資料
   - 預填表單欄位（name, email, avatar_url）

### 錯誤處理
- Token 過期或無效時返回 404
- API 調用失敗時記錄 debug 日誌
- 預填失敗時不影響正常註冊流程

## 測試結果

### 語法檢查 ✅
```bash
flutter analyze
# 結果：633 issues found (均為 info/warning，無錯誤)
# 新檔案無語法錯誤
```

### 後端檢查 ✅
```bash
php -l backend/api/auth/google-callback.php
# 結果：No syntax errors detected

php -l backend/api/auth/oauth-temp.php  
# 結果：No syntax errors detected
```

### 功能驗證
- [x] 新用戶 OAuth 流程
- [x] 現有用戶 OAuth 流程  
- [x] Token 預填機制
- [x] 錯誤處理機制
- [x] 過期時間驗證

## 下一步計劃

### 順序3：OAuth 流程整合 (PR3) ✅
- [x] 更新 `third_party_auth_service.dart` 整合新的回調流程
- [x] 確保 Facebook 和 Apple 登入使用相同的 token 化流程
- [x] 更新 `auth_callback_page.dart` 處理新的重定向邏輯
- [x] 端對端測試完整 OAuth 流程並優化用戶體驗

### 順序4：管理員後台基礎 (PR4)
- [ ] 建立 Laravel 管理員後台基礎架構
- [ ] 設定 RBAC 與稽核資料表
- [ ] 實作管理員登入與權限控制
- [ ] 建立路由樹與中介層

### 順序5：用戶帳戶安全 (PR5)
- [ ] 實作密碼修改功能
- [ ] 建立重設密碼驗證信機制
- [ ] 用戶自主停權與帳號刪除功能
- [ ] 停權恢復流程

## 注意事項

### 環境配置
- 確保 `FRONTEND_URL` 設定為 `http://localhost:3000`
- 確保 Google Cloud Console 已配置正確的 redirect URI
- 確保 `oauth_temp_users` 表已建立

### 開發建議
- 使用 debug 模式查看詳細日誌
- 測試時注意 token 的 1 小時過期限制
- 建議在生產環境中調整過期時間

## 相關文件
- `docs/優先執行/高階專案分析指令.md`
- `docs/PLAN.md`
- `docs/plan.json`
- `docs/優先執行/專案修改指南（Chief Architect 版）.md`

---

**更新記錄**
- 2025-01-11: 完成順序1，建立進度追蹤文件
- 2025-01-11: 完成順序2，OAuth 註冊流程整合完成
- 2025-01-11: 完成順序3，OAuth 流程整合與第三方登入統一化
