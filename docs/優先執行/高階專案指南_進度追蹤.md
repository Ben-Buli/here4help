# 高階專案指南進度追蹤表

## 專案概述
- **專案名稱**: Here4Help Flutter App
- **當前階段**: 順序1 - OAuth 流程閉環完成
- **完成日期**: 2025-01-11
- **主要目標**: 實現第三方登入首次導引註冊的完整流程

## 順序1完成狀況 ✅

## 順序2完成狀況 ✅

## 順序3完成狀況 ✅

### 1. OAuth 流程整合完成

#### 修改檔案
- **`lib/auth/services/third_party_auth_service.dart`**
  - 重構：Web 版 Google/Facebook/Apple 登入使用真實 OAuth 流程
  - 移除：模擬資料，改為直接重定向到 OAuth 授權頁面
  - 新增：統一的 OAuth 流程啟動機制
  - 更新：`_sendUserDataToBackend` 方法支援新的 API 端點
  - 整合：所有第三方登入提供商使用相同的 token 化流程

- **`lib/auth/pages/auth_callback_page.dart`**
  - 新增：支援新用戶 OAuth token 處理邏輯
  - 新增：`_redirectToSignupPage` 方法處理新用戶重定向
  - 修改：`_handleLoginSuccess` 方法區分新用戶與現有用戶
  - 優化：UI 顯示邏輯，正確處理不同的用戶狀態
  - 整合：完整的錯誤處理與用戶體驗

### 2. 技術實現細節

#### 統一 OAuth 流程
1. **Web 版第三方登入**：
   - Google：重定向至 `accounts.google.com/o/oauth2/v2/auth`
   - Facebook：重定向至 `www.facebook.com/v18.0/dialog/oauth`
   - Apple：重定向至 `appleid.apple.com/auth/authorize`
   - 所有提供商都重定向到對應的 `{provider}-callback.php`

2. **回調處理**：
   - 新用戶：後端返回 `oauth_token` → 前端重定向 `/signup?oauth_token=...`
   - 現有用戶：後端返回 `token` + `user_data` → 前端重定向 `/home`
   - 錯誤：統一錯誤處理與用戶提示

3. **移動版兼容**：
   - 保留原有的 Google Sign-In SDK 整合
   - 使用統一的後端 API 端點
   - 支援 iOS/Android 平台特定功能

#### 用戶體驗優化
- 統一的載入狀態與進度指示
- 清晰的錯誤訊息與重試機制
- 新用戶與現有用戶的差異化處理
- 自動重定向與手動操作選項

### 3. 測試結果

#### 語法檢查 ✅
```bash
flutter analyze lib/auth/services/third_party_auth_service.dart lib/auth/pages/auth_callback_page.dart
# 結果：40 issues found (均為 info/warning，無錯誤)
```

#### 流程驗證 ✅
- [x] Google Web OAuth 流程：正確生成授權 URL 並啟動流程
- [x] Facebook Web OAuth 流程：正確配置並支援回調
- [x] Apple Web OAuth 流程：正確配置並支援回調
- [x] 回調頁面處理：正確區分新用戶與現有用戶
- [x] 錯誤處理：統一的錯誤提示與重試機制
- [x] 移動版兼容：保持原有功能不受影響

### 4. 完整流程整合
- [x] 前端 OAuth 啟動：三大提供商統一流程
- [x] 後端回調處理：token 化流程完整實現
- [x] 前端回調處理：新舊用戶正確分流
- [x] 註冊流程整合：OAuth token 預填與註冊
- [x] 錯誤處理機制：端對端錯誤處理與用戶體驗

## 順序2完成狀況 ✅

### 1. 前端 OAuth 註冊完成

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：`_handleOAuthRegistration()` 使用新的 token 化流程
  - 新增：從 URL 參數 `oauth_token` 獲取 token 並調用 API
  - 新增：`_getSchoolValue()` 輔助方法處理學校資料
  - 新增：`_showTokenExpiredDialog()` 處理 token 過期情況
  - 修改：`_handleSubmit()` 正確判斷 OAuth vs 傳統註冊流程
  - 整合：完整的錯誤處理與用戶提示機制

#### 後端 API 更新
- **`backend/api/auth/register-oauth.php`**
  - 修改：從 session 方式改為 token 化流程
  - 新增：接收 `oauth_token` 參數並從 `oauth_temp_users` 表消費
  - 新增：交易式處理確保資料一致性
  - 新增：token 消費後自動刪除，確保一次性使用
  - 保留：完整的錯誤處理與日誌記錄

### 2. 技術實現細節

#### OAuth 註冊流程
1. **前端接收 token**：從 URL 參數 `?oauth_token=xxx` 獲取
2. **API 調用**：POST `/auth/register-oauth.php` 傳遞 token 與表單資料
3. **後端處理**：
   - 驗證 token 有效性與過期時間
   - 從 `oauth_temp_users` 獲取 OAuth 資料
   - 建立 `users` 與 `user_identities` 記錄
   - 刪除臨時 token（消費）
   - 生成 JWT 並返回
4. **前端處理**：保存登入資訊並導向 `/signup/student-id`

#### 錯誤處理機制
- Token 過期/無效：顯示專用對話框建議重新登入
- API 錯誤：顯示具體錯誤訊息
- 網路錯誤：顯示通用錯誤提示
- 表單驗證：保持原有驗證邏輯

### 3. 測試結果

#### API 測試 ✅
```bash
# 無效 token 測試
curl -X POST -H 'Content-Type: application/json' \
  -d '{"oauth_token":"INVALID_TOKEN","name":"Test User"}' \
  http://localhost:8888/here4help/backend/api/auth/register-oauth.php
# 結果：{"success":false,"message":"OAuth token expired or invalid"}
```

#### 語法檢查 ✅
```bash
php -l backend/api/auth/register-oauth.php
# 結果：No syntax errors detected

flutter analyze lib/auth/pages/signup_page.dart
# 結果：45 issues found (均為 info/warning，無錯誤)
```

### 4. 完整流程驗證
- [x] 新用戶 OAuth 流程：Google 登入 → 暫存 → 重定向 `/signup?oauth_token=...`
- [x] 前端 token 預填：自動讀取 token 並調用 API 獲取預填資料
- [x] 註冊 API 調用：token 化 API 正確處理表單提交
- [x] 錯誤處理：token 過期、API 錯誤、網路錯誤均有適當處理
- [x] 成功流程：註冊成功後正確導向 `/signup/student-id`

## 順序1完成狀況 ✅

### 1. 後端部分

#### 新增檔案
- **`backend/api/auth/oauth-temp.php`**
  - 功能：處理臨時 OAuth 用戶資料的查詢與消費
  - 支援 `peek=true` 參數進行資料查看而不刪除
  - 驗證 token 有效性與過期時間
  - 返回用戶基本資料（provider, email, name, avatar_url）

#### 修改檔案
- **`backend/api/auth/google-callback.php`**
  - 新增：新用戶資料存入 `oauth_temp_users` 表
  - 新增：生成一次性 `tempToken` 與 `expired_at` 時間戳
  - 修改：新用戶重定向至 `/signup?oauth_token=...`
  - 保留：現有用戶仍獲得 JWT 並重定向至 `/home`

### 2. 前端部分

#### 新增檔案
- **`lib/services/api/oauth_api.dart`**
  - 功能：OAuth 臨時資料 API 服務
  - 方法：`fetchTempUser(String token)` 查詢臨時用戶資料
  - 整合：使用 `AppConfig.apiBaseUrl` 與 debug 日誌

#### 修改檔案
- **`lib/auth/pages/signup_page.dart`**
  - 新增：支援 URL 參數 `?token=` 的 OAuth 預填
  - 新增：`_loadThirdPartyData()` 中優先處理 token 參數
  - 保留：原有的 `widget.oauthData` 與 SharedPreferences 備用機制
  - 整合：`OAuthApi.fetchTempUser()` 調用

### 3. 資料庫結構
- **`oauth_temp_users` 表** (已建立)
  - 欄位：provider, provider_user_id, email, name, avatar_url, raw_data, token, expired_at
  - 用途：暫存第三方登入的新用戶資料
  - 過期機制：1小時自動過期

## 技術實現細節

### OAuth 流程
1. **用戶點擊 Google 登入**
2. **後端處理**：
   - 檢查是否為新用戶
   - 新用戶：存入 `oauth_temp_users`，生成 tempToken
   - 現有用戶：直接登入並獲得 JWT
3. **前端處理**：
   - 新用戶：重定向至 `/signup?oauth_token=xxx`
   - 現有用戶：重定向至 `/home`
4. **註冊頁面**：
   - 自動讀取 URL 中的 `oauth_token`
   - 調用 `OAuthApi.fetchTempUser()` 獲取預填資料
   - 預填表單欄位（name, email, avatar_url）

### 錯誤處理
- Token 過期或無效時返回 404
- API 調用失敗時記錄 debug 日誌
- 預填失敗時不影響正常註冊流程

## 測試結果

### 語法檢查 ✅
```bash
flutter analyze
# 結果：633 issues found (均為 info/warning，無錯誤)
# 新檔案無語法錯誤
```

### 後端檢查 ✅
```bash
php -l backend/api/auth/google-callback.php
# 結果：No syntax errors detected

php -l backend/api/auth/oauth-temp.php  
# 結果：No syntax errors detected
```

### 功能驗證
- [x] 新用戶 OAuth 流程
- [x] 現有用戶 OAuth 流程  
- [x] Token 預填機制
- [x] 錯誤處理機制
- [x] 過期時間驗證

## 下一步計劃

### 順序3：OAuth 流程整合 (PR3) ✅
- [x] 更新 `third_party_auth_service.dart` 整合新的回調流程
- [x] 確保 Facebook 和 Apple 登入使用相同的 token 化流程
- [x] 更新 `auth_callback_page.dart` 處理新的重定向邏輯
- [x] 端對端測試完整 OAuth 流程並優化用戶體驗

### 順序4：管理員後台基礎 (PR4)
- [ ] 建立 Laravel 管理員後台基礎架構
- [ ] 設定 RBAC 與稽核資料表
- [ ] 實作管理員登入與權限控制
- [ ] 建立路由樹與中介層

### 順序5：用戶帳戶安全 (PR5)
- [ ] 實作密碼修改功能
- [ ] 建立重設密碼驗證信機制
- [ ] 用戶自主停權與帳號刪除功能
- [ ] 停權恢復流程

## 注意事項

### 環境配置
- 確保 `FRONTEND_URL` 設定為 `http://localhost:3000`
- 確保 Google Cloud Console 已配置正確的 redirect URI
- 確保 `oauth_temp_users` 表已建立

### 開發建議
- 使用 debug 模式查看詳細日誌
- 測試時注意 token 的 1 小時過期限制
- 建議在生產環境中調整過期時間

## 相關文件
- `docs/優先執行/高階專案分析指令.md`
- `docs/PLAN.md`
- `docs/plan.json`
- `docs/優先執行/專案修改指南（Chief Architect 版）.md`

---

**更新記錄**
- 2025-01-11: 完成順序1，建立進度追蹤文件
- 2025-01-11: 完成順序2，OAuth 註冊流程整合完成
- 2025-01-11: 完成順序3，OAuth 流程整合與第三方登入統一化
