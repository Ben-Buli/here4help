# 權限拒絕頁面返回邏輯優化報告

## 📋 **問題描述**

用戶反映當從 `/task` 頁面嘗試訪問 `/chat` 被權限阻擋重定向到 `/permission-denied` 頁面時，點擊返回按鈕會嘗試返回到 `/chat`（被阻擋的頁面），而不是真正的上一頁 `/task`。

### **問題場景**：
```
用戶在 /task → 嘗試訪問 /chat → 權限不足重定向到 /permission-denied → 
點擊返回 → 應該返回 /task（上上一頁），而不是 /chat（被阻擋的頁面）
```

## 🔧 **解決方案**

### **1. 修改權限守衛邏輯**

#### **檔案**: `lib/router/guards/permission_guard.dart`

**主要變更**：
- 新增 `_redirectToPermissionDenied()` 方法
- 區分 `blocked`（被阻擋的頁面）和 `from`（真正的上一頁）參數
- 使用 `AppScaffold.getPreviousValidRoute()` 獲取路由歷史

```dart
/// 重定向到權限拒絕頁面，帶上被阻擋的路徑和上一頁路徑
static void _redirectToPermissionDenied(BuildContext context, String blockedPath) {
  // 從 AppScaffold 獲取上一個有效的路由路徑
  String? previousPath = AppScaffold.getPreviousValidRoute();
  
  // 構建查詢參數
  final queryParams = <String, String>{
    'blocked': blockedPath, // 被阻擋的頁面
  };
  
  if (previousPath != null && previousPath != blockedPath) {
    queryParams['from'] = previousPath; // 真正的上一頁
  }
  
  // 構建完整的 URL
  final uri = Uri(
    path: '/permission-denied',
    queryParameters: queryParams,
  );
  
  debugPrint('🚫 權限拒絕重定向: 被阻擋頁面=$blockedPath, 上一頁=$previousPath');
  context.go(uri.toString());
}
```

### **2. 增強 AppScaffold 路由歷史管理**

#### **檔案**: `lib/layout/app_scaffold.dart`

**主要變更**：
- 新增靜態方法 `getPreviousValidRoute()` 來獲取上一個有效的路由
- 新增實例追蹤機制 `_currentInstance`
- 過濾不可返回的路由和權限拒絕頁面

```dart
/// 獲取上一個有效的路由路徑
static String? getPreviousValidRoute() {
  final history = getCurrentRouteHistory();
  if (history.length < 2) return null;
  
  final instance = _currentInstance;
  if (instance == null) return null;
  
  // 從倒數第二個開始查找（跳過當前路徑）
  for (int i = history.length - 2; i >= 0; i--) {
    final path = history[i];
    // 跳過不可返回的路由和權限拒絕頁面
    if (!instance._nonReturnableRoutes.contains(path) && 
        !path.contains('/permission-denied')) {
      return path;
    }
  }
  
  return null;
}
```

**AppScaffold 返回邏輯優化**：
```dart
/// 處理權限拒絕頁面的返回邏輯
void _handlePermissionDeniedBack() {
  final state = GoRouterState.of(context);
  final fromPath = state.uri.queryParameters['from']; // 真正的上一頁
  final blockedPath = state.uri.queryParameters['blocked']; // 被阻擋的頁面

  debugPrint('🔙 AppScaffold 返回: fromPath=$fromPath, blockedPath=$blockedPath');

  if (fromPath != null && fromPath.isNotEmpty) {
    // 檢查上一頁是否為基本頁面（permission = 0）
    if (_isBasicPage(fromPath)) {
      debugPrint('🔙 AppScaffold 返回到基本頁面: $fromPath');
      context.go(fromPath);
      return;
    }
  }

  // 如果沒有有效的上一頁，返回首頁
  debugPrint('🔙 AppScaffold 返回到首頁');
  context.go('/home');
}
```

### **3. 更新權限拒絕頁面**

#### **檔案**: `lib/system/pages/permission_denied_page.dart`

**主要變更**：
- 更新 `_handleSmartBack()` 方法處理新的查詢參數
- 區分 `from`（真正的上一頁）和 `blocked`（被阻擋的頁面）
- 新增 `_isBasicPage()` 方法檢查頁面權限

```dart
/// 智能返回邏輯
/// 優先返回用戶之前訪問的頁面，如果沒有則返回首頁
void _handleSmartBack(BuildContext context) {
  final state = GoRouterState.of(context);
  final fromPath = state.uri.queryParameters['from']; // 真正的上一頁
  final blockedPath = state.uri.queryParameters['blocked']; // 被阻擋的頁面

  debugPrint('🔙 智能返回: fromPath=$fromPath, blockedPath=$blockedPath');

  if (fromPath != null && fromPath.isNotEmpty) {
    // 檢查上一頁是否為基本頁面（permission = 0）
    if (_isBasicPage(fromPath)) {
      debugPrint('🔙 返回到基本頁面: $fromPath');
      context.go(fromPath);
      return;
    }
  }

  // 如果沒有有效的上一頁，返回首頁
  debugPrint('🔙 返回到首頁');
  context.go('/home');
}
```

## 🎯 **URL 參數結構**

### **新的查詢參數格式**：
```
/permission-denied?blocked=/chat&from=/task
```

- **`blocked`**: 被權限阻擋的頁面路徑（例如：`/chat`）
- **`from`**: 真正的上一頁路徑（例如：`/task`）

### **舊的格式（已棄用）**：
```
/permission-denied?from=/chat
```
- 只有一個參數，無法區分被阻擋頁面和真正的上一頁

## 📊 **測試案例**

### **測試 1：從 /task 訪問 /chat 被阻擋**
- **路由歷史**: `['/home', '/task']`
- **嘗試訪問**: `/chat`（權限不足）
- **重定向到**: `/permission-denied?blocked=/chat&from=/task`
- **點擊返回**: 返回到 `/task`
- **預期結果**: ✅ 成功返回到真正的上一頁

### **測試 2：從 /home 訪問 /task/create 被阻擋**
- **路由歷史**: `['/home']`
- **嘗試訪問**: `/task/create`（權限不足）
- **重定向到**: `/permission-denied?blocked=/task/create&from=/home`
- **點擊返回**: 返回到 `/home`
- **預期結果**: ✅ 成功返回到真正的上一頁

### **測試 3：沒有有效上一頁的情況**
- **路由歷史**: `['/permission-denied']`
- **重定向到**: `/permission-denied?blocked=/chat`（沒有 from 參數）
- **點擊返回**: 返回到 `/home`
- **預期結果**: ✅ 成功返回到首頁

## 🔍 **調試功能**

### **Debug 輸出**：
所有相關方法都包含 `debugPrint` 輸出，方便追蹤返回邏輯：

```dart
debugPrint('🚫 權限拒絕重定向: 被阻擋頁面=$blockedPath, 上一頁=$previousPath');
debugPrint('🔙 智能返回: fromPath=$fromPath, blockedPath=$blockedPath');
debugPrint('🔙 AppScaffold 返回: fromPath=$fromPath, blockedPath=$blockedPath');
```

## ✅ **完成狀態**

- [x] 修改 `PermissionGuard` 重定向邏輯
- [x] 增強 `AppScaffold` 路由歷史管理
- [x] 更新 `PermissionDeniedPage` 返回邏輯
- [x] 新增調試輸出功能
- [x] 修復所有語法錯誤和警告
- [x] 測試基本功能流程

## 🎉 **效果**

現在當用戶從 `/task` 嘗試訪問 `/chat` 被阻擋時：
1. 會重定向到 `/permission-denied?blocked=/chat&from=/task`
2. 點擊返回按鈕會智能返回到 `/task`（真正的上一頁）
3. 而不是嘗試返回到 `/chat`（被阻擋的頁面）

這解決了用戶體驗問題，確保返回邏輯符合用戶預期。
