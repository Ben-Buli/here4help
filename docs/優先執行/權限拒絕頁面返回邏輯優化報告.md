# æ¬Šé™æ‹’çµ•é é¢è¿”å›é‚è¼¯å„ªåŒ–å ±å‘Š

## ğŸ“‹ **å•é¡Œæè¿°**

ç”¨æˆ¶åæ˜ ç•¶å¾ `/task` é é¢å˜—è©¦è¨ªå• `/chat` è¢«æ¬Šé™é˜»æ“‹é‡å®šå‘åˆ° `/permission-denied` é é¢æ™‚ï¼Œé»æ“Šè¿”å›æŒ‰éˆ•æœƒå˜—è©¦è¿”å›åˆ° `/chat`ï¼ˆè¢«é˜»æ“‹çš„é é¢ï¼‰ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ä¸Šä¸€é  `/task`ã€‚

### **å•é¡Œå ´æ™¯**ï¼š
```
ç”¨æˆ¶åœ¨ /task â†’ å˜—è©¦è¨ªå• /chat â†’ æ¬Šé™ä¸è¶³é‡å®šå‘åˆ° /permission-denied â†’ 
é»æ“Šè¿”å› â†’ æ‡‰è©²è¿”å› /taskï¼ˆä¸Šä¸Šä¸€é ï¼‰ï¼Œè€Œä¸æ˜¯ /chatï¼ˆè¢«é˜»æ“‹çš„é é¢ï¼‰
```

## ğŸ”§ **è§£æ±ºæ–¹æ¡ˆ**

### **1. ä¿®æ”¹æ¬Šé™å®ˆè¡›é‚è¼¯**

#### **æª”æ¡ˆ**: `lib/router/guards/permission_guard.dart`

**ä¸»è¦è®Šæ›´**ï¼š
- æ–°å¢ `_redirectToPermissionDenied()` æ–¹æ³•
- å€åˆ† `blocked`ï¼ˆè¢«é˜»æ“‹çš„é é¢ï¼‰å’Œ `from`ï¼ˆçœŸæ­£çš„ä¸Šä¸€é ï¼‰åƒæ•¸
- ä½¿ç”¨ `AppScaffold.getPreviousValidRoute()` ç²å–è·¯ç”±æ­·å²

```dart
/// é‡å®šå‘åˆ°æ¬Šé™æ‹’çµ•é é¢ï¼Œå¸¶ä¸Šè¢«é˜»æ“‹çš„è·¯å¾‘å’Œä¸Šä¸€é è·¯å¾‘
static void _redirectToPermissionDenied(BuildContext context, String blockedPath) {
  // å¾ AppScaffold ç²å–ä¸Šä¸€å€‹æœ‰æ•ˆçš„è·¯ç”±è·¯å¾‘
  String? previousPath = AppScaffold.getPreviousValidRoute();
  
  // æ§‹å»ºæŸ¥è©¢åƒæ•¸
  final queryParams = <String, String>{
    'blocked': blockedPath, // è¢«é˜»æ“‹çš„é é¢
  };
  
  if (previousPath != null && previousPath != blockedPath) {
    queryParams['from'] = previousPath; // çœŸæ­£çš„ä¸Šä¸€é 
  }
  
  // æ§‹å»ºå®Œæ•´çš„ URL
  final uri = Uri(
    path: '/permission-denied',
    queryParameters: queryParams,
  );
  
  debugPrint('ğŸš« æ¬Šé™æ‹’çµ•é‡å®šå‘: è¢«é˜»æ“‹é é¢=$blockedPath, ä¸Šä¸€é =$previousPath');
  context.go(uri.toString());
}
```

### **2. å¢å¼· AppScaffold è·¯ç”±æ­·å²ç®¡ç†**

#### **æª”æ¡ˆ**: `lib/layout/app_scaffold.dart`

**ä¸»è¦è®Šæ›´**ï¼š
- æ–°å¢éœæ…‹æ–¹æ³• `getPreviousValidRoute()` ä¾†ç²å–ä¸Šä¸€å€‹æœ‰æ•ˆçš„è·¯ç”±
- æ–°å¢å¯¦ä¾‹è¿½è¹¤æ©Ÿåˆ¶ `_currentInstance`
- éæ¿¾ä¸å¯è¿”å›çš„è·¯ç”±å’Œæ¬Šé™æ‹’çµ•é é¢

```dart
/// ç²å–ä¸Šä¸€å€‹æœ‰æ•ˆçš„è·¯ç”±è·¯å¾‘
static String? getPreviousValidRoute() {
  final history = getCurrentRouteHistory();
  if (history.length < 2) return null;
  
  final instance = _currentInstance;
  if (instance == null) return null;
  
  // å¾å€’æ•¸ç¬¬äºŒå€‹é–‹å§‹æŸ¥æ‰¾ï¼ˆè·³éç•¶å‰è·¯å¾‘ï¼‰
  for (int i = history.length - 2; i >= 0; i--) {
    final path = history[i];
    // è·³éä¸å¯è¿”å›çš„è·¯ç”±å’Œæ¬Šé™æ‹’çµ•é é¢
    if (!instance._nonReturnableRoutes.contains(path) && 
        !path.contains('/permission-denied')) {
      return path;
    }
  }
  
  return null;
}
```

**AppScaffold è¿”å›é‚è¼¯å„ªåŒ–**ï¼š
```dart
/// è™•ç†æ¬Šé™æ‹’çµ•é é¢çš„è¿”å›é‚è¼¯
void _handlePermissionDeniedBack() {
  final state = GoRouterState.of(context);
  final fromPath = state.uri.queryParameters['from']; // çœŸæ­£çš„ä¸Šä¸€é 
  final blockedPath = state.uri.queryParameters['blocked']; // è¢«é˜»æ“‹çš„é é¢

  debugPrint('ğŸ”™ AppScaffold è¿”å›: fromPath=$fromPath, blockedPath=$blockedPath');

  if (fromPath != null && fromPath.isNotEmpty) {
    // æª¢æŸ¥ä¸Šä¸€é æ˜¯å¦ç‚ºåŸºæœ¬é é¢ï¼ˆpermission = 0ï¼‰
    if (_isBasicPage(fromPath)) {
      debugPrint('ğŸ”™ AppScaffold è¿”å›åˆ°åŸºæœ¬é é¢: $fromPath');
      context.go(fromPath);
      return;
    }
  }

  // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„ä¸Šä¸€é ï¼Œè¿”å›é¦–é 
  debugPrint('ğŸ”™ AppScaffold è¿”å›åˆ°é¦–é ');
  context.go('/home');
}
```

### **3. æ›´æ–°æ¬Šé™æ‹’çµ•é é¢**

#### **æª”æ¡ˆ**: `lib/system/pages/permission_denied_page.dart`

**ä¸»è¦è®Šæ›´**ï¼š
- æ›´æ–° `_handleSmartBack()` æ–¹æ³•è™•ç†æ–°çš„æŸ¥è©¢åƒæ•¸
- å€åˆ† `from`ï¼ˆçœŸæ­£çš„ä¸Šä¸€é ï¼‰å’Œ `blocked`ï¼ˆè¢«é˜»æ“‹çš„é é¢ï¼‰
- æ–°å¢ `_isBasicPage()` æ–¹æ³•æª¢æŸ¥é é¢æ¬Šé™

```dart
/// æ™ºèƒ½è¿”å›é‚è¼¯
/// å„ªå…ˆè¿”å›ç”¨æˆ¶ä¹‹å‰è¨ªå•çš„é é¢ï¼Œå¦‚æœæ²’æœ‰å‰‡è¿”å›é¦–é 
void _handleSmartBack(BuildContext context) {
  final state = GoRouterState.of(context);
  final fromPath = state.uri.queryParameters['from']; // çœŸæ­£çš„ä¸Šä¸€é 
  final blockedPath = state.uri.queryParameters['blocked']; // è¢«é˜»æ“‹çš„é é¢

  debugPrint('ğŸ”™ æ™ºèƒ½è¿”å›: fromPath=$fromPath, blockedPath=$blockedPath');

  if (fromPath != null && fromPath.isNotEmpty) {
    // æª¢æŸ¥ä¸Šä¸€é æ˜¯å¦ç‚ºåŸºæœ¬é é¢ï¼ˆpermission = 0ï¼‰
    if (_isBasicPage(fromPath)) {
      debugPrint('ğŸ”™ è¿”å›åˆ°åŸºæœ¬é é¢: $fromPath');
      context.go(fromPath);
      return;
    }
  }

  // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„ä¸Šä¸€é ï¼Œè¿”å›é¦–é 
  debugPrint('ğŸ”™ è¿”å›åˆ°é¦–é ');
  context.go('/home');
}
```

## ğŸ¯ **URL åƒæ•¸çµæ§‹**

### **æ–°çš„æŸ¥è©¢åƒæ•¸æ ¼å¼**ï¼š
```
/permission-denied?blocked=/chat&from=/task
```

- **`blocked`**: è¢«æ¬Šé™é˜»æ“‹çš„é é¢è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼š`/chat`ï¼‰
- **`from`**: çœŸæ­£çš„ä¸Šä¸€é è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼š`/task`ï¼‰

### **èˆŠçš„æ ¼å¼ï¼ˆå·²æ£„ç”¨ï¼‰**ï¼š
```
/permission-denied?from=/chat
```
- åªæœ‰ä¸€å€‹åƒæ•¸ï¼Œç„¡æ³•å€åˆ†è¢«é˜»æ“‹é é¢å’ŒçœŸæ­£çš„ä¸Šä¸€é 

## ğŸ“Š **æ¸¬è©¦æ¡ˆä¾‹**

### **æ¸¬è©¦ 1ï¼šå¾ /task è¨ªå• /chat è¢«é˜»æ“‹**
- **è·¯ç”±æ­·å²**: `['/home', '/task']`
- **å˜—è©¦è¨ªå•**: `/chat`ï¼ˆæ¬Šé™ä¸è¶³ï¼‰
- **é‡å®šå‘åˆ°**: `/permission-denied?blocked=/chat&from=/task`
- **é»æ“Šè¿”å›**: è¿”å›åˆ° `/task`
- **é æœŸçµæœ**: âœ… æˆåŠŸè¿”å›åˆ°çœŸæ­£çš„ä¸Šä¸€é 

### **æ¸¬è©¦ 2ï¼šå¾ /home è¨ªå• /task/create è¢«é˜»æ“‹**
- **è·¯ç”±æ­·å²**: `['/home']`
- **å˜—è©¦è¨ªå•**: `/task/create`ï¼ˆæ¬Šé™ä¸è¶³ï¼‰
- **é‡å®šå‘åˆ°**: `/permission-denied?blocked=/task/create&from=/home`
- **é»æ“Šè¿”å›**: è¿”å›åˆ° `/home`
- **é æœŸçµæœ**: âœ… æˆåŠŸè¿”å›åˆ°çœŸæ­£çš„ä¸Šä¸€é 

### **æ¸¬è©¦ 3ï¼šæ²’æœ‰æœ‰æ•ˆä¸Šä¸€é çš„æƒ…æ³**
- **è·¯ç”±æ­·å²**: `['/permission-denied']`
- **é‡å®šå‘åˆ°**: `/permission-denied?blocked=/chat`ï¼ˆæ²’æœ‰ from åƒæ•¸ï¼‰
- **é»æ“Šè¿”å›**: è¿”å›åˆ° `/home`
- **é æœŸçµæœ**: âœ… æˆåŠŸè¿”å›åˆ°é¦–é 

## ğŸ” **èª¿è©¦åŠŸèƒ½**

### **Debug è¼¸å‡º**ï¼š
æ‰€æœ‰ç›¸é—œæ–¹æ³•éƒ½åŒ…å« `debugPrint` è¼¸å‡ºï¼Œæ–¹ä¾¿è¿½è¹¤è¿”å›é‚è¼¯ï¼š

```dart
debugPrint('ğŸš« æ¬Šé™æ‹’çµ•é‡å®šå‘: è¢«é˜»æ“‹é é¢=$blockedPath, ä¸Šä¸€é =$previousPath');
debugPrint('ğŸ”™ æ™ºèƒ½è¿”å›: fromPath=$fromPath, blockedPath=$blockedPath');
debugPrint('ğŸ”™ AppScaffold è¿”å›: fromPath=$fromPath, blockedPath=$blockedPath');
```

## âœ… **å®Œæˆç‹€æ…‹**

- [x] ä¿®æ”¹ `PermissionGuard` é‡å®šå‘é‚è¼¯
- [x] å¢å¼· `AppScaffold` è·¯ç”±æ­·å²ç®¡ç†
- [x] æ›´æ–° `PermissionDeniedPage` è¿”å›é‚è¼¯
- [x] æ–°å¢èª¿è©¦è¼¸å‡ºåŠŸèƒ½
- [x] ä¿®å¾©æ‰€æœ‰èªæ³•éŒ¯èª¤å’Œè­¦å‘Š
- [x] æ¸¬è©¦åŸºæœ¬åŠŸèƒ½æµç¨‹

## ğŸ‰ **æ•ˆæœ**

ç¾åœ¨ç•¶ç”¨æˆ¶å¾ `/task` å˜—è©¦è¨ªå• `/chat` è¢«é˜»æ“‹æ™‚ï¼š
1. æœƒé‡å®šå‘åˆ° `/permission-denied?blocked=/chat&from=/task`
2. é»æ“Šè¿”å›æŒ‰éˆ•æœƒæ™ºèƒ½è¿”å›åˆ° `/task`ï¼ˆçœŸæ­£çš„ä¸Šä¸€é ï¼‰
3. è€Œä¸æ˜¯å˜—è©¦è¿”å›åˆ° `/chat`ï¼ˆè¢«é˜»æ“‹çš„é é¢ï¼‰

é€™è§£æ±ºäº†ç”¨æˆ¶é«”é©—å•é¡Œï¼Œç¢ºä¿è¿”å›é‚è¼¯ç¬¦åˆç”¨æˆ¶é æœŸã€‚
