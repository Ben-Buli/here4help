# Here4Help 權限設置開發追蹤表

> 本文件追蹤權限設置系統的開發進度，確保權限控制功能完整且用戶體驗良好
> 參考文件：[登入註冊＿階段性任務追蹤表.md](登入註冊＿階段性任務追蹤表.md)

---

## 📋 **權限系統概覽**

### **權限分級定義**
| 權限值 | 狀態 | 行為 | 限制 |
|--------|------|------|------|
| 0 | 新用戶未認證 | 可登入，瀏覽部分頁面 | 無法使用任務應徵或聊天功能 |
| 1 | 已認證用戶 | 可使用所有頁面和功能 | 無限制 |
| 99 | 管理員 | 可使用所有頁面和功能 | 無限制 |
| -1 | 被管理員停權 | 可登入，瀏覽部分頁面 | 無法使用任務應徵或聊天功能 |
| -2 | 被管理員軟刪除 | 無法登入 | 顯示「帳號無效或已被移除」 |
| -3 | 用戶自行停權 | 可登入，瀏覽部分頁面 | 無法使用任務應徵或聊天功能 |
| -4 | 用戶自行軟刪除 | 無法登入 | 顯示「帳號無效或已被移除」 |

### **開發原則**
- 前端顯示文字使用全英文
- debugPrint 可使用中文字
- 權限檢查統一化，避免重複實作
- 用戶體驗優先，提供清晰的權限說明

---

## 🎯 **階段性任務清單**

### **第一階段：權限系統基礎架構**
- [ ] **任務 1.1**：建立權限檢查服務
  - 創建 `PermissionService` 類別
  - 實作權限驗證方法
  - 提供權限狀態查詢功能
- [ ] **任務 1.2**：更新 JWT 驗證邏輯
  - 在 JWT payload 中添加權限資訊
  - 實作 JWT 權限驗證
  - 處理權限過期情況

### **第二階段：路由權限控制**
- [ ] **任務 2.1**：更新 `app_router.dart` 權限檢查
  - 在 `redirect` 邏輯中添加權限驗證
  - 處理不同權限值的路由導向
  - 實作權限拒絕處理
- [ ] **任務 2.2**：更新 `shell_pages.dart` 權限配置
  - 為每個頁面添加權限要求
  - 定義頁面訪問權限規則
  - 建立權限配置驗證

### **第三階段：頁面權限控制**
- [ ] **任務 3.1**：建立 403 權限拒絕頁面
  - 設計權限拒絕頁面 UI
  - 實作自動返回邏輯
  - 提供手動返回選項
- [ ] **任務 3.2**：實作頁面級權限控制
  - 在頁面載入時檢查權限
  - 無權限時自動跳轉到 403 頁面
  - 記錄權限檢查日誌

### **第四階段：元件權限控制**
- [ ] **任務 4.1**：建立權限感知元件
  - 創建 `PermissionAwareWidget` 包裝器
  - 實作條件渲染邏輯
  - 提供權限不足提示
- [ ] **任務 4.2**：更新現有元件權限控制
  - 更新任務應徵按鈕權限控制
  - 更新聊天功能權限控制
  - 更新任務創建權限控制

### **第五階段：權限狀態管理與測試**
- [ ] **任務 5.1**：實作權限狀態管理
  - 建立權限狀態 Provider
  - 實作權限變更通知
  - 處理權限狀態持久化
- [ ] **任務 5.2**：權限系統測試與優化
  - 測試各種權限組合
  - 優化權限檢查性能
  - 完善錯誤處理和用戶提示

---

## 🔧 **詳細任務說明**

### **任務 1.1：建立權限檢查服務**

#### **需要實作**
- 創建 `lib/services/permission_service.dart`
- 實作權限驗證邏輯
- 提供權限狀態查詢方法

#### **技術方案**
```dart
class PermissionService {
  static bool canAccessChat(int permission) {
    return permission >= 1;
  }
  
  static bool canCreateTask(int permission) {
    return permission >= 1;
  }
  
  static bool canApplyTask(int permission) {
    return permission >= 1;
  }
  
  static bool isAccountValid(int permission) {
    return permission >= -3;
  }
}
```

#### **預估工時**：3-4 小時

---

### **任務 1.2：更新 JWT 驗證邏輯**

#### **需要修改**
- 更新 `JWTManager` 類別
- 在 JWT payload 中添加權限資訊
- 實作權限驗證方法

#### **預估工時**：2-3 小時

---

### **任務 2.1：更新 app_router.dart 權限檢查**

#### **需要修改**
- 在 `redirect` 邏輯中添加權限驗證
- 處理不同權限值的路由導向
- 實作權限拒絕處理

#### **技術方案**
```dart
redirect: (context, state) async {
  // 檢查 JWT 和權限
  final token = await _getStoredToken();
  if (token != null) {
    final permission = await _validateTokenAndGetPermission(token);
    if (permission != null) {
      // 根據權限決定路由導向
      return _handlePermissionBasedRouting(state, permission);
    }
  }
  return null;
}
```

#### **預估工時**：4-5 小時

---

### **任務 2.2：更新 shell_pages.dart 權限配置**

#### **需要修改**
- 為每個頁面添加權限要求
- 定義頁面訪問權限規則
- 建立權限配置驗證

#### **技術方案**
```dart
{
  'path': '/chat',
  'child': const ChatPageWrapper(),
  'title': 'Chats',
  'showBottomNav': true,
  'showBackArrow': true,
  'requiredPermission': 1, // 需要已認證用戶
  'permissionDeniedMessage': 'You need to verify your account to access chat features',
},
```

#### **預估工時**：2-3 小時

---

### **任務 3.1：建立 403 權限拒絕頁面**

#### **需要實作**
- 創建 `lib/system/pages/permission_denied_page.dart`
- 設計權限拒絕頁面 UI
- 實作自動返回邏輯

#### **預估工時**：3-4 小時

---

### **任務 3.2：實作頁面級權限控制**

#### **需要實作**
- 在頁面載入時檢查權限
- 無權限時自動跳轉到 403 頁面
- 記錄權限檢查日誌

#### **預估工時**：4-5 小時

---

### **任務 4.1：建立權限感知元件**

#### **需要實作**
- 創建 `PermissionAwareWidget` 包裝器
- 實作條件渲染邏輯
- 提供權限不足提示

#### **技術方案**
```dart
class PermissionAwareWidget extends StatelessWidget {
  final int requiredPermission;
  final Widget child;
  final Widget? fallback;
  
  @override
  Widget build(BuildContext context) {
    final userPermission = context.watch<PermissionProvider>().permission;
    
    if (userPermission >= requiredPermission) {
      return child;
    }
    
    return fallback ?? const SizedBox.shrink();
  }
}
```

#### **預估工時**：3-4 小時

---

### **任務 4.2：更新現有元件權限控制**

#### **需要修改**
- 更新任務應徵按鈕權限控制
- 更新聊天功能權限控制
- 更新任務創建權限控制

#### **預估工時**：4-5 小時

---

### **任務 5.1：實作權限狀態管理**

#### **需要實作**
- 建立權限狀態 Provider
- 實作權限變更通知
- 處理權限狀態持久化

#### **預估工時**：3-4 小時

---

### **任務 5.2：權限系統測試與優化**

#### **需要實作**
- 測試各種權限組合
- 優化權限檢查性能
- 完善錯誤處理和用戶提示

#### **預估工時**：4-5 小時

---

## 📊 **進度追蹤**

### **總體進度**
- **總任務數**：10 個主要任務
- **已完成**：0 個
- **進行中**：0 個
- **待開始**：10 個
- **完成度**：0%

### **階段進度**
- **第一階段**：0/2 任務完成
- **第二階段**：0/2 任務完成
- **第三階段**：0/2 任務完成
- **第四階段**：0/2 任務完成
- **第五階段**：0/2 任務完成

---

## 🚀 **下一步行動**

### **立即執行（本週）**
1. 開始第一階段：建立權限檢查服務
2. 更新 JWT 驗證邏輯
3. 測試基本的權限檢查功能

### **本週完成**
1. 完成第一階段的所有任務
2. 開始第二階段：路由權限控制

### **下週完成**
1. 完成第二階段的所有任務
2. 開始第三階段：頁面權限控制

---

## 📝 **變更記錄**

| 日期 | 版本/PR | 項目 | 影響區 | 修改主題類型 | 說明 |
|---|---|---|---|---|---|
| 2025-01-21 | permission-system-01 | 建立權限設置開發追蹤表 | Docs | 權限系統 | 建立完整的權限系統開發追蹤和進度管理系統 |

---

## 🔍 **注意事項**

### **技術考量**
- 保持與現有 JWT 系統的兼容性
- 確保權限檢查的性能和安全性
- 支援權限的動態更新和變更

### **用戶體驗**
- 權限拒絕時提供清晰的說明
- 自動跳轉時給用戶足夠的反應時間
- 提供手動操作的選項

### **測試要求**
- 每個階段完成後都需要進行測試
- 確保各種權限組合的正確性
- 驗證權限變更的即時性

---

## 📞 **聯絡資訊**

如有問題或需要協助，請聯繫開發團隊。

---

## 📝 **更新記錄**

- **2025-01-21**：初始版本，建立完整的權限系統開發追蹤系統
