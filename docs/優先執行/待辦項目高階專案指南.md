# Here4Help 待辦項目高階專案指南

**版本**: 1.0  
**建立日期**: 2025-01-11  
**基於**: 整合待辦項目分析與高階專案分析指令

---

## 📋 專案背景

### 產品現況
- **產品**: Here4Help (Flutter App)
- **後端**: 原生 PHP + MySQL + Node.js Socket 伺服器
- **管理員後台**: Laravel + Vue.js
- **部署環境**: CPanel (Basic_H10G-50G-addones)
- **當前狀態**: 21/21 核心功能模組已完成 (100%)

### 功能域完成狀況
- ✅ OAuth 登入註冊 (Google/Facebook/Apple)
- ✅ 任務發布與應徵系統
- ✅ 即時聊天室 (WebSocket + 離線支援)
- ✅ 帳戶安全與權限管理
- ✅ 客服事件系統
- ✅ 通知與媒體處理
- ✅ 無障礙與空/錯誤狀態支援

### 近期痛點
- **JWT 驗證問題**: Socket 伺服器與 PHP 後端 JWT 簽名不一致
- **後端配置問題**: 多個 PHP 檔案引用路徑錯誤
- **功能完善需求**: 部分 UI/UX 細節待優化
- **部署準備**: CPanel 環境配置和測試

---

## 🎯 里程碑規劃

### M-CRITICAL-FIXES: 關鍵問題修復
**目標**: 修復影響系統運行的關鍵問題  
**時程**: 1 週  
**優先級**: 🔥 立即處理

### M-FEATURE-ENHANCEMENT: 功能完善
**目標**: 完善用戶體驗和功能細節  
**時程**: 1 週  
**優先級**: 🎯 功能完善

### M-UX-OPTIMIZATION: 體驗優化
**目標**: 改善 UI/UX 和系統穩定性  
**時程**: 1 週  
**優先級**: 🔧 體驗優化

---

## 📊 任務分解

### 里程碑一：關鍵問題修復 (M-CRITICAL-FIXES)

#### T1-JWT-SOCKET-SYNC
**負責人**: Backend  
**目標**: 修復 JWT 驗證問題，確保 Socket 伺服器與 PHP 後端一致性

**問題分析**:
```
[socket:K-uaTpVeosJ38WbmAAAB] ❌ JWT validation failed: JsonWebTokenError invalid signature
[socket:K-uaTpVeosJ38WbmAAAB] ❌ Base64 validation failed: Unexpected non-whitespace character after JSON at position 27
```

**根本原因**:
- PHP JWTManager 和 Node.js jwt 庫使用不同的簽名算法或密鑰處理方式
- Base64 編碼/解碼不一致
- JWT Secret 在兩個環境中可能不同步

**步驟**:
1. **統一 JWT Secret 管理**
   ```bash
   # 確保 PHP 和 Node.js 使用相同的 JWT_SECRET
   # 檢查 .env 檔案中的 JWT_SECRET
   grep JWT_SECRET backend/config/.env
   grep JWT_SECRET backend/socket/.env
   ```

2. **修復 PHP JWTManager Base64 編碼**
   ```php
   // backend/utils/JWTManager.php
   // 確保 base64UrlEncode 函數與 Node.js 一致
   private static function base64UrlEncode($data) {
       return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
   }
   
   private static function base64UrlDecode($data) {
       return base64_decode(str_pad(strtr($data, '-_', '+/'), 
           strlen($data) % 4, '=', STR_PAD_RIGHT));
   }
   ```

3. **同步 Node.js JWT 驗證邏輯**
   ```javascript
   // backend/socket/server.js
   // 確保使用相同的算法和選項
   const payload = jwt.verify(token, JWT_SECRET, {
       algorithms: ['HS256'],
       ignoreExpiration: false,
       ignoreNotBefore: false
   });
   ```

4. **創建 JWT 測試腳本**
   ```php
   // backend/test/jwt_compatibility_test.php
   // 測試 PHP 生成的 JWT 能否被 Node.js 驗證
   ```

**驗收條件**:
- [ ] PHP 生成的 JWT 可被 Node.js 正確驗證
- [ ] Socket 連接不再出現 JWT 驗證錯誤
- [ ] 聊天功能正常運作
- [ ] JWT 測試腳本通過

**檔案清單**:
- `backend/utils/JWTManager.php`
- `backend/socket/server.js`
- `backend/test/jwt_compatibility_test.php`
- `backend/config/.env`

**預估時間**: 8 小時

---

#### T2-BACKEND-CONFIG-FIX
**負責人**: Backend  
**目標**: 修復後端配置問題，創建缺失的 database.php

**步驟**:
1. **創建標準 database.php**
   ```bash
   # 基於 database.example.php 創建正式版本
   cp backend/config/database.example.php backend/config/database.php
   ```

2. **修復檔案引用路徑**
   ```bash
   # 檢查所有引用 database.php 的檔案
   find backend -name "*.php" -exec grep -l "database.php" {} \;
   
   # 統一修正為絕對路徑
   # require_once __DIR__ . '/../config/database.php';
   ```

3. **統一環境變數載入**
   ```php
   // 確保所有檔案都正確載入 env_loader.php
   require_once __DIR__ . '/../config/env_loader.php';
   EnvLoader::load();
   ```

**驗收條件**:
- [ ] 所有 PHP 腳本可正常載入 database.php
- [ ] 資料庫連接測試通過
- [ ] 備份和測試腳本正常運行

**檔案清單**:
- `backend/config/database.php`
- `backend/database/test_connection.php`
- `backend/database/backup_manager.php`
- 所有引用 database.php 的檔案

**預估時間**: 4 小時

---

#### T3-PATH-STANDARDIZATION
**負責人**: Backend  
**目標**: 統一 PHP 檔案路徑引用，解決相對路徑問題

**步驟**:
1. **路徑標準化腳本**
   ```bash
   # 創建路徑檢查和修復腳本
   # backend/scripts/fix_paths.php
   ```

2. **統一使用絕對路徑**
   ```php
   // 標準化所有 require_once 語句
   // 使用 __DIR__ 基準的絕對路徑
   ```

3. **測試所有腳本**
   ```bash
   # 運行所有 PHP 腳本確保無路徑錯誤
   find backend -name "*.php" -exec php -l {} \;
   ```

**驗收條件**:
- [ ] 所有 PHP 檔案語法檢查通過
- [ ] 備份、測試、初始化腳本正常運行
- [ ] 無路徑相關錯誤

**預估時間**: 4 小時

---

### 里程碑二：功能完善 (M-FEATURE-ENHANCEMENT)

#### T4-ACCOUNT-SECURITY-COMPLETE
**負責人**: Flutter  
**目標**: 完善帳戶安全頁面功能

**步驟**:
1. **實現客服聯繫功能**
   ```dart
   // lib/account/pages/security_page.dart (第386行)
   ElevatedButton(
     onPressed: () {
       // 導航至客服聊天室
       context.push('/chat/support');
     },
     child: const Text('Contact Support'),
   ),
   ```

2. **實現登出功能**
   ```dart
   // lib/account/pages/security_page.dart (第399行)
   TextButton(
     onPressed: () => _showConfirmDialog('log out', () async {
       await AuthService.logout();
       if (mounted) {
         context.go('/login');
       }
     }),
     child: const Text('log out', style: TextStyle(color: Colors.red)),
   ),
   ```

3. **整合客服聊天室**
   ```dart
   // 確保客服聊天室路由存在
   // lib/router/app_router.dart
   ```

**驗收條件**:
- [ ] Contact Support 按鈕可正常導航至客服聊天室
- [ ] 登出功能完整實現
- [ ] 用戶體驗流暢

**檔案清單**:
- `lib/account/pages/security_page.dart`
- `lib/auth/services/auth_service.dart`
- `lib/router/app_router.dart`

**預估時間**: 4 小時

---

#### T5-CHAT-SWIPE-OPTIMIZATION
**負責人**: Flutter  
**目標**: 優化聊天頁面滑動工具列配置

**步驟**:
1. **分析任務狀態條件**
   ```dart
   // lib/chat/widgets/posted_tasks_widget.dart
   // 檢查現有滑動動作配置
   ```

2. **優化狀態轉換邏輯**
   ```dart
   // 確保動作與任務狀態對應關係正確
   // 根據 TaskStatus 顯示對應的滑動動作
   ```

3. **測試不同任務狀態**
   ```dart
   // 測試各種任務狀態下的滑動動作
   // Open, In Progress, Pending Confirmation, Completed, Dispute
   ```

**驗收條件**:
- [ ] 滑動動作與任務狀態正確對應
- [ ] 狀態轉換邏輯正確
- [ ] 用戶操作直觀

**檔案清單**:
- `lib/chat/widgets/posted_tasks_widget.dart`
- `lib/chat/utils/action_bar_config.dart`
- `lib/constants/task_status.dart`

**預估時間**: 6 小時

---

#### T6-CHAT-DETAIL-ENHANCEMENT
**負責人**: Flutter  
**目標**: 優化聊天詳情頁面資料載入和 Action Bar

**步驟**:
1. **加強聚合 API 容錯**
   ```dart
   // lib/chat/pages/chat_detail_page.dart
   // 改善 _initializeChat() 方法
   ```

2. **優化 Action Bar 狀態同步**
   ```dart
   // 確保 DynamicActionBar 與任務狀態同步
   // 實現狀態變更時的 UI 更新
   ```

3. **改善錯誤處理**
   ```dart
   // 加強錯誤處理和用戶提示
   // 提供重試機制
   ```

**驗收條件**:
- [ ] 聚合 API 失敗時有備用方案
- [ ] Action Bar 狀態與任務狀態同步
- [ ] 錯誤處理完善

**檔案清單**:
- `lib/chat/pages/chat_detail_page.dart`
- `lib/chat/widgets/dynamic_action_bar.dart`
- `lib/chat/services/chat_service.dart`

**預估時間**: 8 小時

---

### 里程碑三：體驗優化 (M-UX-OPTIMIZATION)

#### T7-TASK-RATINGS-FIX
**負責人**: Backend  
**目標**: 修復 task_ratings 表結構適配問題

**步驟**:
1. **檢查實際表結構**
   ```sql
   -- 查看 task_ratings 表結構
   DESCRIBE task_ratings;
   SHOW CREATE TABLE task_ratings;
   ```

2. **修正 API 查詢**
   ```php
   // 根據實際表結構修正 API 查詢
   // backend/api/tasks/ratings.php
   ```

3. **測試評分功能**
   ```bash
   # 測試評分 API 端點
   curl -X POST /api/tasks/ratings.php
   ```

**驗收條件**:
- [ ] 評分系統正常顯示
- [ ] API 查詢與表結構一致
- [ ] 評分功能完整

**預估時間**: 4 小時

---

#### T8-TABBAR-SYNC-FIX
**負責人**: Flutter  
**目標**: 修復聊天頁面 TabBar 雙向同步問題

**步驟**:
1. **分析同步問題**
   ```dart
   // 檢查 TabBar 與 TabBarView 的控制器同步
   ```

2. **實現雙向同步**
   ```dart
   // 確保 TabBar 點擊和 TabBarView 滑動都能正確同步
   ```

3. **測試用戶體驗**
   ```dart
   // 測試各種切換場景
   ```

**驗收條件**:
- [ ] TabBar 與 TabBarView 完全同步
- [ ] 用戶操作體驗流暢
- [ ] 無同步延遲或錯誤

**預估時間**: 4 小時

---

#### T9-UI-ENHANCEMENTS
**負責人**: Flutter  
**目標**: UI/UX 完善項目

**步驟**:
1. **添加應徵者卡片頭像**
   ```dart
   // 確保 API 回傳 users.avatar_url
   // 映射至前端顯示
   ```

2. **優化未讀訊息數**
   ```dart
   // 端到端確認計數與顯示機制
   ```

3. **修復任務編輯時間欄位**
   ```dart
   // 確認 API 回傳時間資料並正確預填
   ```

**驗收條件**:
- [ ] 應徵者卡片顯示頭像
- [ ] 未讀訊息數準確顯示
- [ ] 時間欄位正確預填

**預估時間**: 6 小時

---

## 🧪 測試計畫

### 單元測試
- **JWT 相容性測試**: PHP 與 Node.js JWT 互通性
- **API 端點測試**: 所有修復的 API 功能
- **UI 組件測試**: 修改的 Flutter 組件

### 整合測試
- **Socket 連接測試**: 完整的 WebSocket 通訊流程
- **聊天功能測試**: 端到端聊天體驗
- **權限系統測試**: 各種用戶角色和權限

### 端對端測試
- **用戶流程測試**: 完整的用戶使用流程
- **跨平台測試**: iOS、Android、Web 一致性
- **效能測試**: 系統回應時間和穩定性

---

## 🔄 回滾計畫

### 緊急回滾步驟
1. **程式碼回滾**
   ```bash
   git checkout HEAD~1
   git push --force-with-lease
   ```

2. **資料庫回滾**
   ```bash
   mysql -u username -p database < backup_before_changes.sql
   ```

3. **服務重啟**
   ```bash
   # 重啟 Socket 伺服器
   pm2 restart socket-server
   ```

### 回滾觸發條件
- JWT 驗證完全失效
- 聊天功能無法使用
- 用戶無法登入
- 資料遺失風險

---

## 📋 驗收清單

### 關鍵問題修復
- [ ] JWT 驗證錯誤完全解決
- [ ] 所有 PHP 腳本正常運行
- [ ] 資料庫連接穩定
- [ ] Socket 伺服器正常運作

### 功能完善
- [ ] 帳戶安全頁面功能完整
- [ ] 聊天滑動工具列優化完成
- [ ] 聊天詳情頁面穩定可靠

### 體驗優化
- [ ] 評分系統正常顯示
- [ ] TabBar 同步問題解決
- [ ] UI/UX 細節完善

### 測試驗證
- [ ] 所有單元測試通過
- [ ] 整合測試無錯誤
- [ ] 端對端測試流暢

---

## 📊 專案狀態更新

### 完成度評估
- **核心功能**: 100% 完成 ✅
- **後端 API**: 95% 完成 ⚠️ (修復配置問題後)
- **前端 UI**: 99% 完成 ✅ (完善細節後)
- **測試驗證**: 90% 完成 📋
- **部署準備**: 85% 完成 📋

### 里程碑時程
- **Week 1**: M-CRITICAL-FIXES (T1-T3)
- **Week 2**: M-FEATURE-ENHANCEMENT (T4-T6)
- **Week 3**: M-UX-OPTIMIZATION (T7-T9)

### 風險評估
- **低風險**: UI/UX 優化項目
- **中風險**: 功能完善項目
- **高風險**: JWT 驗證修復 (需謹慎測試)

---

## 🎯 成功指標

### 技術指標
- JWT 驗證成功率 > 99%
- API 回應時間 < 500ms
- Socket 連接穩定性 > 99%
- 零關鍵錯誤

### 用戶體驗指標
- 聊天功能流暢度
- 登入成功率
- 功能完整性
- UI 一致性

### 部署準備指標
- 所有測試通過
- 文檔完整
- 配置正確
- 監控就緒

---

**文檔版本**: 1.0  
**最後更新**: 2025-01-11  
**下次檢查**: 每個里程碑完成後
