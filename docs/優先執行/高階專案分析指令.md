高階專案分析模型指令（直接貼用）

你是 Chief Architect。請根據下列輸入，產出一份可直接執行的「專案修改指南」。
務必具體到指令/檔名/PR切分/驗收條件，能讓不同角色（Backend/Flutter/iOS/Infra）逐步照做，不需再問你問題。

⸻

專案背景
	•	產品：Here4Help（Flutter App）
	•	後端：Laravel + MySQL，Admin 使用 Laravel Blade
	•	功能域：註冊/登入（Email + Google/Apple/Facebook）、任務與應徵、聊天室（WebSocket 未讀/已讀/圖片）、客服、會員點數、權限/等級
	•	部署：CPanel / TestFlight 內測
	•	近期重點：
	•	權限等級（未認證/已認證/管理員/停權/自刪/自停）
	•	JWT/Session
	•	Socket 穩定
	•	Admin 維運（審核、客服、點數）
	•	目前後端使用原生php，評估是否後面新增的php可以使用laravel（舊的php可保留，但確保混用可行，不可行就統一使用原生php，或是 /admin 管理員後台統一laravel, app 用的 原生php。

⸻

輸入資料

1. Repo 結構（tree）
目錄中有些文件是舊有的，如果不確定的就寫入open_questions[]

專案架構：
docs/優先執行/Project_Schema.md

資料庫結構：
docs/DATABASE_SCHEMA.md -- 資料庫結構以及用途補充說明
docs/優先執行/Database_Structure.md -- 現有資料庫完整結構

其他模組文件
docs/優先執行/登入註冊＿規格整合文件.md格.md
docs/優先執行/聊天室模組_整合規格.md


1.1 專案目標📌 聊天模組
- 狀態：MVP 版本完成
- 備註：
  - 需要完成聊天室（訊息、訊息已讀、未讀數、圖片傳遞）
  - 後續需調整現有socket設定
  - /chat頁面的 ‘POST’頁面需要設定應徵者卡片可以左右滑動並且出現對應的按鈕例如 Read, delete, pin,   - /chat/detail page: action bar 功能完成，確保action bar 可以按照userRole（creator/participant）跟任務狀態出現對應的action bar選項，可以做成可以擴充調整的寫法以便管理（先檢查現有架構是否有）


📌 任務模組
- 狀態：MVP 版本完成
- 備註：
  - 需要完成APPLY NOW按鈕點擊前往/task/apply頁面之後，會插入一個任務政策同意按鈕才可以前往應徵頁面的同意流程介面
  - 完成任務收藏功能
  - 完成任務檢舉選單及功能


📌 管理員後台
- 狀態：架構已規劃，功能尚未實作
- 備註：
  - 會員審核機制：需串接 student_verifications，包含文字 + 圖片審查
  - 客服系統：需支援 socket 即時聊天室，包含客服聊天室內部可以建立該次客服聊天的任務項目，對應到 
  - 點數管理：需支援人工加點
  - 推薦碼反作弊：暫不實作

📌 客服聊天室事件紀錄模組
	•	狀態：新功能
	•	備註：
	•	在現有 chat_rooms type=support 的聊天室中，允許建立「事件」。
	•	每個事件需有：標題、描述、狀態（open / in_progress / resolved / closed_by_customer）、建立者（客服）、結案者（客戶）。
	•	支援事件歷程紀錄（狀態更新 log）。
	•	客戶可在事件 resolved 後，手動結案並評分/評論。
	•	Admin 後台需新增 /services/events 頁面：事件清單、狀態篩選、單筆檢視（含歷程與評分）。
	•	後台需提供事件統計（滿意度平均、處理時長、客服案件數）。


⸻

2. DB Schema（摘要）
	•	users
	•	firstname / lastname（已改名）
	•	status（active, unverified, banned, self_deleted, self_suspended）
		•	name（本名，單欄位，沿用）
		•	nickname（顯示名稱）
		•	status（active, unverified, banned, self_deleted, self_suspended）
		•	user_identities：OAuth 綁定
		•	（備註）原先的 firstname/lastname 規劃已撤回，沿用 name 單欄位；若前端仍分 first/last，提交時先合併為 name。
	•	task_disputes：申訴
	•	dispute_status_logs：申訴狀態紀錄
	•	chat_rooms：type(application|task|support|dispute)，dispute_id FK
	•	chat_messages：kind(text|image|file|system)，含 media_url/mime_type
	•	chat_reads：唯一索引 (user_id, room_id)
	•	student_verifications：會員審核（含圖片）
	•	admins / admin_roles / admin_role_permissions
	•	admin_activity_logs / admin_login_logs

⸻

3. API & WebSocket 路由（摘要）
	•	前台 /api/：會員、任務、聊天
	•	後台 /api/admin/：會員管理、審核、客服、點數、RBAC
	•	WebSocket
	•	/chat（App 用戶）
	•	/support（Admin 客服）
	•	事件：join、message:send、message:new、read:upsert、read:sync

API & WebSocket 路由（新增部分）
	•	REST API (/api/support/events)
	•	POST /support/events → 新增事件
	•	GET /support/events/{chat_room_id} → 查詢聊天室內事件列表
	•	PATCH /support/events/{id}/status → 更新事件狀態
	•	POST /support/events/{id}/close → 客戶結案
	•	POST /support/events/{id}/rating → 提交評分
	•	WebSocket (/support)
	•	新增事件：event:new
	•	狀態更新：event:update
	•	客戶結案：event:closed
	•	評分提交：event:rated

⸻

4. 管理員後台架構（網站樹狀）

/admin
├── /login              → 管理員登入
├── /users              → 會員管理
│     ├── /list         → 會員列表
│     ├── /review       → 會員審核 (串接 student_verifications)
│     └── /edit/{id}    → 修改會員資料
├── /tasks              → 任務管理
│     ├── /list         → 任務列表
│     └── /logs         → 任務紀錄 task_logs
├── /services           → 客服系統
│     ├── /list         → 任務申訴管理 (task_disputes)
│     ├── /chat         → 客服聊天室 (需支援 socket)
├── /points             → 點數管理
│     ├── /list         → 點數紀錄
│     └── /manual-add   → 手動加點
└── /admins             → 管理員帳號管理
      ├── /list
      ├── /create
      └── /reset-password

管理員後台架構（補充）
/admin/services
├── /list            → 任務申訴管理 (task_disputes)
├── /chat            → 客服聊天室
└── /events          → 客服事件紀錄
       ├── /list     → 事件列表（狀態篩選）
       ├── /view/{id}→ 單筆事件檢視（含歷程、評分）
       └── /stats    → 統計（平均滿意度、處理時長、客服案件數）

	•	每頁對應資料表、權限鍵（RBAC）已規劃
	•	API 走 /api/admin/*，Session/JWT 與前台分離
	•	Socket /support 提供客服即時訊息

⸻

5. 近期痛點 / 需求
	•	權限等級（未認證/已認證/管理員/停權/自刪/自停）
	•	Signup 對齊：表單改用 name + nickname；若前端仍有 first/last，提交前合併為 name
	•	Admin 後台操作（審核、客服、點數）
	•	舊表移除（task_status_logs, task_activity_logs）→ 改由 task_logs
	•	socket token 簽發、聊天室型別 support/dispute 區隔
	•	支援客服事件紀錄（資料表 + API + WebSocket）
	•	客戶可在事件完成後結案並評分
	•	Admin 後台可檢視事件清單、歷程、評分
	•	提供客服績效統計

⸻

交付物（產出需求）
	1.	PLAN.md
	•	ADR 決策
	•	分工/里程碑
	•	工作分解（任務 ID、檔案、命令、回滾、測試）
	•	驗收清單
	2.	plan.json
	•	milestone: M-CUSTOMER-SUPPORT-EVENTS
	•	任務包含：
	•	DB migration
	•	API 開發
	•	WebSocket 事件新增
	•	Flutter App UI（聊天室 → 事件卡片）
	•	Admin Blade 頁面 /events
	•	測試計畫（單元 + 端對端）
	3.	SQL / Laravel migration 範例
	•	support_events / support_event_logs
	4.	回滾方案
	•	php artisan migrate:rollback
	•	匯入 SQL dump
	5.	測試計畫
	•	API: 建立/查詢/更新/結案/評分
	•	WebSocket: event:new, event:update, event:closed, event:rated
	•	Admin UI: 篩選、統計
	6.	PR 切分建議
	•	PR1: DB migration
	•	PR2: Backend API & Socket
	•	PR3: Flutter App UI
	•	PR4: Admin Blade 頁面
	•	PR5: 測試與文件
	7.	接口相容矩陣
	•	影響端點：/support/events/*
	•	DTO: 新增 eventDTO (title, description, status, rating, review)

## 結構（以下也需要納入評估開發/修改項目）
{
  "version": "1.0",
  "milestones": [
    {
      "id": "M-SUPPORT-EVENTS",
      "title": "客服事件列表與進度（issues_status_page.dart）",
      "tasks": [
        {
          "id": "T1-FLT-ISSUES-PAGE",
          "owner": "flutter",
          "goal": "在 App 端新增 issues_status_page.dart，列出 support_events 並顯示各事件進度",
          "steps": [
            "建立 lib/pages/support/issues_status_page.dart",
            "呼叫 API: GET /support/events/{chat_room_id} 取得事件清單",
            "事件卡片呈現：標題、狀態(open/in_progress/resolved/closed_by_customer)、最後更新時間",
            "支援點擊卡片開啟事件詳情（含歷程 logs）",
            "Socket 訂閱 /support: event:new、event:update、event:closed、event:rated 即時刷新"
          ],
          "commands": [
            "flutter analyze",
            "flutter test --plain-name issues_status_page"
          ],
          "touch_files": [
            "lib/pages/support/issues_status_page.dart",
            "lib/widgets/support_event_card.dart",
            "lib/services/api/support_event_api.dart",
            "lib/services/socket/support_channel.dart"
          ],
          "acceptance": [
            "可顯示同一聊天室下的全部事件，並依狀態/時間排序",
            "狀態更新時 UI 可即時刷新",
            "無事件時顯示空狀態頁"
          ],
          "estimate_hours": 5,
          "deps": ["T2-LAR-API-SUPPORT-EVENTS", "T3-SOCKET-SUPPORT"]
        }
      ]
    },
    {
      "id": "M-ACCOUNT-SECURITY",
      "title": "安全性設定頁面停用/啟用帳號與任務保護機制",
      "tasks": [
        {
          "id": "T1-BE-SECURITY-GUARD",
          "owner": "backend",
          "goal": "後端提供帳號停用/啟用與任務中斷保護檢查",
          "steps": [
            "新增 API: GET /account/risky-actions-check 返還 { has_active_tasks, has_posted_open_tasks }",
            "新增 API: POST /account/deactivate 與 POST /account/reactivate",
            "停用後在 JWT/Policy 層封鎖：任務建立/編輯、/task/apply、/chat/detail 相關路由",
            "若 status=被管理員停權（permission = -1 或 status='banned'），封鎖同樣權限，但 /reactivate 一律返回需聯繫客服訊息"
          ],
          "commands": [
            "php artisan route:list | grep account",
            "phpunit --filter AccountSecurity"
          ],
          "touch_files": [
            "routes/api.php",
            "app/Policies/*",
            "app/Http/Controllers/AccountSecurityController.php",
            "app/Http/Middleware/PermissionGuard.php"
          ],
          "acceptance": [
            "API 能正確回報是否存在執行中/發布中的任務",
            "停用帳號後，任務與聊天相關 API 一律 403 並含錯誤碼",
            "被管理員停權無法於前端自行啟用，API 返回需聯繫客服的訊息"
          ],
          "estimate_hours": 6,
          "deps": []
        },
        {
          "id": "T2-FLT-SECURITY-UI",
          "owner": "flutter",
          "goal": "/account/security UI 與保護流程",
          "steps": [
            "建立/調整 lib/pages/account/security_page.dart 依設計稿呈現",
            "進入頁面時呼叫 /account/risky-actions-check，若有進行中或發布中的任務，彈出提醒並引導處理完畢後再停用",
            "停用後在同頁提供『啟用帳號』按鈕：呼叫 /account/reactivate（僅限自停用）",
            "若被管理員停權，隱藏啟用按鈕，顯示需聯繫客服的說明文字與快捷入口"
          ],
          "commands": [
            "flutter analyze",
            "flutter test --plain-name security_page"
          ],
          "touch_files": [
            "lib/pages/account/security_page.dart",
            "lib/services/api/account_api.dart",
            "lib/router/guards/permission_guard.dart"
          ],
          "acceptance": [
            "有進行中/發布中的任務時，停用會先提示保護對話框",
            "自停用後可在同頁面再啟用；被管理員停權時不可啟用並顯示說明",
            "停用帳號後，前端按鈕『Apply Now』『進入聊天室』狀態被動態禁用"
          ],
          "estimate_hours": 6,
          "deps": ["T1-BE-SECURITY-GUARD", "T1-PERMISSION-GUARD"]
        }
      ]
    },
    {
      "id": "M-PERMISSION-GUARD",
      "title": "全域權限與路由守衛 (user.permission/status)",
      "tasks": [
        {
          "id": "T1-PERMISSION-GUARD",
          "owner": "flutter",
          "goal": "確認現行以 user.permission 控制路由並補齊元件級條件式",
          "steps": [
            "審視現有 router 設定，確認使用 user.permission / users.status 管理存取",
            "新增 lib/router/guards/permission_guard.dart 封裝：允許、阻擋、跳轉說明頁",
            "在 /task 詳情頁的 Apply Now、/chat/detail 入口，以權限條件式禁用並給出提示 UI",
            "補單元測試：不同 permission/status 組合下的導航與元件可視狀態"
          ],
          "commands": [
            "flutter analyze",
            "flutter test --plain-name permission_guard"
          ],
          "touch_files": [
            "lib/router/app_router.dart",
            "lib/router/guards/permission_guard.dart",
            "lib/pages/task/task_detail_page.dart",
            "lib/pages/chat/detail.dart",
            "lib/widgets/buttons/apply_now_button.dart"
          ],
          "acceptance": [
            "路由級與元件級權限控制皆生效",
            "被停權或自停用無法進入 /chat/detail 與觸發 /task/apply",
            "不同權限提示訊息清楚一致"
          ],
          "estimate_hours": 4,
          "deps": []
        }
      ]
    },
    {
      "id": "M-HISTORY-REVIEW",
      "title": "歷史任務預覽與未評價快捷",
      "tasks": [
        {
          "id": "T1-BE-HISTORY-ENDPOINTS",
          "owner": "backend",
          "goal": "提供發任務/接任務歷史列表與評價狀態",
          "steps": [
            "新增 API: GET /tasks/history?role=poster|acceptor，返回任務摘要+是否已評價",
            "若未評價，回傳 flag can_review=true 與快捷評分所需 task_id"
          ],
          "commands": [
            "php artisan route:list | grep tasks/history",
            "phpunit --filter TaskHistory"
          ],
          "touch_files": [
            "routes/api.php",
            "app/Http/Controllers/TaskHistoryController.php"
          ],
          "acceptance": [
            "能依角色列出歷史任務並標記已/未評價",
            "資料量大時可分頁"
          ],
          "estimate_hours": 3,
          "deps": []
        },
        {
          "id": "T2-FLT-HISTORY-UI",
          "owner": "flutter",
          "goal": "履歷頁（Posted/Accepted）支援未評價快捷按鈕",
          "steps": [
            "更新 lib/pages/account/history_page.dart 呈現 Posted 與 Accepted 清單",
            "未評價項目顯示『Review』快捷按鈕，點擊彈出評分視窗（星等+評論可選）",
            "送出後更新該列狀態並即時刷新平均評分"
          ],
          "commands": [
            "flutter analyze",
            "flutter test --plain-name history_review"
          ],
          "touch_files": [
            "lib/pages/account/history_page.dart",
            "lib/widgets/review_dialog.dart",
            "lib/services/api/review_api.dart"
          ],
          "acceptance": [
            "清單可正確顯示已/未評價標記",
            "點擊 Review 可完成評分評論並刷新 UI"
          ],
          "estimate_hours": 5,
          "deps": ["T1-BE-HISTORY-ENDPOINTS"]
        }
      ]
    },
    {
      "id": "M-OAUTH-FIRST-LOGIN",
      "title": "第三方登入首次導引註冊",
      "tasks": [
        {
          "id": "T1-BE-OAUTH-SESSION",
          "owner": "backend",
          "goal": "OAuth 首登建立暫存身份與導引註冊所需資料",
          "steps": [
            "依 user_identities 結構保存 provider, provider_user_id, email, name, avatar_url, tokens(可空)",
            "若為新用戶，回傳 isNewUser=true 與 session_key 供 App 帶往 /signup"
          ],
          "commands": [
            "phpunit --filter OAuthFirstLogin",
            "php artisan tinker"
          ],
          "touch_files": [
            "app/Http/Controllers/OAuthController.php",
            "app/Models/UserIdentity.php",
            "routes/api.php"
          ],
          "acceptance": [
            "新用戶完成 OAuth 後會返回 isNewUser=true 與暫存資料",
            "既有用戶直接登入並返回 JWT"
          ],
          "estimate_hours": 3,
          "deps": []
        },
        {
          "id": "T2-FLT-OAUTH-SIGNUP-FLOW",
          "owner": "flutter",
          "goal": "首次第三方登入導向 /signup 並帶入暫存資料為預設值",
          "steps": [
            "更新 lib/pages/shell_page.dart：若 isNewUser=true，導航至 /signup 並帶入預設值",
            "預設值可缺省，表單提交後建立 users 與 user_identities",
            "成功註冊後導航至 /student-id 或既定流程頁"
          ],
          "commands": [
            "flutter analyze",
            "flutter test --plain-name oauth_signup_flow"
          ],
          "touch_files": [
            "lib/pages/shell_page.dart",
            "lib/pages/auth/signup_page.dart",
            "lib/services/api/oauth_api.dart"
          ],
          "acceptance": [
            "第三方首登能正確跳轉 /signup 並帶入預設值",
            "註冊成功後能正常登入與後續導流"
          ],
          "estimate_hours": 4,
          "deps": ["T1-BE-OAUTH-SESSION"]
        }
      ]
    }
  ],
  "open_questions": [
    "停用帳號時『進行中/發布中』的定義是否包含待審核/未支付等中間狀態？",
    "前端需否在安全性設定頁顯示當前封鎖原因（自停用/被管理員停權）與代碼？",
    "歷史任務清單是否需要離線快取與分頁大小上限？"
  ],
  "suggestions": [
    "在 PermissionGuard 中統一轉譯後端錯誤碼→前端文案，避免多處重複判斷。",
    "support_events 的事件詳情可共用 review_dialog 做評分提交，減少重複 UI。",
    "為停權/停用相關行為加入審計日誌（admin_activity_logs）便於追溯。"
  ]
}

	3.	SQL/Laravel migration 片段：直接可貼用（含 up/down）
	4.	回滾方案：如何在 5 分鐘內恢復（migrate:rollback / dump 匯回）
⸻

Signup 表單對齊（重要）
	•	前端：維持 UI 有 first/last 亦可，但提交時需組合成 name；nickname 為顯示名稱
	•	後端：/api/register 僅處理 name/nickname（忽略來自前端的 first/last，合併成name）
	•	兼容：現有資料庫維持 users.name、users.nickname，不新增/改名欄位

**必守原則**
	•	根據當下專案現有架構判斷哪些功能模組已經完成，如果已有部分進度但尚未完整功能，請幫我列出尚未完成的建議項目，放在suggestions
	•	不新增需求，只基於輸入最佳化方案
	•	每步驟需列出檔案路徑與命令
	•	破壞性變更必備相容層（transformer/adapter）與回退方案
	•	資訊缺漏時，放在 open_questions
	•	嚴格限制 support_events 僅能綁定 chat_rooms.type = support
	•	狀態更新需寫入 support_event_logs
	•	客戶僅能對自己相關事件進行結案/評分
	•	提供 rollback 機制

⸻

👉 這樣貼給高階模型，它就會輸出：
	•	PLAN.md
	•	plan.json
	•	SQL / Laravel migration 範例
	•	測試與 PR 切分

⸻

