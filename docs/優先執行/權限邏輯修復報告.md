# 權限邏輯修復報告

## 🚨 **問題發現**

用戶反映：`permission = -3`（自主停用）的用戶無法前往 `/home` 頁面。

## 🔍 **根本原因分析**

### **問題所在：`PermissionService.canAccessPage` 邏輯錯誤**

#### **原始邏輯（有問題）**：
```dart
static bool canAccessPage(int permission, int requiredPermission) {
  return permission >= requiredPermission;
}
```

#### **問題分析**：
- `/home` 頁面的 `requiredPermission = 0`
- 用戶 `permission = -3`
- `-3 >= 0` 是 `false`，所以被阻擋了！

### **權限設計意圖**：

| 權限值 | 狀態 | 可登入 | 可訪問基本頁面 | 可訪問功能頁面 | 說明 |
|--------|------|--------|----------------|----------------|------|
| `-4` | 用戶自行軟刪除 | ❌ | ❌ | ❌ | 完全無法訪問 |
| `-3` | 用戶自行停用 | ✅ | ✅ | ❌ | 可登入，可訪問基本頁面 |
| `-2` | 管理員軟刪除 | ❌ | ❌ | ❌ | 完全無法訪問 |
| `-1` | 管理員停權 | ✅ | ✅ | ❌ | 可登入，可訪問基本頁面 |
| `0` | 新用戶未認證 | ✅ | ✅ | ❌ | 可登入，可訪問基本頁面 |
| `1` | 已認證用戶 | ✅ | ✅ | ✅ | 可登入，可訪問所有頁面 |

## 🔧 **修復方案**

### **1. 修復 `PermissionService.canAccessPage` 邏輯**

```dart
static bool canAccessPage(int permission, int requiredPermission) {
  // 被刪除的用戶無法訪問任何頁面
  if (permission <= SELF_SOFT_DELETED) {
    return false;
  }
  
  // 停權用戶（-1, -3）可以訪問基本頁面（0），但無法訪問需要認證的頁面（1+）
  if (permission == SUSPENDED_BY_ADMIN || permission == SELF_SUSPENDED) {
    return requiredPermission <= NEW_USER; // 只能訪問 permission 0 的頁面
  }
  
  // 其他情況使用基本邏輯
  return permission >= requiredPermission;
}
```

### **2. 簡化權限守衛邏輯**

移除 `permission_guard.dart` 中重複的停權用戶處理邏輯，讓 `PermissionService.canAccessPage` 統一處理所有權限檢查。

## 📊 **修復效果驗證**

### **測試案例 1：`permission = -3` 用戶訪問 `/home`**
- **頁面權限要求**：`0`
- **用戶權限**：`-3`
- **修復前**：`-3 >= 0` = `false` ❌
- **修復後**：停權用戶可訪問基本頁面 = `true` ✅

### **測試案例 2：`permission = -3` 用戶訪問 `/chat`**
- **頁面權限要求**：`1`
- **用戶權限**：`-3`
- **修復前**：`-3 >= 1` = `false` ❌
- **修復後**：停權用戶無法訪問認證頁面 = `false` ✅

### **測試案例 3：`permission = -1` 用戶訪問 `/home`**
- **頁面權限要求**：`0`
- **用戶權限**：`-1`
- **修復前**：`-1 >= 0` = `false` ❌
- **修復後**：停權用戶可訪問基本頁面 = `true` ✅

### **測試案例 4：`permission = -2` 用戶訪問任何頁面**
- **修復前**：可能允許訪問 ❌
- **修復後**：完全阻擋 = `false` ✅

## 🎯 **權限邏輯總結**

### **新的權限檢查邏輯**：

1. **被刪除用戶**（`permission <= -4`）：
   - ❌ 無法訪問任何頁面
   - ❌ 無法登入

2. **停權用戶**（`permission = -1, -3`）：
   - ✅ 可以登入
   - ✅ 可以訪問基本頁面（`permission = 0`）
   - ❌ 無法訪問需要認證的頁面（`permission >= 1`）

3. **未認證用戶**（`permission = 0`）：
   - ✅ 可以登入
   - ✅ 可以訪問基本頁面
   - ❌ 無法訪問需要認證的頁面

4. **已認證用戶**（`permission >= 1`）：
   - ✅ 可以登入
   - ✅ 可以訪問所有頁面

## 🚀 **修復完成**

### **修復的文件**：
1. `lib/services/permission_service.dart` - 修復 `canAccessPage` 邏輯
2. `lib/router/guards/permission_guard.dart` - 簡化權限守衛邏輯

### **修復效果**：
- ✅ `permission = -3` 用戶現在可以正常訪問 `/home`
- ✅ 停權用戶可以訪問基本頁面，功能受限
- ✅ 被刪除用戶完全無法訪問
- ✅ 權限邏輯統一且清晰

## 📝 **後續建議**

### **1. 功能級權限檢查**
- 在需要認證的功能按鈕上添加權限檢查
- 顯示友好的權限提示

### **2. 用戶體驗優化**
- 在首頁顯示權限狀態提示
- 提供重新啟用帳號的快捷入口

### **3. 測試覆蓋**
- 添加自動化測試覆蓋所有權限場景
- 確保權限邏輯的正確性

---

**修復完成時間**：2025年1月11日  
**修復執行者**：AI Assistant  
**測試狀態**：邏輯驗證完成，待實際測試
