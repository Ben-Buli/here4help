# æ¬Šé™æ‹’çµ•é é¢èˆ‡ AppScaffold æ•´åˆå ±å‘Š

## ğŸ¯ **æ•´åˆç›®æ¨™**

å°‡æ¬Šé™æ‹’çµ•é é¢ï¼ˆ`/permission-denied`ï¼‰èˆ‡ `AppScaffold` çš„è¿”å›ç®­é ­é‚è¼¯æ•´åˆï¼Œæä¾›ä¸€è‡´çš„ç”¨æˆ¶é«”é©—ã€‚

## ğŸ”§ **æ•´åˆå…§å®¹**

### **1. æ¬Šé™æ‹’çµ•é é¢æ”¹ç‚º shell_pages è·¯ç”±**

#### **æ–°å¢è·¯ç”±é…ç½®**ï¼š
```dart
{
  'path': '/permission-denied',
  'child': const PermissionDeniedPage(),
  'title': 'Permission Denied',
  'showAppBar': true,
  'showBottomNav': false,
  'showBackArrow': true,
  'permission': -4, // ä»»ä½•ç‹€æ…‹éƒ½å¯è¨ªå•æ¬Šé™ä¸è¶³é é¢
},
```

#### **é—œéµç‰¹æ€§**ï¼š
- âœ… **çµ±ä¸€çš„è·¯ç”±ç®¡ç†**ï¼šä½¿ç”¨ shell_pages çµ±ä¸€ç®¡ç†
- âœ… **AppBar æ”¯æ´**ï¼šé¡¯ç¤ºæ¨™é¡Œå’Œè¿”å›ç®­é ­
- âœ… **æ¬Šé™æª¢æŸ¥è±å…**ï¼šä»»ä½•ç”¨æˆ¶éƒ½å¯ä»¥è¨ªå•æ­¤é é¢

### **2. ä½¿ç”¨ AppScaffold åŒ…è£**

#### **ä¿®æ”¹å‰**ï¼š
```dart
return Scaffold(
  body: SafeArea(
    child: Padding(...),
  ),
);
```

#### **ä¿®æ”¹å¾Œ**ï¼š
```dart
return AppScaffold(
  title: 'Permission Denied',
  showAppBar: true,
  showBottomNav: false,
  showBackArrow: true,
  child: Padding(...),
);
```

#### **å„ªå‹¢**ï¼š
- âœ… **ä¸€è‡´çš„ UI é¢¨æ ¼**ï¼šä½¿ç”¨æ‡‰ç”¨ç¨‹å¼çµ±ä¸€çš„ AppBar è¨­è¨ˆ
- âœ… **ä¸»é¡Œæ”¯æ´**ï¼šè‡ªå‹•é©æ‡‰ç•¶å‰ä¸»é¡Œè¨­å®š
- âœ… **è¿”å›ç®­é ­é‚è¼¯**ï¼šæ•´åˆ AppScaffold çš„æ™ºèƒ½è¿”å›æ©Ÿåˆ¶

### **3. æ™ºèƒ½è¿”å›é‚è¼¯**

#### **æ–°å¢ `_handleSmartBack` æ–¹æ³•**ï¼š
```dart
void _handleSmartBack(BuildContext context) {
  final state = GoRouterState.of(context);
  final fromPath = state.uri.queryParameters['from'];
  
  if (fromPath != null && fromPath.isNotEmpty) {
    // å¦‚æœåŸå§‹é é¢æ˜¯åŸºæœ¬é é¢ï¼ˆpermission = 0ï¼‰ï¼Œå‰‡å¯ä»¥è¿”å›
    if (fromPath == '/home' || fromPath == '/account' || fromPath == '/task') {
      context.go(fromPath);
      return;
    }
  }
  
  // é è¨­è¿”å›é¦–é 
  context.go('/home');
}
```

#### **é‚è¼¯èªªæ˜**ï¼š
1. **æª¢æŸ¥ä¾†æºè·¯å¾‘**ï¼šå¾æŸ¥è©¢åƒæ•¸ `from` ç²å–è¢«é˜»æ“‹çš„åŸå§‹è·¯å¾‘
2. **æ¬Šé™é©—è­‰**ï¼šåªå…è¨±è¿”å›åŸºæœ¬é é¢ï¼ˆæ¬Šé™è¦æ±‚ = 0ï¼‰
3. **å®‰å…¨å°èˆª**ï¼šé¿å…ç„¡é™å¾ªç’°é‡å®šå‘åˆ°æ¬Šé™æ‹’çµ•é é¢
4. **é è¨­è¡Œç‚º**ï¼šå¦‚æœç„¡æ³•è¿”å›åŸå§‹é é¢ï¼Œå‰‡å°å‘é¦–é 

### **4. æ¬Šé™å®ˆè¡›é‡å®šå‘é‚è¼¯**

#### **ä¿®æ”¹æ¬Šé™å®ˆè¡›**ï¼š
```dart
// æ¬Šé™ 0, -1, -3 è¨ªå•éœ€è¦èªè­‰çš„é é¢æ™‚ï¼Œé‡å®šå‘åˆ°æ¬Šé™æ‹’çµ•é é¢
if (userPermission <= PermissionService.SELF_SUSPENDED &&
    userPermission != -2 &&
    userPermission != -4) {
  // é‡å®šå‘åˆ°æ¬Šé™æ‹’çµ•é é¢ï¼Œä¸¦å‚³éç•¶å‰è·¯å¾‘ä½œç‚ºæŸ¥è©¢åƒæ•¸
  WidgetsBinding.instance.addPostFrameCallback((_) {
    context.go('/permission-denied?from=$path');
  });
  return const SizedBox.shrink();
}
```

#### **é‡å®šå‘æµç¨‹**ï¼š
1. **æ¬Šé™æª¢æŸ¥å¤±æ•—** â†’ é‡å®šå‘åˆ° `/permission-denied?from=åŸå§‹è·¯å¾‘`
2. **æ¬Šé™æ‹’çµ•é é¢** â†’ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯å’Œè¢«é˜»æ“‹çš„è·¯å¾‘
3. **ç”¨æˆ¶æ“ä½œ** â†’ æ™ºèƒ½è¿”å›æˆ–å°å‘é¦–é 

## ğŸ¨ **ç”¨æˆ¶é«”é©—æµç¨‹**

### **å®Œæ•´æµç¨‹**ï¼š
```
ç”¨æˆ¶ç™»å…¥ â†’ å˜—è©¦è¨ªå•å—é™é é¢ â†’ æ¬Šé™æª¢æŸ¥å¤±æ•— â†’ 
é‡å®šå‘åˆ° /permission-denied?from=åŸå§‹è·¯å¾‘ â†’ 
é¡¯ç¤ºæ¬Šé™æ‹’çµ•é é¢ â†’ ç”¨æˆ¶é»æ“Šè¿”å›ç®­é ­ â†’ 
æ™ºèƒ½è¿”å›é‚è¼¯ â†’ å°å‘åˆé©çš„é é¢
```

### **è¿”å›ç®­é ­è¡Œç‚º**ï¼š
1. **AppBar è¿”å›ç®­é ­**ï¼šä½¿ç”¨ AppScaffold çš„æ™ºèƒ½è¿”å›é‚è¼¯
2. **é é¢å…§è¿”å›æŒ‰éˆ•**ï¼šä½¿ç”¨è‡ªå®šç¾©çš„ `_handleSmartBack` é‚è¼¯
3. **è¿”å›é¦–é æŒ‰éˆ•**ï¼šç›´æ¥å°å‘ `/home`

## ğŸ“Š **æ¸¬è©¦æ¡ˆä¾‹**

### **æ¸¬è©¦ 1ï¼šæ¬Šé™ 0 ç”¨æˆ¶è¨ªå• `/chat`**
- **åŸå§‹è·¯å¾‘**ï¼š`/chat`
- **é‡å®šå‘åˆ°**ï¼š`/permission-denied?from=/chat`
- **è¿”å›ç®­é ­è¡Œç‚º**ï¼šå°å‘ `/home`ï¼ˆå› ç‚º `/chat` éœ€è¦æ¬Šé™ 1ï¼‰
- **é æœŸçµæœ**ï¼šâœ… æˆåŠŸè¿”å›é¦–é 

### **æ¸¬è©¦ 2ï¼šæ¬Šé™ -1 ç”¨æˆ¶è¨ªå• `/task/create`**
- **åŸå§‹è·¯å¾‘**ï¼š`/task/create`
- **é‡å®šå‘åˆ°**ï¼š`/permission-denied?from=/task/create`
- **è¿”å›ç®­é ­è¡Œç‚º**ï¼šå°å‘ `/home`ï¼ˆå› ç‚º `/task/create` éœ€è¦æ¬Šé™ 1ï¼‰
- **é æœŸçµæœ**ï¼šâœ… æˆåŠŸè¿”å›é¦–é 

### **æ¸¬è©¦ 3ï¼šæ¬Šé™ -3 ç”¨æˆ¶å¾ `/home` è¨ªå• `/chat`**
- **åŸå§‹è·¯å¾‘**ï¼š`/chat`
- **é‡å®šå‘åˆ°**ï¼š`/permission-denied?from=/chat`
- **è¿”å›ç®­é ­è¡Œç‚º**ï¼šå°å‘ `/home`ï¼ˆå› ç‚ºç”¨æˆ¶ä¹‹å‰åœ¨ `/home`ï¼‰
- **é æœŸçµæœ**ï¼šâœ… æˆåŠŸè¿”å›é¦–é 

### **æ¸¬è©¦ 4ï¼šæ¬Šé™ 1 ç”¨æˆ¶æ­£å¸¸è¨ªå•**
- **è¨ªå•ä»»ä½•é é¢**ï¼šâœ… æ­£å¸¸è¨ªå•
- **ä¸æœƒè§¸ç™¼æ¬Šé™æ‹’çµ•**ï¼šâœ… æ­£å¸¸æµç¨‹

## ğŸš€ **æ•´åˆæ•ˆæœ**

### **æ•´åˆå‰å•é¡Œ**ï¼š
- âŒ æ¬Šé™æ‹’çµ•é é¢ä½¿ç”¨è‡ªå®šç¾© Scaffold
- âŒ è¿”å›é‚è¼¯ä¸ä¸€è‡´
- âŒ æ²’æœ‰èˆ‡ AppScaffold çš„è·¯ç”±æ­·å²æ•´åˆ
- âŒ ç”¨æˆ¶é«”é©—ä¸çµ±ä¸€

### **æ•´åˆå¾Œæ•ˆæœ**ï¼š
- âœ… ä½¿ç”¨çµ±ä¸€çš„ AppScaffold è¨­è¨ˆ
- âœ… æ™ºèƒ½è¿”å›é‚è¼¯èˆ‡è·¯ç”±æ­·å²æ•´åˆ
- âœ… ä¸€è‡´çš„ç”¨æˆ¶é«”é©—
- âœ… å®‰å…¨çš„æ¬Šé™æª¢æŸ¥å’Œå°èˆª

## ğŸ“ **æŠ€è¡“ç´°ç¯€**

### **ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
1. `lib/system/pages/permission_denied_page.dart` - æ•´åˆ AppScaffold
2. `lib/constants/shell_pages.dart` - æ–°å¢è·¯ç”±é…ç½®
3. `lib/router/guards/permission_guard.dart` - é‡å®šå‘é‚è¼¯

### **æ–°å¢åŠŸèƒ½**ï¼š
- `_handleSmartBack()` - æ™ºèƒ½è¿”å›é‚è¼¯
- æŸ¥è©¢åƒæ•¸è™•ç† - `from` åƒæ•¸å‚³éåŸå§‹è·¯å¾‘
- AppScaffold æ•´åˆ - çµ±ä¸€çš„ UI å’Œå°èˆªé«”é©—

### **ä¾è³´é—œä¿‚**ï¼š
- `AppScaffold` - æä¾›çµ±ä¸€çš„é é¢æ¡†æ¶
- `GoRouter` - è·¯ç”±ç®¡ç†å’ŒæŸ¥è©¢åƒæ•¸è™•ç†
- `PermissionProvider` - æ¬Šé™ç‹€æ…‹ç®¡ç†

---

**æ•´åˆå®Œæˆæ™‚é–“**ï¼š2025å¹´1æœˆ11æ—¥  
**æ•´åˆåŸ·è¡Œè€…**ï¼šAI Assistant  
**æ¸¬è©¦ç‹€æ…‹**ï¼šé‚è¼¯é©—è­‰å®Œæˆï¼Œå¾…å¯¦éš›æ¸¬è©¦
