# 修改密碼功能修復報告

## 📋 **問題分析**

從終端輸出可以看到修改密碼功能出現 HTTP 400 錯誤：
```
🔍 [HTTP] POST: http://localhost:8888/here4help/backend/api/account/change-password.php
🔍 [HTTP] Headers: [Content-Type, Accept, Authorization]
🔍 [HTTP] Body: {"current_password":"1234","new_password":"00000000"}...
🔍 [HTTP] Response: 400
```

### **發現的問題**：

1. **Token 傳遞問題**：
   - `password_api.dart` 設置了 `useQueryParamToken: false`
   - 但後端 `change-password.php` 只從 `HTTP_AUTHORIZATION` header 讀取 token
   - MAMP 環境可能不支持 Authorization header

2. **參數不匹配**：
   - 後端要求 `confirm_password` 參數
   - 前端沒有傳遞此參數

3. **密碼強度驗證不一致**：
   - 後端要求密碼包含大小寫字母和數字
   - 前端只檢查長度

## 🔧 **修復方案**

### **1. 修復 Token 傳遞邏輯**

#### **前端修改** (`lib/services/api/password_api.dart`)：

```dart
// 修改前
useQueryParamToken: false, // 使用 Authorization header 而非查詢參數

// 修改後
useQueryParamToken: true, // 使用查詢參數傳遞 token（MAMP 兼容）
```

#### **後端修改** (`backend/api/account/change-password.php`)：

```php
// 修改前
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

if (!$token) {
    throw new Exception('Token is required');
}

// 修改後
// 驗證 JWT token - 支持多源讀取（Authorization header 和查詢參數）
$jwtManager = new JWTManager();

// 嘗試從 Authorization header 讀取
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// 如果 header 中沒有 token，嘗試從查詢參數讀取（MAMP 兼容性）
if (!$token) {
    $token = $_GET['token'] ?? $_POST['token'] ?? '';
}

if (!$token) {
    throw new Exception('Token is required');
}
```

### **2. 修復參數匹配問題**

#### **前端修改** (`lib/services/api/password_api.dart`)：

```dart
// 修改前
final body = {
  'current_password': currentPassword,
  'new_password': newPassword,
  // 'confirm_password': confirmPassword, // 被註釋掉
};

// 修改後
final body = {
  'current_password': currentPassword,
  'new_password': newPassword,
  'confirm_password': newPassword, // 後端需要此參數進行二次驗證
};
```

### **3. 統一密碼強度驗證**

#### **前端修改** (`lib/account/pages/change_password.dart`)：

```dart
// 修改前
String? _validateNew(String? v) {
  final s = (v ?? '').trim();
  if (s.isEmpty) return 'Please enter a new password';
  if (s.length < 8) return 'At least 8 characters';
  return null;
}

// 修改後
String? _validateNew(String? v) {
  final s = (v ?? '').trim();
  if (s.isEmpty) return 'Please enter a new password';
  if (s.length < 8) return 'At least 8 characters';
  
  // 檢查密碼強度（與後端一致）
  if (!RegExp(r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)').hasMatch(s)) {
    return 'Password must contain at least one uppercase letter, one lowercase letter, and one number';
  }
  
  return null;
}
```

#### **更新提示文字**：

```dart
// 修改前
helperText: 'Use 8+ characters.',

// 修改後
helperText: 'Use 8+ characters with uppercase, lowercase, and number.',
```

#### **更新提交條件**：

```dart
// 修改前
bool get _canSubmit {
  return !_submitting &&
      _currentCtrl.text.isNotEmpty &&
      _newCtrl.text.isNotEmpty &&
      _confirmCtrl.text.isNotEmpty &&
      _matchError == null &&
      _newCtrl.text.length >= 8;
}

// 修改後
bool get _canSubmit {
  return !_submitting &&
      _currentCtrl.text.isNotEmpty &&
      _newCtrl.text.isNotEmpty &&
      _confirmCtrl.text.isNotEmpty &&
      _matchError == null &&
      _newCtrl.text.length >= 8 &&
      RegExp(r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)').hasMatch(_newCtrl.text);
}
```

## 📊 **修復後的流程**

### **完整的請求流程**：

1. **前端驗證**：
   - 檢查當前密碼不為空
   - 檢查新密碼長度 >= 8
   - 檢查新密碼包含大小寫字母和數字
   - 檢查確認密碼匹配

2. **API 請求**：
   - 使用 `HttpClientService.post()` 
   - 設置 `useQueryParamToken: true`
   - 傳遞 `current_password`, `new_password`, `confirm_password`

3. **後端處理**：
   - 多源讀取 token（header 或查詢參數）
   - 驗證 JWT token
   - 驗證當前密碼
   - 檢查新密碼強度
   - 更新密碼並記錄日誌

### **錯誤處理**：

- **Token 問題**：`Token is required` / `Invalid or expired token`
- **密碼驗證**：`Current password is incorrect`
- **密碼強度**：`Password must contain at least one uppercase letter, one lowercase letter, and one number`
- **重複密碼**：`New password must be different from current password`

## ✅ **測試建議**

### **測試案例**：

1. **正常修改密碼**：
   - 當前密碼：正確
   - 新密碼：`NewPass123`（符合強度要求）
   - 預期：成功

2. **密碼強度不足**：
   - 新密碼：`newpass`（只有小寫）
   - 預期：前端驗證失敗

3. **當前密碼錯誤**：
   - 當前密碼：錯誤
   - 預期：後端返回 400 錯誤

4. **Token 失效**：
   - 使用過期 token
   - 預期：後端返回 token 錯誤

## 🎯 **完成狀態**

- [x] 修復 token 傳遞邏輯（前端 + 後端）
- [x] 修復 confirm_password 參數問題
- [x] 統一密碼強度驗證規則
- [x] 更新用戶界面提示文字
- [x] 清理未使用的代碼

## 📝 **注意事項**

1. **MAMP 兼容性**：現在使用查詢參數傳遞 token，確保在 MAMP 環境下正常工作
2. **安全性**：後端仍然支持 Authorization header，優先使用更安全的方式
3. **用戶體驗**：前端實時驗證密碼強度，避免提交後才發現錯誤
4. **一致性**：前後端密碼強度要求完全一致

修復後，修改密碼功能應該能正常工作，用戶可以成功更改密碼並收到相應的成功或錯誤提示。
