# ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½ä¿®å¾©å ±å‘Š

## ğŸ“‹ **å•é¡Œåˆ†æ**

å¾çµ‚ç«¯è¼¸å‡ºå¯ä»¥çœ‹åˆ°ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½å‡ºç¾ HTTP 400 éŒ¯èª¤ï¼š
```
ğŸ” [HTTP] POST: http://localhost:8888/here4help/backend/api/account/change-password.php
ğŸ” [HTTP] Headers: [Content-Type, Accept, Authorization]
ğŸ” [HTTP] Body: {"current_password":"1234","new_password":"00000000"}...
ğŸ” [HTTP] Response: 400
```

### **ç™¼ç¾çš„å•é¡Œ**ï¼š

1. **Token å‚³éå•é¡Œ**ï¼š
   - `password_api.dart` è¨­ç½®äº† `useQueryParamToken: false`
   - ä½†å¾Œç«¯ `change-password.php` åªå¾ `HTTP_AUTHORIZATION` header è®€å– token
   - MAMP ç’°å¢ƒå¯èƒ½ä¸æ”¯æŒ Authorization header

2. **åƒæ•¸ä¸åŒ¹é…**ï¼š
   - å¾Œç«¯è¦æ±‚ `confirm_password` åƒæ•¸
   - å‰ç«¯æ²’æœ‰å‚³éæ­¤åƒæ•¸

3. **å¯†ç¢¼å¼·åº¦é©—è­‰ä¸ä¸€è‡´**ï¼š
   - å¾Œç«¯è¦æ±‚å¯†ç¢¼åŒ…å«å¤§å°å¯«å­—æ¯å’Œæ•¸å­—
   - å‰ç«¯åªæª¢æŸ¥é•·åº¦

## ğŸ”§ **ä¿®å¾©æ–¹æ¡ˆ**

### **1. ä¿®å¾© Token å‚³éé‚è¼¯**

#### **å‰ç«¯ä¿®æ”¹** (`lib/services/api/password_api.dart`)ï¼š

```dart
// ä¿®æ”¹å‰
useQueryParamToken: false, // ä½¿ç”¨ Authorization header è€ŒéæŸ¥è©¢åƒæ•¸

// ä¿®æ”¹å¾Œ
useQueryParamToken: true, // ä½¿ç”¨æŸ¥è©¢åƒæ•¸å‚³é tokenï¼ˆMAMP å…¼å®¹ï¼‰
```

#### **å¾Œç«¯ä¿®æ”¹** (`backend/api/account/change-password.php`)ï¼š

```php
// ä¿®æ”¹å‰
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

if (!$token) {
    throw new Exception('Token is required');
}

// ä¿®æ”¹å¾Œ
// é©—è­‰ JWT token - æ”¯æŒå¤šæºè®€å–ï¼ˆAuthorization header å’ŒæŸ¥è©¢åƒæ•¸ï¼‰
$jwtManager = new JWTManager();

// å˜—è©¦å¾ Authorization header è®€å–
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// å¦‚æœ header ä¸­æ²’æœ‰ tokenï¼Œå˜—è©¦å¾æŸ¥è©¢åƒæ•¸è®€å–ï¼ˆMAMP å…¼å®¹æ€§ï¼‰
if (!$token) {
    $token = $_GET['token'] ?? $_POST['token'] ?? '';
}

if (!$token) {
    throw new Exception('Token is required');
}
```

### **2. ä¿®å¾©åƒæ•¸åŒ¹é…å•é¡Œ**

#### **å‰ç«¯ä¿®æ”¹** (`lib/services/api/password_api.dart`)ï¼š

```dart
// ä¿®æ”¹å‰
final body = {
  'current_password': currentPassword,
  'new_password': newPassword,
  // 'confirm_password': confirmPassword, // è¢«è¨»é‡‹æ‰
};

// ä¿®æ”¹å¾Œ
final body = {
  'current_password': currentPassword,
  'new_password': newPassword,
  'confirm_password': newPassword, // å¾Œç«¯éœ€è¦æ­¤åƒæ•¸é€²è¡ŒäºŒæ¬¡é©—è­‰
};
```

### **3. çµ±ä¸€å¯†ç¢¼å¼·åº¦é©—è­‰**

#### **å‰ç«¯ä¿®æ”¹** (`lib/account/pages/change_password.dart`)ï¼š

```dart
// ä¿®æ”¹å‰
String? _validateNew(String? v) {
  final s = (v ?? '').trim();
  if (s.isEmpty) return 'Please enter a new password';
  if (s.length < 8) return 'At least 8 characters';
  return null;
}

// ä¿®æ”¹å¾Œ
String? _validateNew(String? v) {
  final s = (v ?? '').trim();
  if (s.isEmpty) return 'Please enter a new password';
  if (s.length < 8) return 'At least 8 characters';
  
  // æª¢æŸ¥å¯†ç¢¼å¼·åº¦ï¼ˆèˆ‡å¾Œç«¯ä¸€è‡´ï¼‰
  if (!RegExp(r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)').hasMatch(s)) {
    return 'Password must contain at least one uppercase letter, one lowercase letter, and one number';
  }
  
  return null;
}
```

#### **æ›´æ–°æç¤ºæ–‡å­—**ï¼š

```dart
// ä¿®æ”¹å‰
helperText: 'Use 8+ characters.',

// ä¿®æ”¹å¾Œ
helperText: 'Use 8+ characters with uppercase, lowercase, and number.',
```

#### **æ›´æ–°æäº¤æ¢ä»¶**ï¼š

```dart
// ä¿®æ”¹å‰
bool get _canSubmit {
  return !_submitting &&
      _currentCtrl.text.isNotEmpty &&
      _newCtrl.text.isNotEmpty &&
      _confirmCtrl.text.isNotEmpty &&
      _matchError == null &&
      _newCtrl.text.length >= 8;
}

// ä¿®æ”¹å¾Œ
bool get _canSubmit {
  return !_submitting &&
      _currentCtrl.text.isNotEmpty &&
      _newCtrl.text.isNotEmpty &&
      _confirmCtrl.text.isNotEmpty &&
      _matchError == null &&
      _newCtrl.text.length >= 8 &&
      RegExp(r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)').hasMatch(_newCtrl.text);
}
```

## ğŸ“Š **ä¿®å¾©å¾Œçš„æµç¨‹**

### **å®Œæ•´çš„è«‹æ±‚æµç¨‹**ï¼š

1. **å‰ç«¯é©—è­‰**ï¼š
   - æª¢æŸ¥ç•¶å‰å¯†ç¢¼ä¸ç‚ºç©º
   - æª¢æŸ¥æ–°å¯†ç¢¼é•·åº¦ >= 8
   - æª¢æŸ¥æ–°å¯†ç¢¼åŒ…å«å¤§å°å¯«å­—æ¯å’Œæ•¸å­—
   - æª¢æŸ¥ç¢ºèªå¯†ç¢¼åŒ¹é…

2. **API è«‹æ±‚**ï¼š
   - ä½¿ç”¨ `HttpClientService.post()` 
   - è¨­ç½® `useQueryParamToken: true`
   - å‚³é `current_password`, `new_password`, `confirm_password`

3. **å¾Œç«¯è™•ç†**ï¼š
   - å¤šæºè®€å– tokenï¼ˆheader æˆ–æŸ¥è©¢åƒæ•¸ï¼‰
   - é©—è­‰ JWT token
   - é©—è­‰ç•¶å‰å¯†ç¢¼
   - æª¢æŸ¥æ–°å¯†ç¢¼å¼·åº¦
   - æ›´æ–°å¯†ç¢¼ä¸¦è¨˜éŒ„æ—¥èªŒ

### **éŒ¯èª¤è™•ç†**ï¼š

- **Token å•é¡Œ**ï¼š`Token is required` / `Invalid or expired token`
- **å¯†ç¢¼é©—è­‰**ï¼š`Current password is incorrect`
- **å¯†ç¢¼å¼·åº¦**ï¼š`Password must contain at least one uppercase letter, one lowercase letter, and one number`
- **é‡è¤‡å¯†ç¢¼**ï¼š`New password must be different from current password`

## âœ… **æ¸¬è©¦å»ºè­°**

### **æ¸¬è©¦æ¡ˆä¾‹**ï¼š

1. **æ­£å¸¸ä¿®æ”¹å¯†ç¢¼**ï¼š
   - ç•¶å‰å¯†ç¢¼ï¼šæ­£ç¢º
   - æ–°å¯†ç¢¼ï¼š`NewPass123`ï¼ˆç¬¦åˆå¼·åº¦è¦æ±‚ï¼‰
   - é æœŸï¼šæˆåŠŸ

2. **å¯†ç¢¼å¼·åº¦ä¸è¶³**ï¼š
   - æ–°å¯†ç¢¼ï¼š`newpass`ï¼ˆåªæœ‰å°å¯«ï¼‰
   - é æœŸï¼šå‰ç«¯é©—è­‰å¤±æ•—

3. **ç•¶å‰å¯†ç¢¼éŒ¯èª¤**ï¼š
   - ç•¶å‰å¯†ç¢¼ï¼šéŒ¯èª¤
   - é æœŸï¼šå¾Œç«¯è¿”å› 400 éŒ¯èª¤

4. **Token å¤±æ•ˆ**ï¼š
   - ä½¿ç”¨éæœŸ token
   - é æœŸï¼šå¾Œç«¯è¿”å› token éŒ¯èª¤

## ğŸ¯ **å®Œæˆç‹€æ…‹**

- [x] ä¿®å¾© token å‚³éé‚è¼¯ï¼ˆå‰ç«¯ + å¾Œç«¯ï¼‰
- [x] ä¿®å¾© confirm_password åƒæ•¸å•é¡Œ
- [x] çµ±ä¸€å¯†ç¢¼å¼·åº¦é©—è­‰è¦å‰‡
- [x] æ›´æ–°ç”¨æˆ¶ç•Œé¢æç¤ºæ–‡å­—
- [x] æ¸…ç†æœªä½¿ç”¨çš„ä»£ç¢¼

## ğŸ“ **æ³¨æ„äº‹é …**

1. **MAMP å…¼å®¹æ€§**ï¼šç¾åœ¨ä½¿ç”¨æŸ¥è©¢åƒæ•¸å‚³é tokenï¼Œç¢ºä¿åœ¨ MAMP ç’°å¢ƒä¸‹æ­£å¸¸å·¥ä½œ
2. **å®‰å…¨æ€§**ï¼šå¾Œç«¯ä»ç„¶æ”¯æŒ Authorization headerï¼Œå„ªå…ˆä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
3. **ç”¨æˆ¶é«”é©—**ï¼šå‰ç«¯å¯¦æ™‚é©—è­‰å¯†ç¢¼å¼·åº¦ï¼Œé¿å…æäº¤å¾Œæ‰ç™¼ç¾éŒ¯èª¤
4. **ä¸€è‡´æ€§**ï¼šå‰å¾Œç«¯å¯†ç¢¼å¼·åº¦è¦æ±‚å®Œå…¨ä¸€è‡´

ä¿®å¾©å¾Œï¼Œä¿®æ”¹å¯†ç¢¼åŠŸèƒ½æ‡‰è©²èƒ½æ­£å¸¸å·¥ä½œï¼Œç”¨æˆ¶å¯ä»¥æˆåŠŸæ›´æ”¹å¯†ç¢¼ä¸¦æ”¶åˆ°ç›¸æ‡‰çš„æˆåŠŸæˆ–éŒ¯èª¤æç¤ºã€‚
