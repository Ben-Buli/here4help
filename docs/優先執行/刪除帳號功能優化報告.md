# 刪除帳號功能優化報告

## 📋 **需求分析**

根據用戶要求，需要對 `/security` 頁面的刪除帳號功能進行以下調整：

1. **前端確認機制**：將密碼確認改為輸入 "DELETE" 文字確認
2. **後端狀態調整**：`users.status = 'inactive'` 而非 `'self_deleted'`
3. **日誌記錄**：使用 `user_active_log` 表記錄操作
4. **選填原因**：刪除原因改為選填而非必填
5. **權限同步**：確保所有帳號操作都更新 `PermissionProvider` 狀態

## 🔧 **實現方案**

### **1. 前端對話框優化**

#### **檔案**: `lib/account/pages/security_page.dart`

**主要變更**：
- 移除密碼輸入欄位
- 新增 "DELETE" 文字確認輸入
- 刪除原因改為選填
- 添加清楚的說明文字

```dart
// 修改前：密碼確認
TextField(
  controller: passwordController,
  obscureText: true,
  decoration: const InputDecoration(
    labelText: 'Confirm Password',
    border: OutlineInputBorder(),
    prefixIcon: Icon(Icons.lock),
  ),
),

// 修改後：DELETE 文字確認
Text(
  'To confirm deletion, please type "DELETE" (case-sensitive) in the field below:',
  style: TextStyle(
    fontSize: 14,
    color: Theme.of(context).colorScheme.onSurface,
  ),
),
TextField(
  controller: confirmationController,
  decoration: const InputDecoration(
    labelText: 'Type "DELETE" to confirm',
    border: OutlineInputBorder(),
    prefixIcon: Icon(Icons.keyboard),
    hintText: 'DELETE',
  ),
),
```

**驗證邏輯**：
```dart
if (confirmationController.text != 'DELETE') {
  setDialogState(() {
    deleteError = 'Please type "DELETE" exactly as shown to confirm';
  });
  return;
}
```

### **2. API 參數調整**

#### **檔案**: `lib/services/api/password_api.dart`

**主要變更**：
- 參數名稱從 `password` 改為 `confirmation`
- `reason` 改為可選參數
- 支持 MAMP 兼容的 token 傳遞

```dart
/// 刪除帳號
static Future<Map<String, dynamic>> deleteAccount({
  required String password, // 現在是 "DELETE" 確認文字
  String? reason, // 改為可選參數
}) async {
  final body = <String, dynamic>{
    'confirmation': password, // 傳遞 "DELETE" 確認文字
  };
  
  // 只有在有原因時才添加
  if (reason != null && reason.isNotEmpty) {
    body['reason'] = reason;
  }
}
```

### **3. 後端邏輯重構**

#### **檔案**: `backend/api/account/delete.php`

**主要變更**：

1. **多源 Token 讀取**：
```php
// 嘗試從 Authorization header 讀取
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// 如果 header 中沒有 token，嘗試從查詢參數讀取（MAMP 兼容性）
if (!$token) {
    $token = $_GET['token'] ?? $_POST['token'] ?? '';
}
```

2. **確認文字驗證**：
```php
$confirmation = $input['confirmation'] ?? '';
$reason = $input['reason'] ?? '';

// 驗證必要欄位
if ($confirmation !== 'DELETE') {
    throw new Exception('Please type "DELETE" to confirm account deletion');
}
```

3. **移除密碼驗證**：
```php
// 移除了密碼查詢和驗證邏輯
$stmt = $pdo->prepare("SELECT permission, status FROM users WHERE id = ?");
```

4. **狀態更新調整**：
```php
// 修改前
SET permission = -4, 
    status = 'self_deleted', 

// 修改後
SET permission = -4, 
    status = 'inactive',
```

5. **日誌記錄優化**：
```php
// 使用 user_active_log 表
$logStmt = $pdo->prepare("
    INSERT INTO user_active_log (user_id, actor_type, actor_id, action, field, old_value, new_value, reason, ip, user_agent, request_id, trace_id, metadata)
    VALUES (?, 'user', ?, 'delete', NULL, NULL, NULL, ?, ?, ?, ?, ?, ?)
");

$metadata = json_encode([
    'deleted_at' => date('Y-m-d H:i:s'),
    'reason' => $reason ?: 'No reason provided'
]);
```

### **4. 權限狀態同步**

#### **三個 API 的權限更新**：

1. **刪除帳號** (`delete.php`)：
```dart
// 更新權限狀態
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.clearPermission(); // 清除所有權限狀態
```

2. **停用帳號** (`deactivate.php`)：
```dart
// 更新權限狀態
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.updatePermission(-3); // 設為自行停用
```

3. **重啟帳號** (`reactivate.php`)：
```dart
// 更新權限狀態
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.updatePermission(1); // 恢復為已驗證用戶
```

## 📊 **數據庫變更**

### **用戶狀態變更**：
```sql
-- 刪除帳號時
UPDATE users SET 
    permission = -4,
    status = 'inactive',  -- 而非 'self_deleted'
    deleted_at = NOW(),
    updated_at = NOW()
WHERE id = ?;
```

### **日誌記錄**：
```sql
-- user_active_log 表記錄
INSERT INTO user_active_log (
    user_id, actor_type, actor_id, action, 
    reason, ip, user_agent, metadata
) VALUES (
    ?, 'user', ?, 'delete',
    'User self-deleted account', ?, ?, ?
);
```

## 🎯 **用戶體驗流程**

### **新的刪除流程**：
```
1. 用戶點擊 "Delete Account" 按鈕
2. 彈出確認對話框
3. 用戶閱讀警告訊息
4. 用戶在輸入框中輸入 "DELETE"（大小寫敏感）
5. 用戶可選擇填寫刪除原因
6. 點擊 "Delete Account" 按鈕
7. 前端驗證 "DELETE" 文字
8. 發送 API 請求到後端
9. 後端驗證並執行刪除
10. 更新權限狀態並清除本地資料
11. 跳轉到登入頁面
```

### **安全性改進**：
- **意識確認**：要求輸入 "DELETE" 確保用戶有意識地執行操作
- **移除密碼**：避免密碼洩露風險
- **詳細日誌**：完整記錄刪除操作和原因
- **狀態一致**：確保前後端權限狀態同步

## ✅ **測試案例**

### **測試 1：正常刪除流程**
- **輸入**：確認文字 "DELETE"，原因 "不再需要"
- **預期**：成功刪除，跳轉登入頁
- **驗證**：`users.permission = -4`, `status = 'inactive'`

### **測試 2：確認文字錯誤**
- **輸入**：確認文字 "delete"（小寫）
- **預期**：顯示錯誤 "Please type 'DELETE' exactly as shown to confirm"

### **測試 3：無原因刪除**
- **輸入**：確認文字 "DELETE"，原因留空
- **預期**：成功刪除，日誌記錄 "No reason provided"

### **測試 4：權限狀態同步**
- **操作**：執行刪除後檢查 `PermissionProvider`
- **預期**：權限狀態被清除，導航受限

## 🔍 **完成狀態**

- [x] 修改前端刪除對話框：密碼改為 "DELETE" 文字確認
- [x] 修改後端 `delete.php`：調整 `status` 為 `inactive`
- [x] 添加多源 token 讀取支持（MAMP 兼容）
- [x] 刪除原因改為選填
- [x] 確保三個 API 都更新 `PermissionProvider` 狀態
- [x] 使用 `user_active_log` 表記錄操作日誌
- [x] 移除密碼驗證邏輯
- [x] 添加必要的 import 和修復語法錯誤

## 🎉 **效果總結**

1. **更安全的確認機制**：用戶必須有意識地輸入 "DELETE" 才能刪除帳號
2. **簡化的操作流程**：不需要記住密碼，降低操作門檻
3. **靈活的原因收集**：用戶可選擇是否提供刪除原因
4. **一致的狀態管理**：所有帳號操作都正確更新權限狀態
5. **完整的操作記錄**：使用統一的日誌表記錄所有操作

這些改進提升了用戶體驗，同時保持了操作的安全性和可追溯性。
