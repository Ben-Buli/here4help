# åˆªé™¤å¸³è™ŸåŠŸèƒ½å„ªåŒ–å ±å‘Š

## ğŸ“‹ **éœ€æ±‚åˆ†æ**

æ ¹æ“šç”¨æˆ¶è¦æ±‚ï¼Œéœ€è¦å° `/security` é é¢çš„åˆªé™¤å¸³è™ŸåŠŸèƒ½é€²è¡Œä»¥ä¸‹èª¿æ•´ï¼š

1. **å‰ç«¯ç¢ºèªæ©Ÿåˆ¶**ï¼šå°‡å¯†ç¢¼ç¢ºèªæ”¹ç‚ºè¼¸å…¥ "DELETE" æ–‡å­—ç¢ºèª
2. **å¾Œç«¯ç‹€æ…‹èª¿æ•´**ï¼š`users.status = 'inactive'` è€Œé `'self_deleted'`
3. **æ—¥èªŒè¨˜éŒ„**ï¼šä½¿ç”¨ `user_active_log` è¡¨è¨˜éŒ„æ“ä½œ
4. **é¸å¡«åŸå› **ï¼šåˆªé™¤åŸå› æ”¹ç‚ºé¸å¡«è€Œéå¿…å¡«
5. **æ¬Šé™åŒæ­¥**ï¼šç¢ºä¿æ‰€æœ‰å¸³è™Ÿæ“ä½œéƒ½æ›´æ–° `PermissionProvider` ç‹€æ…‹

## ğŸ”§ **å¯¦ç¾æ–¹æ¡ˆ**

### **1. å‰ç«¯å°è©±æ¡†å„ªåŒ–**

#### **æª”æ¡ˆ**: `lib/account/pages/security_page.dart`

**ä¸»è¦è®Šæ›´**ï¼š
- ç§»é™¤å¯†ç¢¼è¼¸å…¥æ¬„ä½
- æ–°å¢ "DELETE" æ–‡å­—ç¢ºèªè¼¸å…¥
- åˆªé™¤åŸå› æ”¹ç‚ºé¸å¡«
- æ·»åŠ æ¸…æ¥šçš„èªªæ˜æ–‡å­—

```dart
// ä¿®æ”¹å‰ï¼šå¯†ç¢¼ç¢ºèª
TextField(
  controller: passwordController,
  obscureText: true,
  decoration: const InputDecoration(
    labelText: 'Confirm Password',
    border: OutlineInputBorder(),
    prefixIcon: Icon(Icons.lock),
  ),
),

// ä¿®æ”¹å¾Œï¼šDELETE æ–‡å­—ç¢ºèª
Text(
  'To confirm deletion, please type "DELETE" (case-sensitive) in the field below:',
  style: TextStyle(
    fontSize: 14,
    color: Theme.of(context).colorScheme.onSurface,
  ),
),
TextField(
  controller: confirmationController,
  decoration: const InputDecoration(
    labelText: 'Type "DELETE" to confirm',
    border: OutlineInputBorder(),
    prefixIcon: Icon(Icons.keyboard),
    hintText: 'DELETE',
  ),
),
```

**é©—è­‰é‚è¼¯**ï¼š
```dart
if (confirmationController.text != 'DELETE') {
  setDialogState(() {
    deleteError = 'Please type "DELETE" exactly as shown to confirm';
  });
  return;
}
```

### **2. API åƒæ•¸èª¿æ•´**

#### **æª”æ¡ˆ**: `lib/services/api/password_api.dart`

**ä¸»è¦è®Šæ›´**ï¼š
- åƒæ•¸åç¨±å¾ `password` æ”¹ç‚º `confirmation`
- `reason` æ”¹ç‚ºå¯é¸åƒæ•¸
- æ”¯æŒ MAMP å…¼å®¹çš„ token å‚³é

```dart
/// åˆªé™¤å¸³è™Ÿ
static Future<Map<String, dynamic>> deleteAccount({
  required String password, // ç¾åœ¨æ˜¯ "DELETE" ç¢ºèªæ–‡å­—
  String? reason, // æ”¹ç‚ºå¯é¸åƒæ•¸
}) async {
  final body = <String, dynamic>{
    'confirmation': password, // å‚³é "DELETE" ç¢ºèªæ–‡å­—
  };
  
  // åªæœ‰åœ¨æœ‰åŸå› æ™‚æ‰æ·»åŠ 
  if (reason != null && reason.isNotEmpty) {
    body['reason'] = reason;
  }
}
```

### **3. å¾Œç«¯é‚è¼¯é‡æ§‹**

#### **æª”æ¡ˆ**: `backend/api/account/delete.php`

**ä¸»è¦è®Šæ›´**ï¼š

1. **å¤šæº Token è®€å–**ï¼š
```php
// å˜—è©¦å¾ Authorization header è®€å–
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $authHeader);

// å¦‚æœ header ä¸­æ²’æœ‰ tokenï¼Œå˜—è©¦å¾æŸ¥è©¢åƒæ•¸è®€å–ï¼ˆMAMP å…¼å®¹æ€§ï¼‰
if (!$token) {
    $token = $_GET['token'] ?? $_POST['token'] ?? '';
}
```

2. **ç¢ºèªæ–‡å­—é©—è­‰**ï¼š
```php
$confirmation = $input['confirmation'] ?? '';
$reason = $input['reason'] ?? '';

// é©—è­‰å¿…è¦æ¬„ä½
if ($confirmation !== 'DELETE') {
    throw new Exception('Please type "DELETE" to confirm account deletion');
}
```

3. **ç§»é™¤å¯†ç¢¼é©—è­‰**ï¼š
```php
// ç§»é™¤äº†å¯†ç¢¼æŸ¥è©¢å’Œé©—è­‰é‚è¼¯
$stmt = $pdo->prepare("SELECT permission, status FROM users WHERE id = ?");
```

4. **ç‹€æ…‹æ›´æ–°èª¿æ•´**ï¼š
```php
// ä¿®æ”¹å‰
SET permission = -4, 
    status = 'self_deleted', 

// ä¿®æ”¹å¾Œ
SET permission = -4, 
    status = 'inactive',
```

5. **æ—¥èªŒè¨˜éŒ„å„ªåŒ–**ï¼š
```php
// ä½¿ç”¨ user_active_log è¡¨
$logStmt = $pdo->prepare("
    INSERT INTO user_active_log (user_id, actor_type, actor_id, action, field, old_value, new_value, reason, ip, user_agent, request_id, trace_id, metadata)
    VALUES (?, 'user', ?, 'delete', NULL, NULL, NULL, ?, ?, ?, ?, ?, ?)
");

$metadata = json_encode([
    'deleted_at' => date('Y-m-d H:i:s'),
    'reason' => $reason ?: 'No reason provided'
]);
```

### **4. æ¬Šé™ç‹€æ…‹åŒæ­¥**

#### **ä¸‰å€‹ API çš„æ¬Šé™æ›´æ–°**ï¼š

1. **åˆªé™¤å¸³è™Ÿ** (`delete.php`)ï¼š
```dart
// æ›´æ–°æ¬Šé™ç‹€æ…‹
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.clearPermission(); // æ¸…é™¤æ‰€æœ‰æ¬Šé™ç‹€æ…‹
```

2. **åœç”¨å¸³è™Ÿ** (`deactivate.php`)ï¼š
```dart
// æ›´æ–°æ¬Šé™ç‹€æ…‹
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.updatePermission(-3); // è¨­ç‚ºè‡ªè¡Œåœç”¨
```

3. **é‡å•Ÿå¸³è™Ÿ** (`reactivate.php`)ï¼š
```dart
// æ›´æ–°æ¬Šé™ç‹€æ…‹
final permissionProvider = Provider.of<PermissionProvider>(context, listen: false);
permissionProvider.updatePermission(1); // æ¢å¾©ç‚ºå·²é©—è­‰ç”¨æˆ¶
```

## ğŸ“Š **æ•¸æ“šåº«è®Šæ›´**

### **ç”¨æˆ¶ç‹€æ…‹è®Šæ›´**ï¼š
```sql
-- åˆªé™¤å¸³è™Ÿæ™‚
UPDATE users SET 
    permission = -4,
    status = 'inactive',  -- è€Œé 'self_deleted'
    deleted_at = NOW(),
    updated_at = NOW()
WHERE id = ?;
```

### **æ—¥èªŒè¨˜éŒ„**ï¼š
```sql
-- user_active_log è¡¨è¨˜éŒ„
INSERT INTO user_active_log (
    user_id, actor_type, actor_id, action, 
    reason, ip, user_agent, metadata
) VALUES (
    ?, 'user', ?, 'delete',
    'User self-deleted account', ?, ?, ?
);
```

## ğŸ¯ **ç”¨æˆ¶é«”é©—æµç¨‹**

### **æ–°çš„åˆªé™¤æµç¨‹**ï¼š
```
1. ç”¨æˆ¶é»æ“Š "Delete Account" æŒ‰éˆ•
2. å½ˆå‡ºç¢ºèªå°è©±æ¡†
3. ç”¨æˆ¶é–±è®€è­¦å‘Šè¨Šæ¯
4. ç”¨æˆ¶åœ¨è¼¸å…¥æ¡†ä¸­è¼¸å…¥ "DELETE"ï¼ˆå¤§å°å¯«æ•æ„Ÿï¼‰
5. ç”¨æˆ¶å¯é¸æ“‡å¡«å¯«åˆªé™¤åŸå› 
6. é»æ“Š "Delete Account" æŒ‰éˆ•
7. å‰ç«¯é©—è­‰ "DELETE" æ–‡å­—
8. ç™¼é€ API è«‹æ±‚åˆ°å¾Œç«¯
9. å¾Œç«¯é©—è­‰ä¸¦åŸ·è¡Œåˆªé™¤
10. æ›´æ–°æ¬Šé™ç‹€æ…‹ä¸¦æ¸…é™¤æœ¬åœ°è³‡æ–™
11. è·³è½‰åˆ°ç™»å…¥é é¢
```

### **å®‰å…¨æ€§æ”¹é€²**ï¼š
- **æ„è­˜ç¢ºèª**ï¼šè¦æ±‚è¼¸å…¥ "DELETE" ç¢ºä¿ç”¨æˆ¶æœ‰æ„è­˜åœ°åŸ·è¡Œæ“ä½œ
- **ç§»é™¤å¯†ç¢¼**ï¼šé¿å…å¯†ç¢¼æ´©éœ²é¢¨éšª
- **è©³ç´°æ—¥èªŒ**ï¼šå®Œæ•´è¨˜éŒ„åˆªé™¤æ“ä½œå’ŒåŸå› 
- **ç‹€æ…‹ä¸€è‡´**ï¼šç¢ºä¿å‰å¾Œç«¯æ¬Šé™ç‹€æ…‹åŒæ­¥

## âœ… **æ¸¬è©¦æ¡ˆä¾‹**

### **æ¸¬è©¦ 1ï¼šæ­£å¸¸åˆªé™¤æµç¨‹**
- **è¼¸å…¥**ï¼šç¢ºèªæ–‡å­— "DELETE"ï¼ŒåŸå›  "ä¸å†éœ€è¦"
- **é æœŸ**ï¼šæˆåŠŸåˆªé™¤ï¼Œè·³è½‰ç™»å…¥é 
- **é©—è­‰**ï¼š`users.permission = -4`, `status = 'inactive'`

### **æ¸¬è©¦ 2ï¼šç¢ºèªæ–‡å­—éŒ¯èª¤**
- **è¼¸å…¥**ï¼šç¢ºèªæ–‡å­— "delete"ï¼ˆå°å¯«ï¼‰
- **é æœŸ**ï¼šé¡¯ç¤ºéŒ¯èª¤ "Please type 'DELETE' exactly as shown to confirm"

### **æ¸¬è©¦ 3ï¼šç„¡åŸå› åˆªé™¤**
- **è¼¸å…¥**ï¼šç¢ºèªæ–‡å­— "DELETE"ï¼ŒåŸå› ç•™ç©º
- **é æœŸ**ï¼šæˆåŠŸåˆªé™¤ï¼Œæ—¥èªŒè¨˜éŒ„ "No reason provided"

### **æ¸¬è©¦ 4ï¼šæ¬Šé™ç‹€æ…‹åŒæ­¥**
- **æ“ä½œ**ï¼šåŸ·è¡Œåˆªé™¤å¾Œæª¢æŸ¥ `PermissionProvider`
- **é æœŸ**ï¼šæ¬Šé™ç‹€æ…‹è¢«æ¸…é™¤ï¼Œå°èˆªå—é™

## ğŸ” **å®Œæˆç‹€æ…‹**

- [x] ä¿®æ”¹å‰ç«¯åˆªé™¤å°è©±æ¡†ï¼šå¯†ç¢¼æ”¹ç‚º "DELETE" æ–‡å­—ç¢ºèª
- [x] ä¿®æ”¹å¾Œç«¯ `delete.php`ï¼šèª¿æ•´ `status` ç‚º `inactive`
- [x] æ·»åŠ å¤šæº token è®€å–æ”¯æŒï¼ˆMAMP å…¼å®¹ï¼‰
- [x] åˆªé™¤åŸå› æ”¹ç‚ºé¸å¡«
- [x] ç¢ºä¿ä¸‰å€‹ API éƒ½æ›´æ–° `PermissionProvider` ç‹€æ…‹
- [x] ä½¿ç”¨ `user_active_log` è¡¨è¨˜éŒ„æ“ä½œæ—¥èªŒ
- [x] ç§»é™¤å¯†ç¢¼é©—è­‰é‚è¼¯
- [x] æ·»åŠ å¿…è¦çš„ import å’Œä¿®å¾©èªæ³•éŒ¯èª¤

## ğŸ‰ **æ•ˆæœç¸½çµ**

1. **æ›´å®‰å…¨çš„ç¢ºèªæ©Ÿåˆ¶**ï¼šç”¨æˆ¶å¿…é ˆæœ‰æ„è­˜åœ°è¼¸å…¥ "DELETE" æ‰èƒ½åˆªé™¤å¸³è™Ÿ
2. **ç°¡åŒ–çš„æ“ä½œæµç¨‹**ï¼šä¸éœ€è¦è¨˜ä½å¯†ç¢¼ï¼Œé™ä½æ“ä½œé–€æª»
3. **éˆæ´»çš„åŸå› æ”¶é›†**ï¼šç”¨æˆ¶å¯é¸æ“‡æ˜¯å¦æä¾›åˆªé™¤åŸå› 
4. **ä¸€è‡´çš„ç‹€æ…‹ç®¡ç†**ï¼šæ‰€æœ‰å¸³è™Ÿæ“ä½œéƒ½æ­£ç¢ºæ›´æ–°æ¬Šé™ç‹€æ…‹
5. **å®Œæ•´çš„æ“ä½œè¨˜éŒ„**ï¼šä½¿ç”¨çµ±ä¸€çš„æ—¥èªŒè¡¨è¨˜éŒ„æ‰€æœ‰æ“ä½œ

é€™äº›æ”¹é€²æå‡äº†ç”¨æˆ¶é«”é©—ï¼ŒåŒæ™‚ä¿æŒäº†æ“ä½œçš„å®‰å…¨æ€§å’Œå¯è¿½æº¯æ€§ã€‚
