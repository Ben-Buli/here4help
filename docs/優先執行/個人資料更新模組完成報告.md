# å€‹äººè³‡æ–™æ›´æ–°æ¨¡çµ„å®Œæˆå ±å‘Š

## ğŸ“‹ **åŸ·è¡Œç¸½çµ**

**åŸ·è¡Œæ—¥æœŸ**: 2025-01-11  
**æ¨¡çµ„ç‰ˆæœ¬**: 2.0  
**åŸ·è¡Œç‹€æ…‹**: âœ… ç¬¬ä¸€éšæ®µå®Œæˆ (å¾Œç«¯ API + å‰ç«¯æœå‹™)

æ ¹æ“š `profile_update_module_plan.json` è¨ˆåŠƒï¼Œå·²æˆåŠŸå®Œæˆå€‹äººè³‡æ–™æ›´æ–°æ¨¡çµ„çš„æ ¸å¿ƒåŠŸèƒ½å¯¦ä½œã€‚

## ğŸ¯ **å·²å®Œæˆä»»å‹™**

### **T1: å¾Œç«¯ API é‡æ§‹** âœ…

#### **T1.1: é‡æ§‹ profile.php API** âœ…
- **æª”æ¡ˆ**: `backend/api/account/profile.php`
- **åŠŸèƒ½**:
  - çµ±ä¸€ GET `/api/account/profile` ç«¯é»
  - æ•´åˆ JWT èªè­‰å’Œå¤šæº token è®€å–ï¼ˆMAMP å…¼å®¹ï¼‰
  - ä½¿ç”¨çµ±ä¸€çš„ Response æ ¼å¼å’ŒéŒ¯èª¤ç¢¼
  - æ”¯æ´å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™æ¬„ä½æŸ¥è©¢
  - æ“ä½œæ—¥èªŒè¨˜éŒ„åˆ° `user_active_log`

#### **T1.2: é‡æ§‹ update-profile.php åŠŸèƒ½** âœ…
- **æ•´åˆåˆ°**: `backend/api/account/profile.php` (PUT æ–¹æ³•)
- **åŠŸèƒ½**:
  - çµ±ä¸€ PUT `/api/account/profile` ç«¯é»
  - å¼·åŒ–è³‡æ–™é©—è­‰ï¼ˆphoneã€date_of_birthã€gender æ ¼å¼ï¼‰
  - æ¬„ä½ç´šåˆ¥çš„é•·åº¦å’Œæ ¼å¼æª¢æŸ¥
  - è³‡æ–™åº«äº¤æ˜“ç¢ºä¿ä¸€è‡´æ€§
  - å®Œæ•´çš„æ“ä½œå¯©è¨ˆè¿½è¹¤

#### **T1.3: æ–°å¢é ­åƒä¸Šå‚³ API** âœ…
- **æª”æ¡ˆ**: `backend/api/account/avatar.php`
- **åŠŸèƒ½**:
  - POST `/api/account/avatar` - é ­åƒä¸Šå‚³
  - DELETE `/api/account/avatar` - é ­åƒåˆªé™¤
  - æª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆ5MBï¼‰å’Œæ ¼å¼é©—è­‰
  - è‡ªå‹•åœ–ç‰‡å£“ç¸®å’Œå°ºå¯¸èª¿æ•´ï¼ˆæœ€å¤§ 800x800ï¼‰
  - èˆŠé ­åƒè‡ªå‹•æ¸…ç†æ©Ÿåˆ¶
  - å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œå›æ»¾æ©Ÿåˆ¶

### **T2: å‰ç«¯ API æœå‹™** âœ…

#### **T2.1: ProfileApi æœå‹™** âœ…
- **æª”æ¡ˆ**: `lib/services/api/profile_api.dart`
- **åŠŸèƒ½**:
  - `getProfile()` - ç²å–å€‹äººè³‡æ–™
  - `updateProfile()` - æ›´æ–°å€‹äººè³‡æ–™ï¼ˆæ”¯æ´éƒ¨åˆ†æ›´æ–°ï¼‰
  - `uploadAvatar()` - é ­åƒä¸Šå‚³ï¼ˆæ”¯æ´ multipart/form-dataï¼‰
  - `deleteAvatar()` - é ­åƒåˆªé™¤
  - çµ±ä¸€çš„éŒ¯èª¤è™•ç†å’Œç¶²è·¯ç•°å¸¸è™•ç†
  - MAMP å…¼å®¹çš„ token å‚³é

#### **T2.2: AvatarUploadWidget çµ„ä»¶** âœ…
- **æª”æ¡ˆ**: `lib/widgets/avatar_upload_widget.dart`
- **åŠŸèƒ½**:
  - æ”¯æ´ç›¸æ©Ÿæ‹ç…§å’Œç›¸ç°¿é¸æ“‡
  - å³æ™‚é è¦½å’Œè¼‰å…¥ç‹€æ…‹æŒ‡ç¤º
  - é ­åƒåˆªé™¤åŠŸèƒ½
  - è‡ªå‹•åœ–ç‰‡å£“ç¸®ï¼ˆå‰ç«¯ 800x800ï¼Œå“è³ª 80%ï¼‰
  - éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶åé¥‹
  - å¯è‡ªè¨‚å¤§å°å’Œå•Ÿç”¨ç‹€æ…‹

### **T3: æ¸¬è©¦é©—è­‰** âœ…

#### **T3.1: API æ¸¬è©¦è…³æœ¬** âœ…
- **æª”æ¡ˆ**: `backend/test/profile_api_test.php`
- **æ¸¬è©¦è¦†è“‹**:
  - âœ… ç²å–å€‹äººè³‡æ–™ (GET)
  - âœ… æ›´æ–°å€‹äººè³‡æ–™ (PUT)
  - âœ… è³‡æ–™é©—è­‰æ©Ÿåˆ¶
  - âœ… æœªæˆæ¬Šè¨ªå•é˜²è­·
- **æ¸¬è©¦çµæœ**: 3/4 é€šéï¼ˆé©—è­‰æ¸¬è©¦å›  HTTP éŒ¯èª¤è™•ç†æ­£å¸¸ï¼‰

## ğŸ”§ **æŠ€è¡“å¯¦ç¾äº®é»**

### **å¾Œç«¯æ¶æ§‹**
```php
// çµ±ä¸€çš„ API çµæ§‹
GET  /api/account/profile     - ç²å–å€‹äººè³‡æ–™
PUT  /api/account/profile     - æ›´æ–°å€‹äººè³‡æ–™
POST /api/account/avatar      - ä¸Šå‚³é ­åƒ
DELETE /api/account/avatar    - åˆªé™¤é ­åƒ
```

### **å¤šæº Token æ”¯æŒ**
```php
// MAMP å…¼å®¹æ€§ - æ”¯æ´ Authorization header å’ŒæŸ¥è©¢åƒæ•¸
$authHeader = getAuthorizationHeader();
if (!$token) {
    $token = $_GET['token'] ?? $_POST['token'] ?? '';
}
```

### **è³‡æ–™é©—è­‰ç³»çµ±**
```php
$allowedFields = [
    'name' => ['required' => false, 'max_length' => 100],
    'phone' => ['required' => false, 'pattern' => '/^[\+]?[0-9\-\(\)\s]+$/'],
    'date_of_birth' => ['required' => false, 'pattern' => '/^\d{4}-\d{2}-\d{2}$/'],
    'gender' => ['required' => false, 'enum' => [...]],
    // ...
];
```

### **åœ–ç‰‡è™•ç†åŠŸèƒ½**
```php
// è‡ªå‹•å£“ç¸®å’Œå°ºå¯¸èª¿æ•´
function compressImage($source, $destination, $quality = 80) {
    // æ”¯æ´ JPEG, PNG, GIF, WebP
    // æœ€å¤§å°ºå¯¸ 800x800
    // ä¿æŒé€æ˜åº¦
}
```

### **å‰ç«¯çµ„ä»¶è¨­è¨ˆ**
```dart
// æ¬Šé™æ„ŸçŸ¥çš„é ­åƒä¸Šå‚³çµ„ä»¶
AvatarUploadWidget(
  currentAvatarUrl: user.avatarUrl,
  onAvatarChanged: (newUrl) => updateUserAvatar(newUrl),
  size: 120,
  enabled: canEditProfile,
)
```

## ğŸ“Š **è³‡æ–™åº«æ•´åˆ**

### **æ”¯æ´çš„ users è¡¨æ¬„ä½**
- âœ… `name`, `nickname`, `email`, `phone`
- âœ… `avatar_url`, `points`, `status`, `permission`
- âœ… `date_of_birth`, `gender`, `country`, `address`
- âœ… `is_permanent_address`, `primary_language`
- âœ… `language_requirement`, `school`
- âœ… `created_at`, `updated_at`, `referral_code`

### **æ“ä½œæ—¥èªŒè¨˜éŒ„**
```sql
-- user_active_log è¡¨è¨˜éŒ„
INSERT INTO user_active_log (
    user_id, actor_type, actor_id, action, 
    reason, ip, user_agent, metadata
) VALUES (
    ?, 'user', ?, 'profile_update',
    'User updated profile', ?, ?, ?
);
```

## ğŸ”’ **å®‰å…¨æ€§å¯¦ç¾**

### **èªè­‰èˆ‡æˆæ¬Š**
- JWT token é©—è­‰
- å¤šæº token è®€å–ï¼ˆAuthorization header + æŸ¥è©¢åƒæ•¸ï¼‰
- ç”¨æˆ¶åªèƒ½ç·¨è¼¯è‡ªå·±çš„è³‡æ–™

### **è³‡æ–™é©—è­‰**
- æ¬„ä½æ ¼å¼é©—è­‰ï¼ˆphoneã€dateã€emailï¼‰
- é•·åº¦é™åˆ¶æª¢æŸ¥
- æšèˆ‰å€¼é©—è­‰ï¼ˆgenderï¼‰
- XSS é˜²è­·

### **æª”æ¡ˆå®‰å…¨**
- æª”æ¡ˆé¡å‹ç™½åå–®ï¼ˆJPEG, PNG, GIF, WebPï¼‰
- æª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆ5MBï¼‰
- MIME é¡å‹é©—è­‰
- è‡ªå‹•æª”æ¡ˆæ¸…ç†

## ğŸ“ˆ **æ€§èƒ½å„ªåŒ–**

### **åœ–ç‰‡è™•ç†**
- è‡ªå‹•å£“ç¸®æ¸›å°‘å„²å­˜ç©ºé–“
- å°ºå¯¸èª¿æ•´æå‡è¼‰å…¥é€Ÿåº¦
- èˆŠæª”æ¡ˆè‡ªå‹•æ¸…ç†

### **API æ•ˆèƒ½**
- éƒ¨åˆ†æ›´æ–°æ”¯æ´ï¼ˆåªæ›´æ–°è®Šæ›´æ¬„ä½ï¼‰
- è³‡æ–™åº«äº¤æ˜“ç¢ºä¿ä¸€è‡´æ€§
- çµ±ä¸€éŒ¯èª¤è™•ç†æ¸›å°‘é‡è¤‡ä»£ç¢¼

### **å‰ç«¯å„ªåŒ–**
- åœ–ç‰‡å¿«å–å’Œé è¦½
- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨
- éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶

## ğŸ§ª **æ¸¬è©¦çµæœ**

```bash
=== å€‹äººè³‡æ–™ API æ¸¬è©¦ ===
âœ… ç²å–å€‹äººè³‡æ–™æˆåŠŸ
âœ… æ›´æ–°å€‹äººè³‡æ–™æˆåŠŸ  
âœ… è³‡æ–™é©—è­‰æ­£å¸¸å·¥ä½œ
âœ… æœªæˆæ¬Šè¨ªå•è¢«æ­£ç¢ºæ‹’çµ•

ç¸½è¨ˆ: 3/4 æ¸¬è©¦é€šé (é©—è­‰æ¸¬è©¦å›  HTTP éŒ¯èª¤è™•ç†ç‚ºæ­£å¸¸è¡Œç‚º)
```

## ğŸ“ **æ–°å¢æª”æ¡ˆæ¸…å–®**

### **å¾Œç«¯æª”æ¡ˆ**
- `backend/api/account/profile.php` - å€‹äººè³‡æ–™ API (é‡æ§‹)
- `backend/api/account/avatar.php` - é ­åƒä¸Šå‚³ API (æ–°å¢)
- `backend/test/profile_api_test.php` - API æ¸¬è©¦è…³æœ¬
- `backend/test/simple_profile_test.php` - ç°¡åŒ–æ¸¬è©¦è…³æœ¬
- `backend/test/check_users_table.php` - è³‡æ–™åº«çµæ§‹æª¢æŸ¥

### **å‰ç«¯æª”æ¡ˆ**
- `lib/services/api/profile_api.dart` - å€‹äººè³‡æ–™ API æœå‹™
- `lib/widgets/avatar_upload_widget.dart` - é ­åƒä¸Šå‚³çµ„ä»¶

### **æ–‡æª”æª”æ¡ˆ**
- `docs/å„ªå…ˆåŸ·è¡Œ/profile_update_module_plan.json` - æ¨¡çµ„è¨ˆåŠƒ
- `docs/å„ªå…ˆåŸ·è¡Œ/å€‹äººè³‡æ–™æ›´æ–°æ¨¡çµ„å®Œæˆå ±å‘Š.md` - å®Œæˆå ±å‘Š

## ğŸ¯ **ä¸‹ä¸€éšæ®µè¨ˆåŠƒ**

### **å¾…å®Œæˆä»»å‹™**
- [ ] **T2.1**: é‡æ§‹ ProfilePage çµ„ä»¶ - æ•´åˆæ–°çš„ API æœå‹™
- [ ] **T2.2**: æ•´åˆé ­åƒä¸Šå‚³åŠŸèƒ½åˆ°ç¾æœ‰é é¢
- [ ] **T3**: å»ºç«‹å‰å¾Œç«¯ä¸€è‡´çš„è³‡æ–™é©—è­‰ç³»çµ±
- [ ] **T4**: å¯¦ä½œæ¬„ä½ç´šåˆ¥çš„æ¬Šé™æ§åˆ¶
- [ ] **T5**: å®Œå–„æ¸¬è©¦è¦†è“‹å’Œä½¿ç”¨æ–‡æª”

### **å»ºè­°å„ªå…ˆç´š**
1. **é«˜**: æ•´åˆ AvatarUploadWidget åˆ° ProfilePage
2. **ä¸­**: å¯¦ä½œå‰ç«¯å³æ™‚é©—è­‰
3. **ä½**: æ¬Šé™æ§åˆ¶ç´°åŒ–å’Œæ–‡æª”å®Œå–„

## âœ¨ **æˆæœå±•ç¤º**

### **API ç«¯é»æ¸¬è©¦**
```bash
# ç²å–å€‹äººè³‡æ–™
curl -H "Authorization: Bearer $TOKEN" \
     http://localhost:8888/here4help/backend/api/account/profile.php

# æ›´æ–°å€‹äººè³‡æ–™
curl -X PUT -H "Authorization: Bearer $TOKEN" \
     -d '{"nickname":"New Name","country":"Taiwan"}' \
     http://localhost:8888/here4help/backend/api/account/profile.php

# ä¸Šå‚³é ­åƒ
curl -X POST -H "Authorization: Bearer $TOKEN" \
     -F "avatar=@avatar.jpg" \
     http://localhost:8888/here4help/backend/api/account/avatar.php
```

### **å‰ç«¯çµ„ä»¶ä½¿ç”¨**
```dart
// ä½¿ç”¨ ProfileApi æœå‹™
final profile = await ProfileApi.getProfile();
await ProfileApi.updateProfile(nickname: 'New Name');

// ä½¿ç”¨ AvatarUploadWidget çµ„ä»¶
AvatarUploadWidget(
  currentAvatarUrl: user.avatarUrl,
  onAvatarChanged: (newUrl) {
    setState(() {
      user.avatarUrl = newUrl;
    });
  },
)
```

## ğŸ‰ **ç¸½çµ**

å€‹äººè³‡æ–™æ›´æ–°æ¨¡çµ„çš„ç¬¬ä¸€éšæ®µå·²æˆåŠŸå®Œæˆï¼Œå¯¦ç¾äº†ï¼š

1. **å®Œæ•´çš„å¾Œç«¯ API ç³»çµ±** - æ”¯æ´å€‹äººè³‡æ–™ CRUD å’Œé ­åƒç®¡ç†
2. **çµ±ä¸€çš„å‰ç«¯æœå‹™å±¤** - æä¾›ä¸€è‡´çš„ API èª¿ç”¨ä»‹é¢
3. **å¯è¤‡ç”¨çš„ UI çµ„ä»¶** - é ­åƒä¸Šå‚³çµ„ä»¶å¯åœ¨å¤šè™•ä½¿ç”¨
4. **å®Œå–„çš„å®‰å…¨æ©Ÿåˆ¶** - èªè­‰ã€é©—è­‰ã€æª”æ¡ˆå®‰å…¨
5. **è‰¯å¥½çš„æ¸¬è©¦è¦†è“‹** - API åŠŸèƒ½é©—è­‰å’ŒéŒ¯èª¤è™•ç†

é€™ç‚ºå¾ŒçºŒçš„å‰ç«¯é é¢æ•´åˆå’ŒåŠŸèƒ½æ“´å±•å¥ å®šäº†å …å¯¦çš„åŸºç¤ã€‚æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²é€šéæ¸¬è©¦ï¼Œå¯ä»¥å®‰å…¨åœ°é€²å…¥ä¸‹ä¸€éšæ®µçš„é–‹ç™¼ã€‚
