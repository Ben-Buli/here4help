# Here4Help 部署高階專案指南

**版本**: 1.0  
**建立日期**: 2025-01-11  
**適用環境**: CPanel + TestFlight (測試階段) → App Store + Google Play (正式階段)

---

## 📋 專案背景

### 產品架構
- **Flutter App**: iOS (TestFlight → App Store) + Android (Google Play Store) + Web (CPanel)
- **後端**: 原生 PHP + MySQL + Node.js Socket 伺服器
- **管理員後台**: Laravel + Vue.js (部署至 CPanel)
- **部署環境**: CPanel (Basic_H10G-50G-addones)
- **伺服器規格**: Apache 2.4.65, MySQL 5.7.44, PHP 7.x+

### 功能域
- OAuth 登入註冊 (Google/Facebook/Apple)
- 任務發布與應徵系統
- 即時聊天室 (WebSocket)
- 客服事件系統
- 媒體上傳處理
- 管理員後台 (RBAC)

---

## 🎯 部署里程碑

### M-DEPLOY-TESTING: 測試階段部署
**目標**: TestFlight + CPanel 測試環境上線  
**時程**: 2 週

### M-DEPLOY-PRODUCTION: 正式階段部署  
**目標**: App Store + Google Play Store + 正式 CPanel 環境  
**時程**: 1 週

---

## 📊 部署任務分解

### 階段一：測試環境部署 (M-DEPLOY-TESTING)

#### T1-CPANEL-BACKEND-SETUP
**負責人**: Backend  
**目標**: 設置 CPanel 後端環境與資料庫

**步驟**:
1. **CPanel 檔案結構設置**
   ```
   public_html/
   ├── here4help/
   │   ├── backend/          # PHP 後端
   │   │   ├── api/
   │   │   ├── config/
   │   │   ├── utils/
   │   │   └── uploads/      # 媒體上傳目錄
   │   ├── admin/            # Laravel 管理後台
   │   └── web/              # Flutter Web 版本
   └── socket/               # Node.js Socket 伺服器 (需要 Node.js 支援)
   ```

2. **環境配置檔案設置**
   ```bash
   # 創建生產環境配置
   cp backend/config/env.example backend/config/.env
   
   # 設置 CPanel 環境變數
   APP_ENV=production
   APP_DEBUG=false
   APP_URL=https://yourdomain.com/here4help
   
   # 資料庫配置 (CPanel MySQL)
   DB_HOST=localhost
   DB_PORT=3306
   DB_NAME=cpanel_database_name
   DB_USERNAME=cpanel_db_user
   DB_PASSWORD=cpanel_db_password
   DB_CHARSET=utf8mb4
   
   # JWT 配置
   JWT_SECRET=your_production_jwt_secret_minimum_32_characters
   JWT_EXPIRE_HOURS=168
   
   # 媒體上傳配置
   STORAGE_TYPE=local
   LOCAL_STORAGE_PATH=/home/username/public_html/here4help/backend/uploads
   LOCAL_STORAGE_URL=https://yourdomain.com/here4help/backend/api/media/serve.php
   MAX_IMAGE_SIZE=10485760
   MAX_DOCUMENT_SIZE=20971520
   
   # OAuth 配置 (生產環境)
   GOOGLE_CLIENT_ID_WEB=your_production_google_client_id
   FACEBOOK_APP_ID=your_production_facebook_app_id
   APPLE_SERVICE_ID=com.yourcompany.here4help.login
   
   # CORS 配置
   CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://apps.apple.com
   
   # Socket 配置
   SOCKET_URL=https://yourdomain.com:3001
   ```

3. **資料庫遷移**
   ```bash
   # 匯出 MAMP 資料庫
   mysqldump -u root -p hero4helpdemofhs_hero4help > here4help_backup.sql
   
   # 在 CPanel phpMyAdmin 中：
   # 1. 創建新資料庫
   # 2. 匯入 here4help_backup.sql
   # 3. 檢查表結構和資料完整性
   ```

4. **檔案權限設置**
   ```bash
   # 設置上傳目錄權限
   chmod 755 backend/uploads/
   chmod 644 backend/config/.env
   chmod 755 backend/api/
   
   # 確保 .htaccess 檔案正確
   ```

**驗收條件**:
- [ ] 後端 API 可正常訪問
- [ ] 資料庫連線成功
- [ ] 媒體上傳功能正常
- [ ] OAuth 登入流程正常

**檔案清單**:
- `backend/config/.env` (生產環境配置)
- `backend/.htaccess` (Apache 重寫規則)
- `backend/api/test_connection.php` (連線測試腳本)

---

#### T2-CPANEL-SOCKET-SETUP
**負責人**: Backend  
**目標**: 設置 Node.js Socket 伺服器 (如 CPanel 支援)

**步驟**:
1. **檢查 CPanel Node.js 支援**
   ```bash
   # 在 CPanel 中檢查是否支援 Node.js
   # 如不支援，考慮使用第三方 Socket 服務或 WebSocket 替代方案
   ```

2. **Socket 伺服器配置**
   ```javascript
   // backend/socket/server.js 生產環境配置
   const PORT = process.env.PORT || 3001;
   const CORS_ORIGINS = [
     'https://yourdomain.com',
     'https://apps.apple.com',
     'capacitor://localhost',
     'http://localhost'
   ];
   ```

3. **備用方案：長輪詢 (Long Polling)**
   ```php
   // 如 CPanel 不支援 WebSocket，實現長輪詢
   // backend/api/chat/polling.php
   ```

**驗收條件**:
- [ ] Socket 伺服器可正常啟動
- [ ] 即時訊息功能正常
- [ ] 跨域設置正確

**備用方案**:
- 使用第三方 WebSocket 服務 (Pusher, Socket.IO Cloud)
- 實現長輪詢機制

---

#### T3-CPANEL-ADMIN-SETUP
**負責人**: Backend  
**目標**: 部署 Laravel 管理員後台

**步驟**:
1. **Laravel 環境設置**
   ```bash
   # 在 CPanel 中設置 Laravel
   cd public_html/here4help/admin
   
   # 安裝 Composer 依賴 (如 CPanel 支援)
   composer install --no-dev --optimize-autoloader
   
   # 設置 Laravel 環境
   cp .env.example .env
   php artisan key:generate
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

2. **Laravel 配置檔案**
   ```bash
   # admin/.env
   APP_NAME="Here4Help Admin"
   APP_ENV=production
   APP_DEBUG=false
   APP_URL=https://yourdomain.com/here4help/admin
   
   DB_CONNECTION=mysql
   DB_HOST=localhost
   DB_PORT=3306
   DB_DATABASE=cpanel_database_name
   DB_USERNAME=cpanel_db_user
   DB_PASSWORD=cpanel_db_password
   
   # 與主系統共用資料庫
   ```

3. **Vue.js 前端建置**
   ```bash
   # 本地建置後上傳
   cd admin-frontend
   npm run build
   
   # 上傳 dist/ 目錄到 CPanel
   ```

**驗收條件**:
- [ ] Laravel 後台可正常訪問
- [ ] Vue.js 前端正常載入
- [ ] RBAC 權限系統正常
- [ ] 與主資料庫連接正常

---

#### T4-FLUTTER-WEB-DEPLOY
**負責人**: Flutter  
**目標**: 部署 Flutter Web 版本至 CPanel

**步驟**:
1. **Flutter Web 建置**
   ```bash
   # 本地建置
   flutter build web --release --web-renderer html
   
   # 設置生產環境配置
   flutter build web --release --dart-define=ENVIRONMENT=production
   ```

2. **Web 配置檔案**
   ```json
   // assets/app_env/production.json
   {
     "environment": "production",
     "public": {
       "api_base_url": "https://yourdomain.com/here4help/backend/api",
       "socket_url": "https://yourdomain.com:3001",
       "image_base_url": "https://yourdomain.com/here4help",
       "google_client_id": "your_production_google_client_id",
       "facebook_app_id": "your_production_facebook_app_id",
       "apple_service_id": "com.yourcompany.here4help.login"
     },
     "app": {
       "debug_mode": false,
       "log_level": "error",
       "features": {
         "offline_mode": true,
         "push_notifications": false
       }
     }
   }
   ```

3. **上傳至 CPanel**
   ```bash
   # 上傳 build/web/ 內容至 public_html/here4help/web/
   ```

**驗收條件**:
- [ ] Web 版本可正常載入
- [ ] API 連接正常
- [ ] OAuth 登入功能正常
- [ ] 響應式設計正常

---

#### T5-IOS-TESTFLIGHT-SETUP
**負責人**: Flutter  
**目標**: 設置 iOS TestFlight 測試

**步驟**:
1. **iOS 建置配置**
   ```bash
   # 設置 iOS 生產環境
   flutter build ios --release --dart-define=ENVIRONMENT=production
   ```

2. **iOS 配置檔案**
   ```dart
   // ios/Runner/Info.plist 設置
   // 確保 OAuth 回調 URL 正確
   // 設置 App Transport Security
   ```

3. **TestFlight 上傳**
   ```bash
   # 使用 Xcode 或 Fastlane 上傳
   # 設置測試群組
   # 配置測試說明
   ```

**驗收條件**:
- [ ] iOS 應用可正常建置
- [ ] TestFlight 上傳成功
- [ ] 測試用戶可正常下載
- [ ] 所有功能正常運作

---

#### T6-SECURITY-HARDENING
**負責人**: Backend  
**目標**: 生產環境安全加固

**步驟**:
1. **HTTPS 設置**
   ```apache
   # .htaccess 強制 HTTPS
   RewriteEngine On
   RewriteCond %{HTTPS} off
   RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
   ```

2. **安全標頭設置**
   ```php
   // backend/config/security_headers.php
   header('X-Content-Type-Options: nosniff');
   header('X-Frame-Options: DENY');
   header('X-XSS-Protection: 1; mode=block');
   header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
   ```

3. **Rate Limiting**
   ```php
   // 實現 API 速率限制
   // backend/utils/RateLimiter.php
   ```

**驗收條件**:
- [ ] HTTPS 強制重定向正常
- [ ] 安全標頭設置正確
- [ ] Rate Limiting 生效
- [ ] 檔案上傳安全檢查正常

---

### 階段二：正式環境部署 (M-DEPLOY-PRODUCTION)

#### T7-APP-STORE-SUBMISSION
**負責人**: Flutter  
**目標**: 提交 iOS App Store 審核

**步驟**:
1. **App Store Connect 設置**
   - 應用程式資訊完善
   - 截圖和描述準備
   - 隱私政策和服務條款

2. **審核準備**
   - 測試所有功能
   - 確保符合 App Store 指南
   - 準備審核說明

**驗收條件**:
- [ ] 應用程式成功提交審核
- [ ] 通過 App Store 審核
- [ ] 正式上架 App Store

---

#### T8-GOOGLE-PLAY-SUBMISSION
**負責人**: Flutter  
**目標**: 提交 Google Play Store 審核

**步驟**:
1. **Google Play Console 設置**
   - 應用程式資訊完善
   - 截圖和描述準備
   - 內容分級設置

2. **Android 建置**
   ```bash
   flutter build appbundle --release --dart-define=ENVIRONMENT=production
   ```

**驗收條件**:
- [ ] 應用程式成功提交審核
- [ ] 通過 Google Play 審核
- [ ] 正式上架 Google Play Store

---

#### T9-PRODUCTION-MONITORING
**負責人**: Backend  
**目標**: 設置生產環境監控

**步驟**:
1. **錯誤監控**
   ```php
   // backend/utils/ErrorReporting.php
   // 設置錯誤日誌和通知
   ```

2. **效能監控**
   ```php
   // API 回應時間監控
   // 資料庫查詢效能監控
   ```

3. **備份策略**
   ```bash
   # 設置自動資料庫備份
   # 設置檔案備份
   ```

**驗收條件**:
- [ ] 錯誤監控系統正常
- [ ] 效能監控數據正常
- [ ] 備份策略執行正常

---

## 🔧 配置檔案範本

### CPanel .htaccess
```apache
RewriteEngine On

# 強制 HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# API 路由
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ backend/api/$1 [L]

# 管理後台路由
RewriteRule ^admin/(.*)$ admin/public/$1 [L]

# Web 應用路由
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ web/index.html [L]

# 安全設置
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

# 媒體檔案快取
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
</IfModule>
```

### 生產環境 .env
```bash
# 應用程式配置
APP_ENV=production
APP_DEBUG=false
APP_URL=https://yourdomain.com/here4help

# 資料庫配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=your_cpanel_database
DB_USERNAME=your_cpanel_user
DB_PASSWORD=your_secure_password
DB_CHARSET=utf8mb4

# JWT 配置
JWT_SECRET=your_production_jwt_secret_minimum_32_characters_long
JWT_EXPIRE_HOURS=168

# OAuth 配置 (生產環境)
GOOGLE_CLIENT_ID_WEB=your_production_google_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_production_google_client_secret
FACEBOOK_APP_ID=your_production_facebook_app_id
FACEBOOK_APP_SECRET=your_production_facebook_app_secret
APPLE_TEAM_ID=your_apple_team_id
APPLE_KEY_ID=your_apple_key_id
APPLE_SERVICE_ID=com.yourcompany.here4help.login

# 媒體上傳配置
STORAGE_TYPE=local
LOCAL_STORAGE_PATH=/home/username/public_html/here4help/backend/uploads
LOCAL_STORAGE_URL=https://yourdomain.com/here4help/backend/api/media/serve.php
MAX_IMAGE_SIZE=10485760
MAX_DOCUMENT_SIZE=20971520
ENABLE_MEDIA_COMPRESSION=true

# 郵件配置 (CPanel)
MAIL_DRIVER=sendmail
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="Here4Help"

# 安全配置
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://apps.apple.com,capacitor://localhost
RATE_LIMIT_ENABLED=true
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WINDOW_MINUTES=15

# Socket 配置
SOCKET_URL=https://yourdomain.com:3001
SOCKET_ENABLED=true

# 快取配置
CACHE_ENABLED=true
CACHE_TTL=3600

# 日誌配置
LOG_LEVEL=error
LOG_FILE=/home/username/logs/here4help.log
```

---

## ⚠️ 部署注意事項

### CPanel 限制與解決方案
1. **Node.js 支援**
   - 檢查 CPanel 是否支援 Node.js
   - 備用方案：使用第三方 WebSocket 服務或長輪詢

2. **檔案權限**
   - 確保上傳目錄有寫入權限 (755)
   - 保護敏感檔案 (.env, config/)

3. **資料庫連接**
   - 使用 CPanel 提供的資料庫憑證
   - 注意連接數限制

4. **SSL 憑證**
   - 確保 HTTPS 正確配置
   - 檢查 SSL 憑證有效性

### 行動應用部署
1. **iOS 特殊要求**
   - App Transport Security 設置
   - OAuth 回調 URL 配置
   - 推播通知憑證

2. **Android 特殊要求**
   - 簽名金鑰管理
   - Google Play 政策合規
   - 權限聲明

### 安全考量
1. **敏感資料保護**
   - 環境變數加密
   - API 金鑰輪替
   - 資料庫憑證安全

2. **CORS 設置**
   - 限制允許的來源
   - 正確設置預檢請求

3. **Rate Limiting**
   - API 速率限制
   - 登入嘗試限制
   - 檔案上傳限制

---

## 📋 部署檢查清單

### 測試階段
- [ ] CPanel 後端環境設置完成
- [ ] 資料庫遷移成功
- [ ] 媒體上傳功能正常
- [ ] Socket 伺服器運行正常 (或備用方案)
- [ ] Laravel 管理後台部署完成
- [ ] Flutter Web 版本部署完成
- [ ] iOS TestFlight 設置完成
- [ ] 所有 OAuth 登入流程測試通過
- [ ] 安全設置檢查完成

### 正式階段
- [ ] iOS App Store 提交並通過審核
- [ ] Android Google Play Store 提交並通過審核
- [ ] 生產環境監控設置完成
- [ ] 備份策略實施完成
- [ ] 效能優化完成
- [ ] 安全加固完成
- [ ] 使用者文檔準備完成

---

## 🔄 回滾計畫

### 緊急回滾步驟
1. **資料庫回滾**
   ```bash
   # 恢復資料庫備份
   mysql -u username -p database_name < backup_file.sql
   ```

2. **檔案回滾**
   ```bash
   # 恢復檔案備份
   # 切換到穩定版本
   ```

3. **應用程式回滾**
   - iOS: 移除有問題的版本
   - Android: 發布回滾版本
   - Web: 切換到穩定版本

### 回滾觸發條件
- 嚴重安全漏洞
- 資料遺失風險
- 核心功能無法使用
- 用戶大量投訴

---

## 📞 支援與聯繫

### 技術支援
- **CPanel 支援**: 聯繫主機商技術支援
- **Apple Developer**: https://developer.apple.com/support/
- **Google Play Console**: https://support.google.com/googleplay/android-developer/

### 監控與警報
- 設置關鍵指標監控
- 配置異常警報通知
- 建立事件回應流程

---

**文檔版本**: 1.0  
**最後更新**: 2025-01-11  
**下次檢查**: 部署完成後 1 週
