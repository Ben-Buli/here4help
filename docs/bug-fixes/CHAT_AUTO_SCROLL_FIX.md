# 聊天室自動滾動問題修復

## 🐛 **問題描述**

當有未讀訊息出現後，聊天室會自動滾動到底部，而不是保持在未讀分隔線位置等待用戶手動點擊。

## 🔍 **問題根因**

1. **Socket 訊息更新時自動滾動**：`_loadChatMessagesFromDatabase()` 方法在收到 Socket 訊息時會自動滾動
2. **缺乏初次載入標識**：無法區分是初次進入聊天室還是接收新訊息
3. **滾動邏輯過於激進**：任何訊息更新都會觸發滾動

## 🔧 **修復方案**

### **1. 添加初次載入標識**
```dart
bool _isInitialLoad = true; // 是否為初次載入
```

### **2. 修改初次載入邏輯**
```dart
// 只有在初次載入時才自動滾動到未讀位置
if (_isInitialLoad) {
  // 根據是否有未讀訊息決定滾動位置
  if (_hasUnreadMessages()) {
    _scrollToUnreadSeparator(delayed: true);
    setState(() {
      _showScrollToBottomButton = true;
    });
  } else {
    _scrollToBottom(delayed: true);
  }
  _isInitialLoad = false; // 標記為非初次載入
} else if (_isAtBottom) {
  // 非初次載入且用戶在底部時才滾動
  _scrollToBottom(delayed: true);
}
```

### **3. 修改 Socket 訊息更新邏輯**
```dart
// Socket 訊息更新時不自動滾動，保持用戶當前位置
// 只更新滾動按鈕的顯示狀態
if (_hasUnreadMessages() && !_isAtBottom) {
  setState(() {
    _showScrollToBottomButton = true;
  });
} else if (_isAtBottom) {
  setState(() {
    _showScrollToBottomButton = false;
  });
}
```

## 📋 **修復後的行為**

### **進入聊天室（初次載入）**
- ✅ **有未讀訊息**：滾動到未讀分隔線中央 + 顯示滾動按鈕
- ✅ **無未讀訊息**：滾動到底部

### **接收新訊息（Socket 更新）**
- ✅ **用戶在底部**：不滾動，保持在底部
- ✅ **用戶不在底部**：不滾動，保持當前位置 + 顯示滾動按鈕
- ✅ **用戶在未讀分隔線**：不滾動，保持在分隔線位置

### **發送訊息**
- ✅ **總是滾動到底部**：這是正確行為，用戶發送訊息應該看到自己的訊息

### **手動滾動**
- ✅ **點擊滾動按鈕**：滾動到底部 + 標記全部已讀 + 隱藏按鈕
- ✅ **手動滾動到底部**：自動隱藏按鈕
- ✅ **手動滾動離開底部**：顯示按鈕（如果有未讀）

## 🎯 **核心改進**

1. **尊重用戶意圖**：不強制改變用戶的滾動位置
2. **明確區分場景**：初次載入 vs 訊息更新 vs 用戶操作
3. **保持一致性**：滾動行為符合用戶預期
4. **提供控制權**：用戶可以選擇何時查看新訊息

## ✅ **測試要點**

1. **進入有未讀訊息的聊天室**：應停在分隔線中央
2. **在分隔線位置接收新訊息**：應保持在分隔線位置
3. **在底部接收新訊息**：應保持在底部
4. **在中間位置接收新訊息**：應保持在當前位置
5. **發送訊息**：應滾動到底部
6. **點擊滾動按鈕**：應滾動到底部並標記已讀

此修復確保聊天室的滾動行為更加人性化，符合用戶的使用習慣。
