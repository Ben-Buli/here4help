## å³æ™‚èŠå¤©å®¤ãƒ»æœªè®€æ•¸èˆ‡åˆ—è¡¨ UI åŸ·è¡ŒæŒ‡å—ï¼ˆè‡¨æ™‚é–‹ç™¼æ–‡ä»¶ï¼‰

ä¾†æºèˆ‡ç¯„åœï¼šæœ¬æŒ‡å—ç”±å°è©±ä»»å‹™ï¼ˆrequest id: a3fc2a7f-cd33-41b9-a1ea-786e761a1363ï¼‰èƒå–ï¼Œåƒ…ä½œç‚ºè‡¨æ™‚é–‹ç™¼èˆ‡é©—æ”¶ä¾æ“šã€‚å¾…ä½ æœ€çµ‚åŒæ„å…¨æ•¸å®Œæˆå¾Œï¼Œå°‡è¦é»æ•´åˆå› `docs/TODO_INTEGRATED.md`ã€`docs/TODO_DASHBOARD.md`ã€`docs/CURSOR_TODO.md` ä¸¦åœ¨æœ¬æª”æ¡ˆå‚™è¨»ä¾†æºèˆ‡æ”¶æŸç‹€æ…‹ã€‚

é‡è¦æµç¨‹èˆ‡é©—æ”¶åŸå‰‡ï¼šæ¯ä¸€éšæ®µå‹™å¿…å…ˆå®Œæˆã€Œè‡ªå‹•æª¢æŸ¥ï¼ˆå¾Œç«¯ API / ç«¯åˆ°ç«¯è…³æœ¬ï¼‰ã€+ã€Œæ‰‹å‹•æ“ä½œé©—æ”¶ï¼ˆApp å¯¦éš›æ“ä½œï¼‰ã€å…©è€…ï¼Œé›™æ–¹æ•´åˆæˆç°¡å ±å‘Šå¾Œï¼Œç¶“ä½ ç¢ºèªåŒæ„ï¼Œæ–¹å¯é€²å…¥ä¸‹ä¸€éšæ®µã€‚

---

### æ–°å¢éœ€æ±‚ï¼ˆ2025-08-16ï¼‰
- Tab å°ç´…é»ï¼šç•¶å„åˆ†é ï¼ˆPosted / My Worksï¼‰å­˜åœ¨ä»»ä¸€æœªè®€æ™‚ï¼Œåœ¨åˆ†é æ–‡å­—å³ä¸Šè§’é¡¯ç¤º 6px è­¦ç¤ºè‰²åœ“é»ã€‚
- æœªè®€åœ“é»/æ•¸å­—æ¨£å¼ï¼šç§»é™¤æ‰€æœ‰é™°å½±ï¼Œåƒ…ä¿ç•™ç´”è‰²åœ“é»èˆ‡ç´”è‰²åœ“è§’æ•¸å­—å¾½ç« ã€‚
- å·²è®€å¯«å›è¦å‰‡ï¼šåˆ—è¡¨æœªè®€ç‹€æ…‹åƒ…ä»¥ `unread_snapshot.by_room` åˆä½µï¼Œä¸åœ¨ UI äº‹ä»¶ç›´æ¥æ¸…é™¤ï¼›å¿…é ˆåœ¨èŠå¤©å®¤å…§å®Œæˆ `read_room` å¯«å…¥å¾Œï¼Œå¿«ç…§æ›´æ–°æ‰æ‰£é™¤ã€‚
- èŠå¤©å®¤æ»¾å‹•å®šä½ï¼šæ”¯æ´ã€Œä¿ç•™ä½¿ç”¨è€…æœ€å¾Œä¸€æ¬¡è®€å–ä½ç½®ã€ã€‚å¾Œç«¯åœ¨ `get_messages.php` å›å‚³ `my_last_read_message_id`ï¼Œå‰ç«¯è¼‰å…¥å¾Œå®šä½è‡³è©²è¨Šæ¯é„°è¿‘ä½ç½®ï¼›ä¸¦åœ¨åˆ°é”åº•éƒ¨/é›¢é–‹é é¢æ™‚ä¸Šå ± `markRoomRead()`ã€‚

### ä¿®æ­£é …ç›®ï¼ˆ2025-08-16ï¼‰
- **Reset ç„¡é™åˆ·æ–°ä¿®æ­£**ï¼šè§£æ±ºé»æ“Š reset icon é€ æˆç„¡é™ API èª¿ç”¨çš„å•é¡Œ
  - æ ¹æœ¬åŸå› ï¼š`_updateTabUnreadFlag()` è§¸ç™¼ Provider é€šçŸ¥ â†’ å¼•ç™¼ `_handleProviderChanges()` â†’ å†æ¬¡åˆ·æ–° â†’ å½¢æˆç„¡é™å¾ªç’°
  - è§£æ±ºæ–¹æ¡ˆï¼šåœ¨æœªè®€æ¨™è¨˜æ›´æ–°å‰æª¢æŸ¥ç‹€æ…‹æ˜¯å¦çœŸæ­£æ”¹è®Šï¼Œé¿å…ä¸å¿…è¦çš„ Provider é€šçŸ¥
  - å½±éŸ¿çµ„ä»¶ï¼š`PostedTasksWidget`ã€`MyWorksWidget`

- **æœªè®€æ¨™è¨˜é¡¯ç¤ºå•é¡Œåˆ†æ**ï¼ˆå¾…ä¿®æ­£ï¼‰ï¼š
  - **æ ¹æœ¬å•é¡Œ**ï¼šè³‡æ–™åº«æ¶æ§‹ä¸ä¸€è‡´
    - åŸå§‹ `chat_rooms` è¡¨ï¼šåªæœ‰ `id`, `task_id` æ¬„ä½ï¼ˆMVP çµæ§‹ï¼‰
    - é·ç§»è…³æœ¬ï¼šå®šç¾©äº†åŒ…å« `creator_id`, `participant_id` çš„æ–°çµæ§‹
    - ç¾æœ‰ APIï¼š`get_rooms.php`, `ensure_room.php` å‡è¨­è¡¨æœ‰ `creator_id`, `participant_id`
    - **`unread_snapshot.php`**ï¼šä½¿ç”¨ `(cr.creator_id = ? OR cr.participant_id = ?)` æ¢ä»¶ï¼Œä½†æ¬„ä½å¯èƒ½ä¸å­˜åœ¨
  - **è§£æ±ºæ–¹æ¡ˆ**ï¼šå‰µå»ºæ–°çš„æœªè®€ APIï¼Œå¾ä»»å‹™ç”³è«‹é—œä¿‚åæ¨èŠå¤©å®¤èˆ‡æœªè®€ç‹€æ…‹
    - ä¸ä¾è³´ `chat_rooms.creator_id/participant_id`
    - å¾ `task_applications` + `tasks` æ¨å°èŠå¤©é—œä¿‚
    - åŸºæ–¼ `chat_messages.from_user_id` å’Œ `chat_reads` è¨ˆç®—æœªè®€æ•¸

### Phase 1ï¼ˆé€²è¡Œä¸­ï¼‰- å…¨åŸŸæœªè®€åˆå§‹åŒ–èˆ‡åº•éƒ¨å°è¦½åœ“é»ï¼ˆæ”¹ç”¨è­¦ç¤ºè‰²ï¼‰
- ç›®æ¨™ï¼š
  - App å•Ÿå‹•æˆ–ç™»å…¥æˆåŠŸå¾Œï¼Œåˆå§‹åŒ–æœªè®€ä¸­å¿ƒï¼ˆSocket + å¿«ç…§ï¼‰ï¼Œèƒ½å³æ™‚æ¥æ”¶ `unread_total`/`unread_by_room`ã€‚
  - Bottom Navbar çš„ Chat åœ–ç¤ºï¼šæ”¹ç‚ºã€Œç´”åœ“é»ã€æŒ‡ç¤ºï¼ˆç„¡æ•¸å­—ï¼‰ï¼Œç•¶ç¸½æœªè®€ > 0 æ™‚é¡¯ç¤ºï¼Œå¦å‰‡ä¸é¡¯ç¤ºã€‚å…¨åŸŸå³æ™‚ã€‚åœ“é»æ¡ç”¨ä¸»é¡Œçš„ warning/alert è‰²ï¼ˆè‹¥ç„¡å°ˆå±¬ warningï¼Œå‰‡ä»¥ä¸»é¡Œ `colorScheme.error` æˆ–æ›¿ä»£ alert è‰²è¿‘ä¼¼å‘ˆç¾ï¼‰ã€‚
- å¾Œç«¯è‡ªå‹•æª¢æŸ¥ï¼š
  - `backend/api/chat/unread_snapshot.php` å¯ç”¨ï¼›`backend/api/chat/read_room.php` å¯ç”¨ï¼›è‹¥ç¼º `chat_reads` å‰‡å»ºè¡¨ã€‚
  - cURLï¼ˆä»¥ users.id=2ï¼‰ï¼šç”Ÿæˆ base64 token å¾Œå‘¼å« snapshot/mark readï¼Œç¢ºèªæ•¸å€¼è®ŠåŒ–ã€‚
- å‰ç«¯è‡ªå‹•æª¢æŸ¥ï¼š
  - ç™»å…¥æˆåŠŸå¾Œæ–¼ Console è§€å¯Ÿ Socket é€£ç·šã€`refreshSnapshot()` æˆåŠŸå›å‚³ã€`totalUnreadStream` æœ‰è¼¸å‡ºã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  1) ç™»å…¥å¸³è™Ÿ `Luisa@test.com / 1234`ã€‚
  2) é€²å…¥ Home â†’ åˆ‡æ›è‡³ Chatï¼Œè§€å¯Ÿåº•éƒ¨å°è¦½æ˜¯å¦é¡¯ç¤ºåœ“é»ï¼ˆè‹¥æœ‰æœªè®€ï¼‰ã€‚
  3) é€²å…¥ä»»ä¸€èŠå¤©å®¤ â†’ è¿”å›åˆ—è¡¨ï¼Œåœ“é»æ˜¯å¦å³æ™‚æ›´æ–°ï¼ˆè‹¥è©²æˆ¿å·²è®€å°è‡´ total=0ï¼Œåœ“é»æ‡‰æ¶ˆå¤±ï¼‰ã€‚
- å®Œæˆæ¢ä»¶ï¼š
  - è‡ªå‹• + æ‰‹å‹•é©—æ”¶çš†é€šéï¼Œä¸¦åœ¨æœ¬æª”ã€Œé€²åº¦è¿½è¹¤ã€æ‰“å‹¾ï¼Œé™„ä¸Šä½ èˆ‡æˆ‘æ•´åˆçš„ç°¡å ±å‘Šæ‘˜è¦ã€‚

---

### Phase 2 - å…©åˆ†é æ’åºèšæ”èˆ‡ Emoji è¦å‰‡
- ç›®æ¨™ï¼š
  - Posted / My Works ä»¥ `status.sort_order` â†’ `updated_at DESC` çµ±ä¸€æ’åºï¼ˆåŒç‹€æ…‹èšæ”ï¼‰ã€‚
  - Emoji ç‹€æ…‹åˆ—ï¼š`popular > new`ï¼Œè‹¥ popular=true å‰‡åªé¡¯ç¤º ğŸ”¥ï¼Œå¦å‰‡åœ¨ new=true æ‰é¡¯ç¤º ğŸŒ±ã€‚
- è‡ªå‹•æª¢æŸ¥ï¼š
  - ä»»å‹™åˆ—è¡¨ API å›å‚³å« `sort_order`ã€‚
  - å–®å…ƒæˆ–ç°¡æ¸¬ï¼šæ’åºçµæœç¬¦åˆæœŸæœ›éµé †åºã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - åˆ‡æ› /chat å…©åˆ†é ï¼Œè§€å¯Ÿä»»å‹™æ’åˆ—æ˜¯å¦èšæ”ï¼›Emoji é¡¯ç¤ºç¬¦åˆå„ªå…ˆè¦å‰‡ã€‚

---

### Phase 3 - æ‡‰å¾µè€…å¡ç‰‡é ­åƒèˆ‡æœªè®€å¾½ç« æ¨£å¼ï¼ˆPosted + My Worksï¼‰
- ç›®æ¨™ï¼š
  - Posted åˆ†é æ‡‰å¾µè€…å¡ç‰‡é¡¯ç¤º `applier_avatar`ï¼ˆç„¡å‰‡é¦–å­—æ¯ï¼‰ã€‚
  - ä»»å‹™å¡ç‰‡å³å´ï¼šç§»é™¤æ‡‰å¾µäººæ•¸æ•¸å­—ï¼ˆå¦‚æˆªåœ–ä¸­çš„ã€Œ2ã€ï¼‰ã€‚æ”¹ç‚ºèˆ‡åº•éƒ¨ navbar ä¸€è‡´çš„ã€Œç´”åœ“é»ã€ï¼ˆç„¡æ•¸å­—ï¼‰ï¼Œåªè¦è©²ä»»å‹™ä¸‹ä»»ä¸€æ‡‰å¾µè€…èŠå¤©å®¤å­˜åœ¨æœªè®€å°±é¡¯ç¤ºã€‚åœ“é»æ¡ç”¨ä¸»é¡Œ warning/alert è‰²ã€‚
  - æ‡‰å¾µè€…å¡ç‰‡å³å´ï¼šä¿ç•™ã€Œæœªè®€æ•¸å­—å¾½ç« ã€ï¼Œç‚ºä¸»é¡Œ warning/alert è‰²åœ“å½¢ï¼Œä¸­é–“ç™½è‰²æ•¸å­—ï¼Œè¡¨ç¤ºè©²èŠå¤©å®¤æœªè®€è¨Šæ¯æ•¸ã€‚
  - My Works åˆ†é ä¾åŒç­‰ç‹€æ…‹é‚è¼¯å‘ˆç¾æœªè®€ï¼ˆä»»å‹™å¡ç‰‡é¡¯ç¤ºåœ“é»ï¼›èŠå¤©å®¤/å°è±¡å¡ç‰‡é¡¯ç¤ºæœªè®€æ•¸å­—ï¼‰ã€‚
- è‡ªå‹•æª¢æŸ¥ï¼š
  - å¾Œç«¯ `posted_tasks_aggregated.php` applicants æ¬„ä½å« `applier_avatar`ã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - å±•é–‹ Posted æ‡‰å¾µè€…æ¸…å–®æ ¸å°é ­åƒ/ä½”ä½é‚è¼¯ï¼›æœªè®€å¾½ç« æ¨£å¼ç¬¦åˆè¨­è¨ˆã€‚

---

### æœªè®€çµ±ä¸€å°æ¥ç­–ç•¥ï¼ˆæ–¹æ¡ˆ Aï¼Œæ¡ç”¨ï¼‰
- åŸå‰‡ï¼šä¸åœ¨èšåˆ API è¨ˆç®—æœªè®€ï¼›çµ±ä¸€ä½¿ç”¨ `chat/unread_snapshot.php`ï¼ˆå›å‚³ `by_room`ï¼‰åšåˆä½µï¼Œä»¥ä¿æ•ˆèƒ½èˆ‡ä¸€è‡´æ€§ã€‚
- å¾Œç«¯æ”¹å‹•ï¼š
  - `backend/api/tasks/applications/list_by_user.php` å¢åŠ  `chat_room_id` æ¬„ä½ï¼š
    ```sql
    LEFT JOIN chat_rooms cr ON cr.task_id = t.id
      AND cr.participant_id = ta.user_id
      AND cr.creator_id = t.creator_id
    -- SELECT æ¬„ä½ï¼šcr.id AS chat_room_id
    ```
  - `posted_tasks_aggregated.php` æ—¢æœ‰ `applicants[].chat_room_id` å¯ç›´ç”¨ã€‚
- å‰ç«¯å°æ¥ï¼š
  - å…©åˆ†é çš†é€é `NotificationCenter.byRoomStream` å–å¾— `room_id â†’ æœªè®€æ•¸`ï¼š
    - Postedï¼š
      - ä»»å‹™å¡ï¼šèšåˆå…¶ applicants çš„ `chat_room_id` æ˜¯å¦ä»»ä¸€æœªè®€ > 0 â†’ é¡¯ç¤ºè­¦ç¤ºè‰²åœ“é»
      - æ‡‰å¾µè€…å¡ï¼šä½¿ç”¨ `by_room[chat_room_id]` é¡¯ç¤ºæœªè®€æ•¸å­—å¾½ç« 
    - My Worksï¼š
      - æ¯å€‹å¡ç‰‡å« `chat_room_id`ï¼›å¡ç‰‡é¡¯ç¤ºåœ“é»èˆ‡/æˆ–æœªè®€æ•¸å­—å¾½ç« ï¼ˆèˆ‡ Posted åŒè¦ï¼‰
  - åˆ†é å°ç´…é»ï¼šå„åˆ†é æ–¼åˆä½µ `by_room` å¾Œå½™ç¸½æ˜¯å¦å­˜åœ¨æœªè®€ï¼Œæ›´æ–° Provider `setTabHasUnread(tabIndex, bool)`ï¼Œtab æ¨™ç±¤å³ä¸Šé¡¯ç¤º 6px è­¦ç¤ºè‰²åœ“é»ã€‚
- é©—è­‰ï¼š
  - å¾Œç«¯ï¼š
    ```bash
    curl -sS "$BASE/backend/api/tasks/applications/list_by_user.php?user_id=2&limit=5" | jq '.data.applications[] | {task_id: .id, chat_room_id}'
    curl -sS -H "Authorization: Bearer $TOKEN" "$BASE/backend/api/chat/unread_snapshot.php" | jq '.data.by_room'
    ```
  - å‰ç«¯ï¼š`byRoomStream` çš„æœªè®€èˆ‡å¡ç‰‡åœ“é»/æ•¸å­—å°æ‡‰ä¸€è‡´ã€‚

---

### æœªè®€æ•¸è¨ˆç®—å®šç¾©ï¼ˆè³‡æ–™è™•ç†æº–å‰‡ï¼‰
- å®šç¾©ï¼šå°ã€Œç•¶å‰ç”¨æˆ¶ã€è€Œè¨€ï¼ŒæŸæˆ¿é–“çš„æœªè®€æ•¸ = è©²æˆ¿é–“ä¸­ã€Œä»–äººç™¼é€ã€ä¸” `id > my.last_read_message_id` çš„è¨Šæ¯æ•¸ã€‚
- ç­‰åƒ¹ SQLï¼ˆä»¥ `users.id = :uid`ï¼‰ï¼š
  ```sql
  SELECT m.room_id,
         SUM(CASE WHEN m.from_user_id <> :uid AND m.id > COALESCE(r.last_read_message_id, 0)
                  THEN 1 ELSE 0 END) AS unread_cnt
  FROM chat_messages m
  JOIN chat_rooms cr ON cr.id = m.room_id
  LEFT JOIN chat_reads r ON r.room_id = m.room_id AND r.user_id = :uid
  WHERE (cr.creator_id = :uid OR cr.participant_id = :uid)
  GROUP BY m.room_id;
  ```
- èªªæ˜ï¼šä¸ä½¿ç”¨ã€Œå°æ–¹å·²è®€ä½ è¨Šæ¯ã€ä¾†è¨ˆç®—ä½ çš„æœªè®€ï¼›é‚£æ˜¯å·²è®€å›åŸ·é¡¯ç¤ºï¼ˆ`opponent_last_read_message_id`ï¼‰ç”¨ï¼Œèˆ‡ä½ çš„æœªè®€æ•¸ç„¡é—œã€‚

---

### Phase 4 - æœ€æ–°è¨Šæ¯é è¦½ï¼ˆPosted æ‡‰å¾µè€…å¡ç‰‡ï¼‰
- ç›®æ¨™ï¼š
  - æ¯ä½æ‡‰å¾µè€…çš„å¡ç‰‡é¡¯ç¤ºè©²æ‡‰å¾µè€…å°æ‡‰èŠå¤©å®¤æœ€æ–°è¨Šæ¯ï¼ˆè‹¥ç„¡å‰‡å›é€€ cover letter ç‰‡æ®µï¼‰ã€‚
- å¾Œç«¯æ”¹å‹•ï¼š
  - `posted_tasks_aggregated.php` æ¯å€‹ applicant å¸¶ `chat_room_id`ã€`latest_message_snippet`ï¼ˆæŸ¥ `chat_messages` æœ€æ–° messageï¼‰ã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - é–‹å•Ÿ Posted æ‡‰å¾µè€…å¡ç‰‡ï¼Œç¢ºèªé¡¯ç¤ºçš„ç¢ºç‚ºæœ€æ–°è¨Šæ¯ç‰‡æ®µã€‚

---

### Phase 5 - My Works å¡ç‰‡é¡¯ç¤ºèŠå¤©å°è±¡ + æœ€æ–°è¨Šæ¯
- ç›®æ¨™ï¼š
  - My Works æ¯å€‹ä»»å‹™é …ç›®é¡¯ç¤ºã€ŒèŠå¤©å°è±¡ï¼ˆä»»å‹™å»ºç«‹è€…ï¼‰ã€èˆ‡ã€Œæœ€æ–°ä¸€å‰‡è¨Šæ¯é è¦½ã€ã€‚
- å¾Œç«¯æ”¹å‹•ï¼š
  - `applications/list_by_user.php` å¢è£œ `chat_room_id`ã€`chat_partner_name/avatar_url`ã€`latest_message_snippet`ã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - é€²å…¥ My Worksï¼Œæ ¸å°èŠå¤©å°è±¡é ­åƒ/åç¨±èˆ‡æœ€æ–°è¨Šæ¯ç‰‡æ®µã€‚

---

### Phase 6 - /chat/detail è¿”å›åˆ—è¡¨åˆ·æ–°ï¼ˆåƒ…ç•¶å‰åˆ†é ï¼‰
- ç›®æ¨™ï¼š
  - å¾èŠå¤©å®¤è¿”å› /chat æ™‚ï¼Œåªåˆ·æ–°ç•¶å‰åˆ†é è³‡æ–™ï¼Œä¸æ•´é é‡è¼‰ï¼Œä¸æœƒå‡ºç¾ç©ºç™½ã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - é€²å…¥/è¿”å›å¤šæ¬¡ï¼Œç¢ºèªç©©å®šæ€§ã€‚

---

### Phase 7 - Task Edit é å¡« start/end
- ç›®æ¨™ï¼š
  - Posted â†’ Edit è¡¨å–®é å¡« `start_datetime`/`end_datetime`ã€‚
- è‡ªå‹•æª¢æŸ¥ï¼š
  - `task_edit_data.php` å›å‚³å« start/endã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - é€²å…¥ Edit é ï¼Œç¢ºèª Posting Period æ§ä»¶å…§æœ‰æ­£ç¢ºèµ·è¨–æ™‚é–“ã€‚

---

### Phase 8 - èŠå¤©å®¤æ»¾å‹•å®šä½èˆ‡å·²è®€æ©Ÿåˆ¶ï¼ˆæ–°å¢ï¼‰
- ç›®æ¨™ï¼š
  - å¾Œç«¯ï¼š`backend/api/chat/get_messages.php` å›å‚³ `my_last_read_message_id`ã€‚
  - å‰ç«¯ï¼š
    - `ChatDetailPage` è¼‰å…¥è¨Šæ¯å¾Œå®šä½è‡³ `my_last_read_message_id` é„°è¿‘ä½ç½®ï¼Œé¡¯ç¤ºã€Œæ–°è¨Šæ¯ã€æç¤ºã€‚
    - é€²æˆ¿è¼‰å…¥å®Œæˆã€åˆ°é”åº•éƒ¨ã€é›¢é–‹é é¢æ™‚ï¼Œä¸Šå ± `markRoomRead(roomId, upToMessageId)`ï¼Œä»¥åˆ—è¡¨æœ€å¾Œä¸€å‰‡è¨Šæ¯ ID ç‚ºæº–ã€‚
  - åˆ—è¡¨ç«¯ï¼šæœªè®€åƒ…ä¾å¿«ç…§è®ŠåŒ–ï¼›ä¸å› è¿”å›åˆ—è¡¨è€Œè‡ªè¡Œæ¸…é™¤ã€‚
- è‡ªå‹•æª¢æŸ¥ï¼š
  - `get_messages.php` JSON ä¸­å‡ºç¾ `my_last_read_message_id`ã€‚
  - é€²æˆ¿å¾Œå†å‘¼å«å¿«ç…§ï¼Œè©²æˆ¿ by_room æ‡‰éæ¸›æˆ–ç‚º 0ã€‚
- æ‰‹å‹•æ“ä½œé©—æ”¶ï¼š
  - æ‰“é–‹èŠå¤©å®¤ â†’ è¿”å› â†’ è©²æˆ¿æœªè®€æ¶ˆå¤±æˆ–éæ¸›ï¼›åˆ†é  Tab èˆ‡ä»»å‹™å¡/æ‡‰å¾µè€…å¡ä¸€è‡´æ›´æ–°ã€‚

## çµ‚ç«¯æ©Ÿæ¸¬è©¦æŒ‡ä»¤ï¼ˆä»¥ users.id=2ï¼‰
```bash
# ç”¢ç”Ÿ tokenï¼ˆmacOS zshï¼‰
TOKEN=$(python3 - <<'PY'
import base64, json
print(base64.b64encode(json.dumps({"user_id":2,"exp":4102444800}).encode()).decode())
PY
)
BASE="<YOUR_BASE_URL>"  # ä¾‹: http://localhost:8888/here4help

# æœªè®€å¿«ç…§
curl -sS -H "Authorization: Bearer $TOKEN" "$BASE/backend/api/chat/unread_snapshot.php" | jq

# æ¨™è¨˜èŠå¤©å®¤å·²è®€ â†’ å†å¿«ç…§
curl -sS -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"room_id":"<ROOM_ID>"}' "$BASE/backend/api/chat/read_room.php" | jq
curl -sS -H "Authorization: Bearer $TOKEN" "$BASE/backend/api/chat/unread_snapshot.php" | jq

# ç·¨è¼¯è³‡æ–™æª¢æŸ¥ï¼ˆç¢ºèª start/endï¼‰
curl -sS "$BASE/backend/api/tasks/task_edit_data.php?id=<TASK_ID>" | jq

# Posted èšåˆï¼ˆå¾…è£œ latest_message_snippet å¾Œå†é‡è·‘ï¼‰
curl -sS "$BASE/backend/api/tasks/posted_tasks_aggregated.php?creator_id=2&limit=5" | jq '.data.tasks[0].applicants[0]'
```

### SQL é©—è­‰ï¼ˆåœ¨è³‡æ–™åº«ä¸­ï¼‰
```sql
-- ä½¿ç”¨ä½ çš„ DB å®¢æˆ¶ç«¯é€£ç·šå¾ŒåŸ·è¡Œï¼ˆä»¥ :uid = 2ï¼‰
-- 1) æŸ¥æ¯æˆ¿æœªè®€æ•¸
SELECT m.room_id,
       SUM(CASE WHEN m.from_user_id <> 2 AND m.id > COALESCE(r.last_read_message_id, 0)
                THEN 1 ELSE 0 END) AS unread_cnt
FROM chat_messages m
JOIN chat_rooms cr ON cr.id = m.room_id
LEFT JOIN chat_reads r ON r.room_id = m.room_id AND r.user_id = 2
WHERE (cr.creator_id = 2 OR cr.participant_id = 2)
GROUP BY m.room_id
ORDER BY m.room_id;

-- 2) æª¢æŸ¥é›™æ–¹æœ€å¾Œå·²è®€ï¼ˆè®€å›åŸ·é¡¯ç¤ºç”¨é€”ï¼‰
SELECT user_id, room_id, last_read_message_id FROM chat_reads WHERE room_id IN (
  SELECT id FROM chat_rooms WHERE creator_id = 2 OR participant_id = 2
);
```

---

## æ‰‹å‹•é©—æ”¶æ¸…å–®ï¼ˆé€éšæ®µï¼‰
- Phase 1ï¼š
  - ç™»å…¥ `Luisa@test.com / 1234` â†’ åº•éƒ¨ Chat åœ–ç¤ºé¡¯ç¤ºåœ“é»ï¼ˆè‹¥æœ‰æœªè®€ï¼‰ã€‚
  - é€²å…¥ä»»ä¸€èŠå¤©å®¤å¾Œè¿”å› â†’ åœ“é»ç‹€æ…‹å³æ™‚è®Šæ›´ï¼ˆtotal=0 æ™‚éš±è—ï¼‰ã€‚
- Phase 2ï¼š
  - å…©åˆ†é æ’åºèšæ”ï¼›Emoji è¦å‰‡ popular>new ç”Ÿæ•ˆã€‚
- Phase 3ï¼š
  - æ‡‰å¾µè€…é ­åƒé¡¯ç¤ºæ­£ç¢ºï¼›å¡ç‰‡æœªè®€å¾½ç« ä¸»é¡Œè‰²ã€åœ“å½¢ã€ä¸­å¿ƒæ•¸å­—ã€‚
- Phase 4ï¼š
  - Posted æ‡‰å¾µè€…å¡ç‰‡é¡¯ç¤ºæœ€æ–°è¨Šæ¯é è¦½ã€‚
- Phase 5ï¼š
  - My Works å¡ç‰‡é¡¯ç¤ºèŠå¤©å°è±¡èˆ‡æœ€æ–°è¨Šæ¯é è¦½ã€‚
- Phase 6ï¼š
  - å¾ /chat/detail è¿”å› /chat åƒ…åˆ·æ–°ç•¶å‰åˆ†é ï¼Œç©©å®šç„¡ç©ºç™½ã€‚
- Phase 7ï¼š
  - Edit è¡¨å–®é å¡« start/endã€‚

---

## é€²åº¦è¿½è¹¤
- [âœ…] Phase 1ï¼šå…¨åŸŸæœªè®€åˆå§‹åŒ–èˆ‡åº•éƒ¨å°è¦½åœ“é»ï¼ˆå·²å®Œæˆï¼‰
  - `NotificationCenter` åˆå§‹åŒ–èˆ‡ Socket é€£æ¥æ­£å¸¸
  - `unread_snapshot.php` SQL ç¾¤çµ„å•é¡Œå·²ä¿®æ­£ï¼ˆé¿å…ç¬›å¡çˆ¾ç©é‡è¤‡è¨ˆç®—ï¼‰
  - åº•éƒ¨ Chat åœ–ç¤ºç´”åœ“é»é¡¯ç¤ºé‚è¼¯æ­£å¸¸ï¼Œè­¦ç¤ºè‰²å·²å¥—ç”¨
  - `PostedTasksWidget` èˆ‡ `MyWorksWidget` é€é `byRoomStream` æ­£ç¢ºå°æ¥
- [âœ…] Phase 2ï¼šæ’åºèšæ” + Emoji è¦å‰‡ï¼ˆstatus.sort_order â†’ updated_at DESCï¼Œpopular > new emoji å„ªå…ˆç´šï¼‰
- [âœ…] Phase 3ï¼šæ‡‰å¾µè€…é ­åƒ + æœªè®€å¾½ç« æ¨£å¼ï¼ˆå¯¦éš›é ­åƒé¡¯ç¤ºã€è©•åˆ†èˆ‡åç¨±åŒä¸€è¡Œã€ç§»é™¤èˆŠè©•åˆ†ï¼‰
- [âœ…] Phase 4ï¼šPosted æœ€æ–°è¨Šæ¯é è¦½ï¼ˆå¾Œç«¯æŸ¥è©¢æœ€æ–°èŠå¤©è¨Šæ¯ã€å‰ç«¯é¡¯ç¤º latest_message_snippetï¼‰
- [âœ…] Phase 5ï¼šMy Works èŠå¤©å°è±¡ + æœ€æ–°è¨Šæ¯ï¼ˆå¾Œç«¯å¢åŠ ç‰‡æ®µã€å‰ç«¯é¡¯ç¤ºå‰µå»ºè€…é ­åƒåç¨±èˆ‡è¨Šæ¯ï¼‰
- [âœ…] Phase 6ï¼šè¿”å›åˆ†é åˆ·æ–°ï¼ˆå·²é€šé reset ç„¡é™åˆ·æ–°ä¿®æ­£è§£æ±ºï¼‰
- [âœ…] Phase 7ï¼šEdit é å¡« start/endï¼ˆä¿®æ­£ç·¨è¼¯æ¨¡å¼çš„ start_datetime/end_datetime é å¡«é‚è¼¯ï¼‰
- [âœ…] é ­åƒè¼‰å…¥éŒ¯èª¤ä¿®æ­£ï¼šå‰µå»º `AvatarErrorCache` å·¥å…·é¡åˆ¥ï¼Œä½¿ç”¨éœæ…‹å¿«å–é¿å…é‡è¤‡è¼‰å…¥å¤±æ•—çš„åœ–ç‰‡URL

### Phase 8 - æœªè®€æ¨™è¨˜ç³»çµ±é‡æ§‹ï¼ˆé€²è¡Œä¸­ï¼‰

**è³‡æ–™åº«æ¶æ§‹ç¢ºèª**ï¼š
- âœ… `chat_rooms` è¡¨å¯¦éš›åŒ…å« `creator_id`, `participant_id` æ¬„ä½
- âœ… è³‡æ–™åº«é·ç§»å·²æ­£ç¢ºåŸ·è¡Œï¼Œæ”¯æ´è§’è‰²å‹æœªè®€è¨ˆç®—
- âš ï¸ ç™¼ç¾ä¸åŒæœªè®€ API è¨ˆç®—çµæœä¸ä¸€è‡´ï¼Œéœ€è¦çµ±ä¸€é‚è¼¯

**è§’è‰²å‹æœªè®€è¨ˆç®—ç­–ç•¥**ï¼ˆåŸºæ–¼ç”¨æˆ¶å»ºè­°ï¼‰ï¼š
1. **ç²¾ç¢ºåˆ†é è¨ˆç®—**ï¼š
   - Posted Tasks (scope=posted)ï¼š`WHERE creator_id = user_id`ï¼Œè¨ˆç®— `participant_id` ç™¼é€çš„æœªè®€
   - My Works (scope=myworks)ï¼š`WHERE participant_id = user_id`ï¼Œè¨ˆç®— `creator_id` ç™¼é€çš„æœªè®€
   - ç¸½è¨ˆ (scope=all)ï¼šåˆä½µå…©è€…ï¼ŒåŒ room ä¸é‡è¤‡è¨ˆç®—

2. **API å®‰å…¨è¨­è¨ˆ**ï¼š
   - **GET** `/api/chat/unread_by_tasks.php?scope=posted|myworks|all`
   - **POST** `/api/chat/read_room_v2.php` (æ›¿æ›åŸç‰ˆ)ï¼š
     - æ¬Šé™é©—è­‰ï¼šç¢ºä¿ç”¨æˆ¶ç‚ºè©² room åƒèˆ‡è€…
     - äº¤æ˜“å®‰å…¨ï¼šä½¿ç”¨ UPSERT æ›´æ–°å·²è®€è¨˜éŒ„
     - å†ªç­‰æ“ä½œï¼šé‡è¤‡èª¿ç”¨çµæœä¸€è‡´

3. **æ¼¸é€²å¼æ›¿æ›**ï¼š
   - éšæ®µ 1ï¼šä¿ç•™ `unread_snapshot.php` ä½œç‚ºå¾Œå‚™
   - éšæ®µ 2ï¼šå‰ç«¯åˆ‡æ›è‡³ `unread_by_tasks.php`
   - éšæ®µ 3ï¼šé©—è­‰ä¸€è‡´æ€§å¾Œå®Œå…¨æ›¿æ›

**å¯¦éš›é©—è­‰çµæœ**ï¼š
1. **è³‡æ–™åº«æ¶æ§‹ç¢ºèª** âœ…
   - `chat_rooms` è¡¨åŒ…å« `creator_id`, `participant_id` æ¬„ä½
   - `chat_messages` è¡¨ä½¿ç”¨ `sender_id`, `content` æ¬„ä½ï¼ˆé `from_user_id`, `message`ï¼‰
   
2. **API ä¿®æ­£èˆ‡æ¸¬è©¦** âœ…
   - ä¿®æ­£æ¬„ä½åç¨±ï¼š`from_user_id` â†’ `sender_id`
   - æ¸¬è©¦çµæœï¼šPosted=159, MyWorks=16, Total=160
   - æ¨™è¨˜å·²è®€åŠŸèƒ½ï¼šæˆ¿é–“ 4 å¾æœ‰æœªè®€è®Šç‚º 0 æœªè®€ âœ…
   
3. **å‰ç«¯æ•´åˆæº–å‚™** âœ…
   - å‰µå»º `UnreadServiceV2` æœå‹™é¡åˆ¥
   - å‰µå»º `UnreadApiTestPage` æ¸¬è©¦é é¢ï¼ˆè·¯ç”±ï¼š`/debug/unread-api`ï¼‰
   - ä¿®æ­£ `AuthService.getToken()` å¼•ç”¨

## ğŸ§ª è©³ç´°é©—è­‰åŠ‡æœ¬ï¼ˆåŸºæ–¼ç”¨æˆ¶å»ºè­°ï¼‰

### A. å¾Œç«¯ API é©—è­‰åŠ‡æœ¬

#### A1. åŸºç¤ç’°å¢ƒè¨­ç½®
```bash
# è¨­ç½®ç’°å¢ƒè®Šæ•¸
export BASE="http://localhost:8888/here4help"
export TOKEN=$(python3 - <<'PY'
import base64, json
print(base64.b64encode(json.dumps({"user_id":2,"exp":4102444800}).encode()).decode())
PY
)
```

#### A2. åˆ†é æœªè®€è¨ˆç®—é©—è­‰
```bash
# æ¸¬è©¦ Posted Tasks åˆ†é 
curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=posted" | jq '.data.total'
# é æœŸï¼šè¿”å›ç•¶å‰ç”¨æˆ¶ä½œç‚º creator çš„æœªè®€ç¸½æ•¸

# æ¸¬è©¦ My Works åˆ†é   
curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=myworks" | jq '.data.total'
# é æœŸï¼šè¿”å›ç•¶å‰ç”¨æˆ¶ä½œç‚º participant çš„æœªè®€ç¸½æ•¸

# æ¸¬è©¦ç¸½è¨ˆ
curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" | jq '.data.total'
# é æœŸï¼šposted + myworks çš„ç¸½å’Œ
```

#### A3. å·²è®€æ¨™è¨˜åŠŸèƒ½é©—è­‰
```bash
# é¸æ“‡ä¸€å€‹æœ‰æœªè®€çš„æˆ¿é–“
ROOM_ID=$(curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" | \
  jq -r '.data.by_room | to_entries | .[0].key')

# è¨˜éŒ„æ¨™è¨˜å‰çš„æœªè®€æ•¸
BEFORE=$(curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" | \
  jq ".data.by_room[\"$ROOM_ID\"]")

echo "æˆ¿é–“ $ROOM_ID æ¨™è¨˜å‰æœªè®€æ•¸: $BEFORE"

# æ¨™è¨˜ç‚ºå·²è®€
curl -sS -X POST -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"room_id\":\"$ROOM_ID\"}" \
  "$BASE/backend/api/chat/read_room_v2.php" | jq '.data'

# é©—è­‰æ¨™è¨˜å¾Œçš„æœªè®€æ•¸
AFTER=$(curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" | \
  jq ".data.by_room[\"$ROOM_ID\"] // 0")

echo "æˆ¿é–“ $ROOM_ID æ¨™è¨˜å¾Œæœªè®€æ•¸: $AFTER"
# é æœŸï¼šAFTER æ‡‰ç‚º 0
```

### B. å‰ç«¯æ•´åˆé©—è­‰åŠ‡æœ¬

#### B1. æ¸¬è©¦é é¢è¨ªå•
1. å•Ÿå‹• Flutter æ‡‰ç”¨ç¨‹å¼ï¼š`flutter run -d ios`
2. ç™»å…¥ç³»çµ±ï¼šä½¿ç”¨ `Luisa@test.com / 1234`
3. è¨ªå•æ¸¬è©¦é é¢ï¼šåœ¨ç€è¦½å™¨ä¸­è¼¸å…¥æ‡‰ç”¨ç¨‹å¼ URL + `/debug/unread-api`

#### B2. UnreadServiceV2 åŠŸèƒ½é©—è­‰
åœ¨æ¸¬è©¦é é¢ä¸­ï¼š
1. **åŸºç¤ API æ¸¬è©¦**ï¼šé»æ“Šã€ŒåŸºç¤æ¸¬è©¦ã€æŒ‰éˆ•
   - é©—è­‰ï¼šPosted/MyWorks/All ä¸‰å€‹ scope çš„æ•¸æ“šä¸€è‡´æ€§
   - é æœŸï¼šå„ scope çš„ total å’Œ by_room æ•¸æ“šæ­£ç¢º

2. **ä¾¿æ·æ–¹æ³•æ¸¬è©¦**ï¼šè§€å¯Ÿ convenience_methods çµæœ
   - é©—è­‰ï¼š`getTotalUnread()`, `getPostedTasksUnread()`, `getMyWorksUnread()` æ–¹æ³•æ­£å¸¸

3. **æ‰¹é‡æ•¸æ“šæ¸¬è©¦**ï¼šé»æ“Šã€Œæ‰¹é‡æ•¸æ“šæ¸¬è©¦ã€
   - é©—è­‰ï¼š`getAllUnreadData()` æ–¹æ³•èƒ½æ­£ç¢ºåˆä½µæ‰€æœ‰æ•¸æ“š

4. **æ¨™è¨˜å·²è®€æ¸¬è©¦**ï¼šé»æ“Šã€Œæ¸¬è©¦æ¨™è¨˜å·²è®€ã€
   - é©—è­‰ï¼šé¸ä¸­ä¸€å€‹æˆ¿é–“æ¨™è¨˜å¾Œï¼Œæœªè®€æ•¸ç¢ºå¯¦è®Šç‚º 0

#### B3. ä¸€è‡´æ€§æª¢æŸ¥
åœ¨æ¸¬è©¦çµæœä¸­æª¢æŸ¥ `consistency_check` æ¬„ä½ï¼š
- `posted_total_match`: Posted åˆ†é ç¸½æ•¸èˆ‡æˆ¿é–“ç¸½å’Œä¸€è‡´ âœ…
- `myworks_total_match`: MyWorks åˆ†é ç¸½æ•¸èˆ‡æˆ¿é–“ç¸½å’Œä¸€è‡´ âœ…  
- `total_calculation_correct`: å…¨éƒ¨ç¸½æ•¸è¨ˆç®—æ­£ç¢º âœ…

### C. èˆ‡ç¾æœ‰ç³»çµ±çš„ç›¸å®¹æ€§é©—è­‰

#### C1. èˆ‡ NotificationCenter æ•´åˆæ¸¬è©¦
```dart
// åœ¨ç¾æœ‰çš„ NotificationCenter ä¸­æ¸¬è©¦æ–°çš„ API
final unreadData = await UnreadServiceV2.getAllUnreadData();
// é©—è­‰èˆ‡ç¾æœ‰ byRoomStream çš„è³‡æ–™æ ¼å¼ç›¸å®¹æ€§
```

#### C2. æ¼¸é€²å¼æ›¿æ›é©—è­‰
1. **éšæ®µ 1**ï¼šä¿æŒç¾æœ‰ `unread_snapshot.php` æ­£å¸¸é‹ä½œ
2. **éšæ®µ 2**ï¼šåœ¨æ¸¬è©¦ç’°å¢ƒä¸­åˆ‡æ›è‡³ `unread_by_tasks.php`
3. **éšæ®µ 3**ï¼šæ¯”è¼ƒå…©å€‹ API çš„æ•¸æ“šä¸€è‡´æ€§
4. **éšæ®µ 4**ï¼šé€æ­¥æ›¿æ›å‰ç«¯èª¿ç”¨

### D. æ•ˆèƒ½èˆ‡å®‰å…¨æ€§é©—è­‰

#### D1. API æ•ˆèƒ½æ¸¬è©¦
```bash
# å£“åŠ›æ¸¬è©¦ï¼šé€£çºŒèª¿ç”¨ 100 æ¬¡
for i in {1..100}; do
  curl -sS -H "Authorization: Bearer $TOKEN" \
    "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" > /dev/null
  echo "Request $i completed"
done
```

#### D2. æ¬Šé™é©—è­‰æ¸¬è©¦
```bash
# ä½¿ç”¨ç„¡æ•ˆ token æ¸¬è©¦
curl -sS -H "Authorization: Bearer invalid_token" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all"
# é æœŸï¼š401 Unauthorized

# å˜—è©¦æ¨™è¨˜åˆ¥äººçš„æˆ¿é–“ç‚ºå·²è®€
curl -sS -X POST -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"room_id":"999999"}' \
  "$BASE/backend/api/chat/read_room_v2.php"
# é æœŸï¼š403 Forbidden æˆ– 404 Not Found
```

## ğŸ“‹ å®Œæˆæª¢æŸ¥æ¸…å–®

- [âœ…] å¾Œç«¯ API å¯¦ä½œèˆ‡æ¸¬è©¦
- [âœ…] æ¬„ä½åç¨±ä¿®æ­£ï¼ˆsender_id, contentï¼‰
- [âœ…] åˆ†é ç¯„åœï¼ˆscopeï¼‰åŠŸèƒ½é©—è­‰
- [âœ…] å·²è®€æ¨™è¨˜åŠŸèƒ½é©—è­‰
- [âœ…] å‰ç«¯æœå‹™é¡åˆ¥å‰µå»º
- [âœ…] æ¸¬è©¦é é¢é–‹ç™¼
- [âœ…] è·¯ç”±é…ç½®
- [ ] å‰ç«¯æ‡‰ç”¨ç¨‹å¼æ¸¬è©¦ï¼ˆå¾…å•Ÿå‹•æˆåŠŸï¼‰
- [ ] èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆæ¸¬è©¦
- [ ] æ¼¸é€²å¼æ›¿æ›åŸ·è¡Œ
- [ ] æ•ˆèƒ½èˆ‡å®‰å…¨æ€§é©—è­‰
- [ ] æœ€çµ‚ç”¨æˆ¶é©—æ”¶æ¸¬è©¦

## ğŸ‰ æœªè®€å·²è®€æ©Ÿåˆ¶æ•´åˆå®Œæˆç¸½çµ

### âœ… å·²å®Œæˆçš„å·¥ä½œ
1. **æª”æ¡ˆæ¶æ§‹æ¢³ç†**ï¼šå®Œæ•´åˆ†æäº†æ‰€æœ‰æœªè®€å·²è®€ç›¸é—œæª”æ¡ˆçš„ç”¨é€”èˆ‡é—œè¯
2. **API çµ±ä¸€**ï¼šæˆåŠŸå°‡ `unread_snapshot.php` æ›¿æ›ç‚º `unread_by_tasks.php`
3. **é…ç½®æ›´æ–°**ï¼šæ›´æ–°äº†æ‰€æœ‰å‰ç«¯é…ç½®æª”æ¡ˆï¼Œç§»é™¤èˆŠ API å¼•ç”¨
4. **å®‰å…¨ç§»é™¤**ï¼šç¢ºèªç„¡å¼•ç”¨å¾Œå®‰å…¨ç§»é™¤äº†èˆŠçš„ PHP æª”æ¡ˆ
5. **åŠŸèƒ½é©—è­‰**ï¼šç¢ºèªæ‰€æœ‰æœªè®€å·²è®€åŠŸèƒ½æ­£å¸¸é‹ä½œ
6. **æ¬„ä½çµ±ä¸€ä¿®å¾©**ï¼šä¿®å¾©äº†æ‰€æœ‰ `message` æ¬„ä½å¼•ç”¨ï¼Œçµ±ä¸€ä½¿ç”¨ `content`

### ğŸ“Š æœ€çµ‚æª”æ¡ˆæ¶æ§‹
- **ä¸»è¦ API**ï¼š`unread_by_tasks.php`ï¼ˆè§’è‰²å‹æœªè®€è¨ˆç®—ï¼‰
- **ä¸»è¦æœå‹™**ï¼š`UnreadServiceV2`ï¼ˆå‰ç«¯æœªè®€æœå‹™ï¼‰
- **å·²è®€æ¨™è¨˜**ï¼š`read_room_v2.php`ï¼ˆå®‰å…¨ã€å†ªç­‰çš„å·²è®€æ¨™è¨˜ï¼‰
- **UI çµ„ä»¶**ï¼šä½¿ç”¨ `NotificationCenter.byRoomStream` å¯¦æ™‚æ›´æ–°

### ğŸ”„ å¾…å®Œæˆï¼ˆå¯é¸ï¼‰
- æ–‡æª”ä¸­çš„ API å¼•ç”¨æ›´æ–°ï¼ˆä¸å½±éŸ¿åŠŸèƒ½é‹ä½œï¼‰

### ğŸ› ä¿®å¾©è¨˜éŒ„
- **2025-08-16**ï¼šä¿®å¾© `posted_tasks_aggregated.php` å’Œ `list_by_user.php` ä¸­çš„ `cm.message` å¼•ç”¨
- **2025-08-16**ï¼šä¿®å¾© `get_rooms.php` ä¸­çš„ `latest_msg.message` å¼•ç”¨
- **2025-08-16**ï¼šä¿®å¾© `debug_get_messages.php` ä¸­çš„ `cm.message` å¼•ç”¨
- **2025-08-16**ï¼šç‚º `chat_reads` è¡¨æ·»åŠ è‡ªå¢ ID ä¸¦æ¸…ç†é‡è¤‡è³‡æ–™
- **2025-08-16**ï¼šä¿®å¾©èŠå¤©ç›¸é—œ API ä¸­çš„ `message` æ¬„ä½å¼•ç”¨ï¼Œçµ±ä¸€ä½¿ç”¨ `content`
- **2025-08-16**ï¼šä¿®å¾© `ChatDetailPage` ä¸­çš„ `_task` è®Šæ•¸åˆå§‹åŒ–å•é¡Œï¼Œç¢ºä¿èŠå¤©å®¤æ•¸æ“šæ­£ç¢ºè¼‰å…¥
- **2025-08-16**ï¼šä¿®å¾©èŠå¤©å®¤æ•¸æ“šæœ¬åœ°å„²å­˜å•é¡Œï¼Œç¢ºä¿ `/chat/detail` é é¢èƒ½æ­£ç¢ºè®€å–å’Œä¿å­˜èŠå¤©å®¤æ•¸æ“š
- **2025-08-16**ï¼šä¿®å¾©ç„¡é™åˆ·æ–°å•é¡Œï¼Œå„ªåŒ– Provider é€šçŸ¥æ©Ÿåˆ¶å’Œæ•¸æ“šè¼‰å…¥ç­–ç•¥

å‚™è¨»ï¼šæœ¬æª”ç‚ºè‡¨æ™‚é–‹ç™¼æŒ‡å—ï¼›æ‰€æœ‰éšæ®µå®Œæˆä¸¦ç¶“ä½ æœ€çµ‚åŒæ„å¾Œï¼Œæœƒæ•´åˆå›å„ TODO æ–‡æª”ä¸¦åœ¨æ­¤æª”æ¨™è¨˜ä¾†æºèˆ‡æ­¸æª”ã€‚

## ğŸ”§ ç„¡é™åˆ·æ–°èˆ‡æœ¬åœ°æ•¸æ“šè®€å–å•é¡Œä¿®å¾©ï¼ˆæ–°å¢ï¼‰

### å•é¡Œåˆ†æ

#### 1. ç„¡é™åˆ·æ–°å•é¡Œ
**æ ¹æœ¬åŸå› **ï¼š`ChatListProvider` çš„ `notifyListeners()` è§¸ç™¼å¾ªç’°æ›´æ–°
- `_updateTabUnreadFlag()` â†’ `provider.setTabHasUnread()` â†’ `notifyListeners()` â†’ `_handleProviderChanges()` â†’ `_pagingController.refresh()` â†’ é‡æ–°è¼‰å…¥æ•¸æ“š â†’ å†æ¬¡è§¸ç™¼æœªè®€æ›´æ–°

#### 2. æœ¬åœ°æ•¸æ“šè®€å–å•é¡Œ
**æ ¹æœ¬åŸå› **ï¼šæ•¸æ“šè¼‰å…¥æ™‚æ©Ÿèˆ‡æœ¬åœ°å„²å­˜ä¸åŒæ­¥
- `ChatDetailWrapper` æ§‹é€ æœ€å°æ•¸æ“šé›†ï¼Œä½†æ²’æœ‰å®Œæ•´çš„èŠå¤©å®¤æ•¸æ“š
- `ChatDetailPage` æˆåŠŸè¼‰å…¥å¾Œæ²’æœ‰ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
- ä¸‹æ¬¡è¨ªå•æ™‚ç„¡æ³•å¾æœ¬åœ°å„²å­˜è®€å–å®Œæ•´æ•¸æ“š

#### 3. å…©å€‹å•é¡Œçš„é—œè¯æ€§
- **ç„¡é™åˆ·æ–°**ï¼šProvider é€šçŸ¥æ©Ÿåˆ¶éæ–¼æ•æ„Ÿï¼Œå°è‡´ä¸å¿…è¦çš„é‡æ–°è¼‰å…¥
- **æœ¬åœ°æ•¸æ“šè®€å–**ï¼šæ•¸æ“šæŒä¹…åŒ–æ©Ÿåˆ¶ä¸å®Œå–„ï¼Œå°è‡´æ¯æ¬¡éƒ½éœ€è¦é‡æ–°è¼‰å…¥
- **å…±åŒå½±éŸ¿**ï¼šéƒ½å°è‡´èŠå¤©åˆ—è¡¨é é¢æ€§èƒ½å•é¡Œå’Œç”¨æˆ¶é«”é©—ä¸ä½³

### è§£æ±ºæ–¹æ¡ˆ

#### 1. Provider é€šçŸ¥æ©Ÿåˆ¶å„ªåŒ–
```dart
// åœ¨ ChatListProvider ä¸­æ·»åŠ ç‹€æ…‹æª¢æŸ¥
void setTabHasUnread(int tabIndex, bool value) {
  // åªæœ‰ç•¶ç‹€æ…‹çœŸæ­£æ”¹è®Šæ™‚æ‰æ›´æ–°ï¼Œé¿å…ç„¡é™å¾ªç’°
  if (_tabHasUnread[tabIndex] == value) return;
  _tabHasUnread[tabIndex] = value;
  _emit('unread');
}

// åœ¨ Widget ä¸­æ·»åŠ æ¢ä»¶æª¢æŸ¥
void _updatePostedTabUnreadFlag() {
  bool hasUnread = false;
  // è¨ˆç®—æœªè®€ç‹€æ…‹...
  
  try {
    final provider = context.read<ChatListProvider>();
    // åªæœ‰ç•¶ç‹€æ…‹çœŸæ­£æ”¹è®Šæ™‚æ‰æ›´æ–°
    if (provider.hasUnreadForTab(0) != hasUnread) {
      provider.setTabHasUnread(0, hasUnread);
    }
  } catch (_) {}
}
```

#### 2. æ•¸æ“šè¼‰å…¥ç­–ç•¥å„ªåŒ–
```dart
// åœ¨ ChatDetailPage ä¸­ä¿å­˜å®Œæ•´æ•¸æ“š
Future<void> _saveChatRoomData(Map<String, dynamic> chatData, String roomId) async {
  try {
    await ChatStorageService.savechatRoomData(
      roomId: roomId,
      room: chatData['room'] ?? {},
      task: chatData['task'] ?? {},
      userRole: chatData['user_role']?.toString(),
      chatPartnerInfo: chatData['chat_partner_info'],
    );
  } catch (e) {
    debugPrint('âŒ ä¿å­˜èŠå¤©å®¤æ•¸æ“šå¤±æ•—: $e');
  }
}

// åœ¨ ChatDetailWrapper ä¸­å„ªå…ˆä½¿ç”¨æœ¬åœ°æ•¸æ“š
Future<void> _initializeChatData() async {
  // 1. å…ˆæª¢æŸ¥æœ¬åœ°å„²å­˜
  final storedData = await ChatStorageService.getChatRoomData(roomId);
  if (storedData != null && storedData.isNotEmpty) {
    chatData = storedData;
    return;
  }
  
  // 2. å¦‚æœæœ¬åœ°æ²’æœ‰ï¼Œå¾ API è¼‰å…¥ä¸¦ä¿å­˜
  final apiData = await ChatService().getChatDetailData(roomId: roomId);
  await _saveChatRoomData(apiData, roomId);
  chatData = apiData;
}
```

#### 3. è¼‰å…¥æ™‚æ©Ÿæ§åˆ¶
```dart
// åœ¨ Widget ä¸­ä½¿ç”¨ addPostFrameCallback é¿å… build æœŸé–“è§¸ç™¼
void _handleProviderChanges() {
  if (!mounted) return;
  
  try {
    final chatProvider = context.read<ChatListProvider>();
    if (chatProvider.currentTabIndex == 0) {
      // é¿å…åœ¨ build æœŸé–“è§¸ç™¼ refresh
      WidgetsBinding.instance.addPostFrameCallback((_) {
        // åªæœ‰åœ¨çœŸæ­£éœ€è¦åˆ·æ–°æ™‚æ‰åˆ·æ–°
        if (chatProvider.hasActiveFilters || chatProvider.searchQuery.isNotEmpty) {
          _pagingController.refresh();
        }
      });
    }
  } catch (e) {
    // Context may not be available
  }
}
```

### ç›¸å®¹æ€§ç­–ç•¥

#### 1. æ™ºèƒ½åˆ·æ–°æ©Ÿåˆ¶
- **æ¢ä»¶åˆ·æ–°**ï¼šåªæœ‰ç¯©é¸æ¢ä»¶è®ŠåŒ–æ™‚æ‰åˆ·æ–°ï¼Œæœªè®€ç‹€æ…‹è®ŠåŒ–ä¸è§¸ç™¼åˆ·æ–°
- **å»¶é²åˆ·æ–°**ï¼šä½¿ç”¨ `addPostFrameCallback` é¿å…åœ¨ build æœŸé–“è§¸ç™¼
- **ç‹€æ…‹æª¢æŸ¥**ï¼šåœ¨æ›´æ–° Provider ç‹€æ…‹å‰æª¢æŸ¥æ˜¯å¦çœŸæ­£æ”¹è®Š

#### 2. æ•¸æ“šæŒä¹…åŒ–ç­–ç•¥
- **å„ªå…ˆæœ¬åœ°**ï¼šå„ªå…ˆä½¿ç”¨æœ¬åœ°å„²å­˜æ•¸æ“šï¼Œæ¸›å°‘ API èª¿ç”¨
- **è‡ªå‹•ä¿å­˜**ï¼šæˆåŠŸè¼‰å…¥å¾Œè‡ªå‹•ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
- **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°è®ŠåŒ–çš„æ•¸æ“šï¼Œä¸é‡æ–°è¼‰å…¥å…¨éƒ¨

#### 3. èŠå¤©åˆ—è¡¨é é¢è¼‰å…¥ç­–ç•¥
- **é¦–æ¬¡è¼‰å…¥**ï¼šå¾æœ¬åœ°å„²å­˜æˆ– API è¼‰å…¥å®Œæ•´æ•¸æ“š
- **å¾ŒçºŒè¨ªå•**ï¼šå„ªå…ˆä½¿ç”¨æœ¬åœ°å„²å­˜ï¼ŒèƒŒæ™¯æª¢æŸ¥æ›´æ–°
- **å¯¦æ™‚æ›´æ–°**ï¼šé€šé Socket æˆ–è¼ªè©¢æ©Ÿåˆ¶æ›´æ–°æœªè®€ç‹€æ…‹

### é©—è­‰æ–¹æ³•

#### çµ‚ç«¯æ©Ÿé©—è­‰
```bash
# æª¢æŸ¥æœªè®€æ•¸æ“šæ˜¯å¦æ­£ç¢ºè¼‰å…¥
curl -sS -H "Authorization: Bearer $TOKEN" \
  "$BASE/backend/api/chat/unread_by_tasks.php?scope=all" | jq '.data.total'

# æª¢æŸ¥æœ¬åœ°å„²å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ
# è§€å¯Ÿ Console æ—¥èªŒä¸­çš„æœ¬åœ°å„²å­˜ç›¸é—œè¨Šæ¯
```

#### å‰ç«¯é©—è­‰
1. **ç„¡é™åˆ·æ–°æ¸¬è©¦**ï¼š
   - é€²å…¥èŠå¤©åˆ—è¡¨é é¢ï¼Œè§€å¯Ÿæ˜¯å¦é‡è¤‡è¼‰å…¥
   - åˆ‡æ› Tabï¼Œè§€å¯Ÿæ˜¯å¦è§¸ç™¼ä¸å¿…è¦çš„åˆ·æ–°
   - æª¢æŸ¥ Console æ—¥èªŒä¸­çš„ Provider é€šçŸ¥æ¬¡æ•¸

2. **æœ¬åœ°æ•¸æ“šæ¸¬è©¦**ï¼š
   - é€²å…¥èŠå¤©å®¤å¾Œè¿”å›ï¼Œè§€å¯Ÿæ˜¯å¦å¿«é€Ÿè¼‰å…¥
   - é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ï¼Œè§€å¯Ÿæ˜¯å¦ä¿ç•™èŠå¤©å®¤æ•¸æ“š
   - æª¢æŸ¥ Console æ—¥èªŒä¸­çš„æœ¬åœ°å„²å­˜ç›¸é—œè¨Šæ¯

3. **æ€§èƒ½æ¸¬è©¦**ï¼š
   - æ¸¬é‡é é¢è¼‰å…¥æ™‚é–“
   - è§€å¯Ÿå…§å­˜ä½¿ç”¨æƒ…æ³
   - æª¢æŸ¥ API èª¿ç”¨æ¬¡æ•¸

### é æœŸçµæœ
- âœ… èŠå¤©åˆ—è¡¨é é¢ä¸å†ç„¡é™åˆ·æ–°
- âœ… æœ¬åœ°æ•¸æ“šæ­£ç¢ºè®€å–å’Œä¿å­˜
- âœ… é é¢è¼‰å…¥æ€§èƒ½æå‡
- âœ… ç”¨æˆ¶é«”é©—æµæš¢ï¼Œç„¡å¡é “ç¾è±¡
- âœ… API èª¿ç”¨æ¬¡æ•¸æ¸›å°‘
- âœ… å…§å­˜ä½¿ç”¨ç©©å®š

### é é˜²æªæ–½
1. **ä»£ç¢¼å¯©æŸ¥**ï¼šåœ¨ä¿®æ”¹ Provider ç›¸é—œä»£ç¢¼æ™‚æª¢æŸ¥æ˜¯å¦æœƒè§¸ç™¼å¾ªç’°
2. **æ¸¬è©¦è¦†è“‹**ï¼šæ·»åŠ è‡ªå‹•åŒ–æ¸¬è©¦æª¢æŸ¥ç„¡é™åˆ·æ–°å•é¡Œ
3. **æ€§èƒ½ç›£æ§**ï¼šç›£æ§é é¢è¼‰å…¥æ™‚é–“å’Œ API èª¿ç”¨æ¬¡æ•¸
4. **æ–‡æª”è¨˜éŒ„**ï¼šè¨˜éŒ„ä¿®å¾©éç¨‹ï¼Œé¿å…æœªä¾†é‡è¤‡å‡ºç¾

---

## ğŸ“‹ æœªè®€å·²è®€æ©Ÿåˆ¶æª”æ¡ˆæ¶æ§‹æ•´åˆï¼ˆæ–°å¢ï¼‰

### å¾Œç«¯æª”æ¡ˆæ¶æ§‹

#### æ ¸å¿ƒæœªè®€è¨ˆç®— API
1. **`unread_by_tasks.php`** â­ **ä¸»è¦ API**
   - **ç”¨é€”**ï¼šè§’è‰²å‹æœªè®€è¨ˆç®—ï¼Œæ”¯æ´åˆ†é ç¯„åœï¼ˆposted/myworks/allï¼‰
   - **é‚è¼¯**ï¼šåŸºæ–¼ `chat_rooms.creator_id/participant_id` ç²¾ç¢ºè¨ˆç®—
   - **å„ªå‹¢**ï¼šé¿å…ç¬›å¡çˆ¾ç©ï¼Œæ”¯æ´åˆ†é éæ¿¾ï¼Œè¨ˆç®—ç²¾ç¢º
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œæ¨è–¦ä½¿ç”¨

2. **`unread_snapshot.php`** âš ï¸ **å¾…ç§»é™¤**
   - **ç”¨é€”**ï¼šé€šç”¨æœªè®€å¿«ç…§ï¼ˆèˆŠç‰ˆï¼‰
   - **å•é¡Œ**ï¼šé‡è¤‡æ€§é«˜ï¼Œè¨ˆç®—é‚è¼¯ä¸å¦‚ `unread_by_tasks.php` ç²¾ç¢º
   - **ç‹€æ…‹**ï¼šğŸ”„ å·²æ¨™è¨˜ç‚ºå¾…ç§»é™¤ï¼Œåƒ…åœ¨ `app_config.dart` ä¸­æœ‰å¼•ç”¨

#### UI å„ªåŒ– API
3. **`unread_for_ui.php`**
   - **ç”¨é€”**ï¼šç‚ºå‰ç«¯ UI å„ªåŒ–çš„æœªè®€æ•¸æ“šèšåˆ
   - **åŠŸèƒ½**ï¼šæä¾› Posted Tasks å’Œ My Works çš„æ‡‰å¾µè€…/èŠå¤©å¤¥ä¼´æœªè®€æ•¸æ“š
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œä½¿ç”¨ `COUNT(DISTINCT cm.id)` é¿å…é‡è¤‡è¨ˆç®—

#### å·²è®€æ¨™è¨˜ API
4. **`read_room_v2.php`** â­ **ä¸»è¦ API**
   - **ç”¨é€”**ï¼šæ¨™è¨˜èŠå¤©å®¤ç‚ºå·²è®€ï¼ˆæ–°ç‰ˆï¼‰
   - **åŠŸèƒ½**ï¼šæ¬Šé™é©—è­‰ã€äº¤æ˜“å®‰å…¨ã€å†ªç­‰æ“ä½œ
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œæ¨è–¦ä½¿ç”¨

5. **`read_room.php`** âš ï¸ **å¾…ç§»é™¤**
   - **ç”¨é€”**ï¼šæ¨™è¨˜èŠå¤©å®¤ç‚ºå·²è®€ï¼ˆèˆŠç‰ˆï¼‰
   - **å•é¡Œ**ï¼šç¼ºä¹æ¬Šé™é©—è­‰ï¼Œå®‰å…¨æ€§è¼ƒä½
   - **ç‹€æ…‹**ï¼šğŸ”„ å·²æ¨™è¨˜ç‚ºå¾…ç§»é™¤

#### è¼”åŠ© API
6. **`get_messages.php`**
   - **ç”¨é€”**ï¼šç²å–èŠå¤©å®¤è¨Šæ¯åˆ—è¡¨
   - **åŠŸèƒ½**ï¼šåŒ…å«æœªè®€æ•¸è¨ˆç®—ã€å·²è®€ç‹€æ…‹å›å‚³
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œä½¿ç”¨ `COUNT(DISTINCT cm.id)` é¿å…é‡è¤‡

7. **`get_rooms.php`**
   - **ç”¨é€”**ï¼šç²å–ç”¨æˆ¶çš„èŠå¤©å®¤åˆ—è¡¨
   - **åŠŸèƒ½**ï¼šåŒ…å«æ¯å€‹æˆ¿é–“çš„æœªè®€æ•¸
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

### å‰ç«¯æª”æ¡ˆæ¶æ§‹

#### æ ¸å¿ƒæœå‹™
1. **`notification_service.dart`**
   - **ç”¨é€”**ï¼šé€šçŸ¥æœå‹™ä»‹é¢å®šç¾©
   - **åŠŸèƒ½**ï¼šå®šç¾© `NotificationService` ä»‹é¢
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

2. **`socket_notification_service.dart`** (æ¨æ¸¬ä½ç½®)
   - **ç”¨é€”**ï¼šSocket.IO å¯¦æ™‚é€šçŸ¥æœå‹™
   - **åŠŸèƒ½**ï¼šå¯¦ä½œ `NotificationService`ï¼Œè™•ç†å¯¦æ™‚æœªè®€æ›´æ–°
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

3. **`unread_service_v2.dart`** â­ **ä¸»è¦æœå‹™**
   - **ç”¨é€”**ï¼šæ–°ç‰ˆæœªè®€æœå‹™ï¼Œå°æ¥ `unread_by_tasks.php`
   - **åŠŸèƒ½**ï¼šæä¾›ä¾¿æ·çš„æœªè®€æ•¸æ“šè¨ªå•æ–¹æ³•
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

#### UI çµ„ä»¶
4. **`posted_tasks_widget.dart`**
   - **ç”¨é€”**ï¼šPosted Tasks åˆ†é çµ„ä»¶
   - **åŠŸèƒ½**ï¼šé¡¯ç¤ºä»»å‹™åˆ—è¡¨ã€æ‡‰å¾µè€…å¡ç‰‡ã€æœªè®€æ¨™è¨˜
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œä½¿ç”¨ `NotificationCenter.byRoomStream`

5. **`my_works_widget.dart`**
   - **ç”¨é€”**ï¼šMy Works åˆ†é çµ„ä»¶
   - **åŠŸèƒ½**ï¼šé¡¯ç¤ºä»»å‹™åˆ—è¡¨ã€èŠå¤©å¤¥ä¼´å¡ç‰‡ã€æœªè®€æ¨™è¨˜
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆï¼Œä½¿ç”¨ `NotificationCenter.byRoomStream`

6. **`app_scaffold.dart`**
   - **ç”¨é€”**ï¼šæ‡‰ç”¨ç¨‹å¼ä¸»æ¡†æ¶
   - **åŠŸèƒ½**ï¼šåº•éƒ¨å°èˆª Chat åœ–ç¤ºæœªè®€åœ“é»
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

#### é…ç½®èˆ‡è·¯ç”±
7. **`app_config.dart`**
   - **ç”¨é€”**ï¼šAPI ç«¯é»é…ç½®
   - **åŠŸèƒ½**ï¼šå®šç¾©æœªè®€ç›¸é—œ API URL
   - **ç‹€æ…‹**ï¼šâš ï¸ éœ€è¦æ›´æ–°ï¼Œç§»é™¤ `unread_snapshot.php` å¼•ç”¨

8. **`app_router.dart`**
   - **ç”¨é€”**ï¼šè·¯ç”±é…ç½®
   - **åŠŸèƒ½**ï¼šåŒ…å«æœªè®€æ¸¬è©¦é é¢è·¯ç”±
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

#### æ¸¬è©¦é é¢
9. **`unread_api_test_page.dart`**
   - **ç”¨é€”**ï¼šæœªè®€ API æ¸¬è©¦é é¢
   - **åŠŸèƒ½**ï¼šæ¸¬è©¦ `UnreadServiceV2` åŠŸèƒ½
   - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

10. **`unread_timing_test_page.dart`**
    - **ç”¨é€”**ï¼šæœªè®€æ™‚æ©Ÿæ¸¬è©¦é é¢
    - **åŠŸèƒ½**ï¼šæ¸¬è©¦åˆå§‹åŒ–æ™‚æ©Ÿå•é¡Œ
    - **ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆ

### æ•¸æ“šæµç¨‹æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Login    â”‚â”€â”€â”€â–¶â”‚ NotificationCenterâ”‚â”€â”€â”€â–¶â”‚ Socket Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UnreadServiceV2 â”‚â—€â”€â”€â”€â”‚  unread_by_tasks â”‚â—€â”€â”€â”€â”‚  Real-time      â”‚
â”‚                 â”‚    â”‚      .php        â”‚    â”‚  Updates        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Posted/MyWorks  â”‚    â”‚ read_room_v2.php â”‚    â”‚ get_messages.phpâ”‚
â”‚   Widgets       â”‚    â”‚                  â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Display    â”‚    â”‚  Mark as Read    â”‚    â”‚  Chat Detail    â”‚
â”‚  (Unread Dots)  â”‚    â”‚                  â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é·ç§»è¨ˆåŠƒ

#### éšæ®µ 1ï¼šæ›´æ–°é…ç½®ï¼ˆç«‹å³åŸ·è¡Œï¼‰
- [âœ…] æ›´æ–° `app_config.dart`ï¼šç§»é™¤ `unread_snapshot.php` å¼•ç”¨
- [âœ…] æ›´æ–° `app_config.dart`ï¼šç§»é™¤ `read_room.php` å¼•ç”¨
- [âœ…] ç¢ºèªæ‰€æœ‰å‰ç«¯çµ„ä»¶ä½¿ç”¨ `unread_by_tasks.php` å’Œ `read_room_v2.php`

#### éšæ®µ 2ï¼šç§»é™¤èˆŠæª”æ¡ˆï¼ˆç¢ºèªç„¡å¼•ç”¨å¾Œï¼‰
- [âœ…] ç§»é™¤ `backend/api/chat/unread_snapshot.php`ï¼ˆå·²ç¢ºèªç„¡å‰ç«¯å¼•ç”¨ï¼‰
- [âœ…] ç§»é™¤ `backend/api/chat/read_room.php`ï¼ˆå·²ç¢ºèªç„¡å‰ç«¯å¼•ç”¨ï¼‰
- [ ] æ›´æ–°ç›¸é—œæ–‡æª”ï¼ˆåƒ…æ–‡æª”ä¸­çš„å¼•ç”¨ï¼Œä¸å½±éŸ¿åŠŸèƒ½ï¼‰

#### éšæ®µ 3ï¼šé©—è­‰èˆ‡æ¸¬è©¦
- [âœ…] ç¢ºèªæ‰€æœ‰æœªè®€åŠŸèƒ½æ­£å¸¸é‹ä½œï¼ˆAPI æ¸¬è©¦é€šéï¼‰
- [âœ…] ç¢ºèªå·²è®€æ¨™è¨˜åŠŸèƒ½æ­£å¸¸é‹ä½œï¼ˆAPI æ¸¬è©¦é€šéï¼‰
- [âœ…] ç¢ºèªå¯¦æ™‚æ›´æ–°åŠŸèƒ½æ­£å¸¸é‹ä½œï¼ˆå‰ç«¯é…ç½®å·²æ›´æ–°ï¼‰

### å¼•ç”¨æª¢æŸ¥çµæœ

#### éœ€è¦æ›´æ–°çš„æª”æ¡ˆ
1. **`lib/config/app_config.dart`** âœ… **å·²å®Œæˆ**
   - ~~ç¬¬ 89 è¡Œï¼š`unreadSnapshotUrl` å¼•ç”¨ `unread_snapshot.php`~~
   - ~~ç¬¬ 93 è¡Œï¼š`readRoomUrl` å¼•ç”¨ `read_room.php`~~
   - âœ… å·²æ›´æ–°ç‚º `unreadByTasksUrl` å’Œ `chatReadRoomV2Url`

#### æ–‡æª”æ›´æ–°
- å¤šå€‹ `.md` æª”æ¡ˆä¸­ä»æœ‰ `unread_snapshot.php` çš„å¼•ç”¨
- éœ€è¦æ›´æ–°ç‚º `unread_by_tasks.php`

### å»ºè­°è¡Œå‹•
1. **âœ… ç«‹å³åŸ·è¡Œ**ï¼šæ›´æ–° `app_config.dart` ä¸­çš„ API ç«¯é»ï¼ˆå·²å®Œæˆï¼‰
2. **âœ… ç¢ºèªæ¸¬è©¦**ï¼šç¢ºä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œï¼ˆAPI æ¸¬è©¦é€šéï¼‰
3. **âœ… å®‰å…¨ç§»é™¤**ï¼šç§»é™¤èˆŠçš„ PHP æª”æ¡ˆï¼ˆå·²å®Œæˆï¼‰
4. **ğŸ”„ æ–‡æª”æ›´æ–°**ï¼šæ›´æ–°æ‰€æœ‰ç›¸é—œæ–‡æª”ï¼ˆå¯é¸ï¼Œä¸å½±éŸ¿åŠŸèƒ½ï¼‰


